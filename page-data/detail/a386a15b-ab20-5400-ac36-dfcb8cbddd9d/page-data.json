{"componentChunkName":"component---src-pages-detail-tsx","path":"/detail/a386a15b-ab20-5400-ac36-dfcb8cbddd9d","result":{"pageContext":{"html":"<h2>前言</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 258px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6dc35713963eba5e513f59693e2007c1/53f89/graduate-qrcode.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAMCBAX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAv/aAAwDAQACEAMQAAAB9aaVz3sIqmAoD//EABsQAQEAAgMBAAAAAAAAAAAAAAECABEDEBMx/9oACAEBAAEFArvWeok1s5Op+IYSOBo//8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPwEf/8QAFhEBAQEAAAAAAAAAAAAAAAAAAREg/9oACAECAQE/AQJj/8QAGhAAAgMBAQAAAAAAAAAAAAAAACEBEGEREv/aAAgBAQAGPwLBSOoXnRXyD//EABsQAQADAAMBAAAAAAAAAAAAAAEAESExQVHR/9oACAEBAAE/Iedf3BC6/WbeGHd6bS4vRg9XApUVHahfsBtOYRBQT//aAAwDAQACAAMAAAAQlMc8/8QAFREBAQAAAAAAAAAAAAAAAAAAASD/2gAIAQMBAT8QVGP/xAAWEQEBAQAAAAAAAAAAAAAAAAABICH/2gAIAQIBAT8QS1dj/8QAHRABAAMBAAIDAAAAAAAAAAAAAQARITFBUWFx0f/aAAgBAQABPxBLIAEQ7oHZW1OA/PqCNHNLhozVBo0Nj9TVISiqcTxBgnyg/IStAaRpNCnqDyFQE//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"qrcode\"\n        title=\"qrcode\"\n        src=\"/static/6dc35713963eba5e513f59693e2007c1/53f89/graduate-qrcode.jpg\"\n        srcset=\"/static/6dc35713963eba5e513f59693e2007c1/a80bd/graduate-qrcode.jpg 148w,\n/static/6dc35713963eba5e513f59693e2007c1/53f89/graduate-qrcode.jpg 258w\"\n        sizes=\"(max-width: 258px) 100vw, 258px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n这是一个可以用来制作毕业照的微信小程序，主要使用的技术栈是<code>Taro</code>，<code>React</code>。开发总体上，主要的问题是集中在<code>资源加载优化方面</code>还有<code>画布的处理上</code>。</p>\n<h2>资源加载优化方面</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/949a94c6270af48f136b158cc77d282c/47311/41591696515.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 177.7027027027027%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAkABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAUCAQP/xAAWAQEBAQAAAAAAAAAAAAAAAAAAAgH/2gAMAwEAAhADEAAAAbSXiZrpBtfuvOmhh01kU//EAB0QAAIDAAIDAAAAAAAAAAAAAAABAhESAxMQITL/2gAIAQEAAQUCtePR3yZ2ND5Zt5iZRlDdGpEG5KkUcXz/AP/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BX//EABkRAAMAAwAAAAAAAAAAAAAAAAACEgEgMf/aAAgBAgEBPwG1Lxo3T//EAB0QAAICAQUAAAAAAAAAAAAAAAAxARACERIgITL/2gAIAQEABj8C4MYoFAoFqeDvHbU1/8QAHBAAAwEAAgMAAAAAAAAAAAAAAAERITHxQXGB/9oACAEBAAE/IV4DPLvwpoji9YaN6y4hfDojpjph0R/Q4t8zkqXNeGPTFyQsIp23XT//2gAMAwEAAgADAAAAEIwIT4wf/8QAGBEAAgMAAAAAAAAAAAAAAAAAABEBIDH/2gAIAQMBAT8QY6Rh/8QAGhEAAgIDAAAAAAAAAAAAAAAAAAERIRBBYf/aAAgBAgEBPxDphoo2LDwf/8QAIBABAAMAAQQDAQAAAAAAAAAAAQARITFBUdHxYXGRsf/aAAgBAQABPxDRofqUNfFbFC+IFIx36gNAbWLm8TBNwAvM9Xnr8r4/POQA04z5ibR7axh3jC7BeLXfJS6KxnWJqBWmda5i0oVtB/J//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"decorationPage\"\n        title=\"decorationPage\"\n        src=\"/static/949a94c6270af48f136b158cc77d282c/1c72d/41591696515.jpg\"\n        srcset=\"/static/949a94c6270af48f136b158cc77d282c/a80bd/41591696515.jpg 148w,\n/static/949a94c6270af48f136b158cc77d282c/1c91a/41591696515.jpg 295w,\n/static/949a94c6270af48f136b158cc77d282c/1c72d/41591696515.jpg 590w,\n/static/949a94c6270af48f136b158cc77d282c/a8a14/41591696515.jpg 885w,\n/static/949a94c6270af48f136b158cc77d282c/47311/41591696515.jpg 1080w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>在这个装饰页面，以前也有见过类似的场景，是在<code>你头像真棒</code>小程序里。通过点击底下的图片，来更换画布中的背景图。但是不同于上一个场景，上一个场景加载的图片资源大多是一些头像挂件，体积都不大且数量不多，这里的图片资源数量比较多，除了体积大不的挂件，更多的是体积比较大的背景图。虽然图片资源都有进行了一定程度的压缩，但是总体的体积还是很大，加载完这个页面的资源需要<code>20+M</code>的流量，这个加载时长是不能接受的，而且这也会造成加载时滑动的卡顿。</p>\n<p>此外，还有一点对象存储 OSS 的计费和图片的请求次数有关系，因此如果更降低图片的请求次数也是对加载的优化。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/04e4e31646aa01793c8712768dd385cc/d0ab7/subPackage.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.513513513513516%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAAA4ElEQVQoz4VSjQqGIAz0/d+yf/qxLCsjtX3dYCERfMLhds7bLVN939OyLHRdF3nvCQu5tZZj8MB7CSfnArWuK19GEkJ4BMdxpHme79gSasAB27bRNE3MxxgZaUNljOEicYgdXNM0VFUVlWXJcVEUlGUZc13XsSiaYk/dKhy2bcvEeZ4sigYoBvZ9Z+fgBbgIZ+BlqkdQxhFBFCAv8vx2U9MwDOSco+M4WByQiVIhyVVd1zxK6tDalfRomEudCMTl+8HYIb4BxhYxjz1EcsdJ/9bX6yutNYuJQ4m/fok3vkR/mNxxUwEVrisAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"subPackage\"\n        title=\"subPackage\"\n        src=\"/static/04e4e31646aa01793c8712768dd385cc/fcda8/subPackage.png\"\n        srcset=\"/static/04e4e31646aa01793c8712768dd385cc/12f09/subPackage.png 148w,\n/static/04e4e31646aa01793c8712768dd385cc/e4a3f/subPackage.png 295w,\n/static/04e4e31646aa01793c8712768dd385cc/fcda8/subPackage.png 590w,\n/static/04e4e31646aa01793c8712768dd385cc/efc66/subPackage.png 885w,\n/static/04e4e31646aa01793c8712768dd385cc/c83ae/subPackage.png 1180w,\n/static/04e4e31646aa01793c8712768dd385cc/d0ab7/subPackage.png 1532w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>最后的方案是，对原先的高清图进行有损压缩并利用的小程序的<code>分包加载</code>能力，小程序的每个分包大小不超过 2M。将该页面所有缩略图控制在 2M 内，并作为缓存放进小程序的分包中。由于高清图资源的地址需要通过接口获取，因此需要建立高清图的 URL 和分包中对应的缩略图的地址的映射关系来进行优化。</p>\n<pre><code class=\"language-jsx\">// thumbnail.js\nconst thumbnailMap = new Map(\n  [\n    [\n      \"https://graphbed.example.com/graduate/sdfovhidsf1\",\n      \"/subPackage/package1/assets/1.png\"\n    ],\n    [\n      \"https://graphbed.example.com/graduate/67sdf87sd6f\",\n      \"/subPackage/package1/assets/2.png\"\n    ]\n  ]\n)\n\n// page.jsx\n\nrender(){\n  const src = 'https://graphbed.example.com/graduate/sdfovhidsf1';\n  return &#x3C;Image src={thumbnailMap.get(src) || src} >\n}\n</code></pre>\n<p>这样当后端的高清图发生更新添加了新的高清图时，缓存未命中，可以 fallback 直接请求高清图的地址。同时，也需要前端在小程序包中添加新的缩略图，发布新的版本，在此期间不会影响小程序的使用。</p>\n<h2>画布处理上</h2>\n<p>在画布处理上，我将另一个项目中的原生的画布组件封装成了 Taro 组件，并修改了一部分的 props。不过该组件是一个 canvas，不同于普通的组件。框架并不能直接替我计算出需要帮我增加/提换/删除页面的什么节点，因此需要我在特定的生命周期，比对 props 的变化，操作 canvas context 的 api，重新进行渲染。因此要求传入的 props 的<code>graphArray</code>的每一个元素都应该有一个<code>key</code>，便于我追踪每一个 graph 的具体变化。</p>","id":"a386a15b-ab20-5400-ac36-dfcb8cbddd9d","headings":[{"value":"前言","depth":2},{"value":"资源加载优化方面","depth":2},{"value":"画布处理上","depth":2}],"date":"Tuesday, June 9, 2020 5:00 PM","tags":["Taro","JavaScript","小程序"],"title":"毕业照小程序开发复盘"}}}