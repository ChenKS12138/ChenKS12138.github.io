{"componentChunkName":"component---src-pages-detail-tsx","path":"/detail/a386a15b-ab20-5400-ac36-dfcb8cbddd9d","result":{"pageContext":{"html":"<h1>前言</h1>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 258px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/d1f447ae8e413eee570318fa837d4164/53f89/graduate-qrcode.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAMCBAX/xAAWAQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAfWmludzLFpgKA//xAAbEAEBAAIDAQAAAAAAAAAAAAABAgARAxATIf/aAAgBAQABBQK71nqJNbOTqT5QYSOAB//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABYRAQEBAAAAAAAAAAAAAAAAAAERIP/aAAgBAgEBPwECY//EABoQAAEFAQAAAAAAAAAAAAAAAAABEBEhYTH/2gAIAQEABj8CwpS25GlPCH//xAAbEAEBAQEBAAMAAAAAAAAAAAABEQAxIUFR0f/aAAgBAQABPyHsv7wxa/bvf8ON7y+mvIifJyJYmUVChga40EDf/9oADAMBAAIAAwAAABCTAAD/xAAVEQEBAAAAAAAAAAAAAAAAAAABIP/aAAgBAwEBPxBUY//EABYRAQEBAAAAAAAAAAAAAAAAAAEgIf/aAAgBAgEBPxBLV2P/xAAeEAEAAwACAgMAAAAAAAAAAAABABEhMVFBYXHh8P/aAAgBAQABPxBU0AEe+F0zJvwH31AADjS5e6rA01d38RG366KOMRDPKPqImkUpKC64/vHE8DZE/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"qrcode\"\n        title=\"qrcode\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/d1f447ae8e413eee570318fa837d4164/53f89/graduate-qrcode.jpg\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/d1f447ae8e413eee570318fa837d4164/a80bd/graduate-qrcode.jpg 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/d1f447ae8e413eee570318fa837d4164/53f89/graduate-qrcode.jpg 258w\"\n        sizes=\"(max-width: 258px) 100vw, 258px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n这是一个可以用来制作毕业照的微信小程序，主要使用的技术栈是<code>Taro</code>，<code>React</code>。开发总体上，主要的问题是集中在<code>资源加载优化方面</code>还有<code>画布的处理上</code>。</p>\n<h1>资源加载优化方面</h1>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e8db083e2c12b578af9f3226eebf218a/47311/41591696515.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 177.7027027027027%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAkABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAUCAQP/xAAWAQEBAQAAAAAAAAAAAAAAAAAAAgH/2gAMAwEAAhADEAAAAbSXiZrpAsO+dbsDoZGv/8QAHRAAAgICAwEAAAAAAAAAAAAAAAECEgMREBMhMv/aAAgBAQABBQLzjw75Mu0PLNlUVRVDei0iDclpGkYvn//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BX//EABkRAAMAAwAAAAAAAAAAAAAAAAACEgEgMf/aAAgBAgEBPwG1Lxo3T//EAB0QAAICAQUAAAAAAAAAAAAAAAAxARACERIgITL/2gAIAQEABj8C4MYoFAoFqeDvHbU1/8QAHhAAAgICAwEBAAAAAAAAAAAAAAERITFBcYHxsfD/2gAIAQEAAT8hT0+FbbfRP6iRcLihTL29DiYLo8Y8Y8YZCH4GK+YySlzThmSlTIKIlm5s/9oADAMBAAIAAwAAABCMM02MP//EABgRAAIDAAAAAAAAAAAAAAAAAAARASAx/9oACAEDAQE/EGOkYf/EABoRAAICAwAAAAAAAAAAAAAAAAABESEQQWH/2gAIAQIBAT8Q6YaKNiw8H//EAB4QAQADAAIDAQEAAAAAAAAAAAEAESExUWHR8bHh/9oACAEBAAE/ENRYYobkVv8AEoWA4THfUHoG1pzxMW3AC9z5+fAyn0ZzAGnGeY30a2s4dxhlC8Wu8jV4TkqUCtM4a5iSWSrUD8n/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"decorationPage\"\n        title=\"decorationPage\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e8db083e2c12b578af9f3226eebf218a/1c72d/41591696515.jpg\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e8db083e2c12b578af9f3226eebf218a/a80bd/41591696515.jpg 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e8db083e2c12b578af9f3226eebf218a/1c91a/41591696515.jpg 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e8db083e2c12b578af9f3226eebf218a/1c72d/41591696515.jpg 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e8db083e2c12b578af9f3226eebf218a/a8a14/41591696515.jpg 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e8db083e2c12b578af9f3226eebf218a/47311/41591696515.jpg 1080w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>在这个装饰页面，以前也有见过类似的场景，是在<code>你头像真棒</code>小程序里。通过点击底下的图片，来更换画布中的背景图。但是不同于上一个场景，上一个场景加载的图片资源大多是一些头像挂件，体积都不大且数量不多，这里的图片资源数量比较多，除了体积大不的挂件，更多的是体积比较大的背景图。虽然图片资源都有进行了一定程度的压缩，但是总体的体积还是很大，加载完这个页面的资源需要<code>20+M</code>的流量，这个加载时长是不能接受的，而且这也会造成加载时滑动的卡顿。</p>\n<p>此外，还有一点对象存储 OSS 的计费和图片的请求次数有关系，因此如果更降低图片的请求次数也是对加载的优化。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e6875518359b64bf4684d71539687f27/d0ab7/subPackage.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.513513513513516%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA2klEQVQY05WQy47DIAxF8///mE1BBIU6uAECpH6MMkjtSNPFzFl5c3ztO3nva63MTESqGmNsreknROQ1DCZErLWKCDMPGREfjz2lXErZ9z3nXHKOEUs5hvNaNwFA711EiIiZ4X5flsVa65zz3htjbrfbsiwhBMQIACmlt2ytRURVPc+TiFJK27aN44no+Q0RjdNGwFtGxFKKqvber2QAY4xzLsbYe2+t1VqP46i1/m5hmud5XdeRzMwxXv+q6sj5yQc5hAAARHTJRP189pP0b1yFMbOIjJ/1P3wBn1LSnPsNxs4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"subPackage\"\n        title=\"subPackage\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e6875518359b64bf4684d71539687f27/fcda8/subPackage.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e6875518359b64bf4684d71539687f27/12f09/subPackage.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e6875518359b64bf4684d71539687f27/e4a3f/subPackage.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e6875518359b64bf4684d71539687f27/fcda8/subPackage.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e6875518359b64bf4684d71539687f27/efc66/subPackage.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e6875518359b64bf4684d71539687f27/c83ae/subPackage.png 1180w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e6875518359b64bf4684d71539687f27/d0ab7/subPackage.png 1532w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>最后的方案是，对原先的高清图进行有损压缩并利用的小程序的<code>分包加载</code>能力，小程序的每个分包大小不超过 2M。将该页面所有缩略图控制在 2M 内，并作为缓存放进小程序的分包中。由于高清图资源的地址需要通过接口获取，因此需要建立高清图的 URL 和分包中对应的缩略图的地址的映射关系来进行优化。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-jsx line-numbers\"><code class=\"language-jsx\"><span class=\"token comment\">// thumbnail.js</span>\n<span class=\"token keyword\">const</span> thumbnailMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"https://graphbed.example.com/graduate/sdfovhidsf1\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"/subPackage/package1/assets/1.png\"</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"https://graphbed.example.com/graduate/67sdf87sd6f\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"/subPackage/package1/assets/2.png\"</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// page.jsx</span>\n\n<span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> src <span class=\"token operator\">=</span> <span class=\"token string\">'https://graphbed.example.com/graduate/sdfovhidsf1'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Image</span></span> <span class=\"token attr-name\">src</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>thumbnailMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> src<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样当后端的高清图发生更新添加了新的高清图时，缓存未命中，可以 fallback 直接请求高清图的地址。同时，也需要前端在小程序包中添加新的缩略图，发布新的版本，在此期间不会影响小程序的使用。</p>\n<h1>画布处理上</h1>\n<p>在画布处理上，我将另一个项目中的原生的画布组件封装成了 Taro 组件，并修改了一部分的 props。不过该组件是一个 canvas，不同于普通的组件。框架并不能直接替我计算出需要帮我增加/提换/删除页面的什么节点，因此需要我在特定的生命周期，比对 props 的变化，操作 canvas context 的 api，重新进行渲染。因此要求传入的 props 的<code>graphArray</code>的每一个元素都应该有一个<code>key</code>，便于我追踪每一个 graph 的具体变化。</p>","id":"a386a15b-ab20-5400-ac36-dfcb8cbddd9d","headings":[{"value":"前言","depth":1},{"value":"资源加载优化方面","depth":1},{"value":"画布处理上","depth":1}],"date":"Tuesday, June 9, 2020 5:00 PM","tags":["Taro","JavaScript","小程序"],"title":"毕业照小程序开发复盘"}},"staticQueryHashes":["63159454"]}