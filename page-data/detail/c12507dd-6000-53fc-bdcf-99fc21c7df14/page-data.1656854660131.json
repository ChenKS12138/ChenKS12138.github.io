{"componentChunkName":"component---src-pages-detail-tsx","path":"/detail/c12507dd-6000-53fc-bdcf-99fc21c7df14","result":{"pageContext":{"html":"<h1>前言</h1>\n<p>最近看了《the linux programming interface》<sup><a href=\"#1\">[1]</a></sup>，总体感觉这是本好书，补充了一些课内 OS 没有告诉我，但是同样重要的东西，比较清晰地介绍了一些比较重要的概念，如<code>文件空洞</code>、<code>作业控制/进程组</code>、<code>标准信号/实时信号</code>、<code>进程的内存模型</code>、<code>僵尸进程</code>、<code>进程间通信</code>、<code>socket编程</code>、<code>ruid/euid/suid</code>、<code>elf文件</code>、<code>IO模型</code>等。书中最后一章介绍了伪终端技术，这里我想动手实现一个基于 web 的 terminal，顺便复习一下之前学到的东西。</p>\n<h1>什么是终端</h1>\n<p>在大型机的时代，人手一台计算机的事情是不可想象的，相比之下更为常见的是用户通过一台终端设备接入大型机。随着个人计算机的普及，我们通常不再需要单独的终端设备连接我们的计算机，提到的终端更多的是虚拟终端。从虚拟终端的实现上又分为 tty 和 pty<sup><a href=\"#2\">[2]</a></sup>。tty/pty 连接了用户空间的进程和外部的输入输出设备，不同之处在于 tty 连接的是内核的终端模拟器，终端模拟器外部对应真实的外设，pts 通过 ptmx 连接到其他用户空间进程。</p>\n<h1>web 终端的实现</h1>\n<h2>实现目标及方式</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/2bc1de3fcbcc289c8c593a85a78cebdb/cab43/1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.45945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABTklEQVQoz62TWYvCMBSFq6C16Z62SWo3u6bVYRQfBP//DztDLzOiMMNA8eHjLuSc3MCNcWg6NOOIdhrRjBqN1pTP1P2AQ9u/UHcDml6/MPf0dEJVtzDqrkE2VCiONbKuRNZVyKcD1arIkQgFme4hZAqpUvAogR9yBCH/jhH1ojiBUHsYWV5gr1JEIYdIBJRUFEWcII5jCCFQzMZJQvlms8F2u8XONGGaJuWGYRCu58Nou5aEJJYCUilIKUk8m2RZBvXUm8/N/TAMCc/zHoaeH8D4PJ9xuVwwTRPyPCdmIWMMtm3DcRxYlkX5D+v1+mHyDBn2g8b9fsf1eqXbXdcF5/xXwX+Q4fH0gdvtBq01PS2KIpRlSZMsMqwONaqqAucRgiCg5/q+v3zCncUWif80tB2XitVq9R5DZjtvm5D2cN50izEwWgkHFrOXYTH6MV8SahPaM6OlkAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"aliyun-web-terminal\"\n        title=\"aliyun-web-terminal\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/2bc1de3fcbcc289c8c593a85a78cebdb/fcda8/1.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/2bc1de3fcbcc289c8c593a85a78cebdb/12f09/1.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/2bc1de3fcbcc289c8c593a85a78cebdb/e4a3f/1.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/2bc1de3fcbcc289c8c593a85a78cebdb/fcda8/1.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/2bc1de3fcbcc289c8c593a85a78cebdb/cab43/1.png 755w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 461px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/4b310531d1b182b3499c6da413288e63/f816d/2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.189189189189186%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/UlEQVQoz4WSV26EQBBEuf/JOAFCCIkglpxz3LbeWLPG+MMllSYwXdUBoyxL6bpO2raVuq7lPE8B7/f7Q9D3vfi+L1EUSRAE4nneh2EYKr5eLzG2bRONdV0V74Lgui5luCyLOmOMOCIYHMeh7pMk+S04z7PoMyIQEDAMg1BNmqaSZZnkea6IuN7HcSwGD7U73PddnkCYtmD4BCbTNP1kyEN6UhSFKpdLDFzXVdQZsBLId0i/6Ctvm6ZRZmT/p2SCKJEVkjFGuoqqqsQ0TbEsS7WHhGzbFsdxvgX1EMB/Jeuh6GEBDMZxVHvVw7vgfSjP34YMCUZYU5fLSvn08wvufWegmlzbnwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"addon\"\n        title=\"addon\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/4b310531d1b182b3499c6da413288e63/f816d/2.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/4b310531d1b182b3499c6da413288e63/12f09/2.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/4b310531d1b182b3499c6da413288e63/e4a3f/2.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/4b310531d1b182b3499c6da413288e63/f816d/2.png 461w\"\n        sizes=\"(max-width: 461px) 100vw, 461px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>我们在使用各家云服务的计算时，都会提供一个 web 的终端，我的目标就是实现一个类似的 web 服务，通过 websocket 进行通信。同时因为 Node.js 的 Built-in 模块不提供伪终端相关的 api，我编写调用相关系统调用的 Node.js Addon。</p>\n<h2>实现原理</h2>\n<p>主要的流程如下</p>\n<ol>\n<li>进程调用<code>posix_openpt</code>获取伪终端主设备 fd</li>\n<li>进程调用<code>fork</code>生成子进程，父进程返回主设备 fd</li>\n<li>子进程打开伪终端从设备 fd，并将<code>stdin</code>,<code>stdout</code>,'stderr`改为伪终端从设备</li>\n<li>执行 exec，一般是 shell 程序</li>\n</ol>\n<p>关闭伪终端时，需要对子进程发送<code>SIGHUP</code>，通知其终端将关闭。</p>\n<p>上述流程编写完后，使用<code>nan</code>wrap 一层后，即可成为 addon。Node.js 服务获取到伪终端主设备 fd 后，封装为一个 Stream。因为 node.js 使用的是异步 I/O，不能直接阻塞。</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-cpp line-numbers\"><code class=\"language-cpp\"><span class=\"token keyword\">int</span> <span class=\"token function\">fd_add_cloexec</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> fd<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> flags<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>flags <span class=\"token operator\">=</span> <span class=\"token function\">fcntl</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span> F_GETFD<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">pts_fatal</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fcntl\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    flags <span class=\"token operator\">|=</span> FD_CLOEXEC<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">fcntl</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span> F_SETFD<span class=\"token punctuation\">,</span> flags<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">int</span> <span class=\"token function\">create_pts</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token operator\">*</span> child_pid_ptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> master_tty_fd<span class=\"token punctuation\">,</span> slave_tty_fd<span class=\"token punctuation\">,</span> child_pid<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">char</span> slave_tty_name<span class=\"token punctuation\">[</span>FILENAME_MAX<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>str<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>shell<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">sigaction</span> sia<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>child_pid_ptr <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        child_pid_ptr <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>child_pid<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>master_tty_fd <span class=\"token operator\">=</span> <span class=\"token function\">posix_openpt</span><span class=\"token punctuation\">(</span>O_RDWR <span class=\"token operator\">|</span> O_NOCTTY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">pts_fatal</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"posix_openpt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">fd_add_cloexec</span><span class=\"token punctuation\">(</span>master_tty_fd<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">pts_fatal</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fd_add_cloexec\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>str <span class=\"token operator\">=</span> <span class=\"token function\">ptsname</span><span class=\"token punctuation\">(</span>master_tty_fd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">pts_fatal</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ptsname\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">strcpy</span><span class=\"token punctuation\">(</span>slave_tty_name<span class=\"token punctuation\">,</span> str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">unlockpt</span><span class=\"token punctuation\">(</span>master_tty_fd<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">pts_fatal</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unlockpt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>shell <span class=\"token operator\">=</span> <span class=\"token function\">getenv</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SHELL\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span>\n        shell <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token string\">\"/bin/sh\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">memset</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>sia<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">sigaction</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">sigemptyset</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>sia<span class=\"token punctuation\">.</span>sa_mask<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    sia<span class=\"token punctuation\">.</span>sa_flags <span class=\"token operator\">=</span> SA_RESETHAND <span class=\"token operator\">|</span> SA_NOCLDWAIT<span class=\"token punctuation\">;</span>\n    sia<span class=\"token punctuation\">.</span>sa_handler <span class=\"token operator\">=</span> SIG_DFL<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">sigaction</span><span class=\"token punctuation\">(</span>SIGCHLD<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>sia<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">pts_fatal</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sigaction\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>child_pid_ptr<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">fork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>child_pid_ptr<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">pts_fatal</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fork\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// child process</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>child_pid_ptr<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">setsid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">err_exit</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"setsid\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span>master_tty_fd<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">err_exit</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"close\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>slave_tty_fd <span class=\"token operator\">=</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span>slave_tty_name<span class=\"token punctuation\">,</span> O_RDWR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">err_exit</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"open\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">dup2</span><span class=\"token punctuation\">(</span>slave_tty_fd<span class=\"token punctuation\">,</span> STDIN_FILENO<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">err_exit</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dup2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">dup2</span><span class=\"token punctuation\">(</span>slave_tty_fd<span class=\"token punctuation\">,</span> STDOUT_FILENO<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">err_exit</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dup2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">dup2</span><span class=\"token punctuation\">(</span>slave_tty_fd<span class=\"token punctuation\">,</span> STDERR_FILENO<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">err_exit</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dup2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">execlp</span><span class=\"token punctuation\">(</span>shell<span class=\"token punctuation\">,</span> shell<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">err_exit</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"execlp\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> master_tty_fd<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">int</span> <span class=\"token function\">kill_pts_child</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> child_pid<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">kill</span><span class=\"token punctuation\">(</span>child_pid<span class=\"token punctuation\">,</span> SIGHUP<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">int</span> <span class=\"token function\">resize_pts</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> pts_fd<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> rows<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> cols<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">winsize</span> wsize<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">ioctl</span><span class=\"token punctuation\">(</span>pts_fd<span class=\"token punctuation\">,</span> TIOCGWINSZ<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>wsize<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">pts_fatal</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ioctl\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    wsize<span class=\"token punctuation\">.</span>ws_row <span class=\"token operator\">=</span> rows<span class=\"token punctuation\">;</span>\n    wsize<span class=\"token punctuation\">.</span>ws_col <span class=\"token operator\">=</span> cols<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">ioctl</span><span class=\"token punctuation\">(</span>pts_fd<span class=\"token punctuation\">,</span> TIOCSWINSZ<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>wsize<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">pts_fatal</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ioctl\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> stream <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"stream\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fs\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> ptsAddon <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./pts-addon\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">PtsStream</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">stream<span class=\"token punctuation\">.</span>Duplex</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> ptsFd<span class=\"token punctuation\">,</span> childPid <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> ptsAddon<span class=\"token punctuation\">.</span><span class=\"token function\">createPts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ptsFd <span class=\"token operator\">=</span> ptsFd<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>childPid <span class=\"token operator\">=</span> childPid<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">_destroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fs<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ptsFd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    ptsAddon<span class=\"token punctuation\">.</span><span class=\"token function\">killPtsChild</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>childPid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">_read</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">size</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fs<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ptsFd<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">length</span><span class=\"token operator\">:</span> size<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> bytesRead<span class=\"token punctuation\">,</span> buffer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err <span class=\"token operator\">||</span> bytesRead <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">destroy</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> bytesRead<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">_write</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">chunk<span class=\"token punctuation\">,</span> encoding<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fs<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ptsFd<span class=\"token punctuation\">,</span> chunk<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">resize</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">rows<span class=\"token punctuation\">,</span> cols</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    ptsAddon<span class=\"token punctuation\">.</span><span class=\"token function\">resizePts</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ptsFd<span class=\"token punctuation\">,</span> rows<span class=\"token punctuation\">,</span> cols<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> PtsStream <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2>实现效果</h2>\n<p>Github 仓库 <a href=\"https://github.com/ChenKS12138/web-pty\">https://github.com/ChenKS12138/web-pty</a></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e3ac6ebb0c69e4c0bf0382769d8cbb6a/ec3e2/3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.67567567567568%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACWklEQVQ4y5WSe3OaQBTFV1BeKlZ5CLpgxEesoyFVRCGJJtFMk3T6/T/O6dylZJzWdKZ//ObuLHfPnntY9nT6jv3jEYfHE7J8jyx7EHWX77HZ3WGd5ki2d2K9zR+QZgW0zu4PODy94PnlFfvnF+T3B7BNssVtvEIcfxNE0RhRNILv9wV9HqDX43CcLkzzC1qt9geWZcP3e+A8hOt64DwAmyUc45UDK9BgeRxuMIEXRAjDEPV6HZqmCWRZBmPsn1Af2xwWuFo4cMMmzI4D3bRhmBZc10Wj0UC1Wj07VLkoVKkU+6bZBtN0FeEgRBzfoNPpQDcMGPX6R9P/0Gg2qTL0+xzr1Rq+74NzjuFwKMZVFAWqqopRyGk5/qeCjUYhaBgG2u02dF0XQqZpioOlaLPZxGAwECRJAsuyhADlep4t9bNLH0rKPXJHzkejEeI4xmw2w3g8FhORK0mSRJ9RCtZqNcGfgmVjWUlgMplguVwiiiIx2cUMyUmZFwmXlW63bVtEQT+MRrZsB7JcvZihrumFoKLUoOsaWq2WyIcyIxHKkkalN0nuqDptE6pahaqoUFXlN6o47zh2Ieh1fSTrDebzOXyvC1mWhGOCns/5E0qTJU4/T3h9e8fb6w/B+9s7TscTjs9HMKUuYTjleHjKkN3dw/V6sGxXOCWHFAdlKMmSqHx0jcU2w/TmG67nCWaLBF8XK0znt/CDUeGQKQyyxlD5JJtzenwIHk7h9SN0ugGsbiiwvYGAZbsc6WaLdJMiTTfYbVPsdjtkWYY8z0Ut12mawg8idNxCwPGv/uIXpvlyWEqaST4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"result\"\n        title=\"result\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e3ac6ebb0c69e4c0bf0382769d8cbb6a/fcda8/3.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e3ac6ebb0c69e4c0bf0382769d8cbb6a/12f09/3.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e3ac6ebb0c69e4c0bf0382769d8cbb6a/e4a3f/3.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e3ac6ebb0c69e4c0bf0382769d8cbb6a/fcda8/3.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e3ac6ebb0c69e4c0bf0382769d8cbb6a/efc66/3.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e3ac6ebb0c69e4c0bf0382769d8cbb6a/ec3e2/3.png 997w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/9e1fe139b5121765d47e5ba550992e1d/7388e/4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 78.37837837837837%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB+UlEQVQ4y52S3W4SQRiGZ38g7A/bss4K0t2FZWEVt1sr3dli0ZI2Gk5JSCDsSQ/sleiZmnisl6JNPDFKiAdG7wbF1zCh0aRtWpjkyUxm5nvyfpMhgWMf15uNk5g9Gu/u7qVh+CCNoodpI7ifVqr1tOo10qpXv0Cl6qdbdiU1bxXHd8rOieN6T6KdPUIOE/Zt/3Ebh92nYMkBkuQA++0O7jUjeF4DNf8uarXgH34ArxagETQR7bRwdPwMcdxGsxl9evXmPSFbTuVrXjegKOosp6hzTdPmqqrNczllriiXk1MUfscwjDmldLaxsYm8nv/48sVrshgTQggIIb8JIX/W4Ney/ozbJDnzvxBrwOsEQTiTJJkQSZKvFAqCwBFFkXOdkCcUJelKYSaTgWEYsCyLzzcSXpZwIaKUwrZthGGI7e0Qvu+jVCpB07TrEl4UZrNZFItF+DUPjuuiVLZRLpfhui4KhcLqwkWLjuOClhwYmwVkchos6zYXmqYJWZZXa1nXdZ4kb2xA0/MQpCxUVeV7i7eUJGk14brfRhAE3vKX5cFsebgqs6Xww/kbfl8zGf+j52tRFD+bpklIq9V6xxj7EcfxhDE2vSlxHE+73e40SZJJp9P5yRh7C4CQ09Pn+ng8tobDIV2F0WhEe70eHQwGtN/vW2maaouW/wLRM0oRL2SifQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"result-vim\"\n        title=\"result-vim\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/9e1fe139b5121765d47e5ba550992e1d/fcda8/4.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/9e1fe139b5121765d47e5ba550992e1d/12f09/4.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/9e1fe139b5121765d47e5ba550992e1d/e4a3f/4.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/9e1fe139b5121765d47e5ba550992e1d/fcda8/4.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/9e1fe139b5121765d47e5ba550992e1d/efc66/4.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/9e1fe139b5121765d47e5ba550992e1d/7388e/4.png 1104w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>对窗口的调整做了适配，因此 vim 等编辑器也可以正常工作。</p>\n<h1>结语</h1>\n<p>之前遇到 linux 方面的问题，大都是通过直接 Google 搜索报错信息找到解决方案。看完 tlpi 了解了这些概念后对 linux 内核如何运作有了基本的认知，处理问题时心中可以有个模型，能够理解内核中发生的事件，排查问题时更有针对性。这也是我认为工程师区别于其他普通人的地方，其他人只能看到表象，但是工程师理解表象背后的系统运作逻辑。</p>\n<h1>参考引用</h1>\n<ul>\n<li>[1] <a href=\"https://man7.org/tlpi/\">https://man7.org/tlpi/</a></li>\n<li>[2] <a href=\"https://zhuanlan.zhihu.com/p/97018747\">https://zhuanlan.zhihu.com/p/97018747</a></li>\n</ul>","id":"c12507dd-6000-53fc-bdcf-99fc21c7df14","headings":[{"value":"前言","depth":1},{"value":"什么是终端","depth":1},{"value":"web 终端的实现","depth":1},{"value":"实现目标及方式","depth":2},{"value":"实现原理","depth":2},{"value":"实现效果","depth":2},{"value":"结语","depth":1},{"value":"参考引用","depth":1}],"date":"Friday, November 12, 2021 6:02 PM","tags":["随笔"],"title":"动手写一个web pty"}},"staticQueryHashes":["63159454"]}