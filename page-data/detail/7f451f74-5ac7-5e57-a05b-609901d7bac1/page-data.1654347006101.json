{"componentChunkName":"component---src-pages-detail-tsx","path":"/detail/7f451f74-5ac7-5e57-a05b-609901d7bac1","result":{"pageContext":{"html":"<p>有一段是没有写博客了，这一段时间了解了不少新技术，但是没来得及写成博客总结。WebAssembly和Rust是我一直在关注的两项技术，这段时间使用它们编写了一个FaaS服务工具。</p>\n<h1>动机</h1>\n<p>作为一个Web开发者，我总希望能有这样一套工具/系统/流程。它能给我提供一套模板，我只需要简单地编写Restful服务的核心代码，整个过程足够优雅。</p>\n<ul>\n<li>\n<p>性能/性能方面</p>\n<ol>\n<li>性能足够好。服务不会有太高的内存占用，性能足够好。如果能方便地进行扩缩容更好。</li>\n<li>安全性足够好。希望能够向我提供控制Restful服务访问宿主机的各项权限的能力，如IO、环境变量等。</li>\n</ol>\n</li>\n<li>\n<p>开发体验方面</p>\n<ol start=\"3\">\n<li>编程效率足够高。能给我提供注解/装饰器，我只需要编写Restful服务核心的Handler，对于路由实现、服务鉴权等问题我不需要关心或者只需要做简单的配置即可。</li>\n<li>编译产物足够简单。希望它最终产物只有一个Bundle，且这个Bundle体积不应该太大，因为我也不会在里面写什么复杂算法，不希望我的编译器把时间/算力浪费在重复地编译HTTP Server的实现上。</li>\n<li>部署足够方便。以往一些将整个运行环境打包发布的方式太过麻烦（没错，说的就是Node.js/Python ）。同时，如果能同静态资源一起打包发布更好，避免需要同时维护两个模块。</li>\n<li>测试开发的重编译速度足够快。开发时服务重启速度会影响开发速度，不希望我的时间浪费在等待长时间的编译上。</li>\n</ol>\n</li>\n</ul>\n<p>由此，我开发了<a href=\"https://github.com/ChenKS12138/wasm-lambda\">wams-lambda</a>项目，虽然已有不少的Web开发解决方案，但是我认为不能满足我的这些需求。</p>\n<h1>基于事件的FaaS</h1>\n<p>大部分的Restful服务都是可以转化成基于事件处理的服务，这种场景下使用FaaS<sup>[1]</sup>其实更为合适，但是我们看到的更多的是，每个Restful服务都bind一个socket，单独启动了一个HttpServer，这样的Restful服务多了，性能占用自然就高了。而使用FaaS平台，不需要常驻服务监听端口，可以缩容到0，降低了对系统资源的占用。</p>\n<h1>为什么是WebAssembly</h1>\n<h2>WebAssembly的安全性和性能</h2>\n<blockquote>\n<p>WebAssembly provides no ambient access to the computing environment in which code is executed. Any inter- action with the environment, such as I/O, access to resources, or operating system calls, can only be performed by invoking functions provided by the embedder and imported into a WebAssembly module. An embedder can establish security policies suitable for a respective environment by controlling or limiting which functional capa- bilities it makes available for import. Such considerations are an embedder’s responsibility and the subject of API definitions for a specific environment.</p>\n</blockquote>\n<p>WebAssembly<sup>[2]</sup>是一种被用于栈式虚拟机的编码格式。最初是被设计用于Web端，因此安全性在设计之初就是重要考量。wasm模块的指令集只包含了最基础的计算能力，不会影响外部执行环境，内部需要的IO能力、系统调用等都需要由虚拟机提供。当被用于FaaS时，FaaS模块内部代码通过调用import段的特定函数实现对外部环境的访问，这些函数由虚拟机进行实现，由此我们可以轻易地对模块的环境变量、模块的系统调用以及系统调用参数进行控制，提高安全性。同时，每个虚拟机都是隔离的（包括执行栈、内存、系统调用等），即使一个虚拟机发生了crush，也不会影响到其他模块的执行。</p>\n<p>WebAssembly的性能表现依赖于具体的runtime实现，wasm的指令集是对真实世界计算机指令集的抽象<sup>[3]</sup>，不仅可以对wasm进行解释执行，还可以进行JIT/AOT，让代码以native的方式执行。</p>\n<h2>冷启动速度</h2>\n<p>FaaS缩容可以到0，因此冷启动问题<sup>[4]</sup>是FaaS相对于PaaS需要多处理的一个比较大的问题。不同于OpenFaaS等方案，运行一个wasm模块不需要单独启动一个容器，wasm运行时本身就是一个沙箱，因此可以比较好地应对冷启动问题，其主要的时间开销为从代码存储中拉取代码。</p>\n<h1>Runtime Library</h1>\n<p>wasm-lambda提供了wasm-lambda-bridge的crate供FaaS模块调用，定义了一系列hostcall。每个wasm模块通过hostcall获取到事件，与宿主环境(host)进行通信。但是还不够开发者友好，因此wasm-lambda-bridge对hostcall进行了进一步封装，对事件进行解析，并派发给其他Handler，实现更优雅的编程。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-rust line-numbers\"><code class=\"language-rust\"><span class=\"token comment\">// 直接调用raw hostcall</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">std<span class=\"token punctuation\">::</span>collections<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">wasm_lambda_bridge<span class=\"token punctuation\">::</span>core<span class=\"token punctuation\">::</span></span><span class=\"token punctuation\">{</span><span class=\"token namespace\">value<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Response</span><span class=\"token punctuation\">,</span><span class=\"token namespace\">hostcall<span class=\"token punctuation\">::</span>raw<span class=\"token punctuation\">::</span></span>event_reply<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">let</span> reply <span class=\"token operator\">=</span> <span class=\"token class-name\">Response</span> <span class=\"token punctuation\">{</span>\n\t\t\t\tvalue<span class=\"token punctuation\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n\t\t\t\theaders<span class=\"token punctuation\">:</span> <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t\tbody<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Some</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> <span class=\"token namespace\">bson<span class=\"token punctuation\">::</span></span><span class=\"token function\">to_vec</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">unsafe</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">event_reply</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">as_ptr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">u64</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 使用Runtime Library</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">wasm_lambda_bridge<span class=\"token punctuation\">::</span></span><span class=\"token punctuation\">{</span>make_response<span class=\"token punctuation\">,</span>codegen<span class=\"token punctuation\">,</span><span class=\"token namespace\">value<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Response</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token attribute attr-name\">#[codegen::main]</span> \n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">Result</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Response</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Ok</span><span class=\"token punctuation\">(</span><span class=\"token macro property\">make_response!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2>基于洋葱路由的事件处理中间件</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/de890b2d712d4b64709eec2b9055fd3a/d0cc0/1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 87.16216216216216%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsTAAALEwEAmpwYAAACnUlEQVQ4y3VTWW8SURSeH2BMfDcm/gfj9j9q1CeNPKoYtG14ExuTijZpLISmtJKaJp0pmYEHkhKBECAtS0tKF2QZKJQdylBaKDQs4sdcApjY83AzdznnW84Z6s9YVCqVVCpls9kYhlGpVIuLi7FYrNfr4ar3v6DGN8fHxyzL0jS9vb1tMpmkUqlSqex2u71rgrq8vKzVaq1Wq9Pp1Ov18/NznJIEn88nl8uLxSI5GQaIkJU6OjoyGo0OhwNsrVZrPp/HUxTCyvO8TCbLZrPXMafIBdSCAslpd9pAi8fjKysroF0ul3FYKpUODg5wnslksmLgPUUYGjju8PAQH7u7uyDySwy8tlgsxDNU39raAkG32+33+z0eD4oOko2cgVmHU7Rerw+HwvFY/PT0FDjIhxwilchJp1JDFYNkPso/mZhA1VwuByihLDSbzWq1iq3dbod4InKDZuh1ui+t3e4bRpIDgcDzp882GAZizs7OqmJAFZKR6XQ6YcH05NSje/crgtBH7o4ho6ufPiru3r7zZXZWEAQ0rNFoXF1dQWoikVj4vvD4wcNbN26aNzf7bRN9HSVzHLezs4NeyaTvQAyd/6b8OvX+w/Tk5NvXb169ePl5ZsbAskT2sG0jZJfLBUDAAjAUCs3Pz/9YXv65uoppM5vN4D/s/6jPpAxMWltbSyYS4XCYSIULwWAQrXJ7PBqNBrZHo9FkMhkVAxM5GhKsaBJAIpEIvMGjvb09bE9OTkAKPwlmIxqJwDxULxQKGOQRMtAANTc35/V6cY2nSN7f34cXGDLMD3oOdiExMAKE/yAZlbRarUQiUSgUOp0ObFmOVavV+CaZ4MKLgRFE0YuLi39owy1wBvmlpSVMKL7xKJ3GRKUSYvwWA1VgKtH8F6AfYwOQR53nAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"onion model\"\n        title=\"onion model\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/de890b2d712d4b64709eec2b9055fd3a/fcda8/1.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/de890b2d712d4b64709eec2b9055fd3a/12f09/1.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/de890b2d712d4b64709eec2b9055fd3a/e4a3f/1.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/de890b2d712d4b64709eec2b9055fd3a/fcda8/1.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/de890b2d712d4b64709eec2b9055fd3a/d0cc0/1.png 732w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-rust line-numbers\"><code class=\"language-rust\"><span class=\"token attribute attr-name\">#[middleware]</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">not_found</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">:</span> <span class=\"token class-name\">MiddlewareContext</span><span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">:</span> <span class=\"token class-name\">MiddlewareNext</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">MiddlewareContext</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> context <span class=\"token operator\">=</span> next<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> context<span class=\"token number\">.1</span><span class=\"token punctuation\">.</span><span class=\"token function\">is_none</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        context<span class=\"token number\">.1</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">Some</span><span class=\"token punctuation\">(</span><span class=\"token macro property\">make_response!</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"404 Not Found\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    context\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>熟悉Koa.js的人对这个概念一定不陌生，这让我们的中间件有了两次被触发的机会，并且都写在了一个函数里。一些常见的中间件能力，如请求日志、错误捕获、处理未匹配路由都可以被实现。</p>\n<h2>使用Rust宏减少重复编码</h2>\n<p>我喜欢Rust的一个重要原因就是其强大的宏能力，它让我能够做到DRY(Don't Repeat Yourself)，或者是在Rust代码里再实现一套自己的DSL(Domain Specific Language)。Rust宏主要包括了声明式宏和过程宏。声明式宏编写匹配规则返回代码，更容易编写，能力有限；过程宏编写函数处理TokenStrema返回TokenStream，较为复杂，能力强大。Rust宏的使用这里不做赘述。</p>\n<h3><code>main</code>生成入口函数</h3>\n<p>使用过程宏重新wrap了传入的main函数，一方面使得代码更为简洁，另一方面避免了开发时遗忘返回响应。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/4f02d5554c8f15959ab1ac6b9c344be9/6871f/2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.13513513513513%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABKUlEQVQoz21R2W7DMAzL/3/mhnVp6ya+D/ngaGfr0wIQMiKSouytRA/vPayzsN7CEDE6SMmoraJWQQgeOUXYU+G+f2LfP/C8f8EfB8LCiXiyElsyJ47bDcmYhag1sjVoNGnOofeBVAQlBRT2DkU+TQ7qDPnCQTVHtMJKbKLZUM8rhVAohRCMMdC9QWfCAaBLRmP62juspbh1/PdtkzTJwZ9orfAX5WNc3eSBJuvYa0F1epmnGOC0QmK6UirTc9gcPDq2ReJdCZMtEsmLSDT2yLwM5c9wLGGevJhpyK1yWbgM7YlREhVtxrjAVIN1OMNh8jYUqyEUNa79u8O7vlfOvHi73+BfD4TXE1EpRL5a51WADzGnTtncIj2+EdQO0a+FShS+bDUHRrALPw1GIRzDyVepAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"main\"\n        title=\"main\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/4f02d5554c8f15959ab1ac6b9c344be9/fcda8/2.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/4f02d5554c8f15959ab1ac6b9c344be9/12f09/2.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/4f02d5554c8f15959ab1ac6b9c344be9/e4a3f/2.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/4f02d5554c8f15959ab1ac6b9c344be9/fcda8/2.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/4f02d5554c8f15959ab1ac6b9c344be9/efc66/2.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/4f02d5554c8f15959ab1ac6b9c344be9/c83ae/2.png 1180w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/4f02d5554c8f15959ab1ac6b9c344be9/6871f/2.png 2688w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3><code>#[get]</code>等生成route生成函数</h3>\n<p>使用<code>装饰器/注解</code>编写Restful服务的路由是我认为比较优雅的方式，这在<code>flask</code>和<code>Sprint Boot</code>中很常见，一方面使得代码更为直观，另一方面也使得后续使用代码生成文档更为容易。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/4e180ab752f90f7ec5b45339175cc69a/748b0/5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 81.08108108108108%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAACm0lEQVQ4y4VU2ZLjKBD0/3/ibnSE3dbJISEQh5BQTgp393hnH0bhCiwEReVR3JTyaNsHFq0gdUBKG/zqsG4b5piwMPy2Y8sZlnOW7yZGLCki5R2v58R5MlBw27YTWk3o+yfGfoASHUT/CaUFHgPnpMbcjXBSQrY9FqnQiQA1TliWFZIF+RCYtDDvidtRrszAUa7TdpSSOX98LdjrIuz5d5QDdcNZ+DuQt2vPa/1V5c3aAD0rZGeQlESeJ2zzjDhNiKwm+BU7Dy1MsDOu8eCBO5McjPI1dzKuk252yejbAWPToL8/MLYNZH/n2OPjnwFNS26lgFwsBhcIj9x6D7F6SOfQWQftPHL+SkiwFcmyJDRdB9UKTM8Ghkm6UeF+7/Hk+5bIEysrx06oL7hnhf9K9BKGohzHC385IvT4ASPu0D2rbD8xigZdryiaQfQW3mkss4ZlRbOZMJOWlY74TlYTnqww+JMfEx73J9UeMZLTVo+QHPXsYVj9QsiZ1vnbc7sUOvYTMSSMtImYLz9SEG7O+fLkyvBIYUWKjC1S2SsCqUp1rO/Xf66/lQr5ckTE0P1bfdiJJ4VQEAMhNx+QhH7NWyOwBouwThV+9AvcojgarKTEWkvIJDptmVwsmMQntHxgdqqKEIPDxs7IrDLTvNQDx1EQ4849L9v8DzK/I8QMYydyaQjPsIIZiaevlqczWdKaPnX8v3NNhFIOE7mNbL93QaooMW6I5AA77cA+JlEo+9/J/37ON9tUH2oVaI0GljwZWkXQd2Mnq6rGWUw+1QvDEPLkGRRIcbQh/pj5fO+USxNjVgzjJ63TQojrguhhNLuHc0rNcG0HV28jdokJeHQTuoGtSlW/E/5UuO8F51vJ9VLAf2HgD1jva/+E/Ats6dc3743V7wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"routes\"\n        title=\"routes\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/4e180ab752f90f7ec5b45339175cc69a/fcda8/5.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/4e180ab752f90f7ec5b45339175cc69a/12f09/5.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/4e180ab752f90f7ec5b45339175cc69a/e4a3f/5.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/4e180ab752f90f7ec5b45339175cc69a/fcda8/5.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/4e180ab752f90f7ec5b45339175cc69a/748b0/5.png 868w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>同时对传入的函数参数进行解析，从请求事件中提取出对应的<code>Query</code>、<code>Param</code>、<code>TriggerEvent</code>、<code>Json</code>等再传入。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/0f1d281a02003a20b36a7a4231512ef2/9aaee/3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.08108108108108%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABGElEQVQY01WQ226EMAxE+f+PrNR2V8ASEgi5ORdmJ6laqaB5SGQfH2cK+wa7zHB6h9sVvFJwaocYDckZuVTEJPDeI7kT2/yNdf7C/PjAsS7s2ZEOAznP0TNFrWEfn3DLk+AFfttwEZg44G4VN4BaOzShOQu7G1hrEaNnAlKWUTc+DpwKDaw5oJ4PvF6KVjJSRhFxd/tJB18nWk4wxmJdNYwLuEKE5waZQ9tlMLXW4C6LZZtxUN3TQpJHljjAtZYBzqVADlrXPO68D8iE18KzCBqB9SSwv1OgqidduIKkblhw0+o3HdhXjlqhdUC/519bGWm11/NsDwIlw9sTjokhwIc0VsBouf+ASQg0fBLWlegA2v0LB8FqvAHNN9HVJs4uygAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"get\"\n        title=\"get\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/0f1d281a02003a20b36a7a4231512ef2/fcda8/3.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/0f1d281a02003a20b36a7a4231512ef2/12f09/3.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/0f1d281a02003a20b36a7a4231512ef2/e4a3f/3.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/0f1d281a02003a20b36a7a4231512ef2/fcda8/3.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/0f1d281a02003a20b36a7a4231512ef2/efc66/3.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/0f1d281a02003a20b36a7a4231512ef2/c83ae/3.png 1180w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/0f1d281a02003a20b36a7a4231512ef2/9aaee/3.png 2608w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3><code>static_resource!()</code>引入资源</h3>\n<p>使用<code>static_resource!()</code>可以在编译期间对目录进行扫描，读取目录文件并生成包含<code>include_bytes!</code>的代码，实现静态资源也能被打包在wasm模块中。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/36a9ec1ae3be177289d419a695685974/b9bfc/4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.02702702702703%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABsElEQVQoz11Sh2rjQBD1///fQSCEI6S4aK3tvby8XcW5I4bRGmnntZlTChG7VNDWo7aK3vuqlCIrwAQDEw1s0Mglo9SCUhIr/1TKGZe/L3h7+oNTI8i23Raoj44gnoAVtdZ1+bbtuLC0tfC5IBUC8luuHaU1klQMAPfrGa/PTzjlnGB4OVCRj2GdnSTgtUmmrgL7+zvU+QNa3JDUjijviDyzVmjOYgQHw//K2AmYYY0m28HU1/P4tWmN3y43XhYCxiiSGwTvEEgeU1pOwBgsXVrncHpYc5+vKOKKSvZKJZ0NvdGikmyOaHRSc2RvJkihelZvPPtkhhHfgIWZtDGQyB7UHYkKkpYEoPXKwGnlTIX7JmhJc0hhqZvRBLorBBzM8j/AvGT3Zfe3ZTYQPFqHxpyqN2isET0GCcFIVmVug9gOwBgTLJsc2T1feK5RpupjKA3qztwYhZMCfmZN4AfQmDWB6SQED2u/M5QM/PLxCc0pHbv2b8pSOugZxZw+342xnj8+HueMzk2Fs8laBcmm4AzyCj5xF9sK37pAsCOWOneQhHkOhbuKCT76gi3McwJ+AWojCROD8h0wAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"static_resource\"\n        title=\"static_resource\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/36a9ec1ae3be177289d419a695685974/fcda8/4.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/36a9ec1ae3be177289d419a695685974/12f09/4.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/36a9ec1ae3be177289d419a695685974/e4a3f/4.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/36a9ec1ae3be177289d419a695685974/fcda8/4.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/36a9ec1ae3be177289d419a695685974/efc66/4.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/36a9ec1ae3be177289d419a695685974/c83ae/4.png 1180w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/36a9ec1ae3be177289d419a695685974/b9bfc/4.png 3112w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h1>wasm-lambda Demo</h1>\n<ol>\n<li>克隆并安装</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\"><span class=\"token function\">git</span> clone https://github.com/ChenKS12138/wasm-lambda.git\n<span class=\"token builtin class-name\">cd</span> wasm-lambda\ncargo <span class=\"token function\">install</span> --path <span class=\"token builtin class-name\">.</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<ol start=\"2\">\n<li>编译 Example <code>hello-world</code></li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\"><span class=\"token builtin class-name\">cd</span> examples/hello-world\ncargo build</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<ol start=\"3\">\n<li>启动</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\"><span class=\"token comment\"># Start Dev Server</span>\nwasm-lambda dev --bind <span class=\"token number\">0.0</span>.0.0:3000 -m hello-world:./target/wasm32-wasi/debug/hello-world.wasm\n\n<span class=\"token comment\"># Rebuild</span>\n<span class=\"token comment\"># cargo build</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ol start=\"4\">\n<li>触发请求事件</li>\n</ol>\n<p>打开浏览器，访问 <code>http://127.0.0.1:3000/hello-world/latest/</code></p>\n<p>或</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shell line-numbers\"><code class=\"language-shell\"><span class=\"token function\">curl</span> -iL http://127.0.0.1:3000/hello-world/latest/\n<span class=\"token function\">curl</span> -i http://127.0.0.1:3000/hello-world/latest/api/capitalize/hello-world\n<span class=\"token function\">curl</span> -i http://127.0.0.1:3000/hello-world/latest/api/echo-query?name<span class=\"token operator\">=</span>cattchen<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">age</span><span class=\"token operator\">=</span><span class=\"token number\">21</span>\n<span class=\"token function\">curl</span> -i -X POST -d <span class=\"token string\">'{\"name\":\"cattchen\",\"age\":21}'</span> http://127.0.0.1:3000/hello-world/latest/api/echo-person</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/075709d228a8095ec6428b24d0a6a12e/84ee5/6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.16216216216216%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABp0lEQVQoz32SDY+aQBCG+f9/7dpcraaeXmqId+UaI7DsAgvLx9v3RbiqsZ1kHNydnXnmI9q/7PDl6Qmvux1e9nv8OMQ4HN+wP77j6+o7vj0/Y7vdYr1eY7VaYbPZII7pczggSRIMwwDJOI6TjdLKIXUWee2R+QYNz+XS0qEfRoQQ0HXdp/Z9j3tZgl0CFgbnPIOxDklukJQ1bOjwP1GAa70hLJ1DUVjYsoQh5VvpEdsKjkHbfkBNqkCLBwGuyT4JTZ6TkJSuxIl0P43D+0xp2zAFDtd9uqO7J41yBTyfocBpmuLE0mNX40j9Rdq661EwsJ97d0M5603J+tCkFjvMD2RF1lFV8n2vLvYv8XIWtW0LT62adprgwJ5V3sPVNQLPO05ZPpb9rahN00yTl62k2gz6L9OPegbQ45MpYIxBLWdeqlQR67HEhR7dTNIwgUQ+kx/9lWAKqB9NOs8yZOxj7i8Xyvr74wMnboBnySKfqhE9NyIM480aLYmjR6PXydRPtYAP9d9ai4xJlbgggLZgeTvdFQUcaaNHi/ooyb8WXNKyXLWhYSV/AIxlqFzVYD2lAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"visit\"\n        title=\"visit\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/075709d228a8095ec6428b24d0a6a12e/fcda8/6.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/075709d228a8095ec6428b24d0a6a12e/12f09/6.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/075709d228a8095ec6428b24d0a6a12e/e4a3f/6.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/075709d228a8095ec6428b24d0a6a12e/fcda8/6.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/075709d228a8095ec6428b24d0a6a12e/efc66/6.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/075709d228a8095ec6428b24d0a6a12e/84ee5/6.png 1076w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h1>总结</h1>\n<p>这个项目实现还比较原始，很多东西都还没有实现或者是考虑到，后面还需要花比较多的时间来完善。</p>\n<h1>参考资料</h1>\n<ul>\n<li>[1] <a href=\"https://aws.amazon.com/cn/blogs/china/iaas-faas-serverless/\">https://aws.amazon.com/cn/blogs/china/iaas-faas-serverless/</a></li>\n<li>[2] <a href=\"https://webassembly.org/\">https://webassembly.org/</a></li>\n<li>[3] <a href=\"https://blog.logrocket.com/webassembly-runtimes-compared/\">https://blog.logrocket.com/webassembly-runtimes-compared/</a></li>\n<li>[4] <a href=\"https://www.infoq.cn/article/mi0lpquvxi7bpcq7ou9u\">https://www.infoq.cn/article/mi0lpquvxi7bpcq7ou9u</a></li>\n</ul>","id":"7f451f74-5ac7-5e57-a05b-609901d7bac1","headings":[{"value":"动机","depth":1},{"value":"基于事件的FaaS","depth":1},{"value":"为什么是WebAssembly","depth":1},{"value":"WebAssembly的安全性和性能","depth":2},{"value":"冷启动速度","depth":2},{"value":"Runtime Library","depth":1},{"value":"基于洋葱路由的事件处理中间件","depth":2},{"value":"使用Rust宏减少重复编码","depth":2},{"value":"main生成入口函数","depth":3},{"value":"#[get]等生成route生成函数","depth":3},{"value":"static_resource!()引入资源","depth":3},{"value":"wasm-lambda Demo","depth":1},{"value":"总结","depth":1},{"value":"参考资料","depth":1}],"date":"Friday, June 3, 2022 11:54 PM","tags":["WebAssembly","随笔"],"title":"使用WebAssembly构建FaaS服务"}},"staticQueryHashes":["63159454"]}