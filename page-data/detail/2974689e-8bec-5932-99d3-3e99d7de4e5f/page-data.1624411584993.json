{"componentChunkName":"component---src-pages-detail-tsx","path":"/detail/2974689e-8bec-5932-99d3-3e99d7de4e5f","result":{"pageContext":{"html":"<h1>前言</h1>\n<p>从大一开始我每年都打 NCTF，<del>除了恰烂钱，</del>感觉每次都可以学到点不一样的东西。今年的 web 题有点不一样，感觉挺有意思的，加深了我对 JavaScript 相关的一些安全问题的理解。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/40a97/profile.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.24324324324324%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAAA90lEQVQoz51PTWvCQBTMn6iK3hQ8FPqvNNQaCUipOfnHPPZQcvHQ+IHgpSBVLETjfmXJ7kufWY1FtILDHIbZee/NWk9e99HrVtxWod14eGmUHLvYsUsdu+g00Tlj2X2uvzq1N7fac+t9z5ry3YRFY07eF1+D+cxfL/3198dqMdz8TAQZ891fjlj0SaOAbAO6DcjGSo+QlKlY7pWGVOkUIL0FCyMmxYVIlNIAB2YglCqE1jlN3vB0OY5jjBkNGVAkSYIr4EqL07AQglJqDkopcRc6qFGgj455ujyMCUJIPoxgjBkdhiHnHLK/XB4+65Y3hyP+q30HfgG6R+g1cIKp9gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"profile\"\n        title=\"profile\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/fcda8/profile.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/12f09/profile.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/e4a3f/profile.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/fcda8/profile.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/efc66/profile.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/c83ae/profile.png 1180w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b7aeefecca63105e3ab88a5801086b47/40a97/profile.png 1911w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>JS-world</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/476e1/problem1-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAACXklEQVQoz2WQ60/aUByG+6+Y2AultrS05WgrVLGCoEu2AV6JAmbzNkWcbloXibehcUO3mCVehuJEjaIgteXm/7bDtm9785yT98uTvPkhyeT65nZqa3snPr+48D7xOZVMLCTmE4vaanJZW5uZmWVZnmY4C0lxnMDZHTYb53QAqU2S5VakVn9O7+0cHqRrz8+VauX66goWs1LOnv+oFvO39wWX4hYEkeN4lrEBIDEsg+GWNsB2u+3I3UMx5veEXK0PJf36+mbipSe9//02fxWL9M5+WM5kLz0ej8MB7HbeZhd4XqApGscwOEcQJaRkmgdaMrW8qperuVzu08elzFnWLJdTW+sbX/ezF5cdHW5RbOWh6ZBFWQEO0NJCAYFXO52IYZhmtVap158Mo6TrZqWqPxm6YTwZZr1W+3WZYxgOx0nezgPgUlyKBESatKoKFxloR45Ozo5OMpDj0/Pj00Y//nkOgeUkc7GX/kbTbENuc3Z6XapX8fpcqgokGchSOzIUnR6JvRuGf3RyJDoFGY40Sjg2PfY23h9+Q1EMQVgFEShdbp/X/aLHrXa54PKmpiakrz8WCE/OrezGV/fmtN3FtS9LGwcr24dxbTc4OtUXHLVSjMVCwWAoBk+Fo80EjhMEgaIoAroCQA3RrzQquEkH14WhTXZgix1McQHN6RuUuwOklSbJFpywoM3NUGg8FP0n+4Ixf2i8JxjxBSL+ULQnEPUHo7DARa/DE72hMauVgTIB5f+C5AuPtw+Pd4VSvqjfF/XHkl78Q6FYuimYR5kLhmHhbIuFxDAMRRv8DZR/A+vb9xFdxqPoAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"problem1-1.png\"\n        title=\"problem1-1.png\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/fcda8/problem1-1.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/12f09/problem1-1.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/e4a3f/problem1-1.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/fcda8/problem1-1.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/efc66/problem1-1.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/c83ae/problem1-1.png 1180w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/710201356273b643ef19d30d233b05b5/476e1/problem1-1.png 1841w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>这道题涉及到的是 ejs 模板的注入问题，同时传入的后端的信息会先经过前端过滤一次。可以通过 DevTool 的断点调试功能，找到相关的过滤关键字的代码如下，删除后即可绕过。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\">_0x23132f <span class=\"token operator\">=</span> _0x23132f<span class=\"token punctuation\">[</span><span class=\"token function\">_0x1bef85</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"0x5\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>\n  <span class=\"token regex\">/[\\/\\*\\'\\\"\\`\\&lt;\\\\\\>\\-\\(\\)\\[\\]\\=\\%\\.]/g</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"\"</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里的输入存在模板注入问题，通过 payload <code>> &#x3C;%= global.process.mainModule.constructor._load(\"fs\"). readdirSync(\"/\") %> &#x3C;</code> 和<code>> &#x3C;%= global.process.mainModule.constructor._load(\"fs\"). readFileSync(\"/flag.txt\") %> &#x3C;</code> 即可读取目录并获得 flag</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/864a6/problem1-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAAB60lEQVQoz61SXYvTQBSd37PburTpklRWUHzwbfXRB/+Czz76U3yTIq6LSdrYXVQQX3xbaBealCSFgu2GJG0+JvORL28SdtkqioKHYbjMnXPvmXMHvXwsPn0oHQiiKErd3mH7zsHefqvTFUTprij1Jakv9A73W+1Wq/3kqCMIvU6n27/34MXx/eePjtDlZ+3bR00bqWNtOB4pqiIPldOh8v6DpqqqrKqKpsryuzcjRf4yVgaDwenJ27OxZn49/zR4hRLOE0bzLCv/DmlZBrwoylI3LRTHse/7ruc5V87acVbrteu62+02CEJYdRDUcQAhw+HJBX72OtS/x/PLCxSGoeM4SZKQBEeeQ3DEOIernudtNhvIZrtgPItpWha5ZcwQtLUsixDCGeOUMko55yCnaheGFE5q3ATVNUZBvzGfIyhv2zbIg+bVJchxHkURMPktsFughAB5Npsh6LBcLqFwXgOEwQ5kKAr98TWA36QAaQqulXPonGCc4BjIhIF2ktW2F7vIsxwsSRhhKa8Wp2XOqzfjMHCdK9/fuDUah6D8TxMqqunURcGrOruwbQSSdF2fTqewTyYTwzBM01ytVjeEX9GcLxYL1JgBgivl17L/jB1y+Y/4T2RQC9Y3Q/rdI5u/VTmVpdCsGZVlWz8AANcosCSM8ZUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"problem1-1.png\"\n        title=\"problem1-1.png\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/fcda8/problem1-2.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/12f09/problem1-2.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/e4a3f/problem1-2.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/fcda8/problem1-2.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/efc66/problem1-2.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/c83ae/problem1-2.png 1180w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/77e21de23941247167442bb0c0ead368/864a6/problem1-2.png 2276w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>PackageManager_v1.0</h2>\n<p>这道题可以获取到源码，通过审计代码发现了一个问题，这里的鉴权使用的是 JWT token，签名时使用的是 RS256，但是验证时使用的是 RS256 和 HS256，同时将公钥加到了 payload 中。RS256 是非对称加密算法，HS256 是对称加密算法。因此我们可以解析 token 后获取到公钥，并使用公钥和 HS256 生成自己的 token，绕过鉴权。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/f514f7b1b35eab858bd9b180887bccee/35751/problem2-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.027027027027025%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAAwElEQVQY02VQi27EIAzrt/SAkOMZArSndtP+/6tmTps0aUZKQhTHhs17zyklHUF7LNk7a4x57PuKD+Qd0SxYY6111v3BBjIx55g/r4/rvo7zVaac10ub9j7u657zKKWGEGLErP9HJhc891Sk1kNaxRnapLWmc0wwsaWW3IThcqnbH/0NDUdUOJxF5mhfKtLkmYOq1iqgQREuxjhSirOHkp+jR/ggoo3fcOTwHDJrH7rkCSLrO5hxY2S/iuXyN2LyG4sHMyNoPEqKAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"problem2-1\"\n        title=\"problem2-1\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/f514f7b1b35eab858bd9b180887bccee/fcda8/problem2-1.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/f514f7b1b35eab858bd9b180887bccee/12f09/problem2-1.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/f514f7b1b35eab858bd9b180887bccee/e4a3f/problem2-1.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/f514f7b1b35eab858bd9b180887bccee/fcda8/problem2-1.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/f514f7b1b35eab858bd9b180887bccee/35751/problem2-1.png 873w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>代码中存在着对象 clone 的代码，有原型链污染的漏洞</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/3cd8a1c57a0e9d25dfa59af03b2d52be/84ee5/problem2-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.75675675675676%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABLklEQVQoz42RaY6DMAyFOUoHCmRxFidkgbSk0iy9/43GgKr5N/RTEj0perKf3Wi41psC4CNjnPPtcgaSccb6M5qu7TC6UB4plVjnUqafrxiD0UoOZzQfl4swFue7D9lPMUwmRKuAWcOHYTwxt20LAMGis1ZbPSE4lIyx4Q2aruuU0ui8RZ2iDt5MWqESSohxPK3cdTQi9P5R61rWWj9TMFK8XZnMgou6rvd5yXNYa8EtBAoB/xffMkuQHrRHVN7SwKhyCCHFnPOSU/bOp/0lTYe0tVbubGYFCkOIOZTs0EotuRaiH4a+vxLHSg9xffHXNs02p/n5/bytJRa3LH6912UppdyofwCltTbGkHDojLGkKemrbSmBC0nB6V9RiJELQqrNZrbfHRJkUzvHLn8BBwZwhUD4Wf4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"problem2-2\"\n        title=\"problem2-2\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/3cd8a1c57a0e9d25dfa59af03b2d52be/fcda8/problem2-2.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/3cd8a1c57a0e9d25dfa59af03b2d52be/12f09/problem2-2.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/3cd8a1c57a0e9d25dfa59af03b2d52be/e4a3f/problem2-2.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/3cd8a1c57a0e9d25dfa59af03b2d52be/fcda8/problem2-2.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/3cd8a1c57a0e9d25dfa59af03b2d52be/efc66/problem2-2.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/3cd8a1c57a0e9d25dfa59af03b2d52be/84ee5/problem2-2.png 1076w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/7881e65a8432c0f093837ebc85d18910/1fbe8/problem2-3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.21621621621621%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAABaklEQVQoz52RC27jMAxEc5QmtkWJpKifLVtOm91kUWzvf6LSSYqgRYH9jA3JBvQ0HHIX/eG5JUSKAr8vkiKJOOcQwJo/aXc4dK3SdGzx9KP+Oi9r48BexDrb90M/mMGYfnio334+4Kf9kzHWgOMcpqUecxrJi9KOUsAYkKxNjqOEQD54lxMSueHD+aBVAgALB+GIOLEoTIDirXgNsMHivSAz2hgc4j3Rruu6Oxz98no+X37Oz0tYWq6pjMUY0Nq7/qrhvj3K3u/3NxiMiRJLztNxmU9zO02nl5daxhpyHovUGEua6+y9fzTsAVvQ7gRHNY1+jDyGaa5Z3XNJKRsHVmfg0Fr7CSYigJu3Eea317fW1vPl0pY1WIyOci6I+KnRX50B9IQWwOz1QU/aI+/IWxQJeuabOd9gNU8xrWlci4ZL5JCJSYei6/WDr1d+eTdYDTWOygI4uwn+TvfMWsNwDTSYf9AG31r1H3oHvlWA14/CcXMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"problem2-3\"\n        title=\"problem2-3\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/7881e65a8432c0f093837ebc85d18910/fcda8/problem2-3.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/7881e65a8432c0f093837ebc85d18910/12f09/problem2-3.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/7881e65a8432c0f093837ebc85d18910/e4a3f/problem2-3.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/7881e65a8432c0f093837ebc85d18910/fcda8/problem2-3.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/7881e65a8432c0f093837ebc85d18910/1fbe8/problem2-3.png 757w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>这里当第 9 行的 key 为<code>__proto__</code>时就会造成原型链污染，修改变量<code>a</code>的原型(即 Object.prototype)上的属性。</p>\n<p>同时，这里使用的模板引擎是 nunjucks，其源代码中存在着一些<code>new Function</code>和字符串拼接，有被注入的可能性。</p>\n<p>构造 payload 如下，即可成功获取 flag</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-json line-numbers\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"author\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"111\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"__proto__\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"description\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"global.process.mainModule.require('fs').readFileSync('/w0w_Congrats_Th1s_1s_y0ur_flaaag')\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/3d68f/problem2-5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAAB60lEQVQoz5VS227TQBD1v7aouTQhNBJVI56R4AeooGruaSpAKrzxATyWd555shPHXu91dmfXjO2UgIQEPRrN7oz2aI7POFqOjl9fDNr9s/7TZ93TfqvdOTo+6XR7w+fnrXa33emd9gZHT07a3e7L0Vl/MGx1esPz0adXL95dDKNvn2+/fFitFtPb+WS9mM4m4/n0ejGb3CxniwXFnPJ4Ml7Np3fL68vLN1dXb9frm/u75df3ywhDqa0tgy//D/RO+9KGUoCNtJJJHKdpmmw2SbKJ42STpjljeZ4XrELO9qALqGJ1L1of+fcfO55tI+ec1lpIqZTiQnCW8TSRglC1tBTobAhleABgELZEraDII6qNBUsvpaLTAlgD1iFYClfDOzwEog/1NyopK7IyhshaSspgQAJK44S2CpyxyLVrSspVaOcQiUzaokZM+XgAQOR9RfahOn11VJLCn6BmrZeCLlVVegRjIqNEmsSMc8aLgpLgYDQ6+H0IIoIjE0iwbTIKJskwMoQVXNNakmy7VSxTm60ushzRVSOwnuT3Exs00pTWEZnHjdW7VMe7PA+cl0phQSJqPOyYZVlGuWBVH2vDrLVE9hIsaK2yDEww8A+ffrl7IFtFS4ZHub0nC/o9lAp7k/8+7WA7YvOIVvUTLQU5nYDf9NYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"problem2-5\"\n        title=\"problem2-5\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/fcda8/problem2-5.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/12f09/problem2-5.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/e4a3f/problem2-5.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/fcda8/problem2-5.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/efc66/problem2-5.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/c83ae/problem2-5.png 1180w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/08460c318131ffe54333d7f2d37377a4/3d68f/problem2-5.png 2282w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>-------------------------时间分割线---------------------------</p>\n<p>2020 年 11 月 25 日</p>\n<p><img src=\"https://user-images.githubusercontent.com/42082890/100094205-9cc29480-2e93-11eb-8365-6b2d191de84e.png\" alt=\"payload\"></p>\n<p>后面排查发现这个是<code>nunjucks</code>的一个漏洞，目前已经发起 Pull Request 修复了<a href=\"https://github.com/mozilla/nunjucks/pull/1330/\">nunjucks/pull/1330/</a>。感谢出题人<a href=\"https://bycsec.top\">@baiyecha404</a>的题发现了这个漏洞。</p>\n<p>经过排查，问题出在<a href=\"https://github.com/mozilla/nunjucks/blob/f51afa3382eab27ccb216c0f302832e5a4135ac5/nunjucks/src/runtime.js\">nunjucks/src/runtime.js</a>文件中<code>Frame.prototype.variables</code>变量中，错误地使用普通的 object 作为 Map 使用，导致读取变量时可能会从 Object.prototype 中读取变量。当 npm 包外发生 Object.prototype 被污染时，会导致读取 variables 上的属性时得到意料之外的值，同时模板引擎存在着大量字符串拼接，这导致 payload 被执行。</p>\n<p>使用<code>Object.create(null)</code>替代<code>{}</code>作为 Map 会更为安全，同时也可以对原型使用<code>Object.freeze</code>避免原型被意外修改。</p>","id":"2974689e-8bec-5932-99d3-3e99d7de4e5f","headings":[{"value":"前言","depth":1},{"value":"JS-world","depth":2},{"value":"PackageManager_v1.0","depth":2}],"date":"Monday, November 23, 2020 6:36 PM","tags":["随笔","安全"],"title":"NCTF2020复盘"}},"staticQueryHashes":["63159454"]}