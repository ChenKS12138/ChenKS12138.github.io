{"componentChunkName":"component---src-pages-detail-tsx","path":"/detail/7aac5e6f-975f-54c3-9211-ee161df8b9d3","result":{"pageContext":{"html":"<h2>什么是跨域</h2>\n<p>简单地来说就是域 A 下网页试图加载域 B 下的资源。一般来说，浏览器会阻止这类行为。这是浏览器的同源策略导致的。所谓同源，就是要求两个 URL 的协议，域名，端口全部相同。</p>\n<h2>跨域会有什么影响</h2>\n<ul>\n<li>AJAX 请求发不出去</li>\n<li>DOM、JS 对象无法获取</li>\n<li>Cookie、LocalStorage 也无法获取</li>\n</ul>\n<h2>为什么要有同源策略</h2>\n<p>让我们设想一下现在有个电商网站<code>www.oaboat.com</code>，它有个支付接口<code>www.oaboat.com/pay?target=749923710&#x26;amout=100</code> ，这样就可以给用户 id 为<code>749923710</code>的用户转账 100 元。如果有个博客网站 A，它被植入了一张图片<code>&#x3C;img src =\"http://www.oaboat.com/pay?target=749923710&#x26;amout=100\" /></code> 这样访问博客网站 A 的用户在不经意间，财物就被盗取了</p>\n<h2>XSS 和 CSRF</h2>\n<h3>XSS</h3>\n<p>XSS 全称是 <code>Cross Site Scripting</code> ，中文名称是跨站脚本攻击，至于为什么不叫 CSS 是为了避免和<code>Cascading Style Sheets</code> 重名。还是刚才那个例子，黑客是怎么将植入图片的呢？</p>\n<pre><code class=\"language-javascript\">const image = document.createElement(\"img\");\nimg.src = \"http://www.oaboat.com/pay?target=749923710&#x26;amout=100\";\nimg.style = display = \"none\";\ndocument.body.appendChild(img);\n</code></pre>\n<p>只要他将这段代码在评论区评论出来。如果这个博客网站没有 XSS 防范，那么每个浏览的用户都会收到攻击，都会执行上面的那段代码。</p>\n<h3>CSRF</h3>\n<p>CSRF 全称是 <code>Cross-site request forgery</code> ，中文名称是跨站请求伪造。还是刚才那个例子。像刚才那个例子就涉及到了 CSRF，浏览博客网站却试图请求电商网站的接口。此时同源策略的作用就体现出来了，电商网站可以检测请求中的 Origin 字段，判断是否同源，决定是否异常。当然这只是一种方法，并不是绝对地安全。</p>\n<h2>一个有意思的跨域问题</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/399b4dd1969cf7c4bc6f91f7e21b502d/07112/cross_site2.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.64864864864865%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAQBA//EABUBAQEAAAAAAAAAAAAAAAAAAAAC/9oADAMBAAIQAxAAAAGPiGp1T//EABkQAQEBAAMAAAAAAAAAAAAAAAEAAgMSMf/aAAgBAQABBQJ5J2j3sST7/8QAFhEBAQEAAAAAAAAAAAAAAAAAAAES/9oACAEDAQE/Aay//8QAFhEBAQEAAAAAAAAAAAAAAAAAAAES/9oACAECAQE/AY0//8QAFxAAAwEAAAAAAAAAAAAAAAAAAAExIP/aAAgBAQAGPwKIiz//xAAaEAEAAwADAAAAAAAAAAAAAAABABEhQWFx/9oACAEBAAE/IewlwweJ5IBLTYGYTCqf/9oADAMBAAIAAwAAABCIL//EABURAQEAAAAAAAAAAAAAAAAAABAh/9oACAEDAQE/EKH/xAAWEQEBAQAAAAAAAAAAAAAAAAABABH/2gAIAQIBAT8QSWr/xAAcEAEAAwACAwAAAAAAAAAAAAABABEhMUFRYXH/2gAIAQEAAT8QIxZ4Bh9AGAlHSNACjVPsSWbnr3EgVF8E/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"homepage\"\n        title=\"homepage\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/399b4dd1969cf7c4bc6f91f7e21b502d/1c72d/cross_site2.jpg\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/399b4dd1969cf7c4bc6f91f7e21b502d/a80bd/cross_site2.jpg 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/399b4dd1969cf7c4bc6f91f7e21b502d/1c91a/cross_site2.jpg 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/399b4dd1969cf7c4bc6f91f7e21b502d/1c72d/cross_site2.jpg 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/399b4dd1969cf7c4bc6f91f7e21b502d/a8a14/cross_site2.jpg 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/399b4dd1969cf7c4bc6f91f7e21b502d/fbd2c/cross_site2.jpg 1180w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/399b4dd1969cf7c4bc6f91f7e21b502d/07112/cross_site2.jpg 1880w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>我的博客的首页的背景图片以及中间的那一段 copyright 是爬取 Bing 得到的。这样魔改这个 hexo 主题的过程还是挺艰辛的，不过挺好看的就是了，也挺有成就感的。</p>\n<h3>直接请求这个接口</h3>\n<p>一开始我是尝试在博客页面直接请求那个<a href=\"http://cn.bing.com/HPImageArchive.aspx?format=js&#x26;idx=0&#x26;n=1\">Bing 接口</a>。</p>\n<pre><code class=\"language-javascript\">fetch(\"http://cn.bing.com/HPImageArchive.aspx?format=js&#x26;idx=0&#x26;n=1\").then(res =>\n  console.log(res)\n);\n</code></pre>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/aac83f413fee7a00e8878f382ac892d5/07635/cross_site1.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 19.594594594594593%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAEABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFgEBAQEAAAAAAAAAAAAAAAAAAAEC/9oADAMBAAIQAxAAAAHaGbAf/8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQABBQJ//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFhABAQEAAAAAAAAAAAAAAAAAAAER/9oACAEBAAE/IZNYr//aAAwDAQACAAMAAAAQ9C//xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPxBn/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGRABAAIDAAAAAAAAAAAAAAAAAQAxESGR/9oACAEBAAE/EAtnsQVBuf/Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cross-site\"\n        title=\"cross-site\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/aac83f413fee7a00e8878f382ac892d5/1c72d/cross_site1.jpg\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/aac83f413fee7a00e8878f382ac892d5/a80bd/cross_site1.jpg 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/aac83f413fee7a00e8878f382ac892d5/1c91a/cross_site1.jpg 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/aac83f413fee7a00e8878f382ac892d5/1c72d/cross_site1.jpg 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/aac83f413fee7a00e8878f382ac892d5/a8a14/cross_site1.jpg 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/aac83f413fee7a00e8878f382ac892d5/07635/cross_site1.jpg 952w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>结果和我所猜想的一样，这样请求这个接口会有跨域的问题。这个需要后端加上一个响应头<code>Access-Control-Allow-Origin:*</code> ，这样当浏览器接收到这个响应时，才不会被 block。但是，当然我没办法修改这个接口的后端代码。</p>\n<h3>由我的服务器代理我的请求</h3>\n<p>我想到的第二个办法是，将请求发到我自己的服务器上，再由我的服务器请求这个 Bing 接口，服务器收到响应后，再返回给浏览器，并且增加一个<code>Access-Control-Allow-Origin:*</code> ，这样这个响应就不会被浏览器 block 了。</p>\n<pre><code class=\"language-javascript\">const app = express();\nconst { default: axios } = require(\"axios\");\nconst request = require(\"request\");\napp.get(\"/\", async (req, res) => {\n  const {\n    data: { images },\n  } = await axios.get(\n    \"https://cn.bing.com/HPImageArchive.aspx?format=js&#x26;idx=0&#x26;n=1&#x26;nc=1541141842428&#x26;pid=hp&#x26;video=1\"\n  );\n  const { url } = images[0];\n  request(`https://cn.bing.com${url}`).pipe(res);\n}); //用于获取图片信息\napp.get(\"/info\", async (req, res) => {\n  const {\n    data: { images },\n  } = await axios.get(\n    \"https://cn.bing.com/HPImageArchive.aspx?format=js&#x26;idx=0&#x26;n=1&#x26;nc=1541141842428&#x26;pid=hp&#x26;video=1\"\n  );\n  const { copyright } = images[0];\n  res.send(copyright);\n}); //用于获取 copyright 信息\napp.listen(8081);\n</code></pre>\n<p>这个想法在本地测试是没有问题的，但是在 Github Page 上就有问题了。<code>https://ChenKS12138.github.io</code> 是 HTTPS 协议，但是我的服务器上只能 HTTP <del>主要是太懒了，没有弄域名，更别说 HTTPSl 了</del> ,一个 HTTPS 的网站请求 HTTP 的资源会有 <code>mixed content</code><a href=\"https://developers.google.com/web/fundamentals/security/prevent-mixed-content/what-is-mixed-content?hl=zh-cn\">(混合内容)</a> 的问题。请求图片资源问题不是很大，只是 warning，但是像 iframe、fetch 请求会直接报 error。如果想移除<code>mixed content</code> 的警告，需要改动浏览器的启动参数，比较麻烦，不现实。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/216831bef4c1ec60bb5f59979996a674/2a75a/cross_site3.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18.243243243243242%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAEABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQAC/9oADAMBAAIQAxAAAAHdGWiP/8QAFRABAQAAAAAAAAAAAAAAAAAAABH/2gAIAQEAAQUCiI//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAWEAEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQEAAT8hyykP/9oADAMBAAIAAwAAABDwP//EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAEDAQE/EKr/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAZEAEBAAMBAAAAAAAAAAAAAAABAEFRYZH/2gAIAQEAAT8Q6PsBuEZv/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"mixed-content\"\n        title=\"mixed-content\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/216831bef4c1ec60bb5f59979996a674/1c72d/cross_site3.jpg\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/216831bef4c1ec60bb5f59979996a674/a80bd/cross_site3.jpg 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/216831bef4c1ec60bb5f59979996a674/1c91a/cross_site3.jpg 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/216831bef4c1ec60bb5f59979996a674/1c72d/cross_site3.jpg 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/216831bef4c1ec60bb5f59979996a674/a8a14/cross_site3.jpg 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/216831bef4c1ec60bb5f59979996a674/2a75a/cross_site3.jpg 955w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3>继续尝试直接请求 Bing 接口</h3>\n<p>后面我也有尝试去使用 <code>jsonp</code> 、<code>window.postMessage</code> 这类的方法尝试直接请求 bing 接口，但是这类的方法都对服务器端返回的内容有要求，很难实现。</p>\n<h2>JSONProxy</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b93703f2fa38abd15a42f085e453be72/b3058/cross_site4.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.37837837837838%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdwVFDD/xAAZEAACAwEAAAAAAAAAAAAAAAABEAARITH/2gAIAQEAAQUCNTEer//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABoQAAICAwAAAAAAAAAAAAAAAAEQACERUZH/2gAIAQEAAT8huuAaDj8r/9oADAMBAAIAAwAAABDjD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABoQAQACAwEAAAAAAAAAAAAAAAEAERAhcVH/2gAIAQEAAT8QCNt1PcdwAjkFeP/Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"json-proxy\"\n        title=\"json-proxy\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b93703f2fa38abd15a42f085e453be72/1c72d/cross_site4.jpg\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b93703f2fa38abd15a42f085e453be72/a80bd/cross_site4.jpg 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b93703f2fa38abd15a42f085e453be72/1c91a/cross_site4.jpg 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b93703f2fa38abd15a42f085e453be72/1c72d/cross_site4.jpg 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b93703f2fa38abd15a42f085e453be72/a8a14/cross_site4.jpg 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b93703f2fa38abd15a42f085e453be72/fbd2c/cross_site4.jpg 1180w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/b93703f2fa38abd15a42f085e453be72/b3058/cross_site4.jpg 1296w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>这个是我在其他人的博客中找到的，这个<a href=\"https://jsonp.afeld.me/\">代理工具</a>，它可以代理我的请求。这个和我的第二个思路有点相似。但是它的服务器有 HTTPS，不会有<code>mixed content</code> 的问题。</p>\n<pre><code class=\"language-html\">&#x3C;p style=\"font-size: 25px;color:white;margin-bottom:1rem\">今日Bing美图&#x3C;/p>\n&#x3C;p\n  id=\"desc\"\n  style=\"font-size: 20px;color:white;margin-bottom:1rem;max-width:80%;text-align:center;margin: 0 auto;\"\n>\n  loading...\n&#x3C;/p>\n&#x3C;script src=\"http://lib.sinaapp.com/js/jquery/2.0.2/jquery-2.0.2.min.js\">&#x3C;/script>\n&#x3C;script>\n  $.ajax({\n    method: \"get\",\n    url:\n      \"https://jsonp.afeld.me/?url=http%3A%2F%2Fcn.bing.com%2FHPImageArchive.aspx%3Fformat%3Djs%26idx%3D0%26n%3D1\",\n    success: function (data) {\n      document.querySelector(\"#desc\").innerHTML = data.images[0].copyright;\n    },\n  });\n&#x3C;/script>\n</code></pre>\n<p>这样就得到我最后想要的效果了。</p>","id":"7aac5e6f-975f-54c3-9211-ee161df8b9d3","headings":[{"value":"什么是跨域","depth":2},{"value":"跨域会有什么影响","depth":2},{"value":"为什么要有同源策略","depth":2},{"value":"XSS 和 CSRF","depth":2},{"value":"XSS","depth":3},{"value":"CSRF","depth":3},{"value":"一个有意思的跨域问题","depth":2},{"value":"直接请求这个接口","depth":3},{"value":"由我的服务器代理我的请求","depth":3},{"value":"继续尝试直接请求 Bing 接口","depth":3},{"value":"JSONProxy","depth":2}],"date":"Monday, July 22, 2019 11:32 PM","tags":["request"],"title":"跨域那些事"}}}