{"componentChunkName":"component---src-pages-detail-tsx","path":"/detail/bf226b86-7ce2-5925-8b8b-cadc09987f3b","result":{"pageContext":{"html":"<h2>前言</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 258px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/40ccdcc6f581e247c7d3989fd9dc33c7/53f89/graduate-qrcode.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAMCBAX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAv/aAAwDAQACEAMQAAAB9aaVz3sIqmAoD//EABsQAQEAAgMBAAAAAAAAAAAAAAECABEDEBMx/9oACAEBAAEFArvWeok1s5Op+IYSIGj/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAWEQEBAQAAAAAAAAAAAAAAAAABESD/2gAIAQIBAT8BAmP/xAAbEAABBAMAAAAAAAAAAAAAAAAAARAhYRESMf/aAAgBAQAGPwKiFJbmtkPhD//EABsQAQADAAMBAAAAAAAAAAAAAAEAESExQVHR/9oACAEBAAE/Idzf3BC6/WbeGHd6bS4vFMHqBSoqO1C/ZYk5hEFBP//aAAwDAQACAAMAAAAQFMcA/8QAFREBAQAAAAAAAAAAAAAAAAAAASD/2gAIAQMBAT8QVGP/xAAWEQEBAQAAAAAAAAAAAAAAAAABIDH/2gAIAQIBAT8QS12P/8QAHRABAAMBAAIDAAAAAAAAAAAAAQARITFBUWFx0f/aAAgBAQABPxBLAAIh3QLcranAfn1BGrmlw0Zqg0aGx+po0JRXHE8QYJ8oPyErQGkaTQJ6g9hUBP/Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"qrcode\"\n        title=\"qrcode\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/40ccdcc6f581e247c7d3989fd9dc33c7/53f89/graduate-qrcode.jpg\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/40ccdcc6f581e247c7d3989fd9dc33c7/a80bd/graduate-qrcode.jpg 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/40ccdcc6f581e247c7d3989fd9dc33c7/53f89/graduate-qrcode.jpg 258w\"\n        sizes=\"(max-width: 258px) 100vw, 258px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n这是一个可以用来制作毕业照的微信小程序，主要使用的技术栈是<code>Taro</code>，<code>React</code>。开发总体上，主要的问题是集中在<code>资源加载优化方面</code>还有<code>画布的处理上</code>。</p>\n<h2>资源加载优化方面</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/1e25f1e9a3030e07a5272d6fdc295da2/47311/41591696515.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 177.7027027027027%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAkABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAUCAQP/xAAWAQEBAQAAAAAAAAAAAAAAAAAAAgH/2gAMAwEAAhADEAAAAbSXiZrpBtdvypp1h01gU//EAB0QAAICAgMBAAAAAAAAAAAAAAABAhIDERATITL/2gAIAQEAAQUC848O+TOxoeWbKxKoqhvRaRBuS0jRi+f/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AV//xAAZEQADAAMAAAAAAAAAAAAAAAAAAhIBIDH/2gAIAQIBAT8BtS8aN0//xAAdEAACAgEFAAAAAAAAAAAAAAAAMQEQAhESICEy/9oACAEBAAY/AuDGKBQKBang7x21Nf/EABwQAAMAAgMBAAAAAAAAAAAAAAABESExQXHxgf/aAAgBAQABPyFPgY5d+FNEcXWDIzy+GPLC+HhHjHjDoj9DVnubKlzXTHkwtkLBFO266f/aAAwDAQACAAMAAAAQjA1/j9//xAAYEQACAwAAAAAAAAAAAAAAAAAAEQEgMf/aAAgBAwEBPxBjpGH/xAAaEQACAgMAAAAAAAAAAAAAAAAAAREhEDFh/9oACAECAQE/EOmGihbEh4P/xAAfEAEAAwABBQEBAAAAAAAAAAABABEhMUFRYdHxcbH/2gAIAQEAAT8Q1cH8lDXx1ihfPiByMd+oDQG1pm8TAlwAvc+Xnz8p9ecgBpxnmJtHtrGHeMLsF4td8lLpgmdYmoFaZw1zFpQraD+T/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"decorationPage\"\n        title=\"decorationPage\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/1e25f1e9a3030e07a5272d6fdc295da2/1c72d/41591696515.jpg\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/1e25f1e9a3030e07a5272d6fdc295da2/a80bd/41591696515.jpg 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/1e25f1e9a3030e07a5272d6fdc295da2/1c91a/41591696515.jpg 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/1e25f1e9a3030e07a5272d6fdc295da2/1c72d/41591696515.jpg 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/1e25f1e9a3030e07a5272d6fdc295da2/a8a14/41591696515.jpg 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/1e25f1e9a3030e07a5272d6fdc295da2/47311/41591696515.jpg 1080w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>在这个装饰页面，以前也有见过类似的场景，是在<code>你头像真棒</code>小程序里。通过点击底下的图片，来更换画布中的背景图。但是不同于上一个场景，上一个场景加载的图片资源大多是一些头像挂件，体积都不大且数量不多，这里的图片资源数量比较多，除了体积大不的挂件，更多的是体积比较大的背景图。虽然图片资源都有进行了一定程度的压缩，但是总体的体积还是很大，加载完这个页面的资源需要<code>20+M</code>的流量，这个加载时长是不能接受的，而且这也会造成加载时滑动的卡顿。</p>\n<p>此外，还有一点对象存储 OSS 的计费和图片的请求次数有关系，因此如果更降低图片的请求次数也是对加载的优化。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e6875518359b64bf4684d71539687f27/d0ab7/subPackage.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.513513513513516%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAAAuklEQVQY042Q3Q6DIAyFff+3VDPFn0FhIE5RPGkTXcwu/C5ISzk9LcU4js65nHNKCeeHycy+7/mHWwoK7z1eo3CKjTHWOgRSQusQgjGEq425xESEmohxWmvbtn0xSqm6rquqQjwMA5HRWqP1Je77vus6RCszTZNmYowwSQzuxVPSSwxb2XlZFhQwJ9yapsFfzExkZLr7znhXlqU4Q+x9eGtCevqc/BFjB0wutqzf5u+an1FgPCjFWYLnHJ490pGeH9DTAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"subPackage\"\n        title=\"subPackage\"\n        src=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e6875518359b64bf4684d71539687f27/fcda8/subPackage.png\"\n        srcset=\"https://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e6875518359b64bf4684d71539687f27/12f09/subPackage.png 148w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e6875518359b64bf4684d71539687f27/e4a3f/subPackage.png 295w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e6875518359b64bf4684d71539687f27/fcda8/subPackage.png 590w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e6875518359b64bf4684d71539687f27/efc66/subPackage.png 885w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e6875518359b64bf4684d71539687f27/c83ae/subPackage.png 1180w,\nhttps://cdn.jsdelivr.net/gh/ChenKS12138/ChenKS12138.github.io/static/e6875518359b64bf4684d71539687f27/d0ab7/subPackage.png 1532w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>最后的方案是，对原先的高清图进行有损压缩并利用的小程序的<code>分包加载</code>能力，小程序的每个分包大小不超过 2M。将该页面所有缩略图控制在 2M 内，并作为缓存放进小程序的分包中。由于高清图资源的地址需要通过接口获取，因此需要建立高清图的 URL 和分包中对应的缩略图的地址的映射关系来进行优化。</p>\n<pre><code class=\"language-jsx\">// thumbnail.js\nconst thumbnailMap = new Map(\n  [\n    [\n      \"https://graphbed.example.com/graduate/sdfovhidsf1\",\n      \"/subPackage/package1/assets/1.png\"\n    ],\n    [\n      \"https://graphbed.example.com/graduate/67sdf87sd6f\",\n      \"/subPackage/package1/assets/2.png\"\n    ]\n  ]\n)\n\n// page.jsx\n\nrender(){\n  const src = 'https://graphbed.example.com/graduate/sdfovhidsf1';\n  return &#x3C;Image src={thumbnailMap.get(src) || src} >\n}\n</code></pre>\n<p>这样当后端的高清图发生更新添加了新的高清图时，缓存未命中，可以 fallback 直接请求高清图的地址。同时，也需要前端在小程序包中添加新的缩略图，发布新的版本，在此期间不会影响小程序的使用。</p>\n<h2>画布处理上</h2>\n<p>在画布处理上，我将另一个项目中的原生的画布组件封装成了 Taro 组件，并修改了一部分的 props。不过该组件是一个 canvas，不同于普通的组件。框架并不能直接替我计算出需要帮我增加/提换/删除页面的什么节点，因此需要我在特定的生命周期，比对 props 的变化，操作 canvas context 的 api，重新进行渲染。因此要求传入的 props 的<code>graphArray</code>的每一个元素都应该有一个<code>key</code>，便于我追踪每一个 graph 的具体变化。</p>","id":"bf226b86-7ce2-5925-8b8b-cadc09987f3b","headings":[{"value":"前言","depth":2},{"value":"资源加载优化方面","depth":2},{"value":"画布处理上","depth":2}],"date":"Tuesday, June 9, 2020 5:00 PM","tags":["Taro","JavaScript","小程序"],"title":"毕业照小程序开发复盘"}},"staticQueryHashes":["63159454"]}