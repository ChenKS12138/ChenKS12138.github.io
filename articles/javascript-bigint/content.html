<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaScript中的BigInt</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EZRSNLSEWX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
    </script>
    <script type="module" crossorigin="" src="/assets/app.6ad4236d.js"></script>
    <link rel="stylesheet" href="/assets/index.9cdf326d.css">
  <link rel="modulepreload" crossorigin="" href="/assets/content.2174eee5.js"></head>

  <body>
    <div id="app" data-server-rendered="true"><div class="w-full items-center justify-center m-0 p-0"><!--[--><header class="w-full fixed z-99" style="--57bdf034:url(&quot;/bg1.png&quot;);" data-v-69cc4069=""><div class="header-navigation text--layout flex items-center justify-center" style="height:64px;background-color:transparent;" data-v-69cc4069=""><div class="flex justify-between items-center w-3xl <md:w-full" data-v-69cc4069=""><div data-v-69cc4069=""><a href="/" class="text--link" data-v-69cc4069="">ChenKS</a></div><div class="flex text-sm font-400 items-center" data-v-69cc4069=""><!--[--><a href="/" class="text--link" data-v-69cc4069="">Home</a><a href="/article-list" class="text--link" data-v-69cc4069="">Articles</a><a href="/about" class="text--link" data-v-69cc4069="">About</a><a href="/RSS" class="text--link" data-v-69cc4069="">RSS</a><!--]--><button class="cursor-pointer text-white bg-transparent py-0.75 px-2.5 text-sm" data-v-69cc4069=""><span class="inline-block align-middle dark:i-carbon-moon i-carbon-sun"></span><span class="pl-2">Light</span></button></div></div></div></header><div class="w-full header-cover-bg min-h-lg" style="--57bdf034:url(&quot;/bg1.png&quot;);" data-v-69cc4069=""></div><div class="content-container-wrapper dark:bg-dark" style="--57bdf034:url(&quot;/bg1.png&quot;);" data-v-69cc4069=""><div class="content-container" data-v-69cc4069=""><!--[--><div class="h-70 -mt-70 flex flex-col items-center text-white"><div class="font-bold text-3xl">JavaScript中的BigInt</div><div class="text-lg mt-2">2020-04-11</div><div class="mt-2 italic">#JavaScript</div></div><!--[--><div class="markdown-body"><h1>JavaScript 中的 BigInt</h1><p>之前写 JavaScript 代码，有听说到<code>Number.MAX_VALUE</code>和<code>Number.MAX_SAFE_INTEGER</code>，但是一直没有做深入的理解，对<code>Number.MAX_SAFE_INTEGER</code>并不太了解。</p><h2>遇到的问题</h2><p>要从一个密码学实验代码说起，最近在用 JavaScript 实现 RSA 算法，遇到了一个问题。RSA 算法是基于大质数乘积的因式分解困难的难题实现的。</p><p>其中，生成密钥对的大致步骤如下：</p><ol><li>随机生成两个大质数 p,q;</li><li>计算 n=p*q;</li><li>计算 m=(p-1)*(q-1);</li><li>计算数值 e，e 为一个与 m 互质的数</li><li>计算数值 d，d 为满足<code>(d*e) ≡ 1 mod m</code> 的数</li></ol><p>在生成<code>d</code>时遇到了一个问题，<code>generateD()</code>生成的<code>d</code>不符合我的预期，但是计算步骤是没问题的。</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">generateD</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> m</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> k <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">*</span> m <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> e <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>k <span class="token operator">*</span> m <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    k<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>排查发现当 k=<code>5</code>,m=<code>9999999999999999</code>,e=<code>10</code>时，if 的条件语句为真，但是从数学的角度来说，此时<code>(k*m+1)%e</code>显然是 6。</p><pre class="language-javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token number">9999999999999999</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 结果为0</span>
</code></pre><p>怀疑是数值太大的原因改用 BigInt，才解决了问题。</p><pre class="language-javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5n</span> <span class="token operator">*</span> <span class="token number">9999999999999999n</span> <span class="token operator">+</span> <span class="token number">1n</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 结果为6n</span>
</code></pre><p>重新修改<code>generateD</code>函数</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">generateD</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> m</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> k <span class="token operator">=</span> <span class="token number">1n</span><span class="token punctuation">;</span>
  e <span class="token operator">=</span> <span class="token function">BigInt</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  m <span class="token operator">=</span> <span class="token function">BigInt</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">*</span> m <span class="token operator">+</span> <span class="token number">1n</span><span class="token punctuation">)</span> <span class="token operator">%</span> e <span class="token operator">===</span> <span class="token number">0n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">*</span> m <span class="token operator">+</span> <span class="token number">1n</span><span class="token punctuation">)</span> <span class="token operator">/</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    k<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><h2>原因分析</h2><p>原因在于 JavaScript 中的<code>Number</code>无论是整数还是小数都是使用 IEEE754 的双精度浮点数表示的。</p><p><img src="https://s1.ax1x.com/2020/04/11/GbPPij.png" alt="双精度浮点数"></p><p>双精度浮点数的表示类似与科学计数法<code>(-1)^S*(1.M)*2^(E-1023)</code></p><p>由符号位（d63），指数部分（d62-d52），尾数部分（d51-d0）组成。符号位决定了这个浮点数的正负，指数部分决定了这个数的表示范围，尾数部分决定了这个数的表示精度。如果尾数部分太长，那么多余的部分只能舍去，此时浮点数的精度就降低了。</p><p><img src="https://s1.ax1x.com/2020/04/11/Gbtt2R.png" alt="Float Point Converter"></p><p>因此有了<code>Number.MAX_SAFE_INTEGER</code>。它的值为<code>9007199254740991</code><a href="#refer-1"><sup>1</sup></a>， 当数值超过<code>Number.MAX_SAFE_INTEGER</code>时，就不能保证数值的精度了。可以调用<code>Number.isSafeInteger</code>进行判断。</p><blockquote><p>Number.MAX_SAFE_VALUE<a href="#refer-2"><sup>[2]</sup></a> : The value of <code>Number.MAX_SAFE_INTEGER</code> is the largest integer n such that n and n + 1 are both exactly representable as a Number value.</p></blockquote><h2>BigInt</h2><p>我们可以用 BigInt 来表示任意大的整数，但也有需要注意的地方</p><ol><li>不可以和 Number 实例混用</li><li>不能用于 Math 对象中的方法</li><li>使用 BigInt 运算时，带小数的结果会被取整</li><li>在 JSON 中使用时，需要自己实现<code>BigInt.prototype.toJSON</code></li><li>因为对 BigInt 的操作并不是常数时间，因此 BigInt 不适合用于密码学<a href="#refer-3"><sup>[3]</sup></a></li></ol><h1>参考引用</h1><ul><li><p>[1] <a href="https://www.binaryconvert.com/result_double.html?decimal=057048048055049057057050053052055052048057057049">https://www.binaryconvert.com/result_double.html?decimal=057048048055049057057050053052055052048057057049</a></p></li><li><p>[2] <a href="https://www.ecma-international.org/ecma-262/6.0/#sec-number.max_safe_integer/">https://www.ecma-international.org/ecma-262/6.0/#sec-number.max_safe_integer/</a></p></li><li><p>[3] <a href="https://www.chosenplaintext.ca/articles/beginners-guide-constant-time-cryptography.html">https://www.chosenplaintext.ca/articles/beginners-guide-constant-time-cryptography.html</a></p></li></ul></div><!--]--><div class="rounded bg-gray mt-10 p-1 text-white italic indent-md text-lg"> CC BY-SA 3.0协议 。转载请注明出处! </div><!--]--></div></div><!--]--></div></div>
    
  

</body></html>