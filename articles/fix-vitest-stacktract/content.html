<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修复vitest错误栈指向错误文件</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EZRSNLSEWX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
    </script>
    <script type="module" crossorigin="" src="/assets/app.606baedb.js"></script>
    <link rel="stylesheet" href="/assets/index.ddadd7c3.css">
  <link rel="modulepreload" crossorigin="" href="/assets/content.c96f3807.js"><link rel="modulepreload" crossorigin="" href="/assets/ArticleWrapper.f9e95eb4.js"><link rel="stylesheet" href="/assets/ArticleWrapper.f30abf01.css"><meta property="og:title" content="修复vitest错误栈指向错误文件"><meta name="head:count" content="1"></head>

  <body>
    <div id="app" data-server-rendered="true"><div class="w-full items-center justify-center m-0 p-0"><!--[--><header class="w-full fixed z-99" style="--55fa396c:url(&quot;/bg.jpg&quot;);" data-v-75913c0b=""><div class="header-navigation text--layout flex items-center justify-center" style="height:64px;background-color:transparent;" data-v-75913c0b=""><div class="flex justify-between items-center w-3xl <md:w-full" data-v-75913c0b=""><div data-v-75913c0b=""><a href="/" class="text--link" data-v-75913c0b="">ChenKS</a></div><div class="flex text-sm font-400 items-center" data-v-75913c0b=""><!--[--><a href="/" class="text--link" data-v-75913c0b="">首页</a><a href="/article-list" class="text--link" data-v-75913c0b="">文章</a><a href="/about" class="text--link" data-v-75913c0b="">关于</a><!--]--><button class="cursor-pointer text-white bg-transparent py-0.75 px-2.5 text-sm" data-v-75913c0b=""><span class="inline-block align-middle dark:i-carbon-moon i-carbon-sun"></span></button></div></div></div></header><div class="flex flex-col" style="min-height:100vh;--55fa396c:url(&quot;/bg.jpg&quot;);" data-v-75913c0b=""><div class="w-full header-cover-bg min-h-sm" data-v-75913c0b=""></div><div class="content-container-wrapper dark:bg-dark" data-v-75913c0b=""><div class="content-container" data-v-75913c0b=""><div class="flex items-start wrapper" data-v-75913c0b="" data-v-c9e79ed7=""><div class="headings" data-v-c9e79ed7=""><div class="headings-content" data-v-c9e79ed7=""><ol class="article-heading" data-v-c9e79ed7="" data-v-ef16a1ef=""><!--[--><li data-v-ef16a1ef=""><a href="#契机" data-v-ef16a1ef=""><span class="article-heading-title" data-v-ef16a1ef="">1. 契机</span></a><!----></li><li data-v-ef16a1ef=""><a href="#修复历程" data-v-ef16a1ef=""><span class="article-heading-title" data-v-ef16a1ef="">2. 修复历程</span></a><!----></li><li data-v-ef16a1ef=""><a href="#启发" data-v-ef16a1ef=""><span class="article-heading-title" data-v-ef16a1ef="">3. 启发</span></a><ol class="article-heading" data-v-ef16a1ef=""><!--[--><li data-v-ef16a1ef=""><a href="#向社区提反馈问题时尽量提供最小的可复现的样例" data-v-ef16a1ef=""><span class="article-heading-title" data-v-ef16a1ef="">3.1. 向社区提反馈问题时尽量提供最小的可复现的样例</span></a><!----></li><li data-v-ef16a1ef=""><a href="#写好测试代码" data-v-ef16a1ef=""><span class="article-heading-title" data-v-ef16a1ef="">3.2. 写好测试代码</span></a><!----></li><!--]--></ol></li><!--]--></ol></div></div><div class="content-wrapper" data-v-c9e79ed7=""><div class="h-55 -mt-55 flex flex-col items-center text-white" data-v-c9e79ed7=""><div class="font-bold text-3xl" data-v-c9e79ed7="">修复vitest错误栈指向错误文件</div><div class="text-lg mt-2" data-v-c9e79ed7="">2023-04-08</div><div class="mt-2 italic" data-v-c9e79ed7="">#Web</div></div><!--[--><div class="markdown-body"><h1 id="%E5%A5%91%E6%9C%BA" tabindex="-1">契机</h1><p>最近在GitHub闲逛发现了这个Issue，它提供了完成可复现的例子，我试了一下确实可复现，瞬间提起了兴趣想修复它。前前后后花了一个周末+一天清明节假期修复，虽然说打工人的休息时间很宝贵，但是能完成这个挑战还是很是令人兴奋的。</p><p><a href="https://github.com/vitest-dev/vitest/issues/3004">https://github.com/vitest-dev/vitest/issues/3004</a></p><p><img src="/assets/2.8da45182.png" alt="issue"></p><h1 id="%E4%BF%AE%E5%A4%8D%E5%8E%86%E7%A8%8B" tabindex="-1">修复历程</h1><p><a href="https://github.com/vitest-dev/vitest/pull/3115">https://github.com/vitest-dev/vitest/pull/3115</a></p><p>这个PR我前前后后提交了3版修改，虽然每次的修改都可以修复这个Bug，但是前两次都不是根本解。这是我第一次接触这个项目，通过借助debugger调试对项目进行了解，所产生的思维的局限性。这里体现了Code Review的重要性，让有全局视野的人把控代码质量，不让项目工程太快走向混乱。</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> fn <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">runInThisContext</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// 通过debugger发现传入的__filename变量是正确的，但是打印的stacktrace却一直是错误的</span>
  <span class="token literal-property property">filename</span><span class="token operator">:</span> __filename<span class="token punctuation">,</span>
  <span class="token literal-property property">lineOffset</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token literal-property property">columnOffset</span><span class="token operator">:</span> <span class="token operator">-</span>codeDefinition<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p>期间我一度以为是<code>Node.js</code>的Bug，花了一天多调试Node.js的源代码，直到跟着源码发现了<code>Error.prepareStackTrace</code>这个API。Node.js在设计上充斥着各种函数的注册/回调，这导致我阅读代码的体验很糟糕，逻辑是割裂的，我需要不断的通过搜索函数名关联相关的逻辑。最后，才发现是<code>vitest</code>项目使用了这个API，自定义了对stacktrace的处理。</p><p><a href="https://v8.dev/docs/stack-trace-api">https://v8.dev/docs/stack-trace-api</a></p><p>当然调试Node.js期间也有不少收获，学会了使用lldb调试C++二进制，并使用脚本帮助自己更方便地在调试期间打印相关变量。</p><p><a href="https://github.com/nodejs/node/blob/main/deps/v8/tools/lldb_commands.py">https://github.com/nodejs/node/blob/main/deps/v8/tools/lldb_commands.py</a></p><h1 id="%E5%90%AF%E5%8F%91" tabindex="-1">启发</h1><h2 id="%E5%90%91%E7%A4%BE%E5%8C%BA%E6%8F%90%E5%8F%8D%E9%A6%88%E9%97%AE%E9%A2%98%E6%97%B6%E5%B0%BD%E9%87%8F%E6%8F%90%E4%BE%9B%E6%9C%80%E5%B0%8F%E7%9A%84%E5%8F%AF%E5%A4%8D%E7%8E%B0%E7%9A%84%E6%A0%B7%E4%BE%8B" tabindex="-1">向社区提反馈问题时尽量提供最小的可复现的样例</h2><p>在提出自己的问题的同时，提供最小的可复现的样例帮助别人更快地了解自己的问题 <a href="https://stackoverflow.com/help/minimal-reproducible-example">https://stackoverflow.com/help/minimal-reproducible-example</a></p><h2 id="%E5%86%99%E5%A5%BD%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81" tabindex="-1">写好测试代码</h2><p>我一度十分疑惑，社区的开源代码是如何保证代码质量的。项目的开发人员是不固定的（没有开发人员能够为这些代码产生的事故负责，他们没有与任何使用方签订契约），交流也是不固定的（协作的人可能在全球任何可以接入互联网的角落，生活在各个时区），甚至代码风格也有点混乱，但是这样的代码项目就是可以正常的工作，并且被各个商业公司在清楚风险自负的情况下使用。一个比较重要的原因就是有各种测试代码保证着代码质量。</p></div><!--]--><div class="mt-20" data-v-c9e79ed7=""><!----></div></div></div></div></div></div><!--]--></div></div>
    
  

</body></html>