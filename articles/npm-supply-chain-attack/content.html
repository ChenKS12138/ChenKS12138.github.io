<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPM上的软件供应链攻击</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EZRSNLSEWX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
    </script>
    <script type="module" crossorigin="" src="/assets/app.91692cd0.js"></script>
    <link rel="stylesheet" href="/assets/index.40205772.css">
  <link rel="modulepreload" crossorigin="" href="/assets/content.ce0d4b26.js"><link rel="modulepreload" crossorigin="" href="/assets/ArticleWrapper.5f379090.js"><link rel="stylesheet" href="/assets/ArticleWrapper.384cfda4.css"><meta property="og:title" content="NPM上的软件供应链攻击"><meta name="head:count" content="1"></head>

  <body>
    <div id="app" data-server-rendered="true"><div class="w-full items-center justify-center m-0 p-0"><!--[--><header class="w-full fixed z-99" style="--0e5f7568:url(&quot;/bg.jpg&quot;);" data-v-396ec23e=""><div class="header-navigation text--layout flex items-center justify-center" style="height:64px;background-color:transparent;" data-v-396ec23e=""><div class="flex justify-between items-center w-3xl <md:w-full" data-v-396ec23e=""><div data-v-396ec23e=""><a href="/" class="text--link" data-v-396ec23e="">ChenKS</a></div><div class="flex text-sm font-400 items-center" data-v-396ec23e=""><!--[--><a href="/" class="text--link" data-v-396ec23e="">首页</a><a href="/article-list" class="text--link" data-v-396ec23e="">文章</a><a href="/about" class="text--link" data-v-396ec23e="">关于</a><!--]--><button class="cursor-pointer text-white bg-transparent py-0.75 px-2.5 text-sm" data-v-396ec23e=""><span class="inline-block align-middle dark:i-carbon-moon i-carbon-sun"></span></button></div></div></div></header><div class="flex flex-col" style="min-height:100vh;--0e5f7568:url(&quot;/bg.jpg&quot;);" data-v-396ec23e=""><div class="w-full header-cover-bg min-h-sm" data-v-396ec23e=""></div><div class="content-container-wrapper dark:bg-dark" data-v-396ec23e=""><div data-v-396ec23e="" data-v-bb251bbf="" data-v-b11127c4=""><div class="title-content" data-v-b11127c4=""><!--[--><div class="h-55 -mt-55 flex flex-col items-center text-white" data-v-bb251bbf=""><div class="font-bold text-3xl" data-v-bb251bbf="">NPM上的软件供应链攻击</div><div class="text-lg mt-2" data-v-bb251bbf="">2021-09-07</div><div class="mt-2 italic" data-v-bb251bbf="">#信息安全</div></div><!--]--></div><div class="box-container" data-v-b11127c4=""><div class="left-toc" data-v-b11127c4=""><!--[--><ol class="article-heading" data-v-bb251bbf="" data-v-ef16a1ef=""><!--[--><li data-v-ef16a1ef=""><a href="#前言" data-v-ef16a1ef=""><span class="article-heading-title" data-v-ef16a1ef="">1. 前言</span></a><!----></li><li data-v-ef16a1ef=""><a href="#经历复盘" data-v-ef16a1ef=""><span class="article-heading-title" data-v-ef16a1ef="">2. 经历复盘</span></a><!----></li><li data-v-ef16a1ef=""><a href="#典型案例分析" data-v-ef16a1ef=""><span class="article-heading-title" data-v-ef16a1ef="">3. 典型案例分析</span></a><ol class="article-heading" data-v-ef16a1ef=""><!--[--><li data-v-ef16a1ef=""><a href="#依赖混淆攻击" data-v-ef16a1ef=""><span class="article-heading-title" data-v-ef16a1ef="">3.1. 依赖混淆攻击</span></a><!----></li><li data-v-ef16a1ef=""><a href="#误植域名攻击" data-v-ef16a1ef=""><span class="article-heading-title" data-v-ef16a1ef="">3.2. 误植域名攻击</span></a><!----></li><li data-v-ef16a1ef=""><a href="#event-stream 事件" data-v-ef16a1ef=""><span class="article-heading-title" data-v-ef16a1ef="">3.3. event-stream 事件</span></a><!----></li><!--]--></ol></li><li data-v-ef16a1ef=""><a href="#可能的解决措施" data-v-ef16a1ef=""><span class="article-heading-title" data-v-ef16a1ef="">4. 可能的解决措施</span></a><ol class="article-heading" data-v-ef16a1ef=""><!--[--><li data-v-ef16a1ef=""><a href="#依赖包异常调用监测" data-v-ef16a1ef=""><span class="article-heading-title" data-v-ef16a1ef="">4.1. 依赖包异常调用监测</span></a><!----></li><li data-v-ef16a1ef=""><a href="#依赖包可信指标检查" data-v-ef16a1ef=""><span class="article-heading-title" data-v-ef16a1ef="">4.2. 依赖包可信指标检查</span></a><!----></li><!--]--></ol></li><li data-v-ef16a1ef=""><a href="#总结" data-v-ef16a1ef=""><span class="article-heading-title" data-v-ef16a1ef="">5. 总结</span></a><!----></li><li data-v-ef16a1ef=""><a href="#资料参考" data-v-ef16a1ef=""><span class="article-heading-title" data-v-ef16a1ef="">6. 资料参考</span></a><!----></li><!--]--></ol><!--]--></div><div class="content-container" data-v-b11127c4=""><!--[--><div class="flex items-start wrapper" data-v-bb251bbf=""><div class="content-wrapper" data-v-bb251bbf=""><!--[--><div class="markdown-body"><h1 id="%E5%89%8D%E8%A8%80" tabindex="-1">前言</h1><p>今年经历了一次软件供应链攻击，为此觉得有必要想详细复盘，并了解一些相关的攻击手段和可能的防范措施。NPM 有着丰富的生态，但是其中依赖包质量参差不齐，容易成为黑客进行渗透的手段。</p><h1 id="%E7%BB%8F%E5%8E%86%E5%A4%8D%E7%9B%98" tabindex="-1">经历复盘</h1><!----><!----><!----><!----><p>由于构建流水线的的 NPM 版本过低，不支持<code>Dependency Alias</code>(NPM 6.9 及以上支持)。导致出现缺 NPM 包的现象，手动安装时，误安装了<code>fork-ts-checker-webpack-plugin-v5</code>，导致恶意的脚本被执行，造成本机的信息被泄露。</p><p><code>fork-ts-checker-webpack-plugin-v5</code>是一个恶意包的名字，项目中 vue-cli 依赖的<code>fork-checker-webpack-plugin-v5</code>是<code>fork-checker-webpack-plugin</code>的一个别名。</p><p>恶意脚本通过在<code>preinstall</code>这一生命周期钩子进行 burp 扫描，收集了本机的环境变量和主机名。同时这是一个跨平台的脚本，windows 和*nix 用户都会受到影响。</p><p>在后续的分析中，发现这个 NPM 包在此前已经被官方 registry 标记为恶意包了，但是通过 tencent 源还可以继续下载恶意包，这也是造成此次问题的一个原因。</p><h1 id="%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90" tabindex="-1">典型案例分析</h1><!----><p>这里整理的是恶意代码进入项目依赖树的几种方式，从依赖包的源代码编写，到构建发布，到镜像仓库托管，到用户下载，这整个链路都可能发生黑客攻击。</p><h2 id="%E4%BE%9D%E8%B5%96%E6%B7%B7%E6%B7%86%E6%94%BB%E5%87%BB" tabindex="-1">依赖混淆攻击</h2><!----><!----><p>今年的 2 月 10 日，国外的安全研究员 Alex Birsan，发现了一段疑似 Paypal 内部的 package.json 的代码，公有的依赖包和私有的依赖包混合在一个文件中，并且这些私有的依赖包在 NPM registry 中均被没有注册过，于是他在 NPM 官方的 registry 上投放了一些同名的恶意包用来收集信息。普通用户如果没有设置好源，或者是内部镜像源出现了回源，高版本依赖包优先级高于低版本依赖包，也会有出现被污染的情况。最后 Paypal、苹果、Tesla 等公司受到影响。</p><h2 id="%E8%AF%AF%E6%A4%8D%E5%9F%9F%E5%90%8D%E6%94%BB%E5%87%BB" tabindex="-1">误植域名攻击</h2><!----><!----><!----><p>这个翻译可能有点让人摸不着头脑，换句通俗的话讲就是钓鱼攻击。用户在下载依赖包时，包名出现了偏差，导致下载到恶意包。看起来的很低级的错误，但是还是有发生的可能性，不少人会犯。用户<code>hacktask</code>在 NPM 上发布了大量的恶意包，目前已经全部被标记为恶意包，用的 NPM 账号及注册邮箱已被封禁。这也说明了一件事，批量发布恶意包是成本很低的一件事，可以根据 NPM 包命名规则批量生成恶意包，或者是提前抢注官方可能但未使用的包名称。</p><p>这些有的钓鱼包像<code>crossenv</code>在功能上甚至和官方包无差异，只是多增加一些旁路的恶意的逻辑会上报本机信息，这也是钓鱼包隐蔽的一个表现。</p><h2 id="event-stream-%E4%BA%8B%E4%BB%B6" tabindex="-1">event-stream 事件</h2><!----><!----><p>原作者开发了<code>event-stream</code>包，作者个人维护这个包并没有什么获利，自己也不再使用，就直接将这个包的所有权交给了"热心网友"。但是这一举措被别有用心的人利用了，攻击者通过<code>社会工程手段</code><s>简单点说就是骗</s>，获取到了该 NPM 包的所有权，然后让<code>event-stream@3.3.6</code>依赖了含恶意代码的<code>flatmap-stream</code>，一段时间后又发布了<code>event-stream@4.0.0</code>移除了相关的恶意代码，按照 NPM 的语义化版本规范，大部分用户的版本应该都是<code>^3.x.x</code>，这就导致了不会轻易升级 major 版本，但是容易升级 minor 版本，许多用户会停留在 3.3.6 版本，同时审查最新的源代码时又审查不出问题。</p><!----><p><code>event-stream@3.3.6</code>在 2018.09.09 发布后，直到 2018.11.20 有开发者发现了<code>nodemon</code>的异常 warning 才被发现。使用 nodemon 运行一个空的 js 文件，却被提示使用了被废弃的加密模块的 API，事情才被披露。</p><p>直到 2018.11.26，NPM 官方下架了<code>flag-stream</code>和<code>event-stream@3.3.6</code>。</p><p>攻击者的目标是<code>copay</code>，目的是盗取用户的加密货币钱包私钥，只有当用户安装特定的依赖包时恶意代码才会生效，可见其隐蔽性之强。</p><h1 id="%E5%8F%AF%E8%83%BD%E7%9A%84%E8%A7%A3%E5%86%B3%E6%8E%AA%E6%96%BD" tabindex="-1">可能的解决措施</h1><p>从上面的例子看，攻击手段主要是利用了 NPM 的声明周期钩子，又或者是将恶意代码注入到依赖树中，我们是不是可以通过什么方式进行提前监测，又或者是实时拦截呢？</p><h2 id="%E4%BE%9D%E8%B5%96%E5%8C%85%E5%BC%82%E5%B8%B8%E8%B0%83%E7%94%A8%E7%9B%91%E6%B5%8B" tabindex="-1">依赖包异常调用监测</h2><!----><p>不管是什么样的 NPM 包，它依赖的一些能力如网络 I/O、文件 I/O、密码学能力（也可以纯 js 实现）等，都需要由<code>Internal Module</code>又或者是自行编写的<code>ffi</code>提供，可以通过对<code>Module.prototype.require</code>进行 hook，监听所有的<code>require</code>，如果这颗 require 树出现了不应该出现的依赖能力就需要人工进行排查。</p><p>目前只是一个比较初步的思路，<code>JavaScript</code>是一门动态语言，导致了我想通过静态分析的方式得到 require 树是比较困难的。当然也是可以通过一些事前的约定让静态分析得以实现。</p><h2 id="%E4%BE%9D%E8%B5%96%E5%8C%85%E5%8F%AF%E4%BF%A1%E6%8C%87%E6%A0%87%E6%A3%80%E6%9F%A5" tabindex="-1">依赖包可信指标检查</h2><!----><p><code>npq</code>提供一个不错的事前检查的思路，我们在安装依赖包前，先从<code>发布时长</code>、<code>下载量</code>、<code>README</code>、<code>NPM生命周期钩子</code>、<code>漏洞库中的相关信息</code>、<code>开源许可</code>等维度对下载的依赖包进行审查，如果出现问题就阻塞下载让用户自行确认。这种方式对于钓鱼包，以及通过<code>pre/afterinstall</code>进行攻击的恶意包已经能有比较好的拦截了。</p><h1 id="%E6%80%BB%E7%BB%93" tabindex="-1">总结</h1><p>恶意攻击和安全防御一直是一种此消彼长的状态，在这件事情上并没有银弹。每次新功能的加入都会伴随着一定的风险，当然也不是说一成不变就保障安全，对于我们设计出的软件，我们永远要做好安全方面的事前设计，事中的及时响应，事后的及时复盘。在这些安全问题中，人才是最薄弱的一环，我们需要通过设计更好的规则或者是工具，降低犯错的概率。</p><h1 id="%E8%B5%84%E6%96%99%E5%8F%82%E8%80%83" tabindex="-1">资料参考</h1><ul><li>[1] <a href="https://medium.com/@alex.birsan/dependency-confusion-4a5d60fec610">https://medium.com/@alex.birsan/dependency-confusion-4a5d60fec610</a></li><li>[2] <a href="https://security.tencent.com/index.php/blog/msg/182">https://security.tencent.com/index.php/blog/msg/182</a></li><li>[3] <a href="https://snyk.io/blog/typosquatting-attacks/">https://snyk.io/blog/typosquatting-attacks/</a></li><li>[4] <a href="https://snyk.io/blog/a-post-mortem-of-the-malicious-event-stream-backdoor/">https://snyk.io/blog/a-post-mortem-of-the-malicious-event-stream-backdoor/</a></li><li>[5] <a href="https://github.com/remy/nodemon/issues/1442">https://github.com/remy/nodemon/issues/1442</a></li><li>[6] <a href="https://github.com/dominictarr/event-stream/issues/116">https://github.com/dominictarr/event-stream/issues/116</a></li></ul></div><!--]--><div class="rounded bg-gray mt-10 p-1 text-white italic indent-md text-lg" data-v-bb251bbf=""> CC BY-SA 3.0协议 。转载请注明出处! </div><div class="mt-20" data-v-bb251bbf=""><!----></div></div></div><!--]--></div></div></div></div></div><!--]--></div></div>
    
  

</body></html>