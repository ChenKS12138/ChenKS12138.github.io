<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>毕业照小程序开发复盘</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EZRSNLSEWX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
    </script>
    <script type="module" crossorigin="" src="/assets/app.f9f8d20c.js"></script>
    <link rel="stylesheet" href="/assets/index.18aa5f7c.css">
  <link rel="modulepreload" crossorigin="" href="/assets/content.f40fe895.js"></head>

  <body>
    <div id="app" data-server-rendered="true"><div class="w-full items-center justify-center m-0 p-0"><!--[--><header class="w-full fixed z-99" style="--37938739:url(&quot;/bg1.png&quot;);" data-v-35def80b=""><div class="header-navigation text--layout flex items-center justify-center" style="height:64px;background-color:transparent;" data-v-35def80b=""><div class="flex justify-between items-center w-3xl <md:w-full" data-v-35def80b=""><div data-v-35def80b=""><a href="/" class="text--link" data-v-35def80b="">ChenKS</a></div><div class="flex text-sm font-400 items-center" data-v-35def80b=""><!--[--><a href="/" class="text--link" data-v-35def80b="">首页</a><a href="/article-list" class="text--link" data-v-35def80b="">文章</a><a href="/about" class="text--link" data-v-35def80b="">关于</a><!--]--><button class="cursor-pointer text-white bg-transparent py-0.75 px-2.5 text-sm" data-v-35def80b=""><span class="inline-block align-middle dark:i-carbon-moon i-carbon-sun"></span></button></div></div></div></header><div class="flex flex-col" style="min-height:100vh;--37938739:url(&quot;/bg1.png&quot;);" data-v-35def80b=""><div class="w-full header-cover-bg min-h-lg" data-v-35def80b=""></div><div class="content-container-wrapper dark:bg-dark" data-v-35def80b=""><div class="content-container" data-v-35def80b=""><!--[--><div class="h-55 -mt-55 flex flex-col items-center text-white"><div class="font-bold text-3xl">毕业照小程序开发复盘</div><div class="text-lg mt-2">2020-06-09</div><div class="mt-2 italic">#小程序</div></div><!--[--><div class="markdown-body"><h1>前言</h1><p><img src="/assets/graduate-qrcode.58927ec4.jpg" alt="qrcode"> 这是一个可以用来制作毕业照的微信小程序，主要使用的技术栈是<code>Taro</code>，<code>React</code>。开发总体上，主要的问题是集中在<code>资源加载优化方面</code>还有<code>画布的处理上</code>。</p><h1>资源加载优化方面</h1><p><img src="/assets/41591696515.d4cbd800.jpg" alt="decorationPage"></p><p>在这个装饰页面，以前也有见过类似的场景，是在<code>你头像真棒</code>小程序里。通过点击底下的图片，来更换画布中的背景图。但是不同于上一个场景，上一个场景加载的图片资源大多是一些头像挂件，体积都不大且数量不多，这里的图片资源数量比较多，除了体积大不的挂件，更多的是体积比较大的背景图。虽然图片资源都有进行了一定程度的压缩，但是总体的体积还是很大，加载完这个页面的资源需要<code>20+M</code>的流量，这个加载时长是不能接受的，而且这也会造成加载时滑动的卡顿。</p><p>此外，还有一点对象存储 OSS 的计费和图片的请求次数有关系，因此如果更降低图片的请求次数也是对加载的优化。</p><p><img src="/assets/subPackage.0a6fd890.png" alt="subPackage"></p><p>最后的方案是，对原先的高清图进行有损压缩并利用的小程序的<code>分包加载</code>能力，小程序的每个分包大小不超过 2M。将该页面所有缩略图控制在 2M 内，并作为缓存放进小程序的分包中。由于高清图资源的地址需要通过接口获取，因此需要建立高清图的 URL 和分包中对应的缩略图的地址的映射关系来进行优化。</p><pre class="language-jsx"><code class="language-jsx"><span class="token comment">// thumbnail.js</span>
<span class="token keyword">const</span> thumbnailMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span>
  <span class="token punctuation">[</span>
    <span class="token punctuation">[</span>
      <span class="token string">"https://graphbed.example.com/graduate/sdfovhidsf1"</span><span class="token punctuation">,</span>
      <span class="token string">"/subPackage/package1/assets/1.png"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
      <span class="token string">"https://graphbed.example.com/graduate/67sdf87sd6f"</span><span class="token punctuation">,</span>
      <span class="token string">"/subPackage/package1/assets/2.png"</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">)</span>

<span class="token comment">// page.jsx</span>

<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> src <span class="token operator">=</span> <span class="token string">'https://graphbed.example.com/graduate/sdfovhidsf1'</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Image</span></span> <span class="token attr-name">src</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>thumbnailMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span> <span class="token operator">||</span> src<span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">
}
</span></code></pre><p>这样当后端的高清图发生更新添加了新的高清图时，缓存未命中，可以 fallback 直接请求高清图的地址。同时，也需要前端在小程序包中添加新的缩略图，发布新的版本，在此期间不会影响小程序的使用。</p><h1>画布处理上</h1><p>在画布处理上，我将另一个项目中的原生的画布组件封装成了 Taro 组件，并修改了一部分的 props。不过该组件是一个 canvas，不同于普通的组件。框架并不能直接替我计算出需要帮我增加/提换/删除页面的什么节点，因此需要我在特定的生命周期，比对 props 的变化，操作 canvas context 的 api，重新进行渲染。因此要求传入的 props 的<code>graphArray</code>的每一个元素都应该有一个<code>key</code>，便于我追踪每一个 graph 的具体变化。</p></div><!--]--><!--]--></div></div></div><!--]--></div></div>
    
  

</body></html>