<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>对JavaScript的异步机制的理解</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EZRSNLSEWX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
    </script>
    <script type="module" crossorigin="" src="/assets/app.606baedb.js"></script>
    <link rel="stylesheet" href="/assets/index.ddadd7c3.css">
  <link rel="modulepreload" crossorigin="" href="/assets/content.0a7693b1.js"><link rel="modulepreload" crossorigin="" href="/assets/ArticleWrapper.f9e95eb4.js"><link rel="stylesheet" href="/assets/ArticleWrapper.f30abf01.css"><meta property="og:title" content="对JavaScript的异步机制的理解"><meta name="head:count" content="1"></head>

  <body>
    <div id="app" data-server-rendered="true"><div class="w-full items-center justify-center m-0 p-0"><!--[--><header class="w-full fixed z-99" style="--55fa396c:url(&quot;/bg.jpg&quot;);" data-v-75913c0b=""><div class="header-navigation text--layout flex items-center justify-center" style="height:64px;background-color:transparent;" data-v-75913c0b=""><div class="flex justify-between items-center w-3xl <md:w-full" data-v-75913c0b=""><div data-v-75913c0b=""><a href="/" class="text--link" data-v-75913c0b="">ChenKS</a></div><div class="flex text-sm font-400 items-center" data-v-75913c0b=""><!--[--><a href="/" class="text--link" data-v-75913c0b="">首页</a><a href="/article-list" class="text--link" data-v-75913c0b="">文章</a><a href="/about" class="text--link" data-v-75913c0b="">关于</a><!--]--><button class="cursor-pointer text-white bg-transparent py-0.75 px-2.5 text-sm" data-v-75913c0b=""><span class="inline-block align-middle dark:i-carbon-moon i-carbon-sun"></span></button></div></div></div></header><div class="flex flex-col" style="min-height:100vh;--55fa396c:url(&quot;/bg.jpg&quot;);" data-v-75913c0b=""><div class="w-full header-cover-bg min-h-sm" data-v-75913c0b=""></div><div class="content-container-wrapper dark:bg-dark" data-v-75913c0b=""><div class="content-container" data-v-75913c0b=""><div class="flex items-start wrapper" data-v-75913c0b="" data-v-c9e79ed7=""><div class="headings" data-v-c9e79ed7=""><div class="headings-content" data-v-c9e79ed7=""><ol class="article-heading" data-v-c9e79ed7="" data-v-ef16a1ef=""><!--[--><li data-v-ef16a1ef=""><a href="#单线程异步" data-v-ef16a1ef=""><span class="article-heading-title" data-v-ef16a1ef="">1. 单线程异步</span></a><!----></li><li data-v-ef16a1ef=""><a href="#事件循环" data-v-ef16a1ef=""><span class="article-heading-title" data-v-ef16a1ef="">2. 事件循环</span></a><!----></li><li data-v-ef16a1ef=""><a href="#编写异步代码" data-v-ef16a1ef=""><span class="article-heading-title" data-v-ef16a1ef="">3. 编写异步代码</span></a><!----></li><li data-v-ef16a1ef=""><a href="#使用生成器控制异步逻辑" data-v-ef16a1ef=""><span class="article-heading-title" data-v-ef16a1ef="">4. 使用生成器控制异步逻辑</span></a><!----></li><!--]--></ol></div></div><div class="content-wrapper" data-v-c9e79ed7=""><div class="h-55 -mt-55 flex flex-col items-center text-white" data-v-c9e79ed7=""><div class="font-bold text-3xl" data-v-c9e79ed7="">对JavaScript的异步机制的理解</div><div class="text-lg mt-2" data-v-c9e79ed7="">2020-09-08</div><div class="mt-2 italic" data-v-c9e79ed7="">#JavaScript</div></div><!--[--><div class="markdown-body"><h1 id="%E5%8D%95%E7%BA%BF%E7%A8%8B%E5%BC%82%E6%AD%A5" tabindex="-1">单线程异步</h1><p><code>JavaScript</code>是一门单线程异步的语言。这听起来似乎有点奇怪，只有一个 js 线程，为什么还能实现异步的功能。实际上，js 的异步操作的执行例如网络请求、定时器，并不是在 js 线程上执行，这些能力是由宿主环境提供的。例如在浏览器上有五大线程，<code>GUI渲染引擎线程</code>、<code>JavaScript引擎线程</code>、<code>定时器触发线程</code>、<code>事件触发线程</code>、<code>http异步请求线程</code>。当我们在 js 代码中发起一个 http 请求时，除了传递相关参数，浏览器会为网络应答设置一个监听器，当得到网络应答后通过将回调函数插入事件轮询来执行。</p><h1 id="%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF" tabindex="-1">事件循环</h1><p><img src="/assets/runtime.e4f0de70.jpeg" alt="runtime"></p><p>每一个<code>JvaScript</code>运行时都会有一个<code>Heap</code>，<code>Stack</code>，<code>Callback Queue</code>，会不断地执行清空调用栈，然后又从事件队列中取出一个任务执行，依次往复，直至事件队列为空。</p><h1 id="%E7%BC%96%E5%86%99%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81" tabindex="-1">编写异步代码</h1><p>我们可以通过<code>回调函数</code>、<code>Promise</code>、<code>async await</code>编写异步逻辑的代码。但是要注意到使用回调函数会有代码<code>回调地狱</code>的问题。使用回调函数还有其他不好的地方，使用它会将代码的控制权给了其他函数，因为我们并不清楚这个函数会怎么调用我们编写的回调函数，并且我们也无法进行干预。</p><p>使用<code>Promise</code>可以解决上面回调函数的弊端，但是也有代码可读性不好的问题。用<code>async</code> <code>await</code>可以让我们使用比较类似同步的语法编写异步逻辑。</p><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// 回调函数</span>
<span class="token keyword">function</span> <span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">"https://example.com/login"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">reason<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用Promise</span>
<span class="token keyword">function</span> <span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"https://example.com/login"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用async await</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">func3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"https://example.com/login"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h1 id="%E4%BD%BF%E7%94%A8%E7%94%9F%E6%88%90%E5%99%A8%E6%8E%A7%E5%88%B6%E5%BC%82%E6%AD%A5%E9%80%BB%E8%BE%91" tabindex="-1">使用生成器控制异步逻辑</h1><p>使用<code>async</code> <code>await</code>可以帮助我们比较好地写出异步逻辑的代码，但是并不能很好地解决我们对于代码异步逻辑测试的需求，使用<code>async</code>函数，函数调用者对于内部的异步逻辑的具体执行是无法感知的，只能有函数执行中、函数执行成功、函数执行失败三种状态。借助 ES6 中的<code>Generator Function</code>我们可以将函数中对异步逻辑的执行很好地暴露给外部，这样可以更好地控制异步逻辑以及测试，可以帮助我们让测试代码更好地覆盖到比较大的包含异步逻辑的函数。</p><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// util.js</span>
<span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">seconds</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> seconds <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">CallDto</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>fn <span class="token operator">=</span> fn<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> args<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">call</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">CallDto</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">asyncWrapper</span> <span class="token operator">=</span>
  <span class="token punctuation">(</span><span class="token parameter">generatorFunc</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * @type {Generator}
     */</span>
    <span class="token keyword">const</span> generator <span class="token operator">=</span> <span class="token function">generatorFunc</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> done <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> iteratorArgs <span class="token operator">=</span> args<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> iteratorResult <span class="token operator">=</span> generator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>iteratorArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
      done <span class="token operator">=</span> iteratorResult<span class="token punctuation">.</span>done<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>iteratorResult<span class="token punctuation">.</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        iteratorArgs <span class="token operator">=</span> <span class="token keyword">await</span> iteratorResult<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>iteratorResult<span class="token punctuation">.</span>value <span class="token keyword">instanceof</span> <span class="token class-name">CallDto</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> fn<span class="token punctuation">,</span> args <span class="token punctuation">}</span> <span class="token operator">=</span> iteratorResult<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        iteratorArgs <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fn</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        iteratorArgs <span class="token operator">=</span> iteratorResult<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  sleep<span class="token punctuation">,</span>
  call<span class="token punctuation">,</span>
  asyncWrapper<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// sleep.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> sleep<span class="token punctuation">,</span> call <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./util"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">chenSleep</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"start sleep"</span><span class="token punctuation">,</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span> <span class="token function">sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"awake"</span><span class="token punctuation">,</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span> <span class="token function">call</span><span class="token punctuation">(</span>sleep<span class="token punctuation">,</span> time <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"awake again"</span><span class="token punctuation">,</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> chenSleep <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// index.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> asyncWrapper <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./util"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> chenSleep <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./sleep"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">asyncWrapper</span><span class="token punctuation">(</span>chenSleep<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// index.spec.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> chenSleep <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./sleep"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> describe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"mocha"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"assert"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"test chen sleep well"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> generator <span class="token operator">=</span> <span class="token function">chenSleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"expected to be a Promise"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>generator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"expected sleep 4 seconds"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>generator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 运行 index.js
 * start sleep 1599557846539
 * awake 1599557848556
 * awake again 1599557852561
 */</span>

<span class="token comment">/**
 * 运行 mocha index.spec.js
 *    test chen sleep well
 * start sleep 1599557891720
 *     ✓ expected to be a Promise
 * awake 1599557891724
 *     ✓ expected sleep 4 seconds
 *
 *
 *   2 passing (15ms)
 */</span>
</code></pre></div><!--]--><div class="mt-20" data-v-c9e79ed7=""><!----></div></div></div></div></div></div><!--]--></div></div>
    
  

</body></html>