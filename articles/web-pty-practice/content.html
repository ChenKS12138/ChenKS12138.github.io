<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>动手写一个web pty</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EZRSNLSEWX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
    </script>
    <script type="module" crossorigin="" src="/assets/app.83cb956a.js"></script>
    <link rel="stylesheet" href="/assets/index.27166dc9.css">
  <link rel="modulepreload" crossorigin="" href="/assets/content.a96789d6.js"></head>

  <body>
    <div id="app" data-server-rendered="true"><div class="w-full items-center justify-center m-0 p-0"><!--[--><header class="w-full fixed z-99" style="--3eedde64:url(&quot;/bg1.png&quot;);" data-v-686bff37=""><div class="header-navigation text--layout flex items-center justify-center" style="height:64px;background-color:transparent;" data-v-686bff37=""><div class="flex justify-between items-center w-3xl <md:w-full" data-v-686bff37=""><div data-v-686bff37=""><a href="/" class="text--link" data-v-686bff37="">ChenKS</a></div><div class="flex text-sm font-400 items-center" data-v-686bff37=""><!--[--><a href="/" class="text--link" data-v-686bff37="">Home</a><a href="/article-list" class="text--link" data-v-686bff37="">Articles</a><a href="/about" class="text--link" data-v-686bff37="">About</a><a href="/RSS" class="text--link" data-v-686bff37="">RSS</a><!--]--><button class="cursor-pointer text-white bg-transparent py-0.75 px-2.5 text-sm" data-v-686bff37=""><span class="inline-block align-middle dark:i-carbon-moon i-carbon-sun"></span><span class="pl-2">Light</span></button></div></div></div></header><div class="w-full header-cover-bg min-h-lg" style="--3eedde64:url(&quot;/bg1.png&quot;);" data-v-686bff37=""></div><div class="content-container-wrapper dark:bg-dark" style="--3eedde64:url(&quot;/bg1.png&quot;);" data-v-686bff37=""><div class="content-container" data-v-686bff37=""><!--[--><div class="h-70 -mt-70 flex flex-col items-center text-white"><div class="font-bold text-3xl">动手写一个web pty</div><div class="text-lg mt-2">2021-11-12</div><div class="mt-2 italic">#随笔</div></div><!--[--><div class="markdown-body"><h1>前言</h1><p>最近看了《the linux programming interface》<sup><a href="#1">[1]</a></sup>，总体感觉这是本好书，补充了一些课内 OS 没有告诉我，但是同样重要的东西，比较清晰地介绍了一些比较重要的概念，如<code>文件空洞</code>、<code>作业控制/进程组</code>、<code>标准信号/实时信号</code>、<code>进程的内存模型</code>、<code>僵尸进程</code>、<code>进程间通信</code>、<code>socket编程</code>、<code>ruid/euid/suid</code>、<code>elf文件</code>、<code>IO模型</code>等。书中最后一章介绍了伪终端技术，这里我想动手实现一个基于 web 的 terminal，顺便复习一下之前学到的东西。</p><h1>什么是终端</h1><p>在大型机的时代，人手一台计算机的事情是不可想象的，相比之下更为常见的是用户通过一台终端设备接入大型机。随着个人计算机的普及，我们通常不再需要单独的终端设备连接我们的计算机，提到的终端更多的是虚拟终端。从虚拟终端的实现上又分为 tty 和 pty<sup><a href="#2">[2]</a></sup>。tty/pty 连接了用户空间的进程和外部的输入输出设备，不同之处在于 tty 连接的是内核的终端模拟器，终端模拟器外部对应真实的外设，pts 通过 ptmx 连接到其他用户空间进程。</p><h1>web 终端的实现</h1><h2>实现目标及方式</h2><p><img src="/assets/1.a53b96ec.png" alt="aliyun-web-terminal"></p><p><img src="/assets/2.1df95839.png" alt="addon"></p><p>我们在使用各家云服务的计算时，都会提供一个 web 的终端，我的目标就是实现一个类似的 web 服务，通过 websocket 进行通信。同时因为 Node.js 的 Built-in 模块不提供伪终端相关的 api，我编写调用相关系统调用的 Node.js Addon。</p><h2>实现原理</h2><p>主要的流程如下</p><ol><li>进程调用<code>posix_openpt</code>获取伪终端主设备 fd</li><li>进程调用<code>fork</code>生成子进程，父进程返回主设备 fd</li><li>子进程打开伪终端从设备 fd，并将<code>stdin</code>,<code>stdout</code>,'stderr`改为伪终端从设备</li><li>执行 exec，一般是 shell 程序</li></ol><p>关闭伪终端时，需要对子进程发送<code>SIGHUP</code>，通知其终端将关闭。</p><p>上述流程编写完后，使用<code>nan</code>wrap 一层后，即可成为 addon。Node.js 服务获取到伪终端主设备 fd 后，封装为一个 Stream。因为 node.js 使用的是异步 I/O，不能直接阻塞。</p><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">fd_add_cloexec</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> flags<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_GETFD<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pts_fatal</span><span class="token punctuation">(</span><span class="token string">"fcntl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    flags <span class="token operator">|=</span> FD_CLOEXEC<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETFD<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">create_pts</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> child_pid_ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> master_tty_fd<span class="token punctuation">,</span> slave_tty_fd<span class="token punctuation">,</span> child_pid<span class="token punctuation">;</span>
    <span class="token keyword">char</span> slave_tty_name<span class="token punctuation">[</span>FILENAME_MAX<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">*</span>str<span class="token punctuation">,</span> <span class="token operator">*</span>shell<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> sia<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>child_pid_ptr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        child_pid_ptr <span class="token operator">=</span> <span class="token operator">&amp;</span>child_pid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>master_tty_fd <span class="token operator">=</span> <span class="token function">posix_openpt</span><span class="token punctuation">(</span>O_RDWR <span class="token operator">|</span> O_NOCTTY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pts_fatal</span><span class="token punctuation">(</span><span class="token string">"posix_openpt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fd_add_cloexec</span><span class="token punctuation">(</span>master_tty_fd<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pts_fatal</span><span class="token punctuation">(</span><span class="token string">"fd_add_cloexec"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>str <span class="token operator">=</span> <span class="token function">ptsname</span><span class="token punctuation">(</span>master_tty_fd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pts_fatal</span><span class="token punctuation">(</span><span class="token string">"ptsname"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>slave_tty_name<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlockpt</span><span class="token punctuation">(</span>master_tty_fd<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pts_fatal</span><span class="token punctuation">(</span><span class="token string">"unlockpt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>shell <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"SHELL"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        shell <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"/bin/sh"</span><span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sia<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sigaction</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sia<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sia<span class="token punctuation">.</span>sa_flags <span class="token operator">=</span> SA_RESETHAND <span class="token operator">|</span> SA_NOCLDWAIT<span class="token punctuation">;</span>
    sia<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> SIG_DFL<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sigaction</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sia<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pts_fatal</span><span class="token punctuation">(</span><span class="token string">"sigaction"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">(</span><span class="token operator">*</span>child_pid_ptr<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>child_pid_ptr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pts_fatal</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// child process</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>child_pid_ptr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token function">err_exit</span><span class="token punctuation">(</span><span class="token string">"setsid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">close</span><span class="token punctuation">(</span>master_tty_fd<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token function">err_exit</span><span class="token punctuation">(</span><span class="token string">"close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>slave_tty_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>slave_tty_name<span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token function">err_exit</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dup2</span><span class="token punctuation">(</span>slave_tty_fd<span class="token punctuation">,</span> STDIN_FILENO<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token function">err_exit</span><span class="token punctuation">(</span><span class="token string">"dup2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dup2</span><span class="token punctuation">(</span>slave_tty_fd<span class="token punctuation">,</span> STDOUT_FILENO<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token function">err_exit</span><span class="token punctuation">(</span><span class="token string">"dup2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dup2</span><span class="token punctuation">(</span>slave_tty_fd<span class="token punctuation">,</span> STDERR_FILENO<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token function">err_exit</span><span class="token punctuation">(</span><span class="token string">"dup2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">execlp</span><span class="token punctuation">(</span>shell<span class="token punctuation">,</span> shell<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">err_exit</span><span class="token punctuation">(</span><span class="token string">"execlp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> master_tty_fd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">kill_pts_child</span><span class="token punctuation">(</span><span class="token keyword">int</span> child_pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">kill</span><span class="token punctuation">(</span>child_pid<span class="token punctuation">,</span> SIGHUP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">resize_pts</span><span class="token punctuation">(</span><span class="token keyword">int</span> pts_fd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> rows<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> cols<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">winsize</span> wsize<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>pts_fd<span class="token punctuation">,</span> TIOCGWINSZ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsize<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pts_fatal</span><span class="token punctuation">(</span><span class="token string">"ioctl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    wsize<span class="token punctuation">.</span>ws_row <span class="token operator">=</span> rows<span class="token punctuation">;</span>
    wsize<span class="token punctuation">.</span>ws_col <span class="token operator">=</span> cols<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>pts_fd<span class="token punctuation">,</span> TIOCSWINSZ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsize<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pts_fatal</span><span class="token punctuation">(</span><span class="token string">"ioctl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"stream"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ptsAddon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./pts-addon"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">PtsStream</span> <span class="token keyword">extends</span> <span class="token class-name">stream<span class="token punctuation">.</span>Duplex</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ptsFd<span class="token punctuation">,</span> childPid <span class="token punctuation">}</span> <span class="token operator">=</span> ptsAddon<span class="token punctuation">.</span><span class="token function">createPts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ptsFd <span class="token operator">=</span> ptsFd<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>childPid <span class="token operator">=</span> childPid<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">_destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ptsFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ptsAddon<span class="token punctuation">.</span><span class="token function">killPtsChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>childPid<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">_read</span><span class="token punctuation">(</span><span class="token parameter">size</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ptsFd<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">length</span><span class="token operator">:</span> size<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> bytesRead<span class="token punctuation">,</span> buffer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">||</span> bytesRead <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> bytesRead<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">_write</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ptsFd<span class="token punctuation">,</span> chunk<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">resize</span><span class="token punctuation">(</span><span class="token parameter">rows<span class="token punctuation">,</span> cols</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ptsAddon<span class="token punctuation">.</span><span class="token function">resizePts</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ptsFd<span class="token punctuation">,</span> rows<span class="token punctuation">,</span> cols<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> PtsStream <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><h2>实现效果</h2><p>Github 仓库 <a href="https://github.com/ChenKS12138/web-pty">https://github.com/ChenKS12138/web-pty</a></p><p><img src="/assets/3.006803f8.png" alt="result"></p><p><img src="/assets/4.361b0fc0.png" alt="result-vim"></p><p>对窗口的调整做了适配，因此 vim 等编辑器也可以正常工作。</p><h1>结语</h1><p>之前遇到 linux 方面的问题，大都是通过直接 Google 搜索报错信息找到解决方案。看完 tlpi 了解了这些概念后对 linux 内核如何运作有了基本的认知，处理问题时心中可以有个模型，能够理解内核中发生的事件，排查问题时更有针对性。这也是我认为工程师区别于其他普通人的地方，其他人只能看到表象，但是工程师理解表象背后的系统运作逻辑。</p><h1>参考引用</h1><ul><li>[1] <a href="https://man7.org/tlpi/">https://man7.org/tlpi/</a></li><li>[2] <a href="https://zhuanlan.zhihu.com/p/97018747">https://zhuanlan.zhihu.com/p/97018747</a></li></ul></div><!--]--><div class="rounded bg-gray mt-10 p-1 text-white italic indent-md text-lg"> CC BY-SA 3.0协议 。转载请注明出处! </div><!--]--></div></div><!--]--></div></div>
    
  

</body></html>