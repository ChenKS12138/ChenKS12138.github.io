<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>使用WebAssembly构建FaaS服务</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EZRSNLSEWX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
    </script>
    <script type="module" crossorigin="" src="/assets/app.f9f8d20c.js"></script>
    <link rel="stylesheet" href="/assets/index.18aa5f7c.css">
  <link rel="modulepreload" crossorigin="" href="/assets/content.b6a0fae5.js"></head>

  <body>
    <div id="app" data-server-rendered="true"><div class="w-full items-center justify-center m-0 p-0"><!--[--><header class="w-full fixed z-99" style="--37938739:url(&quot;/bg1.png&quot;);" data-v-35def80b=""><div class="header-navigation text--layout flex items-center justify-center" style="height:64px;background-color:transparent;" data-v-35def80b=""><div class="flex justify-between items-center w-3xl <md:w-full" data-v-35def80b=""><div data-v-35def80b=""><a href="/" class="text--link" data-v-35def80b="">ChenKS</a></div><div class="flex text-sm font-400 items-center" data-v-35def80b=""><!--[--><a href="/" class="text--link" data-v-35def80b="">首页</a><a href="/article-list" class="text--link" data-v-35def80b="">文章</a><a href="/about" class="text--link" data-v-35def80b="">关于</a><!--]--><button class="cursor-pointer text-white bg-transparent py-0.75 px-2.5 text-sm" data-v-35def80b=""><span class="inline-block align-middle dark:i-carbon-moon i-carbon-sun"></span></button></div></div></div></header><div class="flex flex-col" style="min-height:100vh;--37938739:url(&quot;/bg1.png&quot;);" data-v-35def80b=""><div class="w-full header-cover-bg min-h-lg" data-v-35def80b=""></div><div class="content-container-wrapper dark:bg-dark" data-v-35def80b=""><div class="content-container" data-v-35def80b=""><!--[--><div class="h-55 -mt-55 flex flex-col items-center text-white"><div class="font-bold text-3xl">使用WebAssembly构建FaaS服务</div><div class="text-lg mt-2">2022-06-03</div><div class="mt-2 italic">#Web</div></div><!--[--><div class="markdown-body"><p>有一段是没有写博客了，这一段时间了解了不少新技术，但是没来得及写成博客总结。WebAssembly和Rust是我一直在关注的两项技术，这段时间使用它们编写了一个FaaS服务工具。</p><h1>动机</h1><p>作为一个Web开发者，我总希望能有这样一套工具/系统/流程。它能给我提供一套模板，我只需要简单地编写Restful服务的核心代码，整个过程足够优雅。</p><ul><li><p>性能/性能方面</p><ol><li>性能足够好。服务不会有太高的内存占用，性能足够好。如果能方便地进行扩缩容更好。</li><li>安全性足够好。希望能够向我提供控制Restful服务访问宿主机的各项权限的能力，如IO、环境变量等。</li></ol></li><li><p>开发体验方面</p><ol start="3"><li>编程效率足够高。能给我提供注解/装饰器，我只需要编写Restful服务核心的Handler，对于路由实现、服务鉴权等问题我不需要关心或者只需要做简单的配置即可。</li><li>编译产物足够简单。希望它最终产物只有一个Bundle，且这个Bundle体积不应该太大，因为我也不会在里面写什么复杂算法，不希望我的编译器把时间/算力浪费在重复地编译HTTP Server的实现上。</li><li>部署足够方便。以往一些将整个运行环境打包发布的方式太过麻烦（没错，说的就是Node.js/Python ）。同时，如果能同静态资源一起打包发布更好，避免需要同时维护两个模块。</li><li>测试开发的重编译速度足够快。开发时服务重启速度会影响开发速度，不希望我的时间浪费在等待长时间的编译上。</li></ol></li></ul><p>由此，我开发了<a href="https://github.com/ChenKS12138/wasm-lambda">wams-lambda</a>项目，虽然已有不少的Web开发解决方案，但是我认为不能满足我的这些需求。</p><h1>基于事件的FaaS</h1><p>大部分的Restful服务都是可以转化成基于事件处理的服务，这种场景下使用FaaS<sup>[1]</sup>其实更为合适，但是我们看到的更多的是，每个Restful服务都bind一个socket，单独启动了一个HttpServer，这样的Restful服务多了，性能占用自然就高了。而使用FaaS平台，不需要常驻服务监听端口，可以缩容到0，降低了对系统资源的占用。</p><h1>为什么是WebAssembly</h1><h2>WebAssembly的安全性和性能</h2><blockquote><p>WebAssembly provides no ambient access to the computing environment in which code is executed. Any inter- action with the environment, such as I/O, access to resources, or operating system calls, can only be performed by invoking functions provided by the embedder and imported into a WebAssembly module. An embedder can establish security policies suitable for a respective environment by controlling or limiting which functional capa- bilities it makes available for import. Such considerations are an embedder’s responsibility and the subject of API definitions for a specific environment.</p></blockquote><p>WebAssembly<sup>[2]</sup>是一种被用于栈式虚拟机的编码格式。最初是被设计用于Web端，因此安全性在设计之初就是重要考量。wasm模块的指令集只包含了最基础的计算能力，不会影响外部执行环境，内部需要的IO能力、系统调用等都需要由虚拟机提供。当被用于FaaS时，FaaS模块内部代码通过调用import段的特定函数实现对外部环境的访问，这些函数由虚拟机进行实现，由此我们可以轻易地对模块的环境变量、模块的系统调用以及系统调用参数进行控制，提高安全性。同时，每个虚拟机都是隔离的（包括执行栈、内存、系统调用等），即使一个虚拟机发生了crush，也不会影响到其他模块的执行。</p><p>WebAssembly的性能表现依赖于具体的runtime实现，wasm的指令集是对真实世界计算机指令集的抽象<sup>[3]</sup>，不仅可以对wasm进行解释执行，还可以进行JIT/AOT，让代码以native的方式执行。</p><h2>冷启动速度</h2><p>FaaS缩容可以到0，因此冷启动问题<sup>[4]</sup>是FaaS相对于PaaS需要多处理的一个比较大的问题。不同于OpenFaaS等方案，运行一个wasm模块不需要单独启动一个容器，wasm运行时本身就是一个沙箱，因此可以比较好地应对冷启动问题，其主要的时间开销为从代码存储中拉取代码。</p><h1>Runtime Library</h1><p>wasm-lambda提供了wasm-lambda-bridge的crate供FaaS模块调用，定义了一系列hostcall。每个wasm模块通过hostcall获取到事件，与宿主环境(host)进行通信。但是还不够开发者友好，因此wasm-lambda-bridge对hostcall进行了进一步封装，对事件进行解析，并派发给其他Handler，实现更优雅的编程。</p><pre class="language-rust"><code class="language-rust"><span class="token comment">// 直接调用raw hostcall</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">wasm_lambda_bridge<span class="token punctuation">::</span>core<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">value<span class="token punctuation">::</span></span><span class="token class-name">Response</span><span class="token punctuation">,</span><span class="token namespace">hostcall<span class="token punctuation">::</span>raw<span class="token punctuation">::</span></span>event_reply<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">let</span> reply <span class="token operator">=</span> <span class="token class-name">Response</span> <span class="token punctuation">{</span>
				value<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
				headers<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				body<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token namespace">bson<span class="token punctuation">::</span></span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>reply<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token function">event_reply</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">as_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用Runtime Library</span>
<span class="token keyword">use</span> <span class="token namespace">wasm_lambda_bridge<span class="token punctuation">::</span></span><span class="token punctuation">{</span>make_response<span class="token punctuation">,</span>codegen<span class="token punctuation">,</span><span class="token namespace">value<span class="token punctuation">::</span></span><span class="token class-name">Response</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token attribute attr-name">#[codegen::main]</span> 
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Response</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">make_response!</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><h2>基于洋葱路由的事件处理中间件</h2><p><img src="/assets/1.e07e3d7f.png" alt="onion model"></p><pre class="language-rust"><code class="language-rust"><span class="token attribute attr-name">#[middleware]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">not_found</span><span class="token punctuation">(</span>context<span class="token punctuation">:</span> <span class="token class-name">MiddlewareContext</span><span class="token punctuation">,</span> next<span class="token punctuation">:</span> <span class="token class-name">MiddlewareNext</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">MiddlewareContext</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> context <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> context<span class="token number">.1</span><span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        context<span class="token number">.1</span> <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token macro property">make_response!</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token string">"404 Not Found"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    context
<span class="token punctuation">}</span>
</code></pre><p>熟悉Koa.js的人对这个概念一定不陌生，这让我们的中间件有了两次被触发的机会，并且都写在了一个函数里。一些常见的中间件能力，如请求日志、错误捕获、处理未匹配路由都可以被实现。</p><h2>使用Rust宏减少重复编码</h2><p>我喜欢Rust的一个重要原因就是其强大的宏能力，它让我能够做到DRY(Don’t Repeat Yourself)，或者是在Rust代码里再实现一套自己的DSL(Domain Specific Language)。Rust宏主要包括了声明式宏和过程宏。声明式宏编写匹配规则返回代码，更容易编写，能力有限；过程宏编写函数处理TokenStrema返回TokenStream，较为复杂，能力强大。Rust宏的使用这里不做赘述。</p><h3><code>main</code>生成入口函数</h3><p>使用过程宏重新wrap了传入的main函数，一方面使得代码更为简洁，另一方面避免了开发时遗忘返回响应。</p><p><img src="/assets/2.f38576f8.png" alt="main"></p><h3><code>#[get]</code>等生成route生成函数</h3><p>使用<code>装饰器/注解</code>编写Restful服务的路由是我认为比较优雅的方式，这在<code>flask</code>和<code>Sprint Boot</code>中很常见，一方面使得代码更为直观，另一方面也使得后续使用代码生成文档更为容易。</p><p><img src="/assets/5.c8d74bc7.png" alt="routes"></p><p>同时对传入的函数参数进行解析，从请求事件中提取出对应的<code>Query</code>、<code>Param</code>、<code>TriggerEvent</code>、<code>Json</code>等再传入。</p><p><img src="/assets/3.d803d29c.png" alt="get"></p><h3><code>static_resource!()</code>引入资源</h3><p>使用<code>static_resource!()</code>可以在编译期间对目录进行扫描，读取目录文件并生成包含<code>include_bytes!</code>的代码，实现静态资源也能被打包在wasm模块中。</p><p><img src="/assets/4.d8dfc95f.png" alt="static_resource"></p><h1>wasm-lambda Demo</h1><ol><li>克隆并安装</li></ol><pre class="language-shell"><code class="language-shell"><span class="token function">git</span> clone https://github.com/ChenKS12138/wasm-lambda.git
<span class="token builtin class-name">cd</span> wasm-lambda
<span class="token function">cargo</span> <span class="token function">install</span> <span class="token parameter variable">--path</span> <span class="token builtin class-name">.</span>
</code></pre><ol start="2"><li>编译 Example <code>hello-world</code></li></ol><pre class="language-shell"><code class="language-shell"><span class="token builtin class-name">cd</span> examples/hello-world
<span class="token function">cargo</span> build
</code></pre><ol start="3"><li>启动</li></ol><pre class="language-shell"><code class="language-shell"><span class="token comment"># Start Dev Server</span>
wasm-lambda dev <span class="token parameter variable">--bind</span> <span class="token number">0.0</span>.0.0:3000 <span class="token parameter variable">-m</span> hello-world:./target/wasm32-wasi/debug/hello-world.wasm

<span class="token comment"># Rebuild</span>
<span class="token comment"># cargo build</span>
</code></pre><ol start="4"><li>触发请求事件</li></ol><p>打开浏览器，访问 <code>http://127.0.0.1:3000/hello-world/latest/</code></p><p>或</p><pre class="language-shell"><code class="language-shell"><span class="token function">curl</span> <span class="token parameter variable">-iL</span> http://127.0.0.1:3000/hello-world/latest/
<span class="token function">curl</span> <span class="token parameter variable">-i</span> http://127.0.0.1:3000/hello-world/latest/api/capitalize/hello-world
<span class="token function">curl</span> <span class="token parameter variable">-i</span> http://127.0.0.1:3000/hello-world/latest/api/echo-query?name<span class="token operator">=</span>cattchen<span class="token operator">&amp;</span><span class="token assign-left variable">age</span><span class="token operator">=</span><span class="token number">21</span>
<span class="token function">curl</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> POST <span class="token parameter variable">-d</span> <span class="token string">'{"name":"cattchen","age":21}'</span> http://127.0.0.1:3000/hello-world/latest/api/echo-person
</code></pre><p><img src="/assets/6.051e9f1a.png" alt="visit"></p><h1>总结</h1><p>这个项目实现还比较原始，很多东西都还没有实现或者是考虑到，后面还需要花比较多的时间来完善。</p><h1>参考资料</h1><ul><li>[1] <a href="https://aws.amazon.com/cn/blogs/china/iaas-faas-serverless/">https://aws.amazon.com/cn/blogs/china/iaas-faas-serverless/</a></li><li>[2] <a href="https://webassembly.org/">https://webassembly.org/</a></li><li>[3] <a href="https://blog.logrocket.com/webassembly-runtimes-compared/">https://blog.logrocket.com/webassembly-runtimes-compared/</a></li><li>[4] <a href="https://www.infoq.cn/article/mi0lpquvxi7bpcq7ou9u">https://www.infoq.cn/article/mi0lpquvxi7bpcq7ou9u</a></li></ul></div><!--]--><!--]--></div></div></div><!--]--></div></div>
    
  

</body></html>