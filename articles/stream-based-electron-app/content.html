<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>使用Stream编写Electron应用</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EZRSNLSEWX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
    </script>
    <script type="module" crossorigin="" src="/assets/app.bcebc84f.js"></script>
    <link rel="stylesheet" href="/assets/index.7901d2da.css">
  <link rel="modulepreload" crossorigin="" href="/assets/content.b612cb89.js"></head>

  <body>
    <div id="app" data-server-rendered="true"><div class="w-full items-center justify-center m-0 p-0"><!--[--><header class="w-full fixed z-99" style="--37938739:url(&quot;/bg1.png&quot;);" data-v-35def80b=""><div class="header-navigation text--layout flex items-center justify-center" style="height:64px;background-color:transparent;" data-v-35def80b=""><div class="flex justify-between items-center w-3xl <md:w-full" data-v-35def80b=""><div data-v-35def80b=""><a href="/" class="text--link" data-v-35def80b="">ChenKS</a></div><div class="flex text-sm font-400 items-center" data-v-35def80b=""><!--[--><a href="/" class="text--link" data-v-35def80b="">首页</a><a href="/article-list" class="text--link" data-v-35def80b="">文章</a><a href="/about" class="text--link" data-v-35def80b="">关于</a><!--]--><button class="cursor-pointer text-white bg-transparent py-0.75 px-2.5 text-sm" data-v-35def80b=""><span class="inline-block align-middle dark:i-carbon-moon i-carbon-sun"></span></button></div></div></div></header><div class="flex flex-col" style="min-height:100vh;--37938739:url(&quot;/bg1.png&quot;);" data-v-35def80b=""><div class="w-full header-cover-bg min-h-lg" data-v-35def80b=""></div><div class="content-container-wrapper dark:bg-dark" data-v-35def80b=""><div class="content-container" data-v-35def80b=""><!--[--><div class="h-55 -mt-55 flex flex-col items-center text-white"><div class="font-bold text-3xl">使用Stream编写Electron应用</div><div class="text-lg mt-2">2021-05-04</div><div class="mt-2 italic">#JavaScript</div></div><!--[--><div class="markdown-body"><h1>Stream 的概念</h1><p>Steram 是 Nodejs 中比较重要的概念，它是对一些流动数据的处理过程的抽象。常见的像标准输入/输出流、文件、Socket、压缩过程都可以被抽象成 Nodejs 中的流。所有的流本质上都是 EventEmitter。</p><blockquote><p>A stream is an abstract interface for working with streaming data in Node.js. The stream module provides an API for implementing the stream interface.</p><p>There are many stream objects provided by Node.js. For instance, a request to an HTTP server and process.stdout are both stream instances.</p><p>Streams can be readable, writable, or both. All streams are instances of EventEmitter.</p></blockquote><p>常见的流有 Writable，Readable，Duplex，Transform 等<sup><a href="#reference-1">[1]</a></sup>。Readable 可以理解为是生产者，提供一个 read 方法，处在一个 pipeline 的上游，Writeable 可以理解为消费者，提供一个 write 方法，处在一个 pipeline 的下游，Duplex 兼具 read 和 write 方法，Transform 和 Duplex 很类似，区别在于 Transform 的数据的流入和流出有比较强的关系，可以用于压缩等场景。</p><h1>基于 TCP 白板应用</h1><p>这是一个基于 TCP 通信的电子白板 Electron 应用，多个应用实例启动，其中一个实例作为 TCP 服务端，其他实例加入。服务端实例可以向自身的信息，每个客户端实例可以接受服务端的信息并同步到自己的画布上，又或者是将自己的信息透过服务端实例广播给其他客户端实例。当服务端实例监听到有新的客户端实例中途加入时，会将自身的画布信息同步给它。</p><p><img src="/assets/example.ce5ef05e.gif" alt="example"></p><p>这个画布功能的实现主要是通过监听鼠标在 canvas 上的操作，获取和修改 canvas 的 imageData 实现的。使用 ipc 通信，将数据传递给 main process。再经过节流、差异比对、数据压缩、将数据块大小编码至数据块前部这样一些操作后，再广播给其他实例。</p><pre class="language-javascript"><code class="language-javascript"><span class="token comment">/**
 * Server Instance
 */</span>

<span class="token comment">// Pipe Msg, Server -&gt; Client</span>
stream<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">EmitterEventStream</span><span class="token punctuation">(</span>ipcMain<span class="token punctuation">,</span> events<span class="token punctuation">.</span><span class="token constant">SERVER_BROADCAST_MESSAGE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">ThrottleStream</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">GenerateDiffStream</span><span class="token punctuation">(</span>bitmapBuffer<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">CompressStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">SizePrefixedChunkEncodeStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  broadcastStream<span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Pipe Msg, Client -&gt; Server</span>
stream<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span>
  broadcastStream<span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">SizePrefixedChunkDecodeStream</span><span class="token punctuation">(</span><span class="token number">960000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">DecompressStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">ApplyDiffStream</span><span class="token punctuation">(</span>bitmapBuffer<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">WebContentsEventStream</span><span class="token punctuation">(</span>
    mainWindow<span class="token punctuation">.</span>webContents<span class="token punctuation">,</span>
    events<span class="token punctuation">.</span><span class="token constant">SERVER_ON_RECERIVED_BROADCAST_MESSAGE</span>
  <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Client Instance
 */</span>

<span class="token comment">// Pipe Msg, Server -&gt; Client</span>
stream<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span>
  connection<span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">SizePrefixedChunkDecodeStream</span><span class="token punctuation">(</span><span class="token number">960000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">DecompressStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">ApplyDiffStream</span><span class="token punctuation">(</span>bitmapBuffer<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">WebContentsEventStream</span><span class="token punctuation">(</span>
    mainWindow<span class="token punctuation">.</span>webContents<span class="token punctuation">,</span>
    events<span class="token punctuation">.</span><span class="token constant">CLIENT_ON_RECEIVED_BROADCAST_MESSAGE</span>
  <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Pipe Msg, Client -&gt; Server</span>
stream<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">EmitterEventStream</span><span class="token punctuation">(</span>ipcMain<span class="token punctuation">,</span> events<span class="token punctuation">.</span><span class="token constant">CLIENT_BROADCAST_MESSAGE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">ThrottleStream</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">GenerateDiffStream</span><span class="token punctuation">(</span>bitmapBuffer<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">CompressStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">SizePrefixedChunkEncodeStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  connection<span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>TCP 是面向流的协议<sup><a href="#reference-1">[2]</a></sup>，发送一个 chunk 后，chunk 可能会被拆分。接收端需要一个长度信息，将 chunk 重新组合。我通过<code>SizePrefixedChunkEncodeStream</code>和<code>SizePrefixedChunkDecodeStream</code>实现了这一个功能。</p><p>通过数据的简单观察发现，在使用<code>zlib.deflate</code>和<code>zlib.inflate</code>压缩 600x400x4 字节的 chunk 时，chunk 的 0x00 的字节越多，压缩效果越明显。所以我使用了计算/应用 diff 的流、压缩/解压缩的流。</p><h2>参考引用</h2><ul><li>[1] <a href="https://www.barretlee.com/blog/2017/06/06/dive-to-nodejs-at-stream-module/">https://www.barretlee.com/blog/2017/06/06/dive-to-nodejs-at-stream-module/</a></li><li>[2] <a href="https://stackoverflow.com/questions/17446491/tcp-stream-vs-udp-message">https://stackoverflow.com/questions/17446491/tcp-stream-vs-udp-message</a></li></ul></div><!--]--><!--]--></div></div></div><!--]--></div></div>
    
  

</body></html>