<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>web应用加载优化相关</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EZRSNLSEWX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
    </script>
    <script type="module" crossorigin="" src="/assets/app.6ad4236d.js"></script>
    <link rel="stylesheet" href="/assets/index.9cdf326d.css">
  <link rel="modulepreload" crossorigin="" href="/assets/content.a2643d0c.js"></head>

  <body>
    <div id="app" data-server-rendered="true"><div class="w-full items-center justify-center m-0 p-0"><!--[--><header class="w-full fixed z-99" style="--57bdf034:url(&quot;/bg1.png&quot;);" data-v-69cc4069=""><div class="header-navigation text--layout flex items-center justify-center" style="height:64px;background-color:transparent;" data-v-69cc4069=""><div class="flex justify-between items-center w-3xl <md:w-full" data-v-69cc4069=""><div data-v-69cc4069=""><a href="/" class="text--link" data-v-69cc4069="">ChenKS</a></div><div class="flex text-sm font-400 items-center" data-v-69cc4069=""><!--[--><a href="/" class="text--link" data-v-69cc4069="">Home</a><a href="/article-list" class="text--link" data-v-69cc4069="">Articles</a><a href="/about" class="text--link" data-v-69cc4069="">About</a><a href="/RSS" class="text--link" data-v-69cc4069="">RSS</a><!--]--><button class="cursor-pointer text-white bg-transparent py-0.75 px-2.5 text-sm" data-v-69cc4069=""><span class="inline-block align-middle dark:i-carbon-moon i-carbon-sun"></span><span class="pl-2">Light</span></button></div></div></div></header><div class="w-full header-cover-bg min-h-lg" style="--57bdf034:url(&quot;/bg1.png&quot;);" data-v-69cc4069=""></div><div class="content-container-wrapper dark:bg-dark" style="--57bdf034:url(&quot;/bg1.png&quot;);" data-v-69cc4069=""><div class="content-container" data-v-69cc4069=""><!--[--><div class="h-70 -mt-70 flex flex-col items-center text-white"><div class="font-bold text-3xl">web应用加载优化相关</div><div class="text-lg mt-2">2020-10-10</div><div class="mt-2 italic">#随笔</div></div><!--[--><div class="markdown-body"><h1>前言</h1><p><img src="/assets/collect-homework-first-version.0b0ae2be.png" alt="first-version"></p><p>大一上时刚学会点 php，然后自己是学习委员，作为学习委员需要经常收电子版的实验报告，从 QQ 上将实验报告一份一份下载很麻烦，为了提高效率就萌生了写一个提交作业的网站的想法。在这里我第一个使用 mysql+php+python 搭建了一个项目，现在回头看，之前写的代码确实不怎么好。没有一个管理后台，每次有需要收新的实验报告时都要改代码。不够安全，由于不清楚如何使用 php 发起 smtp 邮件请求，就采用了使用 exec 函数调用 python 程序发送邮件的方案。</p><p><img src="/assets/collect-homework-2.c6b9c97f.png" alt="collect-homework-second-version"></p><p>后来大一下学会了点 Vue.js Node.js ，进行了重写了，使用了 ElementUI 这个组件库，解决了上一版的两个主要问题，了解到了 session、cookie、可以使用 gzip 这类压缩算法压缩 HTTP 响应，加快响应。</p><p><img src="/assets/collect-homework-3.38de6b18.png" alt="collect-homework-3"></p><p>现在大三了，国庆期间又重写了代码，后端部分的代码试水了 golang，postgres，golang 有 python 的开发效率，有接近 C++的性能。我觉得这门语言设计者是个十足的偏执狂，golang 在代码格式的要求上要求很严格，<code>else if</code>是不换行的，代码格式不正确，编译不通过。前端部分，使用的技术栈是<code>react</code>+<code>redux</code>+<code>redux-saga</code>+<code>saga-duck</code>+<code>antd</code>，在实习期间了解到了<code>saga-duck</code>这个库，和<code>dvajs</code>有点类似，但是在与 typescript 的契合上更优，duck 间不仅有继承关系，还有组合关系。saga-duck 是使用了 ducks 模式管理了 redux 相关的一些代码，避免代码过于分散。在使用时，我没有使用官方的<code>duckRuntime</code>连接<code>redux</code>，我自己写了一个<code>useSagaDuckState</code>的 hook 函数，我认为并没有必要把所有页面组件级别的<code>state</code>都放在<code>store</code>中，使用<code>saga-duck</code>更多的是希望管理好当前页面的<code>state</code>，因此使用一个通过调用<code>useReducer</code>创建页面组件级别的<code>store</code>的<code>useSagaDuckState</code>的 hook 函数可能会更加符合场景需求。</p><p>期间我也了解了 jwt、HTTP 缓存、webpack、docker 这些技术，尽管使用了一台带宽更小的服务器（1Mbps），但是加载效果依然不错。</p><h2>服务端的配置优化</h2><p>这部分的优化主要是在服务端的 nginx 中，通过配置资源类请求的响应头，来实现缓存。可以通过增加 <code>expire</code> <code>cache-control</code>这类响应头字段来使客户端对资源进行缓存，减轻服务端压力。<code>expire</code>可以规定资源的到期时间，在到期时间前，会直接使用缓存。使用<code>cache-control</code>响应头可以规定资源的缓存时间长度。同时，通过浏览器可以通过资源请求响应的 e-tag，和服务器端确认资源的新鲜程度。</p><p><img src="/assets/collect-homework-http-cache.b4238ec0.png" alt="collect-homework-http-cache.png"></p><p>通过开启<code>gzip</code>这类压缩算法，可以优先降低实际传输的资源的大小</p><p>HTTP2 提供了多路复用的功能，可以提高多个并发连接时的性能。</p><h2>webpack 打包优化</h2><h3>使用代码分割</h3><p>这个是 webapck4 中新增的功能，我们可以将多个 chunk 中的共同的部分提取出来，减少重复的代码，从总体上减少传输量。同时对于 vendor_chunk 我们也可以对其进行拆分，将不怎么变动的依赖像 react、redux、antd 之类的，单独放在一个 js 文件中，以达到更好的利用 HTTP 缓存的目的。最初将多个 js 文件合并打包到一个文件里是为了减少 HTTP 连接数，但是现在 HTTP2 多个请求可同时在一个连接上并行执行，或许将这类的依赖拆分出来可以提升缓存效果。</p><h3>使用懒加载</h3><p>懒加载是 webpack 提供的一项能力，可以配合 React16 中的 Suspense 和 lazy 使用。从我的这个项目场景分析看，大部分的用户都是只访问主页的，只有少数用户会访问其他页面，因此这里有必要将其他页面代码分离出来，当需要进入其他页面时再进行加载。</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> loadingElement <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Loading</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">;</span>

<span class="token keyword">const</span> AuthPage <span class="token operator">=</span> <span class="token function">loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">loader</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token keyword">import</span><span class="token punctuation">(</span>
      <span class="token comment">/*webpackChunkName: 'auth_page' */</span>
      <span class="token string">"@/containers/AuthPage/AuthPage"</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">loading</span><span class="token operator">:</span> loadingElement<span class="token punctuation">,</span>
  <span class="token literal-property property">minDuration</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> HelpPage <span class="token operator">=</span> <span class="token function">loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">loader</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token keyword">import</span><span class="token punctuation">(</span>
      <span class="token comment">/*webpackChunkName: 'help_page' */</span>
      <span class="token string">"@/containers/HelpPage/HelpPage"</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">loading</span><span class="token operator">:</span> loadingElement<span class="token punctuation">,</span>
  <span class="token literal-property property">minDuration</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> AdminPage <span class="token operator">=</span> <span class="token function">loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">loader</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token keyword">import</span><span class="token punctuation">(</span>
      <span class="token comment">/*webpackChunkName: 'admin_page' */</span>
      <span class="token string">"@/containers/AdminPage/AdminPage"</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">loading</span><span class="token operator">:</span> loadingElement<span class="token punctuation">,</span>
  <span class="token literal-property property">minDuration</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AppWrapper</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Router</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token string">"/detail/:id"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ListPage</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Route</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token string">"/auth"</span><span class="token punctuation">,</span> <span class="token string">"/auth/registry"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AuthPage</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Route</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token string">"/admin"</span><span class="token punctuation">,</span> <span class="token string">"/admin/create"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AdminPage</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Route</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token string">"/help"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">HelpPage</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Route</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Router</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">GlobalStyle</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">AppWrapper</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h3>分析打包结果</h3><p>使用 webpack-bundle-analyzer 分析体积较大的 vendor，一些依赖可能体积很大，但是只需要使用少数的 api，就可以考虑自己实现一下相关的函数</p><h2>加载效果优化</h2><p>SPA 应用令人诟病的一点就是页面的加载白屏时间长，浏览器加载 html 文件后，还需要加载相关的 css、js 文件，我们可以在 React 在页面 mount 的标签中放上 loading，当相关文件加载完后，loading 会被自动替换。</p></div><!--]--><div class="rounded bg-gray mt-10 p-1 text-white italic indent-md text-lg"> CC BY-SA 3.0协议 。转载请注明出处! </div><!--]--></div></div><!--]--></div></div>
    
  

</body></html>