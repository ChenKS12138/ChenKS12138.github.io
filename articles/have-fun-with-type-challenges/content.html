<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>使用TypeScript做类型体操-ObjectKeyPaths</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EZRSNLSEWX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
    </script>
    <script type="module" crossorigin="" src="/assets/app.606baedb.js"></script>
    <link rel="stylesheet" href="/assets/index.ddadd7c3.css">
  <link rel="modulepreload" crossorigin="" href="/assets/content.a33d7537.js"><link rel="modulepreload" crossorigin="" href="/assets/ArticleWrapper.f9e95eb4.js"><link rel="stylesheet" href="/assets/ArticleWrapper.f30abf01.css"><meta property="og:title" content="使用TypeScript做类型体操-ObjectKeyPaths"><meta name="head:count" content="1"></head>

  <body>
    <div id="app" data-server-rendered="true"><div class="w-full items-center justify-center m-0 p-0"><!--[--><header class="w-full fixed z-99" style="--55fa396c:url(&quot;/bg.jpg&quot;);" data-v-75913c0b=""><div class="header-navigation text--layout flex items-center justify-center" style="height:64px;background-color:transparent;" data-v-75913c0b=""><div class="flex justify-between items-center w-3xl <md:w-full" data-v-75913c0b=""><div data-v-75913c0b=""><a href="/" class="text--link" data-v-75913c0b="">ChenKS</a></div><div class="flex text-sm font-400 items-center" data-v-75913c0b=""><!--[--><a href="/" class="text--link" data-v-75913c0b="">首页</a><a href="/article-list" class="text--link" data-v-75913c0b="">文章</a><a href="/about" class="text--link" data-v-75913c0b="">关于</a><!--]--><button class="cursor-pointer text-white bg-transparent py-0.75 px-2.5 text-sm" data-v-75913c0b=""><span class="inline-block align-middle dark:i-carbon-moon i-carbon-sun"></span></button></div></div></div></header><div class="flex flex-col" style="min-height:100vh;--55fa396c:url(&quot;/bg.jpg&quot;);" data-v-75913c0b=""><div class="w-full header-cover-bg min-h-sm" data-v-75913c0b=""></div><div class="content-container-wrapper dark:bg-dark" data-v-75913c0b=""><div class="content-container" data-v-75913c0b=""><div class="flex items-start wrapper" data-v-75913c0b="" data-v-c9e79ed7=""><div class="headings" data-v-c9e79ed7=""><div class="headings-content" data-v-c9e79ed7=""><ol class="article-heading" data-v-c9e79ed7="" data-v-ef16a1ef=""><!--[--><li data-v-ef16a1ef=""><a href="#前置知识&amp;TypeScript 类型系统" data-v-ef16a1ef=""><span class="article-heading-title" data-v-ef16a1ef="">1. 前置知识&amp;TypeScript 类型系统</span></a><!----></li><li data-v-ef16a1ef=""><a href="#实现 ObjectKeyPaths" data-v-ef16a1ef=""><span class="article-heading-title" data-v-ef16a1ef="">2. 实现 ObjectKeyPaths</span></a><!----></li><!--]--></ol></div></div><div class="content-wrapper" data-v-c9e79ed7=""><div class="h-55 -mt-55 flex flex-col items-center text-white" data-v-c9e79ed7=""><div class="font-bold text-3xl" data-v-c9e79ed7="">使用TypeScript做类型体操-ObjectKeyPaths</div><div class="text-lg mt-2" data-v-c9e79ed7="">2022-12-24</div><div class="mt-2 italic" data-v-c9e79ed7="">#JavaScript</div></div><!--[--><div class="markdown-body"><h1 id="%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%26typescript-%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F" tabindex="-1">前置知识&amp;TypeScript 类型系统</h1><p><code>TypeScript</code>可以基本被简单地理解为<code>JavaScript</code>+<code>类型注解</code>（因为 TypeScript 不会在运行时做约束，因此我更愿意称它为是一种注解）。JavaScript 是一门灵活的动态类型编程语言，正所谓，“动态类型一时爽，代码重构火葬场”，JavaScript 代码中的类型信息只能通过注释（一般是 JSDoc，但是场景也比较局限）记录，起不到约束作用。同时，也导致了代码中充斥着运行时的类型检查。而 TypeScript 的出现很好的解决了这几个问题，通过编译时检查（称之为转译会更合适一些），确保类型被正确使用。</p><p>使用 JavaScript 实现余额展示。</p><pre class="language-javascript"><code class="language-javascript"><span class="token comment">/**
 * 将分为单位的金额数值格式化展示
 * @param {number} amountCent
 */</span>
<span class="token keyword">function</span> <span class="token function">formatAmountCent</span><span class="token punctuation">(</span><span class="token parameter">amountCent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> amountCent <span class="token operator">!==</span> <span class="token string">"number"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">amountCent type error, number expected, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">typeof</span> amountCent<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> founded</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>amountCent <span class="token operator">/</span> <span class="token number">100</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">元</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>而使用 TypeScript</p><pre class="language-typescript"><code class="language-typescript"><span class="token comment">/**
 * 将分为单位的金额数值格式化展示
 */</span>
<span class="token keyword">function</span> <span class="token function">formatAmountCent</span><span class="token punctuation">(</span>amountCent<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>amountCent <span class="token operator">/</span> <span class="token number">100</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">元</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>上面的例子还不足以体现 TypeScript 的强大。如果仔细一想可能会发现这里有问题，JavaScript 作为一门灵活的动态类型语言，TypeScript 是否有足够的能力准确表达类型？一个函数入参可能有多种可能的类型，不同的入参类型需要映射到不同的返回值类型。像下面的例子，第一个函数虽然返回了类型，但是主调方其实还需要通过<code>as</code>等方式进行类型窄化，才能得到比较准确的类型；第二个函数通过了<code>Conditional Types</code>实现了比较准确的类型的计算推导。诸如此类的类型操作还有不少，可以参考<a href="https://www.typescriptlang.org/docs/handbook/2/types-from-types.html">TypeScript HandBook/Type Manipulation</a>。</p><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">type</span> <span class="token class-name">Arg</span> <span class="token operator">=</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

<span class="token keyword">declare</span> <span class="token keyword">function</span> <span class="token function">convertBetweenStringAndNumber1</span><span class="token punctuation">(</span>arg<span class="token operator">:</span> Arg<span class="token punctuation">)</span><span class="token operator">:</span> Arg<span class="token punctuation">;</span>
<span class="token keyword">const</span> t1 <span class="token operator">=</span> <span class="token function">convertBetweenStringAndNumber1</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// number | string</span>
<span class="token keyword">const</span> t2 <span class="token operator">=</span> <span class="token function">convertBetweenStringAndNumber1</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// number | string</span>

<span class="token keyword">declare</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">convertBetweenStringAndNumber2</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  arg<span class="token operator">:</span> <span class="token constant">T</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token builtin">string</span></span> <span class="token operator">?</span> <span class="token builtin">number</span> <span class="token operator">:</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token builtin">number</span></span> <span class="token operator">?</span> <span class="token builtin">string</span> <span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> t3 <span class="token operator">=</span> <span class="token function">convertBetweenStringAndNumber2</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// number</span>
<span class="token keyword">const</span> t4 <span class="token operator">=</span> <span class="token function">convertBetweenStringAndNumber2</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// string</span>
</code></pre><p><a href="https://www.typescriptlang.org/play?#code/C4TwDgpgBAggTgcygXigOwK4FsBGE5QA+UAzsHAJZoIDcAUHQCYQDGANgIZzQBmGaLYBQD2aKC1EA3fMABCEYAHcIENAGVyVBDDSMActjxwAjAAouCAFyxEASmvxadCWjJRgxlOKkz5Sleqa1Dr6hvhmAOTGAEwAzBG2NFAA9MnoYQTEZJTUzqJuwNFeLtJwcgrKqho52roGuOGmMbGJKWmYDZmkQQgMzOxcvPyCImIlvhUB1Voh9UbRADwAKgB8pnRQUBbWS3T2UEtQEAAewKqMJN01UAD86Z1QO0en55cdRrdXWo-oEKX0LgKsWKPjKfkqgRqswy0VMUTiCSSqXuRjyrmA7gALCC0KVyv4qj1oZ1Yc1WsjslogAhttps://www.typescriptlang.org/play?ssl=14&amp;ssc=52&amp;pln=14&amp;pc=58#code/C4TwDgpgBAggTgcygXigOwK4FsBGE5QA+UAzsHAJZoIDcAUHQCYQDGANgIZzQBmGaLYBQD2aKC1EA3fMABCEYAHcIENAGVyVBDDSMActjxwAjAAouCAFyxEASmvxaDZuy69+gkWIlppcOQrKqhqU1Dr6hvgATAA8ACoAfKZ0UFAW1nF09lBxUBAAHsCqjCSkmtRQAPzokQQZeYXFpZi4+FVloUjWaBB+9Aw+ZFDAxijiUjLySirq5dq6Bq0mpgDkxlEAzCu2NFAA9Hs1S0QdWnSDwMNRYz5+AdPBc+GLRmbrGzv7hy1GJ2SdA1EQ2AGxuE38UyCs06z1qUVW722uwORyM5yBl2AABYwb5JoEZiEtLClvD3p8Uf8tEA">https://www.typescriptlang.org/play?#code/C4TwDgpgBAggTgcygXigOwK4FsBGE5QA+UAzsHAJZoIDcAUHQCYQDGANgIZzQBmGaLYBQD2aKC1EA3fMABCEYAHcIENAGVyVBDDSMActjxwAjAAouCAFyxEASmvxadCWjJRgxlOKkz5Sleqa1Dr6hvhmAOTGAEwAzBG2NFAA9MnoYQTEZJTUzqJuwNFeLtJwcgrKqho52roGuOGmMbGJKWmYDZmkQQgMzOxcvPyCImIlvhUB1Voh9UbRADwAKgB8pnRQUBbWS3T2UEtQEAAewKqMJN01UAD86Z1QO0en55cdRrdXWo-oEKX0LgKsWKPjKfkqgRqswy0VMUTiCSSqXuRjyrmA7gALCC0KVyv4qj1oZ1Yc1WsjslogAhttps://www.typescriptlang.org/play?ssl=14&amp;ssc=52&amp;pln=14&amp;pc=58#code/C4TwDgpgBAggTgcygXigOwK4FsBGE5QA+UAzsHAJZoIDcAUHQCYQDGANgIZzQBmGaLYBQD2aKC1EA3fMABCEYAHcIENAGVyVBDDSMActjxwAjAAouCAFyxEASmvxaDZuy69+gkWIlppcOQrKqhqU1Dr6hvgATAA8ACoAfKZ0UFAW1nF09lBxUBAAHsCqjCSkmtRQAPzokQQZeYXFpZi4+FVloUjWaBB+9Aw+ZFDAxijiUjLySirq5dq6Bq0mpgDkxlEAzCu2NFAA9Hs1S0QdWnSDwMNRYz5+AdPBc+GLRmbrGzv7hy1GJ2SdA1EQ2AGxuE38UyCs06z1qUVW722uwORyM5yBl2AABYwb5JoEZiEtLClvD3p8Uf8tEA</a></p><h1 id="%E5%AE%9E%E7%8E%B0-objectkeypaths" tabindex="-1">实现 ObjectKeyPaths</h1><p>从上面的例子中可以看出 TypeSctipt 的类型系统类型计算推导的强大，前一段时间接触到了<a href="https://github.com/type-challenges/type-challenges">type-challenges</a>这个项目，又重新学习了一遍 TypeScript。</p><p>同时，我也想到了一个问题，lodash 的 get 方法是 javascript 开发者熟悉的一个工具函数。在第一个对象参数类型明确的情况下，我们是否可以通过类型推导，得到第二个路径参数的所有可能的字面值。</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> object <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">"a[0].b.c"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// =&gt; 3</span>

_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">"a.b.c"</span><span class="token punctuation">,</span> <span class="token string">"default"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// =&gt; 'default'</span>
</code></pre><p>我也贡献了一道题目，<a href="https://github.com/type-challenges/type-challenges/blob/main/questions/07258-hard-object-key-paths/README.md">type-challenge 题目地址</a></p><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">type</span> <span class="token class-name"><span class="token constant">T1</span></span> <span class="token operator">=</span> ObjectKeyPaths<span class="token operator">&lt;</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> age<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> <span class="token comment">// expected to be 'name' | 'age'</span>
<span class="token keyword">type</span> <span class="token class-name"><span class="token constant">T2</span></span> <span class="token operator">=</span> ObjectKeyPaths<span class="token operator">&lt;</span><span class="token punctuation">{</span>
  refCount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  person<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> age<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> <span class="token comment">// expected to be 'refCount' | 'person' | 'person.name' | 'person.age'</span>
<span class="token keyword">type</span> <span class="token class-name"><span class="token constant">T3</span></span> <span class="token operator">=</span> ObjectKeyPaths<span class="token operator">&lt;</span><span class="token punctuation">{</span> books<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> price<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> <span class="token comment">// expected to be the superset of 'books' | 'books.0' | 'books[0]' | 'books.[0]' | 'books.0.name' | 'books.0.price' | 'books.length' | 'books.find'</span>
</code></pre><p>最终期望的效果如下，不仅能够实现字面值的参数校验，还可以帮助 IDE 更好地做代码提示。</p><p><img src="/assets/1.629837a9.png" alt="1.png"></p><p><a href="https://github.com/type-challenges/type-challenges/issues/7258">https://github.com/type-challenges/type-challenges/issues/7258</a></p><p>提交 Issue 创建题目后，我也评论贴了自己的解法。同时也发现了社区中的其他有意思的解法，比如做尾递归优化等。更发现了这里例子 Anders Hejlsberg 在 TSConf 2021 上演示过。</p></div><!--]--><div class="mt-20" data-v-c9e79ed7=""><!----></div></div></div></div></div></div><!--]--></div></div>
    
  

</body></html>