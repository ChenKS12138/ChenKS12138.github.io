<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content-Security-Policy</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EZRSNLSEWX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
    </script>
    <script type="module" crossorigin="" src="/assets/app.300cb24c.js"></script>
    <link rel="stylesheet" href="/assets/index.2a7adb62.css">
  <link rel="modulepreload" crossorigin="" href="/assets/content.66173f61.js"></head>

  <body>
    <div id="app" data-server-rendered="true"><div class="w-full items-center justify-center m-0 p-0"><!--[--><header class="w-full fixed z-99" style="--37938739:url(&quot;/bg1.png&quot;);" data-v-35def80b=""><div class="header-navigation text--layout flex items-center justify-center" style="height:64px;background-color:transparent;" data-v-35def80b=""><div class="flex justify-between items-center w-3xl <md:w-full" data-v-35def80b=""><div data-v-35def80b=""><a href="/" class="text--link" data-v-35def80b="">ChenKS</a></div><div class="flex text-sm font-400 items-center" data-v-35def80b=""><!--[--><a href="/" class="text--link" data-v-35def80b="">首页</a><a href="/article-list" class="text--link" data-v-35def80b="">文章</a><a href="/about" class="text--link" data-v-35def80b="">关于</a><!--]--><button class="cursor-pointer text-white bg-transparent py-0.75 px-2.5 text-sm" data-v-35def80b=""><span class="inline-block align-middle dark:i-carbon-moon i-carbon-sun"></span></button></div></div></div></header><div class="flex flex-col" style="min-height:100vh;--37938739:url(&quot;/bg1.png&quot;);" data-v-35def80b=""><div class="w-full header-cover-bg min-h-lg" data-v-35def80b=""></div><div class="content-container-wrapper dark:bg-dark" data-v-35def80b=""><div class="content-container" data-v-35def80b=""><!--[--><div class="h-70 -mt-70 flex flex-col items-center text-white"><div class="font-bold text-3xl">Content-Security-Policy</div><div class="text-lg mt-2">2021-03-15</div><div class="mt-2 italic">#Web</div></div><!--[--><div class="markdown-body"><h1>CSP(Content-Security-Policy)</h1><h2>大纲</h2><ol><li>基本概念</li><li>目前 CSP 的使用情况</li><li>一些具体场景下 CSP 的应用</li><li>小结</li></ol><h2>基本概念</h2><p>CSP 的全称是<code>Content-Security-Policy</code><sup><a href="#reference-1">[1]</a></sup> ，是一种计算机安全标准，可以防御跨站脚本、点击劫持等代码注入攻击，阻止恶意内容在守信网页内容中执行。站点可以指定用户代理资源加载的策略，主要是通过响应头<code>Content-Security-Policy</code>，或者是使用带有<code>http-equiv</code>属性的 meta 标签来进行配置的。这可以有效的避免 xss 等一些代码注入形式的攻击。</p><p>⚠️ 同时值得注意的是，部分属性并不能通过<code>meta</code>标签或者是响应头<code>Content-Security-Policy-Repory-Only</code>进行配置，需要将配置写到响应头<code>Content-Security-Policy</code>中。</p><p>其基本的使用方式<sup><a href="#reference-2">[2]</a></sup>为<code>Content-Secuirty-Policy: &lt;policy-directive&gt;; [&lt;policy-directive&gt;];</code> 通过设置指令对各类资源的加载，基本可以分为<code>获取指令</code>、<code>导航指令</code>、<code>报告指令</code>、<code>其他指令</code>。</p><h3>获取指令(Fetch Directives)</h3><table><thead><tr><th>指令名</th><th>主要作用</th></tr></thead><tbody><tr><td>chlid-src</td><td>限制了 worker 和 iframe 的资源来源</td></tr><tr><td>connect-src</td><td>限制了通过脚本接口加载的链接的地址</td></tr><tr><td>default-src</td><td>作为其他<code>获取指令</code>的备选项</td></tr><tr><td>font-src</td><td>限制了<code>@font-face</code> 加载的源字体的地址</td></tr><tr><td>frame-src</td><td>限制了 iframe 的加载源</td></tr><tr><td>script-src</td><td>限制 JavaScript 的源地址</td></tr><tr><td>style-src</td><td>限制层叠样式表的源地址</td></tr><tr><td>…</td><td>…</td></tr></tbody></table><p><code>script-src</code><sup><a href="#reference-3">[3]</a></sup>是比较常见的指令，我们可以从主机名、协议名、是否与当前文档同源、是否允许各种形式的 eval、是否允许内联的 event handlers、是否允许内联的 script 标签或者是 javascript 伪协议的链接等这样一些方面对文档中使用的 javascript 代码进行管理。同时我们也可以使用<code>nonce</code>或者是<code>代码文本hash值</code>这样一些方式对代码的合法性进行验证，避免在开启<code>unsafe-inline</code>时，非法的&lt;script&gt;代码段被执行。</p><h3>文档指令(Document Directives)</h3><table><thead><tr><th>指令名</th><th>主要作用</th></tr></thead><tbody><tr><td>sandbox</td><td>类似于 iframe 的 sandbox 属性，约束 iframe 中的行为</td></tr><tr><td>…</td><td>…</td></tr></tbody></table><h3>导航指令(Navigation Directives)</h3><table><thead><tr><th>指令名</th><th>主要作用</th></tr></thead><tbody><tr><td>from-action</td><td>限制 form 表单的 action 属性</td></tr><tr><td>frame-ancestor</td><td>限制资源被以 iframe、frame、object、embed 等形式嵌入时的有效的父级元素</td></tr><tr><td>…</td><td>…</td></tr></tbody></table><h3>报告指令</h3><table><thead><tr><th>指令名</th><th>主要作用</th></tr></thead><tbody><tr><td>report-uri</td><td>需要配合<code>Content-Security-Policy-Report-Only</code>使用，对可能发生 XSS 的违规行为进行上报</td></tr></tbody></table><h2>目前 CSP 的使用情况</h2><p>观察了<code>zhihu.com</code>、<code>taobao.com</code>、<code>douban.com</code>、<code>juejin.com</code>，目前只有<code>zhihu.com</code>使用 CSP 保护。</p><h3>知乎(zhihu.com)</h3><p><img src="/assets/csp_implement_zhihu.e280e73e.png" alt="csp-implement-zhihu"></p><div align="center"><small>图1 - zhihu.com</small></div> 可以观察到zhihu.com对`img-src`、`connect-src`、`script-src`、`style-src`都做了配置。 <h2>一些具体场景下 CSP 的应用</h2><h3>进一步避免 XSS 攻击</h3><p>CSP 可以作为一个更安全的防止 XSS 的策略。</p><p>从 XSS 攻击的目的讲，XSS 主要是为了窃取用户的 cookie 或者其他数据，又或者是通过 js 代码的执行使用户代理发起意料之外的请求，又或者是在用户网页中生成动态内容。对于前者我们可以通过 cookie 的<code>httpOnly</code>属性避免 js 对该 cookie 进行读写，对于第二种情况，也就是 CSRF 的一种攻击形式，常见的解决方案是检查 reference、检查请求的 token 等。对于这种 CSRF 的场景，前面的方案都是从服务端做检查，除了 CSP 还没有比较好的在用户代理就进行检查的解决方案，虽然说使用<code>service worker</code>可以对资源请求进行拦截，但是使用这个方案防止 CSRF 确实不太合适。对于第二、第三种情况，使用 CSP 就可以很好的解决，可以分别对文档的<code>connect-src</code>和<code>script-src</code>作出约束，浏览器借此判断出非法的 ajax 请求的连接和非法来源的 js 代码。</p><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// app.js</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
    <span class="token string">"Content-Security-Policy"</span><span class="token punctuation">,</span>
    <span class="token string">"connect-src 'self';script-src 'self' 'unsafe-inline'"</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h4>对 script-src 进行拦截</h4><img src="/assets/csp_implement_enhance1.cb43a6f2.png" width="80%"><img src="/assets/csp_implement_enhance2.29ac674f.png" width="80%"><p>⚠️ 需要注意的是，如果原来的站点使用了 JSONP 解决跨域，需要将 JSONP 对应的域名加入<code>script-src</code>中。虽然 script 标签不受同源策略限制，但是 CSP 可能会对 script 的来源进行限制。</p><h4>对 connect-src 进行拦截</h4><img src="/assets/csp_implement_enhance3.70083ecf.png" width="80%"><img src="/assets/csp_implement_enhance4.40588ccf.png" width="80%"><p>相比的跨域拦截，CSP 的<code>connect-src</code>对请求的拦截，不存在需要类似跨域请求预检的过程。即使接口地址允许跨域，也可以将请求拦截下来，更好地避免 CSRF 攻击。</p><h3>避免运营商的 HTTP 劫持</h3><img src="/assets/csp_implemnt_isp-hijack.901a4de9.png" width="40%"><div align="center"><small>图2 - 运营商劫持</small></div> 上图为运营商HTTP劫持插入广告的效果<sup>[[4]](#reference-4)</sup>。其基本形式就是通过在文档末尾添加一些js代码，通过执行这些代码，在页面中动态添加广告位并诱导用户点击广告链接。CSP就可以作为一个有力的措施避免这种行为。对于图中的场景可以使用`navigate-to` （目前navigate-to仍是处于Working Draft阶段）防止用户跳转至广告页面、限制`img-src`避免广告图片被加载、限制`script-src`避免这段插入的js文件被加载。 <pre class="language-javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
    <span class="token string">"Content-Security-Policy"</span><span class="token punctuation">,</span>
    <span class="token string">"navigation-to 'self';img-src *;script-src 'self' nonce-2726c7f26c "</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><img src="/assets/csp_implement_isp-hijack1.726fc430.png" width="100%"><img src="/assets/csp_implement_isp-hijack2.c8f4d574.png" width="100%"><p>对于这种场景，CSP 可以做到在执行 script 脚本这一步，就将该行为阻止。</p><h3>防止网页被他人以 iframe 的形式盗用</h3><p>网页可以通过 iframe 的方式嵌入到另一个网页中。但是对于被嵌入的网页来说，这并不一定是意料之中的。为了避免这种情况，可以设置被嵌入页面的<code>frame-ancestors</code>来进行限制。</p><pre class="language-javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"Content-Security-Policy"</span><span class="token punctuation">,</span> <span class="token string">"frame-ancestors 'none'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><img src="/assets/csp_implement_iframe.e091e85c.png" width="100%"><h3>XSS 攻击的拦截上报</h3><p>对于 XSS 攻击我们除了要做有事前的防范，还要有事后的补救，如何将这个攻击过程记录下来，更好地交给安全人员去复现去分析？如何以各种方式通知用户，当前的账户可能存在安全风险，需要及时更换密码？等等。使用<code>report-uri</code> 这个属性<sup><a href="#reference-5">[5]</a>(</sup>，可以告知浏览器将违反报告发送到指定的 URI。</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/report"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"report comes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"Content-Security-Policy"</span><span class="token punctuation">,</span> <span class="token string">"img-src 'self';report-uri /report"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><img src="/assets/csp_implement_report1.05f6febd.png" width="100%"><img src="/assets/csp_implement_report2.8afbe60b.png" width="100%"><h2>小结</h2><p>CSP 相关的内容，本身并不是 HTTP/1.1 或 HTTP/2.0 的一部分，而是作为一个规范在 w3c 中供浏览器厂商去实现。这是因为 web 应用不同于普通的 app 以及桌面应用，app 或者是桌面应用通常是通过二进制包的形式分发，并且可以有系统层面的签名验证机制以及应用商店的严格的审核提供保障，保证了可执行文件的安全性。但是 web 应用本身是基于源码形式的分发，并具有动态性的特点，这给 web 应用带来了开发、运行、传播的便利性，但同时也带来了一些隐患，如果不能保障传输过程中的准确性、完整性，就会给用户带来安全隐患，通过代码注入等形式造成开发者意料之外的代码在用户代理执行成为了可能。CSP 也就应运而生，通过对文档可加载的资源来源进行限制以及验证达到避免恶意代码执行的目的。如果我们可以保证文档及其响应头没有被修改，并且配置了合理的 CSP 规则，一定程度上网页是安全的。但同时世界上是不存在绝对的安全的，我们也还需要其他的措施帮助我们保护用户的安全。</p><h2>参考引用</h2><ul><li>[1] <a href="https://www.w3.org/TR/CSP/">https://www.w3.org/TR/CSP/</a></li><li>[2] <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy</a></li><li>[3] <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src">https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src</a></li><li>[4] <a href="https://juejin.cn/post/6844903713669283847">https://juejin.cn/post/6844903713669283847</a></li><li>[5] <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/report-uri">https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/report-uri</a></li></ul></div><!--]--><div class="rounded bg-gray mt-10 p-1 text-white italic indent-md text-lg"> CC BY-SA 3.0协议 。转载请注明出处! </div><!--]--></div></div></div><!--]--></div></div>
    
  

</body></html>