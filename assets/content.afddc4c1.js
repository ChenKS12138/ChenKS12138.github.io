import{_ as c}from"./ArticleWrapper.vue_vue_type_script_setup_true_lang.0c35c3b9.js";import{c as p,w as e,o as u,a as n,b as s}from"./app.86c4b747.js";import"./dayjs.min.28e220c7.js";const l="/assets/5-3-1.d90d74a5.png",k="/assets/6-1-1.400b76e0.png",i="/assets/7-1-1.8f044ee7.png",r="/assets/7-2-1.60119aae.png",d="/assets/12-2-1.d7b9b0ac.png",m="/assets/13-1-1.3f5d4a51.png",f="/assets/13-4-1.a6828c12.png",y="/assets/15-2-1.e3d1459c.png",w="/assets/18-2-1.06555a3f.png",g="/assets/18-9-1.26aa8e34.png",_="/assets/20-2-1.6f1c1d4a.png",h="/assets/22-1-1.f0608cde.png",b="/assets/22-2-1.16e7f456.png",v="/assets/22-3-1.fef36a25.png",E="/assets/27-1-1.7f265222.png",S="/assets/27-3-1.7ac87d8e.png",L="/assets/27-4-1.58e35b67.png",x="/assets/28-1-1.3cdd2749.png",I="/assets/29-1-1.a3916ab9.png",U="/assets/30-1-1.e16d836c.png",N="/assets/33-1-1.7fee8a33.png",T="/assets/33-2-1.6cf8f1d4.png",O="/assets/34-2-1.b1d6b616.png",R="/assets/34-3-1.43f6f8d2.png",F="/assets/34-4-1.bdb633b2.png",C="/assets/34-6-1.382f84f8.png",A="/assets/34-7-1.0da7ac33.png",M="/assets/35-1-1.a9c86dad.png",z="/assets/35-2-1.cd18a5c5.png",P="/assets/35-3-1.b385c064.png",D="/assets/36-1-1.4227f29c.png",K="/assets/36-2-1.c97b89f9.png",G="/assets/36-3-1.12ed0d32.png",X="/assets/38-1-1.1ee99927.png",B="/assets/38-2-1.1b61bb78.png",j="/assets/39-1-1.b154c688.png",V="/assets/40-2-1.b0fffae2.png",q="/assets/41-1-1.ddcbd6b6.png",Z="/assets/42-1-1.95014e6f.png",H="/assets/42-2-1.62d7e4b1.png",W="/assets/44-3-1.800fcd35.png",Y="/assets/44-4-1.19d87499.png",$="/assets/45-1-1.1ca8f05d.png",Q="/assets/45-2-1.d34375c4.png",J="/assets/46-1-1.3c00e66f.png",nn="/assets/46-2-1.5c36ee14.png",sn="/assets/47-1-1.e91c4914.png",an="/assets/47-2-1.ea35bf2c.png",tn="/assets/47-3-1.ee64a5dd.png",on="/assets/47-5-1.17963659.png",cn="/assets/47-6-1.c38e5da0.png",pn="/assets/48-1-1.d7c1fa17.png",en="/assets/48-4-1.344e9b9c.png",un="/assets/48-5-1.2d5f4e60.png",ln="/assets/52-5-1.26db60af.png",kn="/assets/55-2-1.5c596d16.png",rn="/assets/55-4-1.4c919ebc.png",dn="/assets/57-1-1.deeb3c75.png",mn="/assets/57-4-1.39b8103f.png",fn="/assets/59-4-1.5f355892.png",yn="/assets/61-4-1.4ceb7af9.png",wn="/assets/61-5-1.aa2b2e12.png",gn=n("div",{class:"markdown-body"},[n("p",null,[n("a",{href:"https://man7.org/tlpi/index.html"},"\u300Athe linux programming interface\u300B")]),n("h1",null,"\u4E60\u9898"),n("h2",null,"\u7B2C\u4E09\u7AE0"),n("h3",null,"3-1"),n("p",null,"magic number \u9690\u85CF\u7740 Torvalds \u548C\u4ED6\u5973\u513F\u4EEC\u7684\u751F\u65E5"),n("p",null,[n("a",{href:"https://github.com/torvalds/linux/blob/5bfc75d92efd494db37f5c4c173d3639d4772966/include/uapi/linux/reboot.h"},"https://github.com/torvalds/linux/blob/5bfc75d92efd494db37f5c4c173d3639d4772966/include/uapi/linux/reboot.h")]),n("p",null,[n("a",{href:"https://www.nndb.com/people/444/000022378/"},"https://www.nndb.com/people/444/000022378/")]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<linux/reboot.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdlib.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/syscall.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" code "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"syscall"),n("span",{class:"token punctuation"},"("),s("SYS_reboot"),n("span",{class:"token punctuation"},","),s(" LINUX_REBOOT_MAGIC1"),n("span",{class:"token punctuation"},","),s(" LINUX_REBOOT_MAGIC2"),n("span",{class:"token punctuation"},","),s(`
                     LINUX_REBOOT_CMD_RESTART`),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("code "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"perror"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"reboot"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_FAILURE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u56DB\u7AE0"),n("h3",null,"4-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdlib.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUFFER_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1024")])]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token comment"},"// check argc"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"usage: %s [-a] <file>\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_FAILURE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`

  `),n("span",{class:"token comment"},"// parse argv"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" flag_append "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(" opt "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("opt "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getopt"),n("span",{class:"token punctuation"},"("),s("argc"),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"a"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("opt"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'a'"),n("span",{class:"token operator"},":"),s(`
      flag_append `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`

  `),n("span",{class:"token comment"},"// open destination file"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" flag "),n("span",{class:"token operator"},"="),s(" O_WRONLY "),n("span",{class:"token operator"},"|"),s(),n("span",{class:"token punctuation"},"("),s("flag_append "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"?"),s(" O_TRUNC "),n("span",{class:"token operator"},":"),s(" O_APPEND"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),s("argc "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" flag"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0644"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"perror"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open dest file"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_FAILURE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`

  `),n("span",{class:"token comment"},"// write file"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("buf "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("BUFFER_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" n "),n("span",{class:"token operator"},"="),s(" BUFFER_SIZE"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"do"),s(),n("span",{class:"token punctuation"},"{"),s(`
    n `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("STDIN_FILENO"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" n"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" n"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("n"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h4",null,"4-2"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdlib.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUFFER_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1014")])]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token comment"},"// check args"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"usage %s <src> <dest>"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_FAILURE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`

  `),n("span",{class:"token comment"},"// open {src,dest}"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd_src"),n("span",{class:"token punctuation"},","),s(" fd_dest"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd_src "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" O_RDONLY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"perror"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open src"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_FAILURE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd_dest "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" O_WRONLY "),n("span",{class:"token operator"},"|"),s(" O_CREAT"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0644"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"perror"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open dest"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_FAILURE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`

  `),n("span",{class:"token comment"},"// copy"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("buf "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("BUFFER_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ino_r"),n("span",{class:"token punctuation"},","),s(" ino_w"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"do"),s(),n("span",{class:"token punctuation"},"{"),s(`
    ino_r `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("fd_src"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" BUFFER_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino_r "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"perror"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"read src"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_FAILURE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    ino_w `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("fd_dest"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" ino_r"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino_w "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"perror"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"write dest"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_FAILURE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("ino_r"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd_src"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd_dest"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u4E94\u7AE0"),n("h3",null,"5-1"),n("pre",{class:"language-shell"},[n("code",{class:"language-shell"},[s("gcc large-file.c "),n("span",{class:"token parameter variable"},"-o"),s(" large-file "),n("span",{class:"token parameter variable"},"-ltlpi"),s(),n("span",{class:"token punctuation"},"\\"),s(`
`),n("span",{class:"token operator"},"&&"),s(" ./target-file "),n("span",{class:"token number"},"1"),s(".txt "),n("span",{class:"token number"},"10111222333"),s(`
`)])]),n("p",null,"\u80FD\u591F\u6210\u529F\u521B\u5EFA\u5305\u542B\u6587\u4EF6\u7A7A\u6D1E\u7684\u5927\u6587\u4EF6\uFF0C\u5927\u6587\u4EF6\u903B\u8F91\u4E0A\u4E3A 10GB \u5DE6\u53F3\uFF0C\u4F46\u662F\u53EA\u5360\u636E\u78C1\u76D8\u7A7A\u95F4 4KB\u3002\u6587\u4EF6\u7A7A\u6D1E\u4F7F\u7528\\0 \u586B\u5145\uFF0C\u672C\u8EAB\u4E0D\u5360\u636E\u7269\u7406\u7A7A\u95F4\uFF0C\u5F53\u5B9E\u9645\u6709\u5199\u5165\u65F6\u624D\u5206\u914D\u78C1\u76D8\u5757\u3002"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"_LARGEFILE64_SOURCE")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/stat.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"off64_t"),s(" off"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"3"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"--help"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s pathname offset\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  fd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open64"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" O_RDWR "),n("span",{class:"token operator"},"|"),s(" O_CREAT"),n("span",{class:"token punctuation"},","),s(" S_IRUSR "),n("span",{class:"token operator"},"|"),s(" S_IWUSR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open64"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  off `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"atoll"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"lseek"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" off"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"SEEK_SET"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"lseek64"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"test"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"4"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"write"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"5-2"),n("p",null,[s("\u4F7F\u7528"),n("code",null,"O_APPEND"),s("\u6253\u5F00\u6587\u4EF6\u540E\uFF0Cwrite \u524D\u4F7F\u7528 lseek \u6539\u53D8\u504F\u79FB\u91CF\u4E0D\u80FD\u4F7F\u4E0B\u6B21\u5199\u5165\u4F4D\u7F6E\u6539\u53D8\u3002\u56E0\u4E3A\u6BCF\u6B21\u7684\u5199\u5165\u90FD\u662F\u4E00\u4E2A\u539F\u5B50\u64CD\u4F5C\uFF0C\u4F1A\u5148\u6539\u53D8\u504F\u79FB\u91CF\u81F3\u6587\u4EF6\u5C3E\u518D\u5199\u5165\u3002\u8FD9\u6837\u505A\u662F\u4E3A\u4E86\u907F\u514D\u5E76\u53D1\u5171\u4EAB fd \u65F6\u7684\u7ADE\u6001\u95EE\u9898\u3002")]),n("blockquote",null,[n("pre",null,[n("code",null,`O_APPEND
      The file is opened in append mode.  Before each write(2),
      the file offset is positioned at the end of the file, as
      if with lseek(2).  The modification of the file offset and
      the write operation are performed as a single atomic step.

      O_APPEND may lead to corrupted files on NFS filesystems if
      more than one process appends data to a file at once.
      This is because NFS does not support appending to a file,
      so the client kernel has to simulate it, which can't be
      done without a race condition.
`)])]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<string.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("text1 "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string"},'"hello\\nhello1\\nhello2\\n"'),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("text2 "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string"},'"abc"'),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("filename "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string"},'"1.txt"'),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ino"),n("span",{class:"token punctuation"},","),s(" fd"),n("span",{class:"token punctuation"},";"),s(`

  fd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("filename"),n("span",{class:"token punctuation"},","),s(" O_WRONLY "),n("span",{class:"token operator"},"|"),s(" O_CREAT "),n("span",{class:"token operator"},"|"),s(" O_TRUNC"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0644"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open0"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" text1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("text1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  fd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("filename"),n("span",{class:"token punctuation"},","),s(" O_WRONLY "),n("span",{class:"token operator"},"|"),s(" O_APPEND"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0644"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open1"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"lseek"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"SEEK_SET"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"lseek"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" text2"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("text2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"5-3"),n("pre",{class:"language-shell"},[n("code",{class:"language-shell"},[n("span",{class:"token comment"},"# generate f1"),s(`
./atomic_append f1 `),n("span",{class:"token number"},"1000000"),s(),n("span",{class:"token operator"},"&"),s(" ./atomic_append f1 "),n("span",{class:"token number"},"1000000"),s(`
`),n("span",{class:"token comment"},"# generate f2"),s(`
./atomic_append f1 `),n("span",{class:"token number"},"1000000"),s(" x "),n("span",{class:"token operator"},"&"),s(" ./atomic_append f1 "),n("span",{class:"token number"},"1000000"),s(` x
`)])]),n("p",null,[n("img",{src:l,alt:"5-3-1"})]),n("p",null,[s("\u4E0D\u4F7F\u7528"),n("code",null,"O_APPEND"),s("\u4F1A\u53D1\u751F\u7ADE\u6001\u95EE\u9898\u3002t4 \u65F6 process1 \u7684 fd \u7684\u504F\u79FB\u91CF\u5E76\u4E0D\u662F\u6587\u4EF6\u5C3E\uFF0C\u800C\u662F\u6700\u540E\u4E00\u4E2A\u5B57\u8282\uFF0C\u56E0\u6B64\u6CA1\u6709\u6210\u4E3A\u5728\u6587\u4EF6\u5C3E\u6DFB\u52A0\u4E00\u4E2A\u5B57\u8282\u3002")]),n("table",null,[n("thead",null,[n("tr",null,[n("th",null,"time slice"),n("th",null,"process1"),n("th",null,"process2")])]),n("tbody",null,[n("tr",null,[n("td",null,"t1"),n("td",null,"lseek(fd,0,SEEK_END);"),n("td")]),n("tr",null,[n("td",null,"t2"),n("td"),n("td",null,"lseek(fd,0,SEEK_END);")]),n("tr",null,[n("td",null,"t3"),n("td"),n("td",null,"write(fd,\u201Ca\u201D,1);")]),n("tr",null,[n("td",null,"t4"),n("td",null,"write(fd,\u201Ca\u201D,1);"),n("td")])])]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<string.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s filename num-bytes [x]"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(" ino"),n("span",{class:"token punctuation"},","),s(" num_bytes"),n("span",{class:"token punctuation"},","),s(" open_flag"),n("span",{class:"token punctuation"},";"),s(`
  num_bytes `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"atoll"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  open_flag `),n("span",{class:"token operator"},"="),s(" O_WRONLY "),n("span",{class:"token operator"},"|"),s(" O_CREAT"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"3"),s(),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"x"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    open_flag `),n("span",{class:"token operator"},"|="),s(" O_APPEND"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  fd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" open_flag"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0644"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("num_bytes"),n("span",{class:"token operator"},"--"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"lseek"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"SEEK_END"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"lseek"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"a"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"write"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"5-4"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<assert.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdlib.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<string.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"tlpi_dup"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" oldfd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token function"},"fcntl"),n("span",{class:"token punctuation"},"("),s("oldfd"),n("span",{class:"token punctuation"},","),s(" F_DUPFD"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"tlpi_dup2"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" oldfd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" newfd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("oldfd "),n("span",{class:"token operator"},"=="),s(" newfd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fcntl"),n("span",{class:"token punctuation"},"("),s("oldfd"),n("span",{class:"token punctuation"},","),s(" F_GETFL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      errno `),n("span",{class:"token operator"},"="),s(" EBADF"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" oldfd"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("newfd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  newfd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fcntl"),n("span",{class:"token punctuation"},"("),s("oldfd"),n("span",{class:"token punctuation"},","),s(" F_DUPFD"),n("span",{class:"token punctuation"},","),s(" newfd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" newfd"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(" fd2"),n("span",{class:"token punctuation"},","),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("text "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string"},'"hello123\\n"'),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},"// validate tlpi_dup"),s(`
  fd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"1.txt"'),n("span",{class:"token punctuation"},","),s(" O_RDWR "),n("span",{class:"token operator"},"|"),s(" O_CREAT "),n("span",{class:"token operator"},"|"),s(" O_TRUNC"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0644"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  fd2 `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"tlpi_dup"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("fd2"),n("span",{class:"token punctuation"},","),s(" text"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("text"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("buf1 "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("text"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  fd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"1.txt"'),n("span",{class:"token punctuation"},","),s(" O_RDONLY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" buf1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("text"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("buf1"),n("span",{class:"token punctuation"},","),s(" text"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},"// validate tlpi_dup2"),s(`
  fd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"2.txt"'),n("span",{class:"token punctuation"},","),s(" O_RDWR "),n("span",{class:"token operator"},"|"),s(" O_CREAT "),n("span",{class:"token operator"},"|"),s(" O_TRUNC"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0644"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"tlpi_dup2"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" STDOUT_FILENO"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("STDOUT_FILENO"),n("span",{class:"token punctuation"},","),s(" text"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("text"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("buf2 "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("text"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  fd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"2.txt"'),n("span",{class:"token punctuation"},","),s(" O_RDONLY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" buf2"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("text"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("buf2"),n("span",{class:"token punctuation"},","),s(" text"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"5-5"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<assert.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdlib.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<string.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"tlpi_dup"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" oldfd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token function"},"fcntl"),n("span",{class:"token punctuation"},"("),s("oldfd"),n("span",{class:"token punctuation"},","),s(" F_DUPFD"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"tlpi_dup2"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" oldfd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" newfd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("oldfd "),n("span",{class:"token operator"},"=="),s(" newfd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fcntl"),n("span",{class:"token punctuation"},"("),s("oldfd"),n("span",{class:"token punctuation"},","),s(" F_GETFL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      errno `),n("span",{class:"token operator"},"="),s(" EBADF"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" oldfd"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("newfd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  newfd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fcntl"),n("span",{class:"token punctuation"},"("),s("oldfd"),n("span",{class:"token punctuation"},","),s(" F_DUPFD"),n("span",{class:"token punctuation"},","),s(" newfd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" newfd"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(" fd2"),n("span",{class:"token punctuation"},","),s(" offset1"),n("span",{class:"token punctuation"},","),s(" offset2"),n("span",{class:"token punctuation"},","),s(" file_flag1"),n("span",{class:"token punctuation"},","),s(" file_flag2"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("text "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string"},'"hello world\\n"'),n("span",{class:"token punctuation"},";"),s(`
  fd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"1.txt"'),n("span",{class:"token punctuation"},","),s(" O_RDWR "),n("span",{class:"token operator"},"|"),s(" O_CREAT "),n("span",{class:"token operator"},"|"),s(" O_TRUNC"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0644"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" text"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("text"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  offset1 `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"lseek"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"SEEK_SET"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  file_flag1 `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fcntl"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" F_GETFL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  fd2 `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"tlpi_dup"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  offset2 `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"lseek"),n("span",{class:"token punctuation"},"("),s("fd2"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"SEEK_CUR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  file_flag2 `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fcntl"),n("span",{class:"token punctuation"},"("),s("fd2"),n("span",{class:"token punctuation"},","),s(" F_GETFL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token comment"},"// validate offset"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),s("offset1 "),n("span",{class:"token operator"},"=="),s(" offset2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token comment"},"// validate file flag"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),s("file_flag1 "),n("span",{class:"token operator"},"=="),s(" file_flag2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"5-6"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<assert.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<string.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("file "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string"},'"1.txt"'),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"char"),s(" buffer"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"20"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"assert_file"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("content"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("file"),n("span",{class:"token punctuation"},","),s(" O_RDONLY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" buffer"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"20"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("buffer"),n("span",{class:"token punctuation"},","),s(" content"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd1"),n("span",{class:"token punctuation"},","),s(" fd2"),n("span",{class:"token punctuation"},","),s(" fd3"),n("span",{class:"token punctuation"},";"),s(`
  fd1 `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("file"),n("span",{class:"token punctuation"},","),s(" O_RDWR "),n("span",{class:"token operator"},"|"),s(" O_CREAT "),n("span",{class:"token operator"},"|"),s(" O_TRUNC"),n("span",{class:"token punctuation"},","),s(" S_IRUSR "),n("span",{class:"token operator"},"|"),s(" S_IWUSR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  fd2 `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"dup"),n("span",{class:"token punctuation"},"("),s("fd1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  fd3 `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("file"),n("span",{class:"token punctuation"},","),s(" O_RDWR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("fd1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Hello,"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"6"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// Hello,"),s(`
  `),n("span",{class:"token function"},"assert_file"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Hello,"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("fd2"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"world"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"6"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// Hello,world"),s(`
  `),n("span",{class:"token function"},"assert_file"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Hello,world"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"lseek"),n("span",{class:"token punctuation"},"("),s("fd2"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"SEEK_SET"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("fd1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"HELLO,"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"6"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// HELLO,world"),s(`
  `),n("span",{class:"token function"},"assert_file"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"HELLO,world"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("fd3"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Gidday"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"6"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// Giddayworld"),s(`
  `),n("span",{class:"token function"},"assert_file"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Giddayworld"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd3"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"5-7"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<assert.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdlib.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<string.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/param.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/uio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"tlpi_readv"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"iovec"),s(),n("span",{class:"token operator"},"*"),s("iov"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" count"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" size"),n("span",{class:"token punctuation"},","),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(" count"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    size `),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token punctuation"},"("),s("iov "),n("span",{class:"token operator"},"+"),s(" i"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("iov_len"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  buf `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" byte_size "),n("span",{class:"token operator"},"="),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(" count"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"iovec"),s(),n("span",{class:"token operator"},"*"),s("curr "),n("span",{class:"token operator"},"="),s(" iov "),n("span",{class:"token operator"},"+"),s(" i"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("iov_base"),n("span",{class:"token punctuation"},","),s(" buf "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"-"),s(" byte_size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
               `),n("span",{class:"token function"},"MIN"),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("iov_len"),n("span",{class:"token punctuation"},","),s(" byte_size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        byte_size `),n("span",{class:"token operator"},"-="),s(" curr"),n("span",{class:"token operator"},"->"),s("iov_len"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"tlpi_writev"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"iovec"),s(),n("span",{class:"token operator"},"*"),s("iov"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" count"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" size"),n("span",{class:"token punctuation"},","),s(" ino"),n("span",{class:"token punctuation"},","),s(" offset "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(" count"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    size `),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token punctuation"},"("),s("iov "),n("span",{class:"token operator"},"+"),s(" i"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("iov_len"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  buf `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(" count"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"iovec"),s(),n("span",{class:"token operator"},"*"),s("curr "),n("span",{class:"token operator"},"="),s(" iov "),n("span",{class:"token operator"},"+"),s(" i"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),s("buf "),n("span",{class:"token operator"},"+"),s(" offset"),n("span",{class:"token punctuation"},","),s(" curr"),n("span",{class:"token operator"},"->"),s("iov_base"),n("span",{class:"token punctuation"},","),s(" curr"),n("span",{class:"token operator"},"->"),s("iov_len"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    offset `),n("span",{class:"token operator"},"+="),s(" curr"),n("span",{class:"token operator"},"->"),s("iov_len"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"iovec"),s(" iov1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" iov2"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("file "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string"},'"1.txt"'),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("text1 "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string"},'"hello c"'),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("text2 "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string"},'"attchen"'),n("span",{class:"token punctuation"},";"),s(`

  iov1`),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"7"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  iov1`),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_len "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"7"),n("span",{class:"token punctuation"},";"),s(`
  iov1`),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"7"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  iov1`),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_len "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"7"),n("span",{class:"token punctuation"},";"),s(`

  iov2`),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"7"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  iov2`),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_len "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"7"),n("span",{class:"token punctuation"},";"),s(`
  iov2`),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"7"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  iov2`),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_len "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"7"),n("span",{class:"token punctuation"},";"),s(`

  fd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("file"),n("span",{class:"token punctuation"},","),s(" O_RDWR "),n("span",{class:"token operator"},"|"),s(" O_CREAT "),n("span",{class:"token operator"},"|"),s(" O_TRUNC"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0644"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),s("iov1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base"),n("span",{class:"token punctuation"},","),s(" text1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"7"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),s("iov1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base"),n("span",{class:"token punctuation"},","),s(" text2"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"7"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"writev"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" iov1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"writev"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"lseek"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"SEEK_SET"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"lseek1"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"tlpi_readv"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" iov2"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"tlpi_readv"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"memcmp"),n("span",{class:"token punctuation"},"("),s("iov1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base"),n("span",{class:"token punctuation"},","),s(" iov2"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base"),n("span",{class:"token punctuation"},","),s(" iov1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_len"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"memcmp"),n("span",{class:"token punctuation"},"("),s("iov1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base"),n("span",{class:"token punctuation"},","),s(" iov2"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base"),n("span",{class:"token punctuation"},","),s(" iov1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_len"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"memcmp"),n("span",{class:"token punctuation"},"("),s("iov1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base"),n("span",{class:"token punctuation"},","),s(" text1"),n("span",{class:"token punctuation"},","),s(" iov1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_len"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"memcmp"),n("span",{class:"token punctuation"},"("),s("iov1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base"),n("span",{class:"token punctuation"},","),s(" text2"),n("span",{class:"token punctuation"},","),s(" iov1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_len"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"ftruncate"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"ftruncate"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"lseek"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"SEEK_SET"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"lseek"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),s("iov2"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base"),n("span",{class:"token punctuation"},","),s(" text2"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"8"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),s("iov2"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base"),n("span",{class:"token punctuation"},","),s(" text1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"8"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"tlpi_writev"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" iov2"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"tlpi_writev"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"lseek"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"SEEK_SET"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"lseek2"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"readv"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" iov1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"readv"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"memcmp"),n("span",{class:"token punctuation"},"("),s("iov1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base"),n("span",{class:"token punctuation"},","),s(" iov2"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base"),n("span",{class:"token punctuation"},","),s(" iov1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_len"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"memcmp"),n("span",{class:"token punctuation"},"("),s("iov1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base"),n("span",{class:"token punctuation"},","),s(" iov2"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base"),n("span",{class:"token punctuation"},","),s(" iov1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_len"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"memcmp"),n("span",{class:"token punctuation"},"("),s("iov2"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base"),n("span",{class:"token punctuation"},","),s(" text2"),n("span",{class:"token punctuation"},","),s(" iov1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_len"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"memcmp"),n("span",{class:"token punctuation"},"("),s("iov2"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base"),n("span",{class:"token punctuation"},","),s(" text1"),n("span",{class:"token punctuation"},","),s(" iov1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_len"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),s("iov1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),s("iov1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),s("iov2"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),s("iov2"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("iov_base"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u516D\u7AE0"),n("h3",null,"6-1"),n("p",null,[s("10MB \u7684\u6570\u7EC4\u6307\u7684\u662F\u53D8\u91CF"),n("code",null,"main.mbuf"),s("\uFF0C\u5B83\u6CA1\u6709\u88AB\u521D\u59CB\u5316\uFF0C\u662F\u5206\u914D\u5230 bss \u6BB5\uFF0C\u5728\u6700\u540E\u751F\u6210\u7684\u4EE3\u7801\u4E2D\u53EA\u8BB0\u5F55\u7684\u5927\u5C0F\u3002")]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token comment"},"// \u65B9\u5F0F1 \u521D\u59CB\u5316 mbuf\u4F1A\u88AB\u5206\u914D\u5230 data segment"),s(`
`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"char"),s(" mbuf"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"10240000"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"{"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token comment"},"// \u65B9\u5F0F2 \u8D4B\u503C mbuf\u88AB\u5206\u914D\u5230 bss segment"),s(`
`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"char"),s(" mbuf"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"10240000"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
mbuf`),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
`)])]),n("p",null,[n("img",{src:k,alt:"6-1-1"})]),n("p",null,"\u4F46\u662F\u5982\u679C\u5BF9 mbuf \u8FDB\u884C\u521D\u59CB\u5316\uFF0C\u4F1A\u5728\u6700\u540E\u7684 binaray \u5360\u7528 10MB \u7684\u7A7A\u95F4\u5B58\u50A8 mbuf \u7684\u503C\uFF0C\u7A0B\u5E8F\u8FD0\u884C\u65F6\u518D\u76F4\u63A5\u62F7\u8D1D\u5230 data segment\u3002bss \u533A\u7684\u6570\u636E\u4E0D\u7528\u53BB\u5360\u636E ELF \u6587\u4EF6\u7684\u78C1\u76D8\u7A7A\u95F4\u3002"),n("p",null,[n("a",{href:"https://stackoverflow.com/questions/16557677/difference-between-data-section-and-the-bss-section-in-c"},"https://stackoverflow.com/questions/16557677/difference-between-data-section-and-the-bss-section-in-c")]),n("blockquote",null,[n("p",null,"Data"),n("p",null,"The values for these variables are initially stored within the read-only memory (typically within the code segment) and are copied into the data segment during the start-up routine of the program.")]),n("h3",null,"6-2"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<setjmp.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"static"),s(" jmp_buf env"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"f1"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"in f1\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"setjmp"),n("span",{class:"token punctuation"},"("),s("env"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"jump from f2()\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"f2"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"in f2\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"longjmp"),n("span",{class:"token punctuation"},"("),s("env"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"f1"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"f2"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"6-3"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<assert.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdlib.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<string.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"TLPI_ENV_SUCCESS"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1")])]),s(`

`),n("span",{class:"token keyword"},"extern"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("environ"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"tlpi_setenv"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("name"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("value"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" overwrite"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("str"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" l_name"),n("span",{class:"token punctuation"},","),s(" l_value"),n("span",{class:"token punctuation"},","),s(" ino"),n("span",{class:"token punctuation"},";"),s(`

  str `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getenv"),n("span",{class:"token punctuation"},"("),s("name"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("str "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),s(),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token operator"},"!"),s("overwrite"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" TLPI_ENV_SUCCESS"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("str "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),s("str"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  l_name `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("name"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  l_value `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("value"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  str `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("l_name "),n("span",{class:"token operator"},"+"),s(" l_value "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),s("str"),n("span",{class:"token punctuation"},","),s(" name"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),s("str "),n("span",{class:"token operator"},"+"),s(" l_name "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(" value"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  str`),n("span",{class:"token punctuation"},"["),s("l_name"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token char"},"'='"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"putenv"),n("span",{class:"token punctuation"},"("),s("str"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"tlpi_unsetenv"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("name"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"extern"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("environ"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("ep_curr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("ep_end"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ep_len"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("ep_curr "),n("span",{class:"token operator"},"="),s(" environ"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token operator"},"*"),s("ep_curr "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(" ep_curr"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  ep_len `),n("span",{class:"token operator"},"="),s(" ep_curr "),n("span",{class:"token operator"},"-"),s(" environ"),n("span",{class:"token punctuation"},";"),s(`
  ep_end `),n("span",{class:"token operator"},"="),s(" environ "),n("span",{class:"token operator"},"+"),s(" ep_len"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("ep_curr "),n("span",{class:"token operator"},"="),s(" environ"),n("span",{class:"token punctuation"},";"),s(" ep_curr "),n("span",{class:"token operator"},"!="),s(" ep_end"),n("span",{class:"token punctuation"},";"),s(" ep_curr"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("name_p1 "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"*"),s("ep_curr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("name_p2 "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("name"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("name_p1 "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"*"),s("name_p2 "),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token operator"},"*"),s("name_p2 "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      name_p1`),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(`
      name_p2`),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("name_p1 "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'='"),s(),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token operator"},"*"),s("name_p2 "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      ep_end`),n("span",{class:"token operator"},"--"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ep_curr "),n("span",{class:"token operator"},"=="),s(" ep_end"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token operator"},"*"),s("ep_curr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token operator"},"*"),s("ep_curr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"*"),s("ep_end"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token operator"},"*"),s("ep_end "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" TLPI_ENV_SUCCESS"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("key1 "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string"},'"TLPI_TEST"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("value1 "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string"},'"cattchen"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("key2 "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string"},'"TLPI_TEST_2"'),n("span",{class:"token punctuation"},","),s(`
       `),n("span",{class:"token operator"},"*"),s("value2 "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string"},'"value2"'),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"clearenv"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"tlpi_setenv"),n("span",{class:"token punctuation"},"("),s("key1"),n("span",{class:"token punctuation"},","),s(" value1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"tlpi_setenv1"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getenv"),n("span",{class:"token punctuation"},"("),s("key1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" value1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"tlpi_setenv"),n("span",{class:"token punctuation"},"("),s("key2"),n("span",{class:"token punctuation"},","),s(" value2"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"tlpi_setenv2"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"tlpi_setenv"),n("span",{class:"token punctuation"},"("),s("key2"),n("span",{class:"token punctuation"},","),s(" value1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"tlpi_setenv3"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getenv"),n("span",{class:"token punctuation"},"("),s("key2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" value2"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"tlpi_unsetenv"),n("span",{class:"token punctuation"},"("),s("key2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"tlpi_unsetenv1"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getenv"),n("span",{class:"token punctuation"},"("),s("key2"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"tlpi_unsetenv"),n("span",{class:"token punctuation"},"("),s("key1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"tlpi_unsetenv2"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getenv"),n("span",{class:"token punctuation"},"("),s("key1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u4E03\u7AE0"),n("h3",null,"7-1"),n("p",null,[n("img",{src:i,alt:"7-1-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"MAX_ALLOCS"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1000000")])]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("ptr"),n("span",{class:"token punctuation"},"["),s("MAX_ALLOCS"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" freeStep"),n("span",{class:"token punctuation"},","),s(" freeMin"),n("span",{class:"token punctuation"},","),s(" freeMax"),n("span",{class:"token punctuation"},","),s(" blockSize"),n("span",{class:"token punctuation"},","),s(" numAllocs"),n("span",{class:"token punctuation"},","),s(" j"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s num-allocs block-size [step [min [max]]]\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  numAllocs `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getInt"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" GN_GT_0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"num-allocs"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("numAllocs "),n("span",{class:"token operator"},">"),s(" MAX_ALLOCS"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"cmdLineErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"free-max > num-allocs\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  blockSize `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getInt"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" GN_GT_0 "),n("span",{class:"token operator"},"|"),s(" GN_ANY_BASE"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"bolck-size"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  freeStep `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"?"),s(),n("span",{class:"token function"},"getInt"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" GN_GT_0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"step"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},":"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  freeMin `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"4"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"?"),s(),n("span",{class:"token function"},"getInt"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"4"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" GN_GT_0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"min"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},":"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  freeMax `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"?"),s(),n("span",{class:"token function"},"getInt"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" GN_GT_0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"max"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},":"),s(" numAllocs"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("freeMax "),n("span",{class:"token operator"},">"),s(" numAllocs"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"cmdLineErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"free-max > num-allocs\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Initial program brea: %10p\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"sbrk"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Allocating %d*%d bytes\\n"'),n("span",{class:"token punctuation"},","),s(" numAllocs"),n("span",{class:"token punctuation"},","),s(" blockSize"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("j "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" j "),n("span",{class:"token operator"},"<"),s(" numAllocs"),n("span",{class:"token punctuation"},";"),s(" j"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    ptr`),n("span",{class:"token punctuation"},"["),s("j"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("blockSize"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ptr"),n("span",{class:"token punctuation"},"["),s("j"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"malloc"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Current Program Break %10p\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"sbrk"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`

  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Program break is now %10p\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"sbrk"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Freeing blocks from %d to %d in steps of %d\\n"'),n("span",{class:"token punctuation"},","),s(" freeMin"),n("span",{class:"token punctuation"},","),s(" freeMax"),n("span",{class:"token punctuation"},","),s(`
         freeStep`),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("j "),n("span",{class:"token operator"},"="),s(" freeMin "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(" j "),n("span",{class:"token operator"},"<"),s(" freeMax"),n("span",{class:"token punctuation"},";"),s(" j "),n("span",{class:"token operator"},"+="),s(" freeStep"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),s("ptr"),n("span",{class:"token punctuation"},"["),s("j"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"After free(),program break is %10p\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"sbrk"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"7-2"),n("p",null,"\u4E3B\u8981\u662F\u8E29\u4E86\u4E00\u4E2A\u5751\uFF0C\u8C03\u8BD5\u82B1\u4E86\u6BD4\u8F83\u957F\u7684\u65F6\u95F4\uFF0C\u6307\u9488\u503C\u8FDB\u884C\u76F8\u52A0\u51CF\u65F6\uFF0C\u4F1A\u6709\u9690\u5F0F\u7684\u7C7B\u578B\u8F6C\u6362\uFF0C\u6700\u540E\u5F97\u5230\u7684\u7ED3\u679C\u4E5F\u4E0D\u662F\u6211\u9884\u60F3\u7684\u5B57\u8282\u6570\u3002\u540C\u65F6\u6807\u51C6\u5E93\u7684 printf \u6709\u8C03\u7528 malloc \u5EFA\u7ACB\u7F13\u51B2\u533A\u9700\u8981\u6CE8\u610F\u3002"),n("p",null,[n("img",{src:r,alt:"7-2-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<assert.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdarg.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdint.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdlib.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<string.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"PRINT_BUFFER_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"200")])]),s(`
`),n("span",{class:"token keyword"},"char"),s(" msgbuf"),n("span",{class:"token punctuation"},"["),s("PRINT_BUFFER_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token comment"},"// printf \u4F1A\u4F7F\u7528glibc/malloc"),s(`
`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"tlpi_printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("format"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"."),n("span",{class:"token punctuation"},"."),n("span",{class:"token punctuation"},"."),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  va_list arglist`),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ret"),n("span",{class:"token punctuation"},","),s(" len"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"va_start"),n("span",{class:"token punctuation"},"("),s("arglist"),n("span",{class:"token punctuation"},","),s(" format"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"vsnprintf"),n("span",{class:"token punctuation"},"("),s("msgbuf"),n("span",{class:"token punctuation"},","),s(" PRINT_BUFFER_SIZE"),n("span",{class:"token punctuation"},","),s(" format"),n("span",{class:"token punctuation"},","),s(" arglist"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  len `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("msgbuf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ret `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("STDOUT_FILENO"),n("span",{class:"token punctuation"},","),s(" msgbuf"),n("span",{class:"token punctuation"},","),s(" len"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"va_end"),n("span",{class:"token punctuation"},"("),s("arglist"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" ret"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token comment"},`/**
 * low address               ->           high address
 * malloc_meta|buffer|...|malloc_meta|buffer|
 *  \u2191                      \u2191
 * [malloc_meta_first]    [malloc_meta_last]
 */`),s(`
`),n("span",{class:"token keyword"},"typedef"),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"malloc_meta"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token comment"},"// TODO *prev *next \u51CF\u5C0F\u4F53\u79EF"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"malloc_meta"),s(),n("span",{class:"token operator"},"*"),s("prev"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"malloc_meta"),s(),n("span",{class:"token operator"},"*"),s("next"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"short"),s(" is_in_use "),n("span",{class:"token operator"},":"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(" malloc_meta"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"MALLOC_META_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("malloc_meta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")")])]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"MALLOC_META_INUSE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1")])]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"MALLOC_META_NOUSE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"0")])]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name function"},"malloc_size"),n("span",{class:"token expression"},[n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token punctuation"},")"),s("                                                      ")]),n("span",{class:"token punctuation"},"\\"),s(`
  `),n("span",{class:"token expression"},[n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("prev"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("malloc_meta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")")])]),s(`

`),n("span",{class:"token keyword"},"static"),s(" malloc_meta "),n("span",{class:"token operator"},"*"),s("malloc_meta_first "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// address of first malloc_meta"),s(`
`),n("span",{class:"token keyword"},"static"),s(" malloc_meta "),n("span",{class:"token operator"},"*"),s("malloc_meta_last "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s("  "),n("span",{class:"token comment"},"// address of last malloc_meta"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"tlpi_malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" size"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
  malloc_meta `),n("span",{class:"token operator"},"*"),s("curr "),n("span",{class:"token operator"},"="),s(" malloc_meta_first"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("candidate "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"size_t"),s(" curr_size"),n("span",{class:"token punctuation"},","),s(" candidate_size "),n("span",{class:"token operator"},"="),s(" SIZE_MAX"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    curr_size `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc_size"),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("is_in_use "),n("span",{class:"token operator"},"=="),s(" MALLOC_META_NOUSE "),n("span",{class:"token operator"},"&&"),s(" curr_size "),n("span",{class:"token operator"},">="),s(" size "),n("span",{class:"token operator"},"&&"),s(`
        curr_size `),n("span",{class:"token operator"},"<"),s(" candidate_size"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      candidate `),n("span",{class:"token operator"},"="),s(" curr"),n("span",{class:"token punctuation"},";"),s(`
      candidate_size `),n("span",{class:"token operator"},"="),s(" curr_size"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    curr `),n("span",{class:"token operator"},"="),s(" curr"),n("span",{class:"token operator"},"->"),s("next"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("candidate "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("ino"),n("span",{class:"token punctuation"},";"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"sbrk"),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"+"),s(" MALLOC_META_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    candidate `),n("span",{class:"token operator"},"="),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("malloc_meta_first "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      malloc_meta_first `),n("span",{class:"token operator"},"="),s(" candidate"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
      malloc_meta_last`),n("span",{class:"token operator"},"->"),s("next "),n("span",{class:"token operator"},"="),s(" candidate"),n("span",{class:"token punctuation"},";"),s(`
      candidate`),n("span",{class:"token operator"},"->"),s("prev "),n("span",{class:"token operator"},"="),s(" malloc_meta_last"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    malloc_meta_last `),n("span",{class:"token operator"},"="),s(" candidate"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("candidate"),n("span",{class:"token operator"},"->"),s("prev "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    malloc_meta `),n("span",{class:"token operator"},"*"),s("rest"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token class-name"},"size_t"),s(" rest_size"),n("span",{class:"token punctuation"},";"),s(`
    rest_size `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc_size"),n("span",{class:"token punctuation"},"("),s("candidate"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"-"),s(" size"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("rest_size "),n("span",{class:"token operator"},">"),s(" MALLOC_META_SIZE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      rest `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),s("malloc_meta "),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("candidate"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(" MALLOC_META_SIZE "),n("span",{class:"token operator"},"+"),s(" size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      rest`),n("span",{class:"token operator"},"->"),s("is_in_use "),n("span",{class:"token operator"},"="),s(" MALLOC_META_NOUSE"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("candidate "),n("span",{class:"token operator"},"!="),s(" malloc_meta_last"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        candidate`),n("span",{class:"token operator"},"->"),s("next"),n("span",{class:"token operator"},"->"),s("prev "),n("span",{class:"token operator"},"="),s(" rest"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
      rest`),n("span",{class:"token operator"},"->"),s("next "),n("span",{class:"token operator"},"="),s(" candidate"),n("span",{class:"token operator"},"->"),s("next"),n("span",{class:"token punctuation"},";"),s(`
      rest`),n("span",{class:"token operator"},"->"),s("prev "),n("span",{class:"token operator"},"="),s(" candidate"),n("span",{class:"token punctuation"},";"),s(`
      candidate`),n("span",{class:"token operator"},"->"),s("next "),n("span",{class:"token operator"},"="),s(" rest"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  candidate`),n("span",{class:"token operator"},"->"),s("is_in_use "),n("span",{class:"token operator"},"="),s(" MALLOC_META_INUSE"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("candidate"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(" MALLOC_META_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"tlpi_free"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("ptr"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  malloc_meta `),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"size_t"),s(" curr_size"),n("span",{class:"token punctuation"},";"),s(`
  curr `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),s("malloc_meta "),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("ptr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"-"),s("MALLOC_META_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  curr`),n("span",{class:"token operator"},"->"),s("is_in_use "),n("span",{class:"token operator"},"="),s(" MALLOC_META_NOUSE"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"&&"),s(" curr "),n("span",{class:"token operator"},"=="),s(" malloc_meta_last "),n("span",{class:"token operator"},"&&"),s(`
         curr`),n("span",{class:"token operator"},"->"),s("is_in_use "),n("span",{class:"token operator"},"=="),s(" MALLOC_META_NOUSE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    curr_size `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc_size"),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(" MALLOC_META_SIZE"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"sbrk"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"-"),s("curr_size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    curr `),n("span",{class:"token operator"},"="),s(" curr"),n("span",{class:"token operator"},"->"),s("prev"),n("span",{class:"token punctuation"},";"),s(`
    malloc_meta_last `),n("span",{class:"token operator"},"="),s(" curr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("malloc_meta_last "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    malloc_meta_first `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token operator"},"*"),s("ptr_arr"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"20"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"20"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    ptr_arr`),n("span",{class:"token punctuation"},"["),s("i"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"tlpi_malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"20"),s(),n("span",{class:"token operator"},"-"),s(" i"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token operator"},"*"),s("ptr_arr"),n("span",{class:"token punctuation"},"["),s("i"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(" i "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"20"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("ptr_arr"),n("span",{class:"token punctuation"},"["),s("i"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"=="),s(" i "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"10"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"tlpi_free"),n("span",{class:"token punctuation"},"("),s("ptr_arr"),n("span",{class:"token punctuation"},"["),s("i"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    ptr_arr`),n("span",{class:"token punctuation"},"["),s("i"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"tlpi_malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token punctuation"},"("),s("i "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token operator"},"*"),s("ptr_arr"),n("span",{class:"token punctuation"},"["),s("i"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(" i "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"20"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("ptr_arr"),n("span",{class:"token punctuation"},"["),s("i"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"=="),s(" i "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u516B\u7AE0"),n("h3",null,"8-1"),n("p",null,[s("\u8FD9\u4E2A\u95EE\u9898\u672C\u8EAB\u662F\u6709\u7684\u95EE\u9898\u7684\uFF0C\u793A\u4F8B\u4EE3\u7801\u53EF\u80FD\u88AB\u4F18\u5316\u4E3A\u4E24\u79CD\u7ED3\u679C\uFF08\u8FD9\u4E2A\u53D6\u51B3\u4E8E\u7F16\u8BD1\u5668\uFF09\uFF0C\u540C\u65F6\u4E24\u6B21"),n("code",null,"getpwnam"),s("\u8FD4\u56DE\u7684\u662F\u540C\u4E00\u4E2A\u6307\u9488\uFF0C\u53EA\u662F\u4E24\u6B21\u8FD9\u4E2A\u6307\u9488\u6307\u5411\u7684\u5185\u5BB9\u4E0D\u540C\uFF0C\u6240\u4EE5\u624D\u5BFC\u81F4\u4E86\u8FD9\u4E2A\u73B0\u8C61\u3002")]),n("p",null,[n("a",{href:"https://stackoverflow.com/questions/37043139/statically-allocated-variable-when-using-getpwnam"},"https://stackoverflow.com/questions/37043139/statically-allocated-variable-when-using-getpwnam")]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token comment"},"// \u539F\u59CB\u4EE3\u7801"),s(`
`),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%ld %ld\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getpwnam"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"cattchen"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("pw_uid"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getpwnam"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"root"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("pw_uid"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token comment"},"// \u7F16\u8BD1\u5668\u53EF\u80FD\u7684\u4F18\u5316\u7ED3\u679C1"),s(`
`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"passwd"),s(),n("span",{class:"token operator"},"*"),s("p1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("p2"),n("span",{class:"token punctuation"},";"),s(`
p1 `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getpwnam"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"cattchen"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
p2 `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getpwnam"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"root"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%u\\n"'),n("span",{class:"token punctuation"},","),s(" p1"),n("span",{class:"token operator"},"->"),s("pw_uid"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%u\\n"'),n("span",{class:"token punctuation"},","),s(" p2"),n("span",{class:"token operator"},"->"),s("pw_uid"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token comment"},"// \u7F16\u8BD1\u5668\u53EF\u80FD\u7684\u4F18\u5316\u7ED3\u679C2"),s(`
`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"passwd"),s(),n("span",{class:"token operator"},"*"),s("p1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("p2"),n("span",{class:"token punctuation"},";"),s(`
p1 `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getpwnam"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"cattchen"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%u\\n"'),n("span",{class:"token punctuation"},","),s(" p1"),n("span",{class:"token operator"},"->"),s("pw_uid"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
p2 `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getpwnam"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"root"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%u\\n"'),n("span",{class:"token punctuation"},","),s(" p2"),n("span",{class:"token operator"},"->"),s("pw_uid"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token comment"},"// \u907F\u514D\u6B67\u4E49\u7684\u5199\u6CD5"),s(`
`),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%ld %ld\\n"'),n("span",{class:"token punctuation"},","),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"getpwnam"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"cattchen"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"."),s("pw_uid"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"getpwnam"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"root"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"."),s("pw_uid"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`)])]),n("h3",null,"8-2"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<assert.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<pwd.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<string.h>")]),s(`

`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"passwd"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"tlpi_getpwnam"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("name"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"passwd"),s(),n("span",{class:"token operator"},"*"),s("pw"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"setpwent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"do"),s(),n("span",{class:"token punctuation"},"{"),s(`
    pw `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getpwent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("pw "),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("pw"),n("span",{class:"token operator"},"->"),s("pw_name"),n("span",{class:"token punctuation"},","),s(" name"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"endpwent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" pw"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getpwnam"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"root"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"."),s("pw_uid "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"tlpi_getpwnam"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"root"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"."),s("pw_uid"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getpwnam"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"cattchen"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"."),s("pw_uid "),n("span",{class:"token operator"},"=="),s(`
         `),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"tlpi_getpwnam"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"cattchen"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"."),s("pw_uid"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u4E5D\u7AE0"),n("h3",null,"9-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"_GNU_SOURCE")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<assert.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/fsuid.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"uid_t"),s(" u_real"),n("span",{class:"token punctuation"},","),s(" u_effective"),n("span",{class:"token punctuation"},","),s(" u_saved"),n("span",{class:"token punctuation"},","),s(" u_fs "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"getresuid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("u_real"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("u_effective"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("u_saved"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  u_fs `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"setfsuid"),n("span",{class:"token punctuation"},"("),s("u_fs"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),s("u_real "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"1000"),s(),n("span",{class:"token operator"},"&&"),s(" u_effective "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"&&"),s(" u_saved "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"&&"),s(" u_fs "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"precheck pass\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},"// setuid(2000);"),s(`
  `),n("span",{class:"token comment"},"// getresuid(&u_real, &u_effective, &u_saved);"),s(`
  `),n("span",{class:"token comment"},'// printf("%d %d %d\\n", u_real, u_effective, u_saved);'),s(`
  `),n("span",{class:"token comment"},"// assert(u_real == 2000 && u_effective == 2000 && u_saved == 2000);"),s(`
  `),n("span",{class:"token comment"},'// printf("a passed\\n");'),s(`

  `),n("span",{class:"token comment"},"// setreuid(-1, 2000);"),s(`
  `),n("span",{class:"token comment"},"// getresuid(&u_real, &u_effective, &u_saved);"),s(`
  `),n("span",{class:"token comment"},'// printf("%d %d %d\\n", u_real, u_effective, u_saved);'),s(`
  `),n("span",{class:"token comment"},"// assert(u_real == 1000 && u_effective == 2000 && u_saved == 2000);"),s(`
  `),n("span",{class:"token comment"},'// printf("b passed\\n");'),s(`

  `),n("span",{class:"token comment"},"// seteuid(2000);"),s(`
  `),n("span",{class:"token comment"},"// getresuid(&u_real, &u_effective, &u_saved);"),s(`
  `),n("span",{class:"token comment"},'// printf("%d %d %d\\n", u_real, u_effective, u_saved);'),s(`
  `),n("span",{class:"token comment"},"// assert(u_real == 1000 && u_effective == 2000 && u_saved == 0);"),s(`
  `),n("span",{class:"token comment"},'// printf("c passed\\n");'),s(`

  `),n("span",{class:"token comment"},"// setresuid(-1, 2000, 3000);"),s(`
  `),n("span",{class:"token comment"},"// getresuid(&u_real, &u_effective, &u_saved);"),s(`
  `),n("span",{class:"token comment"},'// printf("%d %d %d\\n", u_real, u_effective, u_saved);'),s(`
  `),n("span",{class:"token comment"},"// assert(u_real == 1000 && u_effective == 2000 && u_saved == 3000);"),s(`
  `),n("span",{class:"token comment"},'// printf("e passed\\n");'),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"9-2"),n("p",null,[s("\u8BE5\u8FDB\u7A0B\u4E0D\u4EAB\u6709\u7279\u6743\uFF0C\u56E0\u4E3A"),n("code",null,"effective"),s("\u4E0D\u4E3A 0\u3002")]),n("h3",null,"9-3"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<grp.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<limits.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<pwd.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"tlpi_initgroups"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("name"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token class-name"},"gid_t"),s(" group"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"group"),s(),n("span",{class:"token operator"},"*"),s("g"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("mem"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"gid_t"),s(" grouplist"),n("span",{class:"token punctuation"},"["),s("NGROUPS_MAX "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"size_t"),s(" grouplist_len "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"setgrent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("g "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getgrent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("mem "),n("span",{class:"token operator"},"="),s(" g"),n("span",{class:"token operator"},"->"),s("gr_mem"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token operator"},"*"),s("mem "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(" mem"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("mem"),n("span",{class:"token punctuation"},","),s(" name"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        grouplist`),n("span",{class:"token punctuation"},"["),s("grouplist_len"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(" g"),n("span",{class:"token operator"},"->"),s("gr_gid"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"endgrent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  grouplist`),n("span",{class:"token punctuation"},"["),s("grouplist_len"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(" group"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"setgroups"),n("span",{class:"token punctuation"},"("),s("grouplist_len"),n("span",{class:"token punctuation"},","),s(" grouplist"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"gid_t"),s(" grouplist"),n("span",{class:"token punctuation"},"["),s("NGROUPS_MAX "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"tlpi_initgroups"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"cattchen"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"3000"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"initgroups"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`

  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getgroups"),n("span",{class:"token punctuation"},"("),s("NGROUPS_MAX "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(" grouplist"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"getgroups"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(" ino"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%d\\n"'),n("span",{class:"token punctuation"},","),s(" grouplist"),n("span",{class:"token punctuation"},"["),s("i"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"9-4"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"_GNU_SOURCE")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token class-name"},"uid_t"),s(" u1"),n("span",{class:"token punctuation"},","),s(" u2"),n("span",{class:"token punctuation"},","),s(" u3"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"show_uid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getresuid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("u1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("u2"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("u3"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"getresuid"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"real %d effective %d saved %d\\n"'),n("span",{class:"token punctuation"},","),s(" u1"),n("span",{class:"token punctuation"},","),s(" u2"),n("span",{class:"token punctuation"},","),s(" u3"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"show_uid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},"// a"),s(`
  `),n("span",{class:"token comment"},"// ino = seteuid(u1);"),s(`
  `),n("span",{class:"token comment"},"// if (ino == -1) {"),s(`
  `),n("span",{class:"token comment"},'//   errExit("seteuid");'),s(`
  `),n("span",{class:"token comment"},"// }"),s(`
  `),n("span",{class:"token comment"},"// show_uid();"),s(`
  `),n("span",{class:"token comment"},"// exit(EXIT_SUCCESS);"),s(`

  `),n("span",{class:"token comment"},"// b"),s(`
  `),n("span",{class:"token comment"},"// ino = setresuid(u1, u1, u1);"),s(`
  `),n("span",{class:"token comment"},"// show_uid();"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"9-5"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"_GNU_SOURCE")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token class-name"},"uid_t"),s(" u1"),n("span",{class:"token punctuation"},","),s(" u2"),n("span",{class:"token punctuation"},","),s(" u3"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"show_uid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getresuid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("u1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("u2"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("u3"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"getresuid"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"real %d effective %d saved %d\\n"'),n("span",{class:"token punctuation"},","),s(" u1"),n("span",{class:"token punctuation"},","),s(" u2"),n("span",{class:"token punctuation"},","),s(" u3"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},`/*
 * # shell process real user as cattchen
 * gcc ch9/9-5.c -o set-user-ID-root -ltlpi
 * sudo chown root set-user-ID-root
 * sudo chmod u+s set-user-ID-root
 * ./set-user-ID-root
 */`),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"show_uid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u5341\u7AE0"),n("h3",null,"10-1"),n("p",null,"\u9700\u8981\u9694 42949672 \u79D2"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdint.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/times.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"200")])]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" clock_per_second "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"sysconf"),n("span",{class:"token punctuation"},"("),s("_SC_CLK_TCK"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"double"),s(" res "),n("span",{class:"token operator"},"="),s(" UINT32_MAX "),n("span",{class:"token operator"},"/"),s(" clock_per_second"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%lf\\n"'),n("span",{class:"token punctuation"},","),s(" res"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u5341\u4E00\u7AE0"),n("h3",null,"11-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"sysconfPrint"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("msg"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" name"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"long"),s(" lim"),n("span",{class:"token punctuation"},";"),s(`
  errno `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  lim `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"sysconf"),n("span",{class:"token punctuation"},"("),s("name"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("lim "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s %ld\\n"'),n("span",{class:"token punctuation"},","),s(" msg"),n("span",{class:"token punctuation"},","),s(" lim"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("errno "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s (indeterminate)\\n"'),n("span",{class:"token punctuation"},","),s(" msg"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sysconf %s"'),n("span",{class:"token punctuation"},","),s(" msg"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"sysconfPrint"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"_SC_ARG_MAX: "'),n("span",{class:"token punctuation"},","),s(" _SC_ARG_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sysconfPrint"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"_SC_LOGIN_NAME_MAX: "'),n("span",{class:"token punctuation"},","),s(" _SC_LOGIN_NAME_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sysconfPrint"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"_SC_OPEN_MAX: "'),n("span",{class:"token punctuation"},","),s(" _SC_OPEN_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sysconfPrint"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"_SC_NGROUPS_MAX: "'),n("span",{class:"token punctuation"},","),s(" _SC_NGROUPS_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sysconfPrint"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"_SC_PAGESIZE: "'),n("span",{class:"token punctuation"},","),s(" _SC_PAGESIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sysconfPrint"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"_SC_RTSIG_MAX: "'),n("span",{class:"token punctuation"},","),s(" _SC_RTSIG_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u5341\u4E8C\u7AE0"),n("h3",null,"12-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<ctype.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<dirent.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<pwd.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<string.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"AUTOINCMM_INIT_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"32")])]),s(`

`),n("span",{class:"token keyword"},"typedef"),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"auto_inc_mm"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("ptr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"int"),s(" size"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"int"),s(" pos"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(" auto_inc_mm"),n("span",{class:"token punctuation"},";"),s(`

auto_inc_mm `),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"autoincmm_create"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  auto_inc_mm `),n("span",{class:"token operator"},"*"),s("mm"),n("span",{class:"token punctuation"},";"),s(`
  mm `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("auto_inc_mm"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  mm`),n("span",{class:"token operator"},"->"),s("ptr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("AUTOINCMM_INIT_SIZE "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  mm`),n("span",{class:"token operator"},"->"),s("size "),n("span",{class:"token operator"},"="),s(" AUTOINCMM_INIT_SIZE"),n("span",{class:"token punctuation"},";"),s(`
  mm`),n("span",{class:"token operator"},"->"),s("pos "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" mm"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"proc_status_item"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("name"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("value"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"autoincmm_append"),n("span",{class:"token punctuation"},"("),s("auto_inc_mm "),n("span",{class:"token operator"},"*"),s("mm"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("src"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token class-name"},"size_t"),s(" size"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"int"),s(" next_size "),n("span",{class:"token operator"},"="),s(" mm"),n("span",{class:"token operator"},"->"),s("size"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"+"),s(" mm"),n("span",{class:"token operator"},"->"),s("pos "),n("span",{class:"token operator"},">="),s(" next_size"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    next_size `),n("span",{class:"token operator"},"="),s(" next_size "),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token punctuation"},"("),s("next_size "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"1024"),s(),n("span",{class:"token operator"},"?"),s(),n("span",{class:"token number"},"2"),s(),n("span",{class:"token operator"},":"),s(),n("span",{class:"token number"},"1.25"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("next_size "),n("span",{class:"token operator"},"!="),s(" mm"),n("span",{class:"token operator"},"->"),s("size"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("next_ptr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("next_size "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),s("next_ptr"),n("span",{class:"token punctuation"},","),s(" mm"),n("span",{class:"token operator"},"->"),s("ptr"),n("span",{class:"token punctuation"},","),s(" mm"),n("span",{class:"token operator"},"->"),s("pos"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    mm`),n("span",{class:"token operator"},"->"),s("ptr "),n("span",{class:"token operator"},"="),s(" next_ptr"),n("span",{class:"token punctuation"},";"),s(`
    mm`),n("span",{class:"token operator"},"->"),s("size "),n("span",{class:"token operator"},"="),s(" next_size"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),s("mm"),n("span",{class:"token operator"},"->"),s("ptr "),n("span",{class:"token operator"},"+"),s(" mm"),n("span",{class:"token operator"},"->"),s("pos"),n("span",{class:"token punctuation"},","),s(" src"),n("span",{class:"token punctuation"},","),s(" size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  mm`),n("span",{class:"token operator"},"->"),s("pos "),n("span",{class:"token operator"},"+="),s(" size"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("mm"),n("span",{class:"token operator"},"->"),s("ptr"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(" mm"),n("span",{class:"token operator"},"->"),s("pos"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"autoincmm_reset"),n("span",{class:"token punctuation"},"("),s("auto_inc_mm "),n("span",{class:"token operator"},"*"),s("mm"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(" mm"),n("span",{class:"token operator"},"->"),s("pos "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(" ps_fd"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"setpsent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("filename"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  ps_fd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("filename"),n("span",{class:"token punctuation"},","),s(" O_RDONLY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" ps_fd"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUFFER_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"32")])]),s(`
`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"proc_status_item"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"getpsent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"static"),s(" auto_inc_mm "),n("span",{class:"token operator"},"*"),s("mm"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"char"),s(" buffer"),n("span",{class:"token punctuation"},"["),s("BUFFER_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"int"),s(" pos_buffer "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"proc_status_item"),s(" curr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"static"),s(" auto_inc_mm "),n("span",{class:"token operator"},"*"),s("curr_name"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"static"),s(" auto_inc_mm "),n("span",{class:"token operator"},"*"),s("curr_value"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("mm "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    mm `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"autoincmm_create"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("curr_name "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    curr_name `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"autoincmm_create"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("curr_value "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    curr_value `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"autoincmm_create"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"autoincmm_reset"),n("span",{class:"token punctuation"},"("),s("mm"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"autoincmm_reset"),n("span",{class:"token punctuation"},"("),s("curr_name"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"autoincmm_reset"),n("span",{class:"token punctuation"},"("),s("curr_value"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("ps_fd"),n("span",{class:"token punctuation"},","),s(" buffer"),n("span",{class:"token punctuation"},","),s(" BUFFER_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"read"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    pos_buffer `),n("span",{class:"token operator"},"="),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(" ino"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("buffer"),n("span",{class:"token punctuation"},"["),s("i"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'\\n'"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        pos_buffer `),n("span",{class:"token operator"},"="),s(" i"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token function"},"autoincmm_append"),n("span",{class:"token punctuation"},"("),s("mm"),n("span",{class:"token punctuation"},","),s(" buffer"),n("span",{class:"token punctuation"},","),s(" pos_buffer"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("pos_buffer "),n("span",{class:"token operator"},"!="),s(" ino"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"int"),s(" offset "),n("span",{class:"token operator"},"="),s(" pos_buffer "),n("span",{class:"token operator"},"-"),s(" ino "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"lseek"),n("span",{class:"token punctuation"},"("),s("ps_fd"),n("span",{class:"token punctuation"},","),s(" offset"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"SEEK_CUR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("mm"),n("span",{class:"token operator"},"->"),s("ptr "),n("span",{class:"token operator"},"+"),s(" i"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token char"},"':'"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"autoincmm_append"),n("span",{class:"token punctuation"},"("),s("curr_name"),n("span",{class:"token punctuation"},","),s(" mm"),n("span",{class:"token operator"},"->"),s("ptr "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token punctuation"},"("),s("i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  i`),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("mm"),n("span",{class:"token operator"},"->"),s("ptr "),n("span",{class:"token operator"},"+"),s(" i"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'\\t'"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("mm"),n("span",{class:"token operator"},"->"),s("ptr "),n("span",{class:"token operator"},"+"),s(" i"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"' '"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    i`),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("mm"),n("span",{class:"token operator"},"->"),s("ptr "),n("span",{class:"token operator"},"+"),s(" i"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"autoincmm_append"),n("span",{class:"token punctuation"},"("),s("curr_value"),n("span",{class:"token punctuation"},","),s(" mm"),n("span",{class:"token operator"},"->"),s("ptr "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token punctuation"},"("),s("i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  curr`),n("span",{class:"token punctuation"},"."),s("name "),n("span",{class:"token operator"},"="),s(" curr_name"),n("span",{class:"token operator"},"->"),s("ptr"),n("span",{class:"token punctuation"},";"),s(`
  curr`),n("span",{class:"token punctuation"},"."),s("value "),n("span",{class:"token operator"},"="),s(" curr_value"),n("span",{class:"token operator"},"->"),s("ptr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"&"),s("curr"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"endpsent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("ps_fd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token class-name"},"uid_t"),s(),n("span",{class:"token function"},"uid_from_name"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("name"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"passwd"),s(),n("span",{class:"token operator"},"*"),s("pw"),n("span",{class:"token punctuation"},";"),s(`
  pw `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getpwnam"),n("span",{class:"token punctuation"},"("),s("name"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("pw "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"getpwnam"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" pw"),n("span",{class:"token operator"},"->"),s("pw_uid"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s <user>\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"uid_t"),s(" uid"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" filename"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"64"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  DIR `),n("span",{class:"token operator"},"*"),s("dir"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"dirent"),s(),n("span",{class:"token operator"},"*"),s("dire"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"proc_status_item"),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},";"),s(`

  uid `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"uid_from_name"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  dir `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"opendir"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"/proc"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("dire "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"readdir"),n("span",{class:"token punctuation"},"("),s("dir"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),n("span",{class:"token function"},"strspn"),n("span",{class:"token punctuation"},"("),s("dire"),n("span",{class:"token operator"},"->"),s("d_name"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"1234567890"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"||"),s(" dire"),n("span",{class:"token operator"},"->"),s("d_type "),n("span",{class:"token operator"},"!="),s(" DT_DIR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token function"},"snprintf"),n("span",{class:"token punctuation"},"("),s("filename"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"64"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"/proc/%s/status"'),n("span",{class:"token punctuation"},","),s(" dire"),n("span",{class:"token operator"},"->"),s("d_name"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"setpsent"),n("span",{class:"token punctuation"},"("),s("filename"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("name "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token class-name"},"uid_t"),s(" curr_uid "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getpsent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("name"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Name"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        name `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("value"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),s("name"),n("span",{class:"token punctuation"},","),s(" curr"),n("span",{class:"token operator"},"->"),s("value"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("name"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Uid"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        curr_uid `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"atol"),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("value"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("curr_uid "),n("span",{class:"token operator"},"=="),s(" uid"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"puts"),n("span",{class:"token punctuation"},"("),s("name"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token function"},"endpsent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"12-2"),n("p",null,[n("img",{src:d,alt:"12-2-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<dirent.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdlib.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<string.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"AUTOINCMM_SIZE_INIT"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"32")])]),s(`

`),n("span",{class:"token keyword"},"typedef"),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"auto_inc_mm"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("ptr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"size_t"),s(" size"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"size_t"),s(" pos"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(" auto_inc_mm"),n("span",{class:"token punctuation"},";"),s(`

auto_inc_mm `),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"autoincmm_create"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  auto_inc_mm `),n("span",{class:"token operator"},"*"),s("mm "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("auto_inc_mm"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  mm`),n("span",{class:"token operator"},"->"),s("ptr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("AUTOINCMM_SIZE_INIT"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  mm`),n("span",{class:"token operator"},"->"),s("size "),n("span",{class:"token operator"},"="),s(" AUTOINCMM_SIZE_INIT"),n("span",{class:"token punctuation"},";"),s(`
  mm`),n("span",{class:"token operator"},"->"),s("pos "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" mm"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"autoincmm_append"),n("span",{class:"token punctuation"},"("),s("auto_inc_mm "),n("span",{class:"token operator"},"*"),s("mm"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("ptr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token class-name"},"size_t"),s(" size"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"size_t"),s(" next_size "),n("span",{class:"token operator"},"="),s(" mm"),n("span",{class:"token operator"},"->"),s("size"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("mm"),n("span",{class:"token operator"},"->"),s("pos "),n("span",{class:"token operator"},"+"),s(" size "),n("span",{class:"token operator"},">="),s(" next_size"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    next_size `),n("span",{class:"token operator"},"="),s(" next_size "),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token punctuation"},"("),s("next_size "),n("span",{class:"token operator"},"<="),s(),n("span",{class:"token number"},"1024"),s(),n("span",{class:"token operator"},"?"),s(),n("span",{class:"token number"},"2"),s(),n("span",{class:"token operator"},":"),s(),n("span",{class:"token number"},"1.25"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("next_size "),n("span",{class:"token operator"},"!="),s(" mm"),n("span",{class:"token operator"},"->"),s("size"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("next_ptr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("next_size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),s("next_ptr"),n("span",{class:"token punctuation"},","),s(" mm"),n("span",{class:"token operator"},"->"),s("ptr"),n("span",{class:"token punctuation"},","),s(" mm"),n("span",{class:"token operator"},"->"),s("pos"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),s("mm"),n("span",{class:"token operator"},"->"),s("ptr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    mm`),n("span",{class:"token operator"},"->"),s("ptr "),n("span",{class:"token operator"},"="),s(" next_ptr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),s("mm"),n("span",{class:"token operator"},"->"),s("ptr "),n("span",{class:"token operator"},"+"),s(" mm"),n("span",{class:"token operator"},"->"),s("pos"),n("span",{class:"token punctuation"},","),s(" ptr"),n("span",{class:"token punctuation"},","),s(" size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  mm`),n("span",{class:"token operator"},"->"),s("pos "),n("span",{class:"token operator"},"+="),s(" size"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"autoincmm_reset"),n("span",{class:"token punctuation"},"("),s("auto_inc_mm "),n("span",{class:"token operator"},"*"),s("mm"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(" mm"),n("span",{class:"token operator"},"->"),s("pos "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"pstree_node"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("name"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"int"),s(" pid"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"int"),s(" ppid"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(" pstree_node"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"ps_item"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("name"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("value"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(" ps_fd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"setpsent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("filename"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  ps_fd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("filename"),n("span",{class:"token punctuation"},","),s(" O_RDONLY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" ps_fd"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"ps_item"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"getpsent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"char"),s(" buffer"),n("span",{class:"token punctuation"},"["),s("AUTOINCMM_SIZE_INIT"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"static"),s(" auto_inc_mm "),n("span",{class:"token operator"},"*"),s("mm "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"static"),s(" auto_inc_mm "),n("span",{class:"token operator"},"*"),s("curr_name "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"static"),s(" auto_inc_mm "),n("span",{class:"token operator"},"*"),s("curr_value "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"ps_item"),s(" curr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"int"),s(" pos"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("mm "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    mm `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"autoincmm_create"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("curr_name "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    curr_name `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"autoincmm_create"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("curr_value "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    curr_value `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"autoincmm_create"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"autoincmm_reset"),n("span",{class:"token punctuation"},"("),s("mm"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"autoincmm_reset"),n("span",{class:"token punctuation"},"("),s("curr_name"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"autoincmm_reset"),n("span",{class:"token punctuation"},"("),s("curr_value"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("ps_fd"),n("span",{class:"token punctuation"},","),s(" buffer"),n("span",{class:"token punctuation"},","),s(" AUTOINCMM_SIZE_INIT"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"read"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    pos `),n("span",{class:"token operator"},"="),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(" ino"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("buffer"),n("span",{class:"token punctuation"},"["),s("i"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'\\n'"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        pos `),n("span",{class:"token operator"},"="),s(" i"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token function"},"autoincmm_append"),n("span",{class:"token punctuation"},"("),s("mm"),n("span",{class:"token punctuation"},","),s(" buffer"),n("span",{class:"token punctuation"},","),s(" pos"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("pos "),n("span",{class:"token operator"},"!="),s(" ino"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"autoincmm_append"),n("span",{class:"token punctuation"},"("),s("mm"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'""'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"int"),s(" offset "),n("span",{class:"token operator"},"="),s(" pos "),n("span",{class:"token operator"},"-"),s(" ino "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"lseek"),n("span",{class:"token punctuation"},"("),s("ps_fd"),n("span",{class:"token punctuation"},","),s(" offset"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"SEEK_CUR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("mm"),n("span",{class:"token operator"},"->"),s("ptr"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(" i"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token char"},"':'"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"autoincmm_append"),n("span",{class:"token punctuation"},"("),s("curr_name"),n("span",{class:"token punctuation"},","),s(" mm"),n("span",{class:"token operator"},"->"),s("ptr "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token punctuation"},"("),s("i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  i`),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("mm"),n("span",{class:"token operator"},"->"),s("ptr"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(" i"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"' '"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("mm"),n("span",{class:"token operator"},"->"),s("ptr"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(" i"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'\\t'"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    i`),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("mm"),n("span",{class:"token operator"},"->"),s("ptr"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(" i"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"autoincmm_append"),n("span",{class:"token punctuation"},"("),s("curr_value"),n("span",{class:"token punctuation"},","),s(" mm"),n("span",{class:"token operator"},"->"),s("ptr "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token punctuation"},"("),s("i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"autoincmm_append"),n("span",{class:"token punctuation"},"("),s("curr_name"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'""'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"autoincmm_append"),n("span",{class:"token punctuation"},"("),s("curr_value"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'""'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  curr`),n("span",{class:"token punctuation"},"."),s("name "),n("span",{class:"token operator"},"="),s(" curr_name"),n("span",{class:"token operator"},"->"),s("ptr"),n("span",{class:"token punctuation"},";"),s(`
  curr`),n("span",{class:"token punctuation"},"."),s("value "),n("span",{class:"token operator"},"="),s(" curr_value"),n("span",{class:"token operator"},"->"),s("ptr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"&"),s("curr"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"endpsend"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("ps_fd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"print_pstree"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"pstree_node"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("list"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" ppid"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" depth"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"pstree_node"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("item "),n("span",{class:"token operator"},"="),s(" list"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token operator"},"*"),s("item "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(" item"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ppid "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("item"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("ppid"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(" depth"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"|\\t"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
      `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"|---%s(%d)\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("item"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("name"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("item"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("pid"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"print_pstree"),n("span",{class:"token punctuation"},"("),s("list"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("item"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("pid"),n("span",{class:"token punctuation"},","),s(" depth "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" filename"),n("span",{class:"token punctuation"},"["),s("PATH_MAX"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  DIR `),n("span",{class:"token operator"},"*"),s("d"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"dirent"),s(),n("span",{class:"token operator"},"*"),s("dire"),n("span",{class:"token punctuation"},";"),s(`
  d `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"opendir"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"/proc"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"pstree_node"),s(),n("span",{class:"token operator"},"*"),s("ps"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"ps_item"),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},";"),s(`
  auto_inc_mm `),n("span",{class:"token operator"},"*"),s("list "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"autoincmm_create"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("dire "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"readdir"),n("span",{class:"token punctuation"},"("),s("d"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),n("span",{class:"token function"},"strspn"),n("span",{class:"token punctuation"},"("),s("dire"),n("span",{class:"token operator"},"->"),s("d_name"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"1234567890"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"||"),s(" dire"),n("span",{class:"token operator"},"->"),s("d_type "),n("span",{class:"token operator"},"!="),s(" DT_DIR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token function"},"snprintf"),n("span",{class:"token punctuation"},"("),s("filename"),n("span",{class:"token punctuation"},","),s(" PATH_MAX"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"/proc/%s/status"'),n("span",{class:"token punctuation"},","),s(" dire"),n("span",{class:"token operator"},"->"),s("d_name"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    ps `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"pstree_node"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"setpsent"),n("span",{class:"token punctuation"},"("),s("filename"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getpsent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("name"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Name"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        ps`),n("span",{class:"token operator"},"->"),s("name "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("value"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),s("ps"),n("span",{class:"token operator"},"->"),s("name"),n("span",{class:"token punctuation"},","),s(" curr"),n("span",{class:"token operator"},"->"),s("value"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("name"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Pid"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        ps`),n("span",{class:"token operator"},"->"),s("pid "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"atoi"),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("value"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("name"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"PPid"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        ps`),n("span",{class:"token operator"},"->"),s("ppid "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"atoi"),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("value"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token function"},"endpsend"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"autoincmm_append"),n("span",{class:"token punctuation"},"("),s("list"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("ps"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("ps"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    ps `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"autoincmm_append"),n("span",{class:"token punctuation"},"("),s("list"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("ps"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("ps"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"print_pstree"),n("span",{class:"token punctuation"},"("),s("list"),n("span",{class:"token operator"},"->"),s("ptr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"12-3"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<dirent.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<limits.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"reset_filename"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("ptr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token class-name"},"size_t"),s(" size"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),s("ptr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" target_filename"),n("span",{class:"token punctuation"},"["),s("PATH_MAX"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" tmp_filename"),n("span",{class:"token punctuation"},"["),s("PATH_MAX"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(`
      tmp2_filename`),n("span",{class:"token punctuation"},"["),s("PATH_MAX"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s <filename>\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  fd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" O_RDONLY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"snprintf"),n("span",{class:"token punctuation"},"("),s("tmp_filename"),n("span",{class:"token punctuation"},","),s(" PATH_MAX"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"/proc/self/fd/%d"'),n("span",{class:"token punctuation"},","),s(" fd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"readlink"),n("span",{class:"token punctuation"},"("),s("tmp_filename"),n("span",{class:"token punctuation"},","),s(" target_filename"),n("span",{class:"token punctuation"},","),s(" PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"reset_filename"),n("span",{class:"token punctuation"},"("),s("tmp_filename"),n("span",{class:"token punctuation"},","),s(" PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"readlink"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  DIR `),n("span",{class:"token operator"},"*"),s("d1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("d2"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"dirent"),s(),n("span",{class:"token operator"},"*"),s("dire1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("dire2"),n("span",{class:"token punctuation"},";"),s(`
  d1 `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"opendir"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"/proc"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("d1 "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"opendir d1"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("dire1 "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"readdir"),n("span",{class:"token punctuation"},"("),s("d1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),n("span",{class:"token function"},"strspn"),n("span",{class:"token punctuation"},"("),s("dire1"),n("span",{class:"token operator"},"->"),s("d_name"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"1234567890"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"||"),s(" dire1"),n("span",{class:"token operator"},"->"),s("d_type "),n("span",{class:"token operator"},"!="),s(" DT_DIR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token function"},"snprintf"),n("span",{class:"token punctuation"},"("),s("tmp_filename"),n("span",{class:"token punctuation"},","),s(" PATH_MAX"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"/proc/%s/fd"'),n("span",{class:"token punctuation"},","),s(" dire1"),n("span",{class:"token operator"},"->"),s("d_name"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    d2 `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"opendir"),n("span",{class:"token punctuation"},"("),s("tmp_filename"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"reset_filename"),n("span",{class:"token punctuation"},"("),s("tmp_filename"),n("span",{class:"token punctuation"},","),s(" PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("d2 "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"opendir d2"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("dire2 "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"readdir"),n("span",{class:"token punctuation"},"("),s("d2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("dire2"),n("span",{class:"token operator"},"->"),s("d_name"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"."'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("dire2"),n("span",{class:"token operator"},"->"),s("d_name"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'".."'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
      `),n("span",{class:"token function"},"snprintf"),n("span",{class:"token punctuation"},"("),s("tmp_filename"),n("span",{class:"token punctuation"},","),s(" PATH_MAX"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"/proc/%s/fd/%s"'),n("span",{class:"token punctuation"},","),s(" dire1"),n("span",{class:"token operator"},"->"),s("d_name"),n("span",{class:"token punctuation"},","),s(`
               dire2`),n("span",{class:"token operator"},"->"),s("d_name"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"readlink"),n("span",{class:"token punctuation"},"("),s("tmp_filename"),n("span",{class:"token punctuation"},","),s(" tmp2_filename"),n("span",{class:"token punctuation"},","),s(" PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"readlink"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("tmp2_filename"),n("span",{class:"token punctuation"},","),s(" target_filename"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fd: %s\\n"'),n("span",{class:"token punctuation"},","),s(" dire1"),n("span",{class:"token operator"},"->"),s("d_name"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
      `),n("span",{class:"token function"},"reset_filename"),n("span",{class:"token punctuation"},"("),s("tmp_filename"),n("span",{class:"token punctuation"},","),s(" PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"reset_filename"),n("span",{class:"token punctuation"},"("),s("tmp2_filename"),n("span",{class:"token punctuation"},","),s(" PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"closedir"),n("span",{class:"token punctuation"},"("),s("d1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"closedir"),n("span",{class:"token punctuation"},"("),s("d2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u5341\u4E09\u7AE0"),n("h3",null,"13-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/stat.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"ifndef"),s(),n("span",{class:"token expression"},"BUF_SIZE")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1024")])]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"endif")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" input_fd"),n("span",{class:"token punctuation"},","),s(" output_fd"),n("span",{class:"token punctuation"},","),s(" open_flags"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"mode_t"),s(" file_perms"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"ssize_t"),s(" num_read"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" buf"),n("span",{class:"token punctuation"},"["),s("BUF_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s old-file new-file\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  input_fd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" O_RDONLY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("input_fd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  open_flags `),n("span",{class:"token operator"},"="),s(" O_CREAT "),n("span",{class:"token operator"},"|"),s(" O_WRONLY "),n("span",{class:"token operator"},"|"),s(" O_TRUNC"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"ifdef"),s(),n("span",{class:"token expression"},"USE_SYNC")]),s(`
  open_flags `),n("span",{class:"token operator"},"|="),s(" O_SYNC"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"endif")]),s(`

  file_perms `),n("span",{class:"token operator"},"="),s(" S_IRUSR "),n("span",{class:"token operator"},"|"),s(" S_IWUSR "),n("span",{class:"token operator"},"|"),s(" S_IRGRP "),n("span",{class:"token operator"},"|"),s(" S_IWGRP "),n("span",{class:"token operator"},"|"),s(" S_IROTH "),n("span",{class:"token operator"},"|"),s(" S_IWOTH"),n("span",{class:"token punctuation"},";"),s(`
  output_fd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" open_flags"),n("span",{class:"token punctuation"},","),s(" file_perms"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("output_fd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("num_read "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("input_fd"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("output_fd"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" num_read"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"write"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("num_read "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"read"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("input_fd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"close"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("output_fd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"close"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("pre",{class:"language-shell"},[n("code",{class:"language-shell"},[n("span",{class:"token function"},"dd"),s(),n("span",{class:"token assign-left variable"},"if"),n("span",{class:"token operator"},"="),s("/dev/urandom "),n("span",{class:"token assign-left variable"},"of"),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"1"),s(".bin "),n("span",{class:"token assign-left variable"},"bs"),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"1024"),s(),n("span",{class:"token assign-left variable"},"count"),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"100"),s(`
gcc ch13/13-1.c `),n("span",{class:"token parameter variable"},"-DBUF_SIZE"),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"1"),s(),n("span",{class:"token parameter variable"},"-ltlpi"),s(),n("span",{class:"token parameter variable"},"-o"),s(` copy-1
gcc ch13/13-1.c `),n("span",{class:"token parameter variable"},"-DBUF_SIZE"),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"1048576"),s(),n("span",{class:"token parameter variable"},"-ltlpi"),s(),n("span",{class:"token parameter variable"},"-o"),s(` copy-1048576
gcc ch13/13-1.c `),n("span",{class:"token parameter variable"},"-DBUF_SIZE"),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"1"),s(),n("span",{class:"token parameter variable"},"-DUSE_SYNC"),s(),n("span",{class:"token parameter variable"},"-ltlpi"),s(),n("span",{class:"token parameter variable"},"-o"),s(` copy-1-sync
gcc ch13/13-1.c `),n("span",{class:"token parameter variable"},"-DBUF_SIZE"),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"1048576"),s(),n("span",{class:"token parameter variable"},"-DUSE_SYNC"),s(),n("span",{class:"token parameter variable"},"-ltlpi"),s(),n("span",{class:"token parameter variable"},"-o"),s(` copy-1048576-sync
`)])]),n("p",null,[n("img",{src:m,alt:"13-1-1"})]),n("h3",null,"13-3"),n("p",null,[n("code",null,"fflush(fp);"),s("\u4F1A\u6E05\u7A7A\u8FDB\u7A0B\u7684\u7528\u6237\u7A7A\u95F4 buffer\uFF0C\u8C03\u7528"),n("code",null,"write"),s("\u5C06\u5185\u5BB9\u5199\u5165\u5185\u6838\u7F13\u51B2\u533A")]),n("p",null,[n("code",null,"fsync(fileno(fp));"),s("\u7B49\u5230\u5185\u6838\u7F13\u51B2\u533A\u7684\u5185\u5BB9\u52A0\u5165\u5199\u961F\u5217\uFF0C\u5185\u5BB9\u90FD\u5199\u5230\u78C1\u76D8\u540E\u624D\u8FD4\u56DE")]),n("h3",null,"13-4"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"If I had more time, \\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("STDOUT_FILENO"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"I would have written you a shorter letter.\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"43"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("p",null,[n("img",{src:f,alt:"13-4-1"})]),n("p",null,[s("\u5F53 stdout \u6307\u5411\u7EC8\u7AEF\u65F6\uFF0C\u9ED8\u8BA4\u7684\u7F13\u51B2\u7C7B\u578B\u4E3A"),n("code",null,"_IOLBF"),s("\uFF0C\u8F93\u51FA\u6362\u884C\u7B26\u524D\uFF08\u9664\u975E\u7F13\u51B2\u533A\u5DF2\u6EE1\uFF09\u5C06\u7F13\u51B2\u6570\u636E\u3002")]),n("p",null,[s("\u5F53 stdout \u6307\u5411\u6587\u4EF6\u65F6\uFF0C\u9ED8\u8BA4\u7684\u7F13\u51B2\u7C7B\u578B\u4E3A"),n("code",null,"_IOFBF"),s("\uFF0C\u7F13\u51B2\u533A\u6EE1\u65F6\u624D\u4F1A\u8BFB/\u5199\u6570\u636E\u3002")]),n("h3",null,"13-5"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"ifndef"),s(),n("span",{class:"token expression"},"BUF_SIZE")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"32")])]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"endif")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" num "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(" fd"),n("span",{class:"token punctuation"},","),s(" ino"),n("span",{class:"token punctuation"},","),s(" offset"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("filename"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" buf"),n("span",{class:"token punctuation"},"["),s("BUF_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" c"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s [-n num] file\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("c "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getopt"),n("span",{class:"token punctuation"},"("),s("argc"),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"n:"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'n'"),n("span",{class:"token operator"},":"),s(`
      num `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"atoi"),n("span",{class:"token punctuation"},"("),s("optarg"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("num "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    num `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"10"),n("span",{class:"token punctuation"},";"),s(`
    filename `),n("span",{class:"token operator"},"="),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
    filename `),n("span",{class:"token operator"},"="),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("num "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"num should larger than 0"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  fd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("filename"),n("span",{class:"token punctuation"},","),s(" O_RDONLY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"lseek"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"-"),s("BUF_SIZE"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"SEEK_END"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"lseek1"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("num "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"read"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(" ino "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},">="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"--"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},"["),s("i"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'\\n'"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        num `),n("span",{class:"token operator"},"-="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("num "),n("span",{class:"token operator"},"<="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        offset `),n("span",{class:"token operator"},"="),s(" i "),n("span",{class:"token operator"},"-"),s(" ino "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
        ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"lseek"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" offset"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"SEEK_CUR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
          `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"lseek2"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("num "),n("span",{class:"token operator"},"<="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    offset `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"-"),s("BUF_SIZE "),n("span",{class:"token operator"},"-"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"lseek"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" offset"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"SEEK_CUR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"lseek3"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("STDOUT_FILENO"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" ino"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"write"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u5341\u56DB\u7AE0"),n("h2",null,"\u7B2C\u5341\u4E94\u7AE0"),n("h3",null,"15-1"),n("pre",{class:"language-bash"},[n("code",{class:"language-bash"},[n("span",{class:"token shebang important"},"#!/usr/bin/env bash"),s(`

`),n("span",{class:"token builtin class-name"},"echo"),s(),n("span",{class:"token string"},"'123'"),s(),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"1"),s(".txt "),n("span",{class:"token operator"},"&&"),n("span",{class:"token punctuation"},"\\"),s(`
`),n("span",{class:"token function"},"chmod"),s(" 0077 "),n("span",{class:"token number"},"1"),s(".txt "),n("span",{class:"token operator"},"&&"),n("span",{class:"token punctuation"},"\\"),s(`
`),n("span",{class:"token function"},"cat"),s(),n("span",{class:"token number"},"1"),s(`.txt
`)])]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[s("#"),n("span",{class:"token operator"},"!"),n("span",{class:"token operator"},"/"),s("usr"),n("span",{class:"token operator"},"/"),s("bin"),n("span",{class:"token operator"},"/"),s(`env bash

mkdir tmp`),n("span",{class:"token operator"},"-"),s("tlpi "),n("span",{class:"token operator"},"&&"),s(`\\
echo `),n("span",{class:"token char"},"'1234'"),s(),n("span",{class:"token operator"},">"),s(" tmp"),n("span",{class:"token operator"},"-"),s("tlpi"),n("span",{class:"token operator"},"/"),n("span",{class:"token number"},"1."),s("txt "),n("span",{class:"token operator"},"&&"),s(`\\
chmod `),n("span",{class:"token number"},"0477"),s(" tmp"),n("span",{class:"token operator"},"-"),s(`tlpi
ls tmp`),n("span",{class:"token operator"},"-"),s(`tlpi
cat tmp`),n("span",{class:"token operator"},"-"),s("tlpi"),n("span",{class:"token operator"},"/"),n("span",{class:"token number"},"1."),s(`txt
`)])]),n("table",null,[n("thead",null,[n("tr",null,[n("th"),n("th",null,"\u65B0\u5EFA\u6587\u4EF6"),n("th",null,"\u8BFB\u6587\u4EF6"),n("th",null,"\u5199\u6587\u4EF6"),n("th",null,"\u5220\u9664\u6587\u4EF6")])]),n("tbody",null,[n("tr",null,[n("td",null,"\u7236\u76EE\u5F55\u6743\u9650"),n("td",null,"W+X"),n("td",null,"X"),n("td",null,"X"),n("td",null,"W+X")]),n("tr",null,[n("td",null,"\u6587\u4EF6\u672C\u8EAB"),n("td",null,"N/A"),n("td",null,"R"),n("td",null,"W"),n("td",null,"(nil)")])])]),n("p",null,"\u6587\u4EF6\u6807\u8BB0\u4E3A sticky \u540E\uFF0C\u9664\u4E86\u6709\u5BF9\u5E94\u6743\u9650\uFF0C\u8FD8\u9700\u8981\u662F\u6587\u4EF6\u7684\u5C5E\u4E3B"),n("h2",null,"15-2"),n("p",null,"\u4E0D\u4F1A\u3002stat \u6CA1\u6709\u8BBF\u95EE/\u4FEE\u6539\u6587\u4EF6\u5185\u5BB9\uFF0C\u6CA1\u6709\u4FEE\u6539\u6587\u4EF6\u7684 i-node \u4FE1\u606F"),n("p",null,[n("img",{src:y,alt:"15-2-1"})]),n("h3",null,"15-3"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/stat.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"stat"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s <filename>\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  fd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" O_RDONLY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fstat"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("s"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fstat"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Access %lu.%lu\\nModify: %lu.%lu\\nChange: %lu.%lu\\n"'),n("span",{class:"token punctuation"},","),s(" s"),n("span",{class:"token punctuation"},"."),s("st_atim"),n("span",{class:"token punctuation"},"."),s("tv_sec"),n("span",{class:"token punctuation"},","),s(`
         s`),n("span",{class:"token punctuation"},"."),s("st_atim"),n("span",{class:"token punctuation"},"."),s("tv_nsec"),n("span",{class:"token punctuation"},","),s(" s"),n("span",{class:"token punctuation"},"."),s("st_mtim"),n("span",{class:"token punctuation"},"."),s("tv_sec"),n("span",{class:"token punctuation"},","),s(" s"),n("span",{class:"token punctuation"},"."),s("st_mtim"),n("span",{class:"token punctuation"},"."),s("tv_nsec"),n("span",{class:"token punctuation"},","),s(`
         s`),n("span",{class:"token punctuation"},"."),s("st_ctim"),n("span",{class:"token punctuation"},"."),s("tv_sec"),n("span",{class:"token punctuation"},","),s(" s"),n("span",{class:"token punctuation"},"."),s("st_ctim"),n("span",{class:"token punctuation"},"."),s("tv_nsec"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"15-4"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<string.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(" file_perms "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s filename frwx\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" len "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(" len"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"["),s("i"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'f'"),n("span",{class:"token operator"},":"),s(`
      file_perms `),n("span",{class:"token operator"},"|="),s(" F_OK"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'r'"),n("span",{class:"token operator"},":"),s(`
      file_perms `),n("span",{class:"token operator"},"|="),s(" R_OK"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'w'"),n("span",{class:"token operator"},":"),s(`
      file_perms `),n("span",{class:"token operator"},"|="),s(" W_OK"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'x'"),n("span",{class:"token operator"},":"),s(`
      file_perms `),n("span",{class:"token operator"},"|="),s(" X_OK"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"access"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" file_perms"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"puts"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"yes"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"puts"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"no"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"15-5"),n("p",null,"\u9700\u8981\u8B66\u60D5\u4E24\u6B21\u8C03\u7528 umask \u4E0D\u80FD\u4FDD\u8BC1\u539F\u5B50\u6027"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/stat.h>")]),s(`

`),n("span",{class:"token class-name"},"mode_t"),s(),n("span",{class:"token function"},"get_mask"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"mode_t"),s(" t"),n("span",{class:"token punctuation"},";"),s(`
  t `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"umask"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"0777"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"umask"),n("span",{class:"token punctuation"},"("),s("t"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" t"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%04o\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"get_mask"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"15-6"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/stat.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/types.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"FILE_PERMS"),s(),n("span",{class:"token expression"},[n("span",{class:"token punctuation"},"("),s("S_IRUSR "),n("span",{class:"token operator"},"|"),s(" S_IRGRP "),n("span",{class:"token operator"},"|"),s(" S_IROTH"),n("span",{class:"token punctuation"},")")])]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(" ino"),n("span",{class:"token punctuation"},","),s(" file_perms"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"stat"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s [filename...]\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(" argc"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    file_perms `),n("span",{class:"token operator"},"="),s(" FILE_PERMS"),n("span",{class:"token punctuation"},";"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"stat"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),s("i"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("s"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"stat"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},"."),s("st_mode "),n("span",{class:"token operator"},"&"),s(" S_IFMT"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" S_IFDIR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"||"),s(`
        `),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},"."),s("st_mode "),n("span",{class:"token operator"},"&"),s(),n("span",{class:"token punctuation"},"("),s("S_IXUSR "),n("span",{class:"token operator"},"|"),s(" S_IXGRP "),n("span",{class:"token operator"},"|"),s(" S_IXUSR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      file_perms `),n("span",{class:"token operator"},"|="),s(),n("span",{class:"token punctuation"},"("),s("S_IXOTH "),n("span",{class:"token operator"},"|"),s(" S_IXUSR "),n("span",{class:"token operator"},"|"),s(" S_IXGRP"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"chmod"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),s("i"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" file_perms"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"chmod"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"15-7"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<linux/fs.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/ioctl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(" attr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" prev_attr"),n("span",{class:"token punctuation"},","),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s [+-=][acDijAdtsSTu] <filename>\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("c_attr "),n("span",{class:"token operator"},"="),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("filename "),n("span",{class:"token operator"},"="),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  fd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("filename"),n("span",{class:"token punctuation"},","),s(" O_RDONLY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"ioctl"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" FS_IOC_GETFLAGS"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("prev_attr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"ioctl"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(" len "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("c_attr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(" len"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("c_attr"),n("span",{class:"token punctuation"},"["),s("i"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'a'"),n("span",{class:"token operator"},":"),s(`
      attr `),n("span",{class:"token operator"},"|="),s(" FS_APPEND_FL"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'c'"),n("span",{class:"token operator"},":"),s(`
      attr `),n("span",{class:"token operator"},"|="),s(" FS_COMPR_FL"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'D'"),n("span",{class:"token operator"},":"),s(`
      attr `),n("span",{class:"token operator"},"|="),s(" FS_DIRSYNC_FL"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'i'"),n("span",{class:"token operator"},":"),s(`
      attr `),n("span",{class:"token operator"},"|="),s(" FS_IMMUTABLE_FL"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'j'"),n("span",{class:"token operator"},":"),s(`
      attr `),n("span",{class:"token operator"},"|="),s(" FS_JOURNAL_DATA_FL"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'A'"),n("span",{class:"token operator"},":"),s(`
      attr `),n("span",{class:"token operator"},"|="),s(" FS_NOATIME_FL"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'d'"),n("span",{class:"token operator"},":"),s(`
      attr `),n("span",{class:"token operator"},"|="),s(" FS_NODUMP_FL"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'t'"),n("span",{class:"token operator"},":"),s(`
      attr `),n("span",{class:"token operator"},"|="),s(" FS_NOTAIL_FL"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'s'"),n("span",{class:"token operator"},":"),s(`
      attr `),n("span",{class:"token operator"},"|="),s(" FS_SECRM_FL"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'S'"),n("span",{class:"token operator"},":"),s(`
      attr `),n("span",{class:"token operator"},"|="),s(" FS_SYNC_FL"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'T'"),n("span",{class:"token operator"},":"),s(`
      attr `),n("span",{class:"token operator"},"|="),s(" FS_TOPDIR_FL"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'u'"),n("span",{class:"token operator"},":"),s(`
      attr `),n("span",{class:"token operator"},"|="),s(" FS_UNRM_FL"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("c_attr"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'+'"),n("span",{class:"token operator"},":"),s(`
    prev_attr `),n("span",{class:"token operator"},"|="),s(" attr"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'-'"),n("span",{class:"token operator"},":"),s(`
    prev_attr `),n("span",{class:"token operator"},"&="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"~"),s("attr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'='"),n("span",{class:"token operator"},":"),s(`
    prev_attr `),n("span",{class:"token operator"},"="),s(" attr"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s <filename> [+-=][acDijAdtsSTu]\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"ioctl"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" FS_IOC_SETFLAGS"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("prev_attr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"ioctl"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u5341\u516D\u7AE0"),n("h3",null,"16-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdlib.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<string.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/xattr.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("flag_n "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("flag_v "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("flag_x "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("filename"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("tmp"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" c"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s [-x <key>| -n <key> -v <value>] <filename>\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("c "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getopt"),n("span",{class:"token punctuation"},"("),s("argc"),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"x:n:v:"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    tmp `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("optarg"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),s("tmp"),n("span",{class:"token punctuation"},","),s(" optarg"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'x'"),n("span",{class:"token operator"},":"),s(`
      flag_x `),n("span",{class:"token operator"},"="),s(" tmp"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'n'"),n("span",{class:"token operator"},":"),s(`
      flag_n `),n("span",{class:"token operator"},"="),s(" tmp"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'v'"),n("span",{class:"token operator"},":"),s(`
      flag_v `),n("span",{class:"token operator"},"="),s(" tmp"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"unknown opt"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`
  filename `),n("span",{class:"token operator"},"="),s(" argv"),n("span",{class:"token punctuation"},"["),s("argc "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("flag_x "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"removexattr"),n("span",{class:"token punctuation"},"("),s("filename"),n("span",{class:"token punctuation"},","),s(" flag_x"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"removexattr"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("flag_n "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),s(),n("span",{class:"token operator"},"&&"),s(" flag_v "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"setxattr"),n("span",{class:"token punctuation"},"("),s("filename"),n("span",{class:"token punctuation"},","),s(" flag_n"),n("span",{class:"token punctuation"},","),s(" flag_v"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("flag_v"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"setxattr"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u5341\u4E03\u7AE0"),n("h3",null,"17-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/acl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"2048")])]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("flag_type"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("flag_id"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("filename"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"acl_entry_t"),s(" entry"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"acl_tag_t"),s(" tag"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"uid_t"),s(),n("span",{class:"token operator"},"*"),s("qualp"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"acl_permset_t"),s(" permset"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"acl_t"),s(" acl"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s [u|g] <id> <filename>\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  flag_type `),n("span",{class:"token operator"},"="),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  flag_id `),n("span",{class:"token operator"},"="),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  filename `),n("span",{class:"token operator"},"="),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  acl `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"acl_get_file"),n("span",{class:"token punctuation"},"("),s("filename"),n("span",{class:"token punctuation"},","),s(" ACL_TYPE_ACCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"acl_get_entry"),n("span",{class:"token punctuation"},"("),s("acl"),n("span",{class:"token punctuation"},","),s(" ACL_FIRST_ENTRY"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("entry"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"acl_get_entry"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"do"),s(),n("span",{class:"token punctuation"},"{"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"acl_get_tag_type"),n("span",{class:"token punctuation"},"("),s("entry"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("tag"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"acl_get_tag_type"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"acl_get_permset"),n("span",{class:"token punctuation"},"("),s("entry"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("permset"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"acl_get_permset"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("tag "),n("span",{class:"token operator"},"=="),s(" ACL_USER "),n("span",{class:"token operator"},"||"),s(" tag "),n("span",{class:"token operator"},"=="),s(" ACL_GROUP"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      qualp `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"acl_get_qualifier"),n("span",{class:"token punctuation"},"("),s("entry"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("qualp "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"acl_get_qualifier"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("flag_type"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'g'"),s(),n("span",{class:"token operator"},"&&"),s(" tag "),n("span",{class:"token operator"},"=="),s(" ACL_GROUP"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"||"),s(`
           `),n("span",{class:"token punctuation"},"("),s("flag_type"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'u'"),s(),n("span",{class:"token operator"},"&&"),s(" tag "),n("span",{class:"token operator"},"=="),s(" ACL_USER"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"&&"),s(`
          `),n("span",{class:"token operator"},"*"),s("qualp "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token function"},"atol"),n("span",{class:"token punctuation"},"("),s("flag_id"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token class-name"},"ssize_t"),s(" len "),n("span",{class:"token operator"},"="),s(" BUF_SIZE "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
        buf `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"acl_to_text"),n("span",{class:"token punctuation"},"("),s("acl"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("len"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s\\n"'),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"acl_get_entry"),n("span",{class:"token punctuation"},"("),s("acl"),n("span",{class:"token punctuation"},","),s(" ACL_NEXT_ENTRY"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("entry"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u5341\u516B\u7AE0"),n("h3",null,"18-1"),n("p",null,"\u4E24\u6B21\u6587\u4EF6\u7684 i-node \u7F16\u53F7\u4E0D\u540C\uFF0C\u6587\u4EF6\u7684\u5220\u9664\u672C\u8D28\u662F\u5728\u5220\u9664\u6587\u4EF6\u540D\u548C inode \u7684\u6620\u5C04\u5173\u7CFB\uFF0C\u4E0D\u5F71\u54CD\u5F53\u524D fd \u548C inode \u7684\u6620\u5C04\u3002"),n("h3",null,"18-2"),n("p",null,[s("\u8C03\u7528"),n("code",null,'symlink("myfile", "../mylink")'),s("\uFF0C\u521B\u5EFA\u7684\u7B26\u53F7\u94FE\u63A5\u7684\u5185\u5BB9\u4E3A"),n("code",null,"myfile"),s("\uFF0C\u76F8\u5BF9\u7684\u662F\u7B26\u53F7\u94FE\u63A5\u6587\u4EF6\u672C\u8EAB\u800C\u4E0D\u662F cwd\uFF0C\u56E0\u6B64\u62A5\u9519")]),n("p",null,[n("img",{src:w,alt:"18-2-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<dirent.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/stat.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ino"),n("span",{class:"token punctuation"},","),s(" fd"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"mkdir"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"test"'),n("span",{class:"token punctuation"},","),s(" S_IRUSR "),n("span",{class:"token operator"},"|"),s(" S_IWUSR "),n("span",{class:"token operator"},"|"),s(" S_IXUSR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mkdir"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"chdir"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"test"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"test"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  fd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"myfile"'),n("span",{class:"token punctuation"},","),s(" O_RDWR "),n("span",{class:"token operator"},"|"),s(" O_CREAT"),n("span",{class:"token punctuation"},","),s(" S_IRUSR "),n("span",{class:"token operator"},"|"),s(" S_IWUSR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"symlink"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"myfile"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"../mylink"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"symlink"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"chmod"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"../mylink"'),n("span",{class:"token punctuation"},","),s(" S_IRUSR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"chmod"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"18-3"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<assert.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<limits.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<pwd.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<string.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"tlpi_realpath"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("path"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("tokens "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"*"),s(" PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
       `),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("next_tokens "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"*"),s(" PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("next_path "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" tmp"),n("span",{class:"token punctuation"},"["),s("PATH_MAX"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"{"),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" token_index "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" tmp_index "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" char_index "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" path_len "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" c_prev "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" c_curr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),s("next_path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},"// prefix"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("path_len "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'~'"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"passwd"),s(),n("span",{class:"token operator"},"*"),s("pw "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getpwuid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getuid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"strcat"),n("span",{class:"token punctuation"},"("),s("next_path"),n("span",{class:"token punctuation"},","),s(" pw"),n("span",{class:"token operator"},"->"),s("pw_dir"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"strcat"),n("span",{class:"token punctuation"},"("),s("next_path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"/"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"strcat"),n("span",{class:"token punctuation"},"("),s("next_path"),n("span",{class:"token punctuation"},","),s(" path "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'/'"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"strcat"),n("span",{class:"token punctuation"},"("),s("next_path"),n("span",{class:"token punctuation"},","),s(" path"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"getcwd"),n("span",{class:"token punctuation"},"("),s("next_path"),n("span",{class:"token punctuation"},","),s(" PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"strcat"),n("span",{class:"token punctuation"},"("),s("next_path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"/"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"strcat"),n("span",{class:"token punctuation"},"("),s("next_path"),n("span",{class:"token punctuation"},","),s(" path"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`

  path_len `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("next_path"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("path_len "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    c_curr `),n("span",{class:"token operator"},"="),s(" next_path"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("tokens"),n("span",{class:"token punctuation"},"["),s("token_index"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"/"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"do"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("c_prev "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'/'"),s(),n("span",{class:"token operator"},"&&"),s(" c_curr "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'/'"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token comment"},"// do nothing"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("c_prev "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"&&"),s(" c_curr "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'/'"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      tmp`),n("span",{class:"token punctuation"},"["),s("tmp_index"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(" c_curr"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("c_prev "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token char"},"'/'"),s(),n("span",{class:"token operator"},"&&"),s(" c_curr "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'/'"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      tmp`),n("span",{class:"token punctuation"},"["),s("tmp_index"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("tokens"),n("span",{class:"token punctuation"},"["),s("token_index"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" tmp"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      tmp_index `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
      tmp`),n("span",{class:"token punctuation"},"["),s("tmp_index"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(" c_curr"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("tmp_index "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"&&"),s(" c_curr "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'.'"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      tmp`),n("span",{class:"token punctuation"},"["),s("tmp_index"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(" c_curr"),n("span",{class:"token punctuation"},";"),s(`
      tmp`),n("span",{class:"token punctuation"},"["),s("tmp_index"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("tokens"),n("span",{class:"token punctuation"},"["),s("token_index"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" tmp"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      tmp_index `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
      tmp`),n("span",{class:"token punctuation"},"["),s("tmp_index"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(" c_curr"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    c_prev `),n("span",{class:"token operator"},"="),s(" c_curr"),n("span",{class:"token punctuation"},";"),s(`
    c_curr `),n("span",{class:"token operator"},"="),s(" next_path"),n("span",{class:"token punctuation"},"["),n("span",{class:"token operator"},"++"),s("char_index"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("c_curr "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("tmp_index "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    tmp`),n("span",{class:"token punctuation"},"["),s("tmp_index"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("tokens"),n("span",{class:"token punctuation"},"["),s("token_index"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" tmp"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  tokens`),n("span",{class:"token punctuation"},"["),s("token_index"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},"// handle `..`"),s(`
  token_index `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("curr "),n("span",{class:"token operator"},"="),s(" tokens"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token operator"},"*"),s("curr "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(" curr"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"/."'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"/.."'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"&&"),s(" token_index "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),s("next_tokens"),n("span",{class:"token punctuation"},"["),n("span",{class:"token operator"},"--"),s("token_index"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
      next_tokens`),n("span",{class:"token punctuation"},"["),s("token_index"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  next_tokens`),n("span",{class:"token punctuation"},"["),s("token_index"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),s("next_path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("curr "),n("span",{class:"token operator"},"="),s(" next_tokens "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token operator"},"*"),s("curr "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(" curr"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"strcat"),n("span",{class:"token punctuation"},"("),s("next_path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),s("tokens"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),s("next_tokens"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" next_path"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"usage: %s <filename>\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"tlpi_realpath"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"18-4"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<dirent.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"listFiles"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("dirpath"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  DIR `),n("span",{class:"token operator"},"*"),s("dirp"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"dirent"),s(" dp"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("result"),n("span",{class:"token punctuation"},";"),s(`
  dirp `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"opendir"),n("span",{class:"token punctuation"},"("),s("dirpath"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("dirp "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"errMsg"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"opendir failed %s"'),n("span",{class:"token punctuation"},","),s(" dirpath"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"return"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"readdir_r"),n("span",{class:"token punctuation"},"("),s("dirp"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("dp"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("result"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"&&"),s(" result "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("dp"),n("span",{class:"token punctuation"},"."),s("d_name"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"."'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("dp"),n("span",{class:"token punctuation"},"."),s("d_name"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'".."'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s\\n"'),n("span",{class:"token punctuation"},","),s(" dp"),n("span",{class:"token punctuation"},"."),s("d_name"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"listFiles"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"."'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(" argc"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"listFiles"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),s("i"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"18-5"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<dirent.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdlib.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/stat.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"tlpi_getcwd"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  DIR `),n("span",{class:"token operator"},"*"),s("d1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"dirent"),s(" dr1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("dr2"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"stat"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("tokens "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"*"),s(" PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" prev_inode"),n("span",{class:"token punctuation"},","),s(" curr_inode"),n("span",{class:"token punctuation"},","),s(" ino"),n("span",{class:"token punctuation"},","),s(" token_index "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("path "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"strcat"),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"./"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  prev_inode `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"stat"),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("s"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"stat"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  curr_inode `),n("span",{class:"token operator"},"="),s(" s"),n("span",{class:"token punctuation"},"."),s("st_ino"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"do"),s(),n("span",{class:"token punctuation"},"{"),s(`
    d1 `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"opendir"),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("d1 "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"opendir"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"readdir_r"),n("span",{class:"token punctuation"},"("),s("d1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("dr1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("dr2"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"&&"),s(" dr2 "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("dr1"),n("span",{class:"token punctuation"},"."),s("d_ino "),n("span",{class:"token operator"},"=="),s(" prev_inode"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),s("tokens"),n("span",{class:"token punctuation"},"["),s("token_index"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" dr1"),n("span",{class:"token punctuation"},"."),s("d_name"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    prev_inode `),n("span",{class:"token operator"},"="),s(" curr_inode"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"strcat"),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"../"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"stat"),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("s"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"stat"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    curr_inode `),n("span",{class:"token operator"},"="),s(" s"),n("span",{class:"token punctuation"},"."),s("st_ino"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("prev_inode "),n("span",{class:"token operator"},"!="),s(" curr_inode"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("curr "),n("span",{class:"token operator"},"="),s(" tokens "),n("span",{class:"token operator"},"+"),s(" token_index "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(" curr "),n("span",{class:"token operator"},">="),s(" tokens"),n("span",{class:"token punctuation"},";"),s(" curr"),n("span",{class:"token operator"},"--"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"strcat"),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"/"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"strcat"),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),s("tokens"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" path"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("cwd"),n("span",{class:"token punctuation"},";"),s(`
  cwd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"tlpi_getcwd"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s\\n"'),n("span",{class:"token punctuation"},","),s(" cwd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"18-6"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"_XOPEN_SOURCE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"600")])]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<ftw.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"dir_tree"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("pathname"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"stat"),s(),n("span",{class:"token operator"},"*"),s("sbuf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" type"),n("span",{class:"token punctuation"},","),s(`
                    `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"FTW"),s(),n("span",{class:"token operator"},"*"),s("ftwb"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("sbuf"),n("span",{class:"token operator"},"->"),s("st_mode "),n("span",{class:"token operator"},"&"),s(" S_IFMT"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(" S_IFREG"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"-"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(" S_IFDIR"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"d"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(" S_IFCHR"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"c"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(" S_IFBLK"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"b"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(" S_IFLNK"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"l"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(" S_IFIFO"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"p"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(" S_IFSOCK"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"s"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"?"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("type"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(" FTW_D"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"D  "'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(" FTW_DNR"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"DNR"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(" FTW_DP"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"DP "'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(" FTW_F"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"F  "'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(" FTW_SL"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"SL "'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(" FTW_SLN"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"SLN"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(" FTW_NS"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"NS "'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"   "'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("type "),n("span",{class:"token operator"},"!="),s(" FTW_NS"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%7ld "'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("sbuf"),n("span",{class:"token operator"},"->"),s("st_ino"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"        "'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'" %*s"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"4"),s(),n("span",{class:"token operator"},"*"),s(" ftwb"),n("span",{class:"token operator"},"->"),s("level"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'""'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("pathname"),n("span",{class:"token punctuation"},"["),s("ftwb"),n("span",{class:"token operator"},"->"),s("base"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" flags"),n("span",{class:"token punctuation"},","),s(" opt"),n("span",{class:"token punctuation"},";"),s(`
  flags `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("opt "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getopt"),n("span",{class:"token punctuation"},"("),s("argc"),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"dmp"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("opt"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'d'"),n("span",{class:"token operator"},":"),s(`
      flags `),n("span",{class:"token operator"},"|="),s(" FTW_DEPTH"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'m'"),n("span",{class:"token operator"},":"),s(`
      flags `),n("span",{class:"token operator"},"|="),s(" FTW_MOUNT"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'p'"),n("span",{class:"token operator"},":"),s(`
      flags `),n("span",{class:"token operator"},"|="),s(" FTW_PHYS"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},">"),s(" optind "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"nftw"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},">"),s(" optind"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"?"),s(" argv"),n("span",{class:"token punctuation"},"["),s("optind"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},":"),s(),n("span",{class:"token string"},'"."'),n("span",{class:"token punctuation"},","),s(" dir_tree"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"10"),n("span",{class:"token punctuation"},","),s(" flags"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"perror"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"ntfw"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_FAILURE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"18-7"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"_XOPEN_SOURCE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"500")])]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<ftw.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(" count_file "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(" count_dir "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(" count_symlnk "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"tree_dir"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("pathname"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"stat"),s(),n("span",{class:"token operator"},"*"),s("statbuf"),n("span",{class:"token punctuation"},","),s(`
                    `),n("span",{class:"token keyword"},"int"),s(" typeflag"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"FTW"),s(),n("span",{class:"token operator"},"*"),s("ftwbuf"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("typeflag"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(" FTW_D"),n("span",{class:"token operator"},":"),s(`
  `),n("span",{class:"token keyword"},"case"),s(" FTW_DNR"),n("span",{class:"token operator"},":"),s(`
  `),n("span",{class:"token keyword"},"case"),s(" FTW_DP"),n("span",{class:"token operator"},":"),s(`
    count_dir `),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(" FTW_F"),n("span",{class:"token operator"},":"),s(`
    count_file `),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(" FTW_SL"),n("span",{class:"token operator"},":"),s(`
  `),n("span",{class:"token keyword"},"case"),s(" FTW_SLN"),n("span",{class:"token operator"},":"),s(`
    count_symlnk `),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s dirpath\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  count_file `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  count_dir `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  count_symlnk `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"nftw"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" tree_dir"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"10"),n("span",{class:"token punctuation"},","),s(" FTW_MOUNT "),n("span",{class:"token operator"},"|"),s(" FTW_PHYS"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"nftw"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"dir %d\\nfile %d\\nsymbol %d\\n"'),n("span",{class:"token punctuation"},","),s(" count_dir"),n("span",{class:"token punctuation"},","),s(" count_file"),n("span",{class:"token punctuation"},","),s(" count_symlnk"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"18-8"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<dirent.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<ftw.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<limits.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<string.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"tlpi_ntfw"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("dirpath"),n("span",{class:"token punctuation"},","),s(`
              `),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("func"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("pathname"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"stat"),s(),n("span",{class:"token operator"},"*"),s("statbuf"),n("span",{class:"token punctuation"},","),s(`
                          `),n("span",{class:"token keyword"},"int"),s(" typeflag"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
              `),n("span",{class:"token keyword"},"int"),s(" nopenfd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" flags"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  DIR `),n("span",{class:"token operator"},"*"),s("d"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"dirent"),s(" dr1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("dr2"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"stat"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" path"),n("span",{class:"token punctuation"},"["),s("PATH_MAX"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  d `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"opendir"),n("span",{class:"token punctuation"},"("),s("dirpath"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"readdir_r"),n("span",{class:"token punctuation"},"("),s("d"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("dr1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("dr2"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"&&"),s(" dr2 "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("dr1"),n("span",{class:"token punctuation"},"."),s("d_name"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"."'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("dr1"),n("span",{class:"token punctuation"},"."),s("d_name"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'".."'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"strcat"),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},","),s(" dirpath"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"strcat"),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"/"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"strcat"),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},","),s(" dr1"),n("span",{class:"token punctuation"},"."),s("d_name"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"stat"),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("s"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"stat"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"func"),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("s"),n("span",{class:"token punctuation"},","),s(" s"),n("span",{class:"token punctuation"},"."),s("st_mode "),n("span",{class:"token operator"},"&"),s(" S_IFMT"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token keyword"},"return"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("dr1"),n("span",{class:"token punctuation"},"."),s("d_type "),n("span",{class:"token operator"},"=="),s(" DT_DIR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"tlpi_ntfw"),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},","),s(" func"),n("span",{class:"token punctuation"},","),s(" nopenfd"),n("span",{class:"token punctuation"},","),s(" flags"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token keyword"},"return"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"tree_dir"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("pathname"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"stat"),s(),n("span",{class:"token operator"},"*"),s("statbuf"),n("span",{class:"token punctuation"},","),s(`
                    `),n("span",{class:"token keyword"},"int"),s(" typeflag"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s\\n"'),n("span",{class:"token punctuation"},","),s(" pathname"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token function"},"tlpi_ntfw"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"."'),n("span",{class:"token punctuation"},","),s(" tree_dir"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"10"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"18-9"),n("p",null,[n("img",{src:g,alt:"18-9-1"})]),n("p",null,[s("\u8FDB\u884C\u9891\u7E41\u5207\u6362\u65F6"),n("code",null,"chdir"),s("\u56E0\u4E3A\u6709\u9891\u7E41\u7684\u7533\u8BF7/\u91CA\u653E fd \u7684\u7CFB\u7EDF\u8C03\u7528\uFF0C\u6240\u4EE5\u8017\u65F6\u4F1A\u66F4\u591A\u3002")]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"COUNT"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1e3")])]),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"bench_1"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"size_t"),s(" count"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"clock_t"),s(" t_start"),n("span",{class:"token punctuation"},","),s(" t_end"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  t_start `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"clock"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("count"),n("span",{class:"token operator"},"--"),s(),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"chdir"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"tmp"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"chdir"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"chdir"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"../"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"chdir"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  t_end `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"clock"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"bench1: %ld\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("t_end "),n("span",{class:"token operator"},"-"),s(" t_start"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"bench_2"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"size_t"),s(" count"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"clock_t"),s(" t_start"),n("span",{class:"token punctuation"},","),s(" t_end"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd1"),n("span",{class:"token punctuation"},","),s(" fd2"),n("span",{class:"token punctuation"},","),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  t_start `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"clock"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  fd1 `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"tmp"'),n("span",{class:"token punctuation"},","),s(" O_DIRECTORY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  fd2 `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"../"'),n("span",{class:"token punctuation"},","),s(" O_DIRECTORY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("fd1 "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"||"),s(" fd2 "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("count"),n("span",{class:"token operator"},"--"),s(),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fchdir"),n("span",{class:"token punctuation"},"("),s("fd1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"chdir"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    ino `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fchdir"),n("span",{class:"token punctuation"},"("),s("fd2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ino "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"chdir"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  t_end `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"clock"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"bench2 %ld\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("t_end "),n("span",{class:"token operator"},"-"),s(" t_start"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"bench_1"),n("span",{class:"token punctuation"},"("),s("COUNT"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"bench_2"),n("span",{class:"token punctuation"},"("),s("COUNT"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"\u7B2C\u5341\u4E5D\u7AE0"),n("h3",null,"19-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"_XOPEN_SOURCE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"500")])]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<ftw.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<limits.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/inotify.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"inotify_event"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(" NAME_MAX "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1")])]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(" itd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"walk_dir"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("fpath"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"stat"),s(),n("span",{class:"token operator"},"*"),s("sb"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" tflag"),n("span",{class:"token punctuation"},","),s(`
                    `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"FTW"),s(),n("span",{class:"token operator"},"*"),s("ftwbuf"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"inotify_add_watch"),n("span",{class:"token punctuation"},"("),s("itd"),n("span",{class:"token punctuation"},","),s(" fpath"),n("span",{class:"token punctuation"},","),s(`
                    IN_CREATE `),n("span",{class:"token operator"},"|"),s(" IN_DELETE "),n("span",{class:"token operator"},"|"),s(" IN_MOVE "),n("span",{class:"token operator"},"|"),s(" IN_DONT_FOLLOW"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"stat"),s(" st"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ino"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s dirname\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"inotify_event"),s(),n("span",{class:"token operator"},"*"),s("ie"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("pathname"),n("span",{class:"token punctuation"},";"),s(`

  buf `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  itd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"inotify_init"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"nftw"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("walk_dir"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"20"),n("span",{class:"token punctuation"},","),s(" FTW_MOUNT "),n("span",{class:"token operator"},"|"),s(" FTW_DEPTH "),n("span",{class:"token operator"},"|"),s(" FTW_PHYS"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"nftw"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("itd"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    ie `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"inotify_event"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    pathname `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"inotify_event"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ie"),n("span",{class:"token operator"},"->"),s("mask "),n("span",{class:"token operator"},"&"),s(" IN_CREATE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"create %s\\n"'),n("span",{class:"token punctuation"},","),s(" pathname"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ie"),n("span",{class:"token operator"},"->"),s("mask "),n("span",{class:"token operator"},"&"),s(" IN_DELETE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"delete %s\\n"'),n("span",{class:"token punctuation"},","),s(" pathname"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ie"),n("span",{class:"token operator"},"->"),s("mask "),n("span",{class:"token operator"},"&"),s(" IN_MOVE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"move %s\\n"'),n("span",{class:"token punctuation"},","),s(" pathname"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u4E8C\u5341\u7AE0"),n("h3",null,"20-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal_functions.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(" sigCnt"),n("span",{class:"token punctuation"},"["),s("NSIG"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"volatile"),s(),n("span",{class:"token class-name"},"sig_atomic_t"),s(" gotSigint "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"handler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("sig "),n("span",{class:"token operator"},"=="),s(" SIGINT"),n("span",{class:"token punctuation"},")"),s(`
    gotSigint `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"else"),s(`
    sigCnt`),n("span",{class:"token punctuation"},"["),s("sig"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" n"),n("span",{class:"token punctuation"},","),s(" numSecs"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"sigset_t"),s(" pendingMask"),n("span",{class:"token punctuation"},","),s(" blockingMask"),n("span",{class:"token punctuation"},","),s(" emptyMask"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"pid %ld\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("n "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(" n "),n("span",{class:"token operator"},"<"),s(" NSIG"),n("span",{class:"token punctuation"},";"),s(" n"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sigaction"),s(" s1"),n("span",{class:"token punctuation"},","),s(" s2"),n("span",{class:"token punctuation"},";"),s(`
    s1`),n("span",{class:"token punctuation"},"."),s("sa_handler "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"&"),s("handler"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"sigaction"),n("span",{class:"token punctuation"},"("),s("n"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("s1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("s2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),s("gotSigint"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`

  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("n "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(" n "),n("span",{class:"token operator"},"<"),s(" NSIG"),n("span",{class:"token punctuation"},";"),s(" n"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("sigCnt"),n("span",{class:"token punctuation"},"["),s("n"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"singal %d caught %d times\\n"'),n("span",{class:"token punctuation"},","),s(" n"),n("span",{class:"token punctuation"},","),s(" sigCnt"),n("span",{class:"token punctuation"},"["),s("n"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"20-2"),n("p",null,[n("img",{src:_,alt:"20-2-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%d\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"signal"),n("span",{class:"token punctuation"},"("),s("SIGTERM"),n("span",{class:"token punctuation"},","),s(" SIG_IGN"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"20-3"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(" sigs"),n("span",{class:"token punctuation"},"["),s("NSIG"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"handler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(" sigs"),n("span",{class:"token punctuation"},"["),s("sig"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sigaction"),s(" s1"),n("span",{class:"token punctuation"},","),s(" s2"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"sigset_t"),s(" st"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" i"),n("span",{class:"token punctuation"},";"),s(`
  s1`),n("span",{class:"token punctuation"},"."),s("sa_handler "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"&"),s("handler"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigaddset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},","),s(" SIGTERM"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  s1`),n("span",{class:"token punctuation"},"."),s("sa_mask "),n("span",{class:"token operator"},"="),s(" st"),n("span",{class:"token punctuation"},";"),s(`
  s1`),n("span",{class:"token punctuation"},"."),s("sa_flags "),n("span",{class:"token operator"},"="),s(" SA_RESETHAND"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigaction"),n("span",{class:"token punctuation"},"("),s("SIGTERM"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("s1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("s2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%d\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),s("sigs"),n("span",{class:"token punctuation"},"["),s("SIGINT"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"20-4"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},`
`)]),n("h2",null,"\u7B2C\u4E8C\u5341\u4E00\u7AE0"),n("h3",null,"21-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"tlpi_abort"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"sigset_t"),s(" st1"),n("span",{class:"token punctuation"},","),s(" st2"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigaddset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st1"),n("span",{class:"token punctuation"},","),s(" SIGABRT"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigprocmask"),n("span",{class:"token punctuation"},"("),s("SIG_UNBLOCK"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("st1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("st2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"signal"),n("span",{class:"token punctuation"},"("),s("SIGABRT"),n("span",{class:"token punctuation"},","),s(" SIG_DFL#include "),n("span",{class:"token operator"},"<"),s("signal"),n("span",{class:"token punctuation"},"."),s("h"),n("span",{class:"token operator"},">"),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"tlpi_abort"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"sigset_t"),s(" st1"),n("span",{class:"token punctuation"},","),s(" st2"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigaddset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st1"),n("span",{class:"token punctuation"},","),s(" SIGABRT"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token comment"},"// \u5C06SIGABRT\u4ECE\u8FDB\u7A0B\u63A9\u7801\u4E2D\u53BB\u9664"),s(`
  `),n("span",{class:"token function"},"sigprocmask"),n("span",{class:"token punctuation"},"("),s("SIG_UNBLOCK"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("st1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("st2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token comment"},"// \u8BBE\u7F6ESIGABRT\u4E3A\u9ED8\u8BA4\u4FE1\u53F7\u5904\u7406\u5668"),s(`
  `),n("span",{class:"token function"},"signal"),n("span",{class:"token punctuation"},"("),s("SIGABRT"),n("span",{class:"token punctuation"},","),s(" SIG_DFL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"raise"),n("span",{class:"token punctuation"},"("),s("SIGABRT"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"signal"),n("span",{class:"token punctuation"},"("),s("SIGABRT"),n("span",{class:"token punctuation"},","),s(" SIG_IGN"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"hello\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"tlpi_abort"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"raise"),n("span",{class:"token punctuation"},"("),s("SIGABRT"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"signal"),n("span",{class:"token punctuation"},"("),s("SIGABRT"),n("span",{class:"token punctuation"},","),s(" SIG_IGN"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"hello\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"tlpi_abort"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u4E8C\u5341\u4E8C\u7AE0"),n("h3",null,"22-1"),n("p",null,[n("img",{src:h,alt:"22-1-1"})]),n("p",null,[s("\u5BF9 SIGCONT \u8BBE\u7F6E\u81EA\u5B9A\u4E49\u51FD\u6570\u540E\uFF0C\u4F9D\u7136\u53EF\u4EE5\u6267\u884C\u9ED8\u8BA4\u7684"),n("code",null,"\u7EE7\u7EED"),s("\u884C\u4E3A\u3002\u4F7F\u7528\u8FDB\u7A0B\u63A9\u7801\u963B\u585E\u540E\uFF0C\u81EA\u5B9A\u4E49\u4FE1\u53F7\u5904\u7406\u5668\u51FD\u6570\u4E0D\u6267\u884C\uFF0C\u4E0D\u5F71\u54CD\u9ED8\u8BA4\u884C\u4E3A\u3002")]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"handler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%d captured\\n"'),n("span",{class:"token punctuation"},","),s(" sig"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sigaction"),s(" s1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"sigset_t"),s(" st1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%d\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigaddset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st1"),n("span",{class:"token punctuation"},","),s(" SIGCONT"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"sigprocmask"),n("span",{class:"token punctuation"},"("),s("SIG_BLOCK"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("st1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`

  `),n("span",{class:"token function"},"signal"),n("span",{class:"token punctuation"},"("),s("SIGCONT"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("handler"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"22-2"),n("p",null,[n("img",{src:b,alt:"22-2-1"})]),n("p",null,"\u505C\u6B62\u963B\u585E\u540E\uFF0C\u5B9E\u65F6\u4FE1\u53F7\u7684\u4FE1\u53F7\u5904\u7406\u5668\u4F1A\u6BD4\u6807\u51C6\u4FE1\u53F7\u7684\u5148\u6267\u884C"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"handler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%d captured\\n"'),n("span",{class:"token punctuation"},","),s(" sig"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"sigset_t"),s(" st1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" i"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"pid %d\\nsigmin %d\\nsigmax %d\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" SIGRTMIN"),n("span",{class:"token punctuation"},","),s(" SIGRTMAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(" SIGRTMAX"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"signal"),n("span",{class:"token punctuation"},"("),s("i"),n("span",{class:"token punctuation"},","),s(" handler"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(" SIGRTMAX"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"sigaddset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st1"),n("span",{class:"token punctuation"},","),s(" i"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"sigprocmask"),n("span",{class:"token punctuation"},"("),s("SIG_BLOCK"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("st1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"15"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"time out\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigprocmask"),n("span",{class:"token punctuation"},"("),s("SIG_UNBLOCK"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("st1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("pre",{class:"language-shell"},[n("code",{class:"language-shell"},[n("span",{class:"token shebang important"},"#!/usr/bin/env bash"),s(`

`),n("span",{class:"token assign-left variable"},"pid"),n("span",{class:"token operator"},"="),n("span",{class:"token variable"},"$1"),s(`
`),n("span",{class:"token function"},"kill"),s(),n("span",{class:"token parameter variable"},"-CONT"),s(),n("span",{class:"token variable"},"${pid}"),s(`
`),n("span",{class:"token function"},"kill"),s(),n("span",{class:"token parameter variable"},"-35"),s(),n("span",{class:"token variable"},"${pid}"),s(`
`)])]),n("h3",null,"22-3"),n("p",null,[n("img",{src:v,alt:"22-3-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"handler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"TESTSIG"),s(),n("span",{class:"token expression"},"SIGUSR1")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"2"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"--help"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s num-sigs\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"int"),s(" numSigs "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getInt"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" GN_GT_0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"num-sigs"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sigaction"),s(" sa"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},"."),s("sa_mask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  sa`),n("span",{class:"token punctuation"},"."),s("sa_flags "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  sa`),n("span",{class:"token punctuation"},"."),s("sa_handler "),n("span",{class:"token operator"},"="),s(" handler"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigaction"),n("span",{class:"token punctuation"},"("),s("TESTSIG"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigaction"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},`/* Block the signal before fork(), so that the child doesn't manage
     to send it to the parent before the parent is ready to catch it */`),s(`

  `),n("span",{class:"token class-name"},"sigset_t"),s(" blockedMask"),n("span",{class:"token punctuation"},","),s(" emptyMask"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("blockedMask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigaddset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("blockedMask"),n("span",{class:"token punctuation"},","),s(" TESTSIG"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigprocmask"),n("span",{class:"token punctuation"},"("),s("SIG_SETMASK"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("blockedMask"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigprocmask"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("emptyMask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token class-name"},"pid_t"),s(" childPid "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("childPid"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(),n("span",{class:"token comment"},"/* child */"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" scnt "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" scnt "),n("span",{class:"token operator"},"<"),s(" numSigs"),n("span",{class:"token punctuation"},";"),s(" scnt"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"kill"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getppid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" TESTSIG"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"kill"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigwaitinfo"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("blockedMask"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"&&"),s(" errno "),n("span",{class:"token operator"},"!="),s(" EINTR"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigwaitinfo"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(),n("span",{class:"token comment"},"/* parent */"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" scnt "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" scnt "),n("span",{class:"token operator"},"<"),s(" numSigs"),n("span",{class:"token punctuation"},";"),s(" scnt"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigwaitinfo"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("blockedMask"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"&&"),s(" errno "),n("span",{class:"token operator"},"!="),s(" EINTR"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigwaitinfo"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"kill"),n("span",{class:"token punctuation"},"("),s("childPid"),n("span",{class:"token punctuation"},","),s(" TESTSIG"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"kill"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"22-4"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"_XOPEN_SOURCE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"500")])]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`

`),n("span",{class:"token keyword"},"typedef"),s(" __sighandler_t "),n("span",{class:"token class-name"},"sighandler_t"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"tlpi_sighold"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"sigset_t"),s(" st"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigaddset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},","),s(" sig"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token function"},"sigprocmask"),n("span",{class:"token punctuation"},"("),s("SIG_BLOCK"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"tlpi_sigrelse"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"sigset_t"),s(" st"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigaddset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},","),s(" sig"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token function"},"sigprocmask"),n("span",{class:"token punctuation"},"("),s("SIG_UNBLOCK"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"tlpi_sigpause"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"sigset_t"),s(" st"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigprocmask"),n("span",{class:"token punctuation"},"("),s("SIG_BLOCK"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigdelset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},","),s(" sig"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigprocmask"),n("span",{class:"token punctuation"},"("),s("SIGUNUSED"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token function"},"sigsuspend"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token class-name"},"sighandler_t"),s(),n("span",{class:"token function"},"tlpi_sigset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token class-name"},"sighandler_t"),s(" disp"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sigaction"),s(" st1"),n("span",{class:"token punctuation"},","),s(" st2"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("disp "),n("span",{class:"token operator"},"=="),s(" SIG_HOLD"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"tlpi_sighold"),n("span",{class:"token punctuation"},"("),s("sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token keyword"},"return"),s(" SIG_ERR"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigaction"),n("span",{class:"token punctuation"},"("),s("sig"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("st1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token keyword"},"return"),s(" SIG_ERR"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st2"),n("span",{class:"token punctuation"},"."),s("sa_mask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    st2`),n("span",{class:"token punctuation"},"."),s("sa_flags "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
    st2`),n("span",{class:"token punctuation"},"."),s("sa_handler "),n("span",{class:"token operator"},"="),s(" disp"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigaction"),n("span",{class:"token punctuation"},"("),s("sig"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("st2"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("st1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token keyword"},"return"),s(" SIG_ERR"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" st1"),n("span",{class:"token punctuation"},"."),s("sa_handler"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"tlpi_sigignore"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"tlpi_sigset"),n("span",{class:"token punctuation"},"("),s("sig"),n("span",{class:"token punctuation"},","),s(" SIG_IGN"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(" SIG_ERR"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u4E8C\u5341\u4E09\u7AE0"),n("h3",null,"23-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<errno.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"tlpi_alarm"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"int"),s(" seconds"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"itimerval"),s(" it1"),n("span",{class:"token punctuation"},","),s(" it2"),n("span",{class:"token punctuation"},";"),s(`
  it1`),n("span",{class:"token punctuation"},"."),s("it_interval"),n("span",{class:"token punctuation"},"."),s("tv_sec "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  it1`),n("span",{class:"token punctuation"},"."),s("it_interval"),n("span",{class:"token punctuation"},"."),s("tv_usec "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  it1`),n("span",{class:"token punctuation"},"."),s("it_value"),n("span",{class:"token punctuation"},"."),s("tv_sec "),n("span",{class:"token operator"},"="),s(" seconds"),n("span",{class:"token punctuation"},";"),s(`
  it1`),n("span",{class:"token punctuation"},"."),s("it_value"),n("span",{class:"token punctuation"},"."),s("tv_usec "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"setitimer"),n("span",{class:"token punctuation"},"("),s("ITIMER_REAL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("it1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("it2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" it2"),n("span",{class:"token punctuation"},"."),s("it_value"),n("span",{class:"token punctuation"},"."),s("tv_sec"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"tlpi_alarm"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"sigset_t"),s(" st"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigsuspend"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"23-2"),n("p",null,[s("\u4F7F\u7528"),n("code",null,"nanosleep"),s("\u65F6\uFF0C\u4F7F\u7528\u7684\u76F8\u5BF9\u65F6\u95F4\uFF0C\u5148\u6839\u636E\u5F53\u524D\u65F6\u95F4\u8BA1\u7B97\u76EE\u6807\u65F6\u95F4\uFF0C\u518D\u4F11\u7720\u3002\u671F\u95F4\u5982\u679C\u88AB\u9891\u7E41\u6253\u65AD\uFF0C\u8BA1\u7B97\u5360\u636E\u4E86\u65F6\u95F4\uFF0C\u4F46\u662F\u9891\u7E41\u7684\u4F11\u7720\u5931\u8D25\uFF0C\u6CA1\u6709\u6210\u529F\u6263\u9664\u76F8\u5BF9\u65F6\u95F4\u3002\u5BFC\u81F4\u5B9E\u9645\u4F11\u7720\u65F6\u95F4\u66F4\u957F\u3002")]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"_POSIX_C_SOURCE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"199309")])]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"_XOPEN_SOURCE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"600")])]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"sigint_handler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token keyword"},"return"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"timeval"),s(" start"),n("span",{class:"token punctuation"},","),s(" finish"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"timespec"),s(" request"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sigaction"),s(" sa"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"3"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"--help"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s secs nanosecs\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"pid %d\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"clock_gettime"),n("span",{class:"token punctuation"},"("),s("CLOCK_REALTIME"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("request"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"clock_gettime"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  request`),n("span",{class:"token punctuation"},"."),s("tv_sec "),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token function"},"getLong"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"secs"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  request`),n("span",{class:"token punctuation"},"."),s("tv_nsec "),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token function"},"getLong"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"nanosecs"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},"."),s("sa_mask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  sa`),n("span",{class:"token punctuation"},"."),s("sa_flags "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  sa`),n("span",{class:"token punctuation"},"."),s("sa_handler "),n("span",{class:"token operator"},"="),s(" sigint_handler"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigaction"),n("span",{class:"token punctuation"},"("),s("SIGINT"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigaction"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"gettimeofday"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("start"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"gettimeofday"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token class-name"},"clock_t"),s(" ct"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    s `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"clock_nanosleep"),n("span",{class:"token punctuation"},"("),s("CLOCK_REALTIME"),n("span",{class:"token punctuation"},","),s(" TIMER_ABSTIME"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("request"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"&&"),s(" errno "),n("span",{class:"token operator"},"!="),s(" EINTR"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"nanosleep"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"gettimeofday"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("finish"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"gettimeofday"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Slept for: %9.6f secs\\n"'),n("span",{class:"token punctuation"},","),s(`
           finish`),n("span",{class:"token punctuation"},"."),s("tv_sec "),n("span",{class:"token operator"},"-"),s(" start"),n("span",{class:"token punctuation"},"."),s("tv_sec "),n("span",{class:"token operator"},"+"),s(`
               `),n("span",{class:"token punctuation"},"("),s("finish"),n("span",{class:"token punctuation"},"."),s("tv_usec "),n("span",{class:"token operator"},"-"),s(" start"),n("span",{class:"token punctuation"},"."),s("tv_usec"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"/"),s(),n("span",{class:"token number"},"1000000.0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sleep complete\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"23-3"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"_POSIX_C_SOURCE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"199309")])]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"handler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sigevent"),s(" evp"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"timer_t"),s(" tt"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"itimerspec"),s(" itr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"sigset_t"),s(" st"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"siginfo_t"),s(" sinfo"),n("span",{class:"token punctuation"},";"),s(`

  itr`),n("span",{class:"token punctuation"},"."),s("it_interval"),n("span",{class:"token punctuation"},"."),s("tv_nsec "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  itr`),n("span",{class:"token punctuation"},"."),s("it_interval"),n("span",{class:"token punctuation"},"."),s("tv_sec "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  itr`),n("span",{class:"token punctuation"},"."),s("it_value"),n("span",{class:"token punctuation"},"."),s("tv_nsec "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  itr`),n("span",{class:"token punctuation"},"."),s("it_value"),n("span",{class:"token punctuation"},"."),s("tv_sec "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"timer_create"),n("span",{class:"token punctuation"},"("),s("CLOCK_REALTIME"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("tt"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"timer_create"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"timer_settime"),n("span",{class:"token punctuation"},"("),s("tt"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("itr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"timer_settime"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigaddset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},","),s(" SIGALRM"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"signal"),n("span",{class:"token punctuation"},"("),s("SIGALRM"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("handler"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigwaitinfo"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sinfo"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigwaitinfo"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%d %d\\n"'),n("span",{class:"token punctuation"},","),s(" sinfo"),n("span",{class:"token punctuation"},"."),s("si_signo"),n("span",{class:"token punctuation"},","),s(" sinfo"),n("span",{class:"token punctuation"},"."),s("si_value"),n("span",{class:"token punctuation"},"."),s("sival_int"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"23-4"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"_POSIX_C_SOURCE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"199309")])]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"curr_time.h"'),s("           "),n("span",{class:"token comment"},"/* Declares currTime() */")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"itimerspec_from_str.h"'),s(),n("span",{class:"token comment"},"/* Declares itimerspecFromStr() */")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"TIMER_SIG"),s(),n("span",{class:"token expression"},"SIGRTMAX "),n("span",{class:"token comment"},"/* Our timer notification signal */")]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"handler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token keyword"},"return"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"itimerspec"),s(" ts"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sigaction"),s(" sa"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sigevent"),s(" sev"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"timer_t"),s(),n("span",{class:"token operator"},"*"),s("tidlist"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" j"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s secs[/nsecs][:int-secs[/int-nsecs]]...\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  tidlist `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"calloc"),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"timer_t"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("tidlist "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"malloc"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},"/* Establish handler for notification signal */"),s(`

  `),n("span",{class:"token function"},"signal"),n("span",{class:"token punctuation"},"("),s("TIMER_SIG"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("handler"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},"/* Create and start one timer for each command-line argument */"),s(`

  sev`),n("span",{class:"token punctuation"},"."),s("sigev_notify "),n("span",{class:"token operator"},"="),s(" SIGEV_SIGNAL"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Notify via signal */"),s(`
  sev`),n("span",{class:"token punctuation"},"."),s("sigev_signo "),n("span",{class:"token operator"},"="),s(" TIMER_SIG"),n("span",{class:"token punctuation"},";"),s("     "),n("span",{class:"token comment"},"/* Notify using this signal */"),s(`

  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("j "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" j "),n("span",{class:"token operator"},"<"),s(" argc "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(" j"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"itimerspecFromStr"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),s("j "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("ts"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    sev`),n("span",{class:"token punctuation"},"."),s("sigev_value"),n("span",{class:"token punctuation"},"."),s("sival_ptr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"&"),s("tidlist"),n("span",{class:"token punctuation"},"["),s("j"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token comment"},"/* Allows handler to get ID of this timer */"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"timer_create"),n("span",{class:"token punctuation"},"("),s("CLOCK_REALTIME"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sev"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("tidlist"),n("span",{class:"token punctuation"},"["),s("j"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"timer_create"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Timer ID: %ld (%s)\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),s("tidlist"),n("span",{class:"token punctuation"},"["),s("j"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),s("j "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"timer_settime"),n("span",{class:"token punctuation"},"("),s("tidlist"),n("span",{class:"token punctuation"},"["),s("j"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("ts"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"timer_settime"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`

  `),n("span",{class:"token class-name"},"sigset_t"),s(" st"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"siginfo_t"),s(" sit"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigaddset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},","),s(" TIMER_SIG"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigwaitinfo"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sit"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token class-name"},"timer_t"),s(),n("span",{class:"token operator"},"*"),s("tidptr"),n("span",{class:"token punctuation"},";"),s(`

    tidptr `),n("span",{class:"token operator"},"="),s(" sit"),n("span",{class:"token punctuation"},"."),s("si_value"),n("span",{class:"token punctuation"},"."),s("sival_ptr"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%s] Got signal %d\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"currTime"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%T"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" sit"),n("span",{class:"token punctuation"},"."),s("si_signo"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"    *sival_ptr         = %ld\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"*"),s("tidptr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"    timer_getoverrun() = %d\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"timer_getoverrun"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("tidptr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u4E8C\u5341\u56DB\u7AE0"),n("h3",null,"24-1"),n("p",null,"\u5171\u6709 8 \u4E2A\u8FDB\u7A0B\uFF0C\u4EA7\u751F 7 \u4E2A\u65B0\u8FDB\u7A0B"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%d\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"24-2"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<unistd.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"pid_t"),s(" child_pid"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("child_pid "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"vfork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"vfork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"done"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u65E0\u6CD5\u88AB\u6B63\u5E38\u6253\u5370\uFF0C\u5B50\u8FDB\u7A0B\u5171\u4EAB\u5E76\u5173\u95ED\u4E86fd1"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("STDOUT_FILENO"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"24-3"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/wait.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"generator_core_dump"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"pid_t"),s(" child_pid"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" status "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("child_pid "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"pause"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"kill"),n("span",{class:"token punctuation"},"("),s("child_pid"),n("span",{class:"token punctuation"},","),s(" SIGABRT"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"generator_core_dump"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"done\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"24-4"),n("h3",null,"24-5"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"curr_time.h"'),s(),n("span",{class:"token comment"},"/* Declaration of currTime() */")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"tlpi_hdr.h"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"SYNC_SIG"),s(),n("span",{class:"token expression"},"SIGUSR1 "),n("span",{class:"token comment"},"/* Synchronization signal */")]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token comment"},"/* Signal handler - does nothing but return */"),s(`
`),n("span",{class:"token function"},"handler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"pid_t"),s(" childPid"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"sigset_t"),s(" blockMask"),n("span",{class:"token punctuation"},","),s(" origMask"),n("span",{class:"token punctuation"},","),s(" emptyMask"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sigaction"),s(" sa"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"setbuf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stdout"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Disable buffering of stdout */"),s(`

  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("blockMask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigaddset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("blockMask"),n("span",{class:"token punctuation"},","),s(" SYNC_SIG"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Block signal */"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigprocmask"),n("span",{class:"token punctuation"},"("),s("SIG_BLOCK"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("blockMask"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("origMask"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigprocmask"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},"."),s("sa_mask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  sa`),n("span",{class:"token punctuation"},"."),s("sa_flags "),n("span",{class:"token operator"},"="),s(" SA_RESTART"),n("span",{class:"token punctuation"},";"),s(`
  sa`),n("span",{class:"token punctuation"},"."),s("sa_handler "),n("span",{class:"token operator"},"="),s(" handler"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigaction"),n("span",{class:"token punctuation"},"("),s("SYNC_SIG"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigaction"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("childPid "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(),n("span",{class:"token comment"},"/* Child */"),s(`

    `),n("span",{class:"token comment"},"/* Child process wait for parent process */"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigsuspend"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("emptyMask"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"&&"),s(" errno "),n("span",{class:"token operator"},"!="),s(" EINTR"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigsuspend"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"/* Child does some required action here... */"),s(`

    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%s %ld] Child started - doing some work\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"currTime"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%T"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
           `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Simulate time spent doing some work */"),s(`

    `),n("span",{class:"token comment"},"/* And then signals parent that it's done */"),s(`

    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%s %ld] Child about to signal parent\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"currTime"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%T"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
           `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"kill"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getppid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" SYNC_SIG"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"kill"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"/* Now child can do other things... */"),s(`

    `),n("span",{class:"token function"},"_exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(),n("span",{class:"token comment"},"/* Parent */"),s(`

    `),n("span",{class:"token comment"},`/* Parent may do some work here, and then waits for child to
       complete the required action */`),s(`

    `),n("span",{class:"token comment"},"/* Parent finish work */"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"kill"),n("span",{class:"token punctuation"},"("),s("childPid"),n("span",{class:"token punctuation"},","),s(" SYNC_SIG"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"kill"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%s %ld] Parent about to wait for signal\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"currTime"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%T"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
           `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("emptyMask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigsuspend"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("emptyMask"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"&&"),s(" errno "),n("span",{class:"token operator"},"!="),s(" EINTR"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigsuspend"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%s %ld] Parent got signal\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"currTime"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%T"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"/* If required, return signal mask to its original state */"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigprocmask"),n("span",{class:"token punctuation"},"("),s("SIG_SETMASK"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("origMask"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigprocmask"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"/* Parent carries on to do other things... */"),s(`

    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u4E8C\u5341\u4E94\u7AE0"),n("h3",null,"25-1"),n("p",null,[s("\u8FD4\u56DE\u7ED3\u679C\u4E3A"),n("code",null,"255"),s("\uFF0C-1 \u7684 16 \u4F4D\u8868\u793A\u662F 0xffff\uFF0C\u5BF9\u5E94\u7684\u4F4E 8 \u4F4D\u8868\u793A\u4E3A 0xff\uFF0C\u5373 255\u3002")]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/wait.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"pid_t"),s(" child_pid"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" status"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"setbuf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stdout"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("child_pid "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("status"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"status: %d\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"WEXITSTATUS"),n("span",{class:"token punctuation"},"("),s("status"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u4E8C\u5341\u516D\u7AE0"),n("h3",null,"26-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"pid_t"),s(" child_pid"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("child_pid "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"ppid: %d\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"getppid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"26-2"),n("p",null,"\u5F53\u7236\u8FDB\u7A0B\u53D8\u4E3A\u50F5\u5C38\u8FDB\u7A0B\u540E\uFF0C\u5B50\u8FDB\u7A0B\u5C31\u4F1A\u88AB init \u6536\u517B"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"pid_t"),s(" child_pid1"),n("span",{class:"token punctuation"},","),s(" child_pid2"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("child_pid1 "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("child_pid2 "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"ppid: %d\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"getppid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"ppid: %d\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"getppid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"26-3"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"print_wait_status.h"'),s(),n("span",{class:"token comment"},"/* Declares printWaitStatus() */")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"tlpi_hdr.h"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/wait.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" status"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"pid_t"),s(" childPid"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"--help"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s [exit-status]\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(),n("span",{class:"token comment"},`/* Child: either exits immediately with given
             status or loops waiting for signals */`),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Child started with PID = %ld\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token comment"},"/* Status supplied on command line? */"),s(`
      `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getInt"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"exit-status"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token comment"},"/* Otherwise, wait for signals */"),s(`
      `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"pause"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_FAILURE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Not reached, but good practice */"),s(`

  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(),n("span",{class:"token comment"},`/* Parent: repeatedly wait on child until it
              either exits or is terminated by a signal */`),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token class-name"},"siginfo_t"),s(" infop"),n("span",{class:"token punctuation"},";"),s(`
      childPid `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"waitid"),n("span",{class:"token punctuation"},"("),s("P_ALL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("infop"),n("span",{class:"token punctuation"},","),s(" WEXITED"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token comment"},"//       childPid = waitpid(-1, &status,"),s(`
      `),n("span",{class:"token comment"},"//                          WUNTRACED"),s(`
      `),n("span",{class:"token comment"},"// #ifdef WCONTINUED /* Not present on older versions of Linux */"),s(`
      `),n("span",{class:"token comment"},"//                              | WCONTINUED"),s(`
      `),n("span",{class:"token comment"},"// #endif"),s(`
      `),n("span",{class:"token comment"},"//       );"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("childPid "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"waitpid"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

      `),n("span",{class:"token comment"},"/* Print status in hex, and as separate decimal bytes */"),s(`

      `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"waitpid() returned: PID=%ld; status=0x%04x (%d,%d)\\n"'),n("span",{class:"token punctuation"},","),s(`
             `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),s("childPid"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"int"),n("span",{class:"token punctuation"},")"),s("status"),n("span",{class:"token punctuation"},","),s(" status "),n("span",{class:"token operator"},">>"),s(),n("span",{class:"token number"},"8"),n("span",{class:"token punctuation"},","),s(" status "),n("span",{class:"token operator"},"&"),s(),n("span",{class:"token number"},"0xff"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token comment"},"// printWaitStatus(NULL, status);"),s(`
      `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s %d %d\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strsignal"),n("span",{class:"token punctuation"},"("),s("infop"),n("span",{class:"token punctuation"},"."),s("si_signo"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" infop"),n("span",{class:"token punctuation"},"."),s("si_code"),n("span",{class:"token punctuation"},","),s(`
             infop`),n("span",{class:"token punctuation"},"."),s("si_errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"WIFEXITED"),n("span",{class:"token punctuation"},"("),s("status"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"WIFSIGNALED"),n("span",{class:"token punctuation"},"("),s("status"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"26-4"),n("p",null,[s("\u4F7F\u7528"),n("code",null,"sigsuspend"),s("\u963B\u585E\u63A5\u6536\u4FE1\u53F7\u524D\uFF0C\u9700\u8981\u5148\u4F7F\u7528"),n("code",null,"sigprocmask"),s("\u963B\u585E\u5BF9\u5E94\u4FE1\u53F7\uFF0C\u9632\u6B62\u8FDB\u7A0B\u63D0\u524D\u63A5\u6536\u5230\u4FE1\u53F7\u3002")]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<libgen.h>"),s(),n("span",{class:"token comment"},"/* For basename() declaration */")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/wait.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"CMD_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"200")])]),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"sig_handler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"captured %d\\n"'),n("span",{class:"token punctuation"},","),s(" sig"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" cmd"),n("span",{class:"token punctuation"},"["),s("CMD_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"pid_t"),s(" childPid"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"sigset_t"),s(" st"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sigaction"),s(" sa"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"setbuf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stdout"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Disable buffering of stdout */"),s(`

  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Parent PID=%ld\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("childPid "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(),n("span",{class:"token comment"},"/* Child: immediately exits to become zombie */"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Child (PID=%ld) exiting\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"_exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(),n("span",{class:"token comment"},"/* Parent */"),s(`
    `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"sigaddset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},","),s(" SIGCHLD"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigprocmask"),n("span",{class:"token punctuation"},"("),s("SIG_BLOCK"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigprocmask"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    sa`),n("span",{class:"token punctuation"},"."),s("sa_flags "),n("span",{class:"token operator"},"="),s(" SA_RESTART"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},"."),s("sa_mask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    sa`),n("span",{class:"token punctuation"},"."),s("sa_handler "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"&"),s("sig_handler"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"sigaction"),n("span",{class:"token punctuation"},"("),s("SIGCHLD"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token function"},"sigfillset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"sigdelset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},","),s(" SIGCHLD"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigsuspend"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"&&"),s(" errno "),n("span",{class:"token operator"},"!="),s(" EINTR"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigsuspend"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"snprintf"),n("span",{class:"token punctuation"},"("),s("cmd"),n("span",{class:"token punctuation"},","),s(" CMD_SIZE"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"ps aux | grep %s"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"basename"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"system"),n("span",{class:"token punctuation"},"("),s("cmd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* View zombie child */"),s(`

    `),n("span",{class:"token comment"},'/* Now send the "sure kill" signal to the zombie */'),s(`

    `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"sigaddset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},","),s(" SIGCHLD"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigprocmask"),n("span",{class:"token punctuation"},"("),s("SIG_BLOCK"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigprocmask"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"kill"),n("span",{class:"token punctuation"},"("),s("childPid"),n("span",{class:"token punctuation"},","),s(" SIGKILL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errMsg"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"kill"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token function"},"sigfillset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"sigdelset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},","),s(" SIGCHLD"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigsuspend"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"&&"),s(" errno "),n("span",{class:"token operator"},"!="),s(" EINTR"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigsuspend"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token comment"},"// sleep(3); /* Give child a chance to react to signal */"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"After sending SIGKILL to zombie (PID=%ld):\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),s("childPid"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"system"),n("span",{class:"token punctuation"},"("),s("cmd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* View zombie child again */"),s(`

    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"\u7B2C\u4E8C\u5341\u4E03\u7AE0"),n("h3",null,"27-1"),n("p",null,[n("img",{src:E,alt:"27-1-1"})]),n("p",null,"\u76EE\u5F55 dir1 \u548C dir2 \u90FD\u88AB\u52A0\u8FDB\u4E86$PATH\uFF0C\u4F46\u662F dir1/xyz \u6CA1\u6709\u6267\u884C\u6743\u9650\uFF0Cdir2/xyz \u6709\u6267\u884C\u6743\u9650\u3002"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"2"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"--help"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s pathname\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"execlp"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"hello world"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"execlp"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"27-2"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<limits.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdarg.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<string.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"extern"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("environ"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"tlpi_execlp"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("filename"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"."),n("span",{class:"token punctuation"},"."),n("span",{class:"token punctuation"},"."),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  va_list ap`),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("tmp"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2048"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"size_t"),s(" argv_size"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" tmp_index "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("path"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" next_filename"),n("span",{class:"token punctuation"},"["),s("PATH_MAX"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" path_index"),n("span",{class:"token punctuation"},","),s(" next_filename_index"),n("span",{class:"token punctuation"},","),s(" path_len"),n("span",{class:"token punctuation"},";"),s(`

  tmp`),n("span",{class:"token punctuation"},"["),s("tmp_index"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"strdup"),n("span",{class:"token punctuation"},"("),s("filename"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"va_start"),n("span",{class:"token punctuation"},"("),s("ap"),n("span",{class:"token punctuation"},","),s(" filename"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"do"),s(),n("span",{class:"token punctuation"},"{"),s(`
    tmp`),n("span",{class:"token punctuation"},"["),s("tmp_index"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"va_arg"),n("span",{class:"token punctuation"},"("),s("ap"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("tmp"),n("span",{class:"token punctuation"},"["),s("tmp_index"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  tmp`),n("span",{class:"token punctuation"},"["),s("tmp_index"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
  argv_size `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token punctuation"},"("),s("tmp_index"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  argv `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("argv_size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},","),s(" tmp"),n("span",{class:"token punctuation"},","),s(" argv_size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  path `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getenv"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"PATH"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  path_len `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  path_index `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  next_filename_index `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),s("next_filename"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"do"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},"["),s("path_index"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"':'"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"strcat"),n("span",{class:"token punctuation"},"("),s("next_filename"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"/"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"strcat"),n("span",{class:"token punctuation"},"("),s("next_filename"),n("span",{class:"token punctuation"},","),s(" filename"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"execve"),n("span",{class:"token punctuation"},"("),s("next_filename"),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},","),s(" environ"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

      `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),s("next_filename"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" PATH_MAX"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      next_filename_index `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
      next_filename`),n("span",{class:"token punctuation"},"["),s("next_filename_index"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(" path"),n("span",{class:"token punctuation"},"["),s("path_index"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("path_index"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"<"),s(" path_len"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"strcat"),n("span",{class:"token punctuation"},"("),s("next_filename"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"/"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"strcat"),n("span",{class:"token punctuation"},"("),s("next_filename"),n("span",{class:"token punctuation"},","),s(" filename"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"execve"),n("span",{class:"token punctuation"},"("),s("filename"),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},","),s(" environ"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"tlpi_execlp"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"python"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"--version"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"tlpi_execlp"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"27-3"),n("p",null,[n("img",{src:S,alt:"27-3-1"})]),n("pre",{class:"language-shell"},[n("code",{class:"language-shell"},[n("span",{class:"token shebang important"},"#!/bin/cat -n"),s(`
Hello world
`)])]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s script\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"system"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"27-4"),n("p",null,[n("img",{src:L,alt:"27-4-1"})]),n("p",null,[s("\u7956\u7236\u8FDB\u7A0B\u53EF\u4EE5\u5E38\u9A7B\u540E\u53F0\uFF0C\u7236\u8FDB\u7A0B\u65E0\u9700"),n("code",null,"wait"),s("\u5B50\u8FDB\u7A0B\uFF0C\u7236\u8FDB\u7A0B\u9000\u51FA\u540E\uFF0C\u5B50\u8FDB\u7A0B\u7531"),n("code",null,"init"),s("\u63A5\u7BA1\uFF0C\u5B50\u8FDB\u7A0B\u7ED3\u675F\u540E\u7531"),n("code",null,"init"),s("\u8FDB\u7A0B\u8FDB\u884C"),n("code",null,"wait"),s("\uFF0C\u907F\u514D\u50F5\u5C38\u8FDB\u7A0B\u4EA7\u751F\u3002")]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/wait.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"pid_t"),s(" childPid"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" status"),n("span",{class:"token punctuation"},";"),s(`
  childPid `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("childPid "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork1"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("childPid "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork2"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"waitpid"),n("span",{class:"token punctuation"},"("),s("childPid"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("status"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"waitpid"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"27-5"),n("p",null,[s("\u5F53 stdout \u4E3A\u7EC8\u7AEF\u65F6\uFF0Cprintf \u9ED8\u8BA4\u7684\u6A21\u5F0F\u4E3A"),n("code",null,"_IOLBF"),s("\uFF0C\u9047\u5230\u56DE\u8F66\u624D\u4F1A\u6E05\u7A7A\u7528\u6237\u7A7A\u95F4\u7684\u7F13\u51B2\u533A\u3002\u4F46\u662F\u6267\u884C"),n("code",null,"execlp"),s("\u540E\uFF0C\u5F53\u524D\u8FDB\u7A0B\u7684\u4EE3\u7801\u4F1A\u88AB\u66FF\u6362\uFF0C\u5806\u533A\u3001\u6808\u533A\u3001\u6570\u636E\u533A\u4F1A\u88AB\u91CD\u65B0\u521D\u59CB\u5316\uFF0C\u6240\u4EE5\u5B57\u7B26\u4E32\u6765\u4E0D\u53CA\u6253\u5370\u5C31\u88AB\u6E05\u7A7A\u4E86\u3002")]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Hello world"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"execlp"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sleep"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"sleep"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"0"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"27-6"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/wait.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"handler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%d captured\\n"'),n("span",{class:"token punctuation"},","),s(" sig"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"sigset_t"),s(" ss"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"pid_t"),s(" child_pid"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sigaction"),s(" sa"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" status"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("cmd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string"},'"pwd"'),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("ss"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigaddset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("ss"),n("span",{class:"token punctuation"},","),s(" SIGCHLD"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  sa`),n("span",{class:"token punctuation"},"."),s("sa_flags "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},"."),s("sa_mask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  sa`),n("span",{class:"token punctuation"},"."),s("sa_handler "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"&"),s("handler"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"sigprocmask"),n("span",{class:"token punctuation"},"("),s("SIG_BLOCK"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("ss"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("child_pid "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"sigprocmask"),n("span",{class:"token punctuation"},"("),s("SIG_UNBLOCK"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("ss"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"sigaction"),n("span",{class:"token punctuation"},"("),s("SIGCHLD"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"system"),n("span",{class:"token punctuation"},"("),s("cmd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("status"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"wait"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"system"),n("span",{class:"token punctuation"},"("),s("cmd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"status %d\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"WEXITSTATUS"),n("span",{class:"token punctuation"},"("),s("status"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"sigprocmask"),n("span",{class:"token punctuation"},"("),s("SIG_UNBLOCK"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("ss"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u4E8C\u5341\u516B\u7AE0"),n("h3",null,"28-1"),n("p",null,[n("img",{src:x,alt:"28-1-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/wait.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" count "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" is_vfork "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" status"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"pid_t"),s(" child_pid"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s count [is-vfork]\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  count `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getInt"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"count"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(`
    is_vfork `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(" count"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("child_pid "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),s("is_vfork "),n("span",{class:"token operator"},"?"),s(),n("span",{class:"token function"},"vfork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},":"),s(),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token function"},"wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("status"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"done\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u4E8C\u5341\u4E5D\u7AE0"),n("h3",null,"29-1"),n("p",null,[n("img",{src:I,alt:"29-1-1"})]),n("p",null,"\u4F1A\u9020\u6210\u6B7B\u9501\u7684\u7F16\u8BD1\u65F6\u68C0\u67E5\u62A5\u9519\u3002\u4E3A\u4E86\u907F\u514D join \u6B7B\u9501\uFF0C\u9700\u8981\u4FDD\u8BC1 join \u7684\u7EBF\u7A0B\u4E0D\u4E3A\u5F53\u524D\u7EBF\u7A0B\u3002"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<pthread.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  s `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_join"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"pthread_self"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"thread_join"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"29-2"),n("p",null,"\u5B50\u7EBF\u7A0B\u6CA1\u6709\u88AB\u4E3B\u7EBF\u7A0B join\uFF0C\u4E3B\u7EBF\u7A0B\u7684\u751F\u547D\u5468\u671F\u53EF\u80FD\u5C0F\u4E8E\u5B50\u7EBF\u7A0B\uFF0C\u4E3B\u7EBF\u7A0B\u76F4\u63A5 return \u76F8\u5F53\u4E8E\u8C03\u7528 exit()\uFF0C\u5BFC\u81F4\u5B50\u7EBF\u7A0B\u7684\u63D0\u524D\u9000\u51FA\u3002"),n("h2",null,"\u7B2C\u4E09\u5341\u7AE0"),n("h3",null,"30-1"),n("p",null,[n("img",{src:U,alt:"30-1-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"tlpi_hdr.h"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<pthread.h>")]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"volatile"),s(),n("span",{class:"token keyword"},"int"),s(" glob "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},`/* "volatile" prevents compiler optimizations
                                 of arithmetic operations on 'glob' */`),s(`

`),n("span",{class:"token keyword"},"typedef"),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"func_arg"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token operator"},"*"),s("loops"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("thread_name"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(" func_arg"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token comment"},"/* Loop 'arg' times incrementing 'glob' */"),s(`
`),n("span",{class:"token function"},"threadFunc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("arg"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  func_arg `),n("span",{class:"token operator"},"*"),s("fa "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),s("func_arg "),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("arg"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" loc"),n("span",{class:"token punctuation"},","),s(" j"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("j "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" j "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token operator"},"*"),s("fa"),n("span",{class:"token operator"},"->"),s("loops"),n("span",{class:"token punctuation"},";"),s(" j"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    loc `),n("span",{class:"token operator"},"="),s(" glob"),n("span",{class:"token punctuation"},";"),s(`
    loc`),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(`
    glob `),n("span",{class:"token operator"},"="),s(" loc"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s: %d\\n"'),n("span",{class:"token punctuation"},","),s(" fa"),n("span",{class:"token operator"},"->"),s("thread_name"),n("span",{class:"token punctuation"},","),s(" glob"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`

  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"pthread_t"),s(" t1"),n("span",{class:"token punctuation"},","),s(" t2"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" loops"),n("span",{class:"token punctuation"},","),s(" s"),n("span",{class:"token punctuation"},";"),s(`

  loops `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"?"),s(),n("span",{class:"token function"},"getInt"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" GN_GT_0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"num-loops"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},":"),s(),n("span",{class:"token number"},"10000000"),n("span",{class:"token punctuation"},";"),s(`

  func_arg func_arg1 `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"{"),n("span",{class:"token operator"},"&"),s("loops"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"thread1"'),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},","),s(" func_arg2 "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"{"),n("span",{class:"token operator"},"&"),s("loops"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"thread2"'),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

  s `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_create"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("t1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(" threadFunc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("func_arg1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_create"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  s `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_create"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("t2"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(" threadFunc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("func_arg2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_create"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  s `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_join"),n("span",{class:"token punctuation"},"("),s("t1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_join"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  s `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_join"),n("span",{class:"token punctuation"},"("),s("t2"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_join"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"glob = %d\\n"'),n("span",{class:"token punctuation"},","),s(" glob"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"30-2"),n("p",null,"\u53EF\u4EE5\u8FDB\u4E00\u6B65\u4F18\u5316\uFF0C\u76EE\u524D\u662F\u5BF9\u6574\u68F5\u6811\u90FD\u4E0A\u9501\uFF0C\u53EF\u4EE5\u6539\u8FDB\u4E3A\u5BF9\u6BCF\u4E2A\u8282\u70B9\u8FDB\u884C\u4E0A\u9501"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<assert.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<pthread.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"enum"),s(),n("span",{class:"token class-name"},"BINARY_TREE_ERROR"),s(),n("span",{class:"token punctuation"},"{"),s(`
  OK`),n("span",{class:"token punctuation"},","),s("        "),n("span",{class:"token comment"},"// OK"),s(`
  EREPET`),n("span",{class:"token punctuation"},","),s("    "),n("span",{class:"token comment"},"// key repeat"),s(`
  ENOTFOUND`),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token comment"},"// key not found"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"typedef"),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"binary_tree_node"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("value"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("key"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"binary_tree_node"),s(),n("span",{class:"token operator"},"*"),s("left"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"binary_tree_node"),s(),n("span",{class:"token operator"},"*"),s("right"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(" binary_tree_node"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"typedef"),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"binary_tree"),s(),n("span",{class:"token punctuation"},"{"),s(`
  binary_tree_node `),n("span",{class:"token operator"},"*"),s("root"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"pthread_mutex_t"),s(),n("span",{class:"token operator"},"*"),s("mux"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(" binary_tree"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"binary_tree_initialize"),n("span",{class:"token punctuation"},"("),s("binary_tree "),n("span",{class:"token operator"},"*"),s("tree"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  tree`),n("span",{class:"token operator"},"->"),s("root "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
  tree`),n("span",{class:"token operator"},"->"),s("mux "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"pthread_mutex_t"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"pthread_mutex_init"),n("span",{class:"token punctuation"},"("),s("tree"),n("span",{class:"token operator"},"->"),s("mux"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"binary_tree_add"),n("span",{class:"token punctuation"},"("),s("binary_tree "),n("span",{class:"token operator"},"*"),s("tree"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("value"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  binary_tree_node `),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  s `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_mutex_lock"),n("span",{class:"token punctuation"},"("),s("tree"),n("span",{class:"token operator"},"->"),s("mux"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_mutex_lock"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  current `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"&"),s("tree"),n("span",{class:"token operator"},"->"),s("root"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    s `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("key"),n("span",{class:"token punctuation"},","),s(" key"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      s `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_mutex_unlock"),n("span",{class:"token punctuation"},"("),s("tree"),n("span",{class:"token operator"},"->"),s("mux"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_mutex_unlock"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"return"),s(" EREPET"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    current `),n("span",{class:"token operator"},"="),s(" s "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"?"),s(),n("span",{class:"token operator"},"&"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("left "),n("span",{class:"token operator"},":"),s(),n("span",{class:"token operator"},"&"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("right"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token operator"},"*"),s("current "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("binary_tree_node"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("key "),n("span",{class:"token operator"},"="),s(" key"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("value "),n("span",{class:"token operator"},"="),s(" value"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("left "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("right "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
  s `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_mutex_unlock"),n("span",{class:"token punctuation"},"("),s("tree"),n("span",{class:"token operator"},"->"),s("mux"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_mutex_unlock"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" OK"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"binary_tree_delete"),n("span",{class:"token punctuation"},"("),s("binary_tree "),n("span",{class:"token operator"},"*"),s("tree"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("key"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  binary_tree_node `),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("to_replace"),n("span",{class:"token punctuation"},";"),s(`
  binary_tree_node `),n("span",{class:"token operator"},"*"),s("tmp"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  s `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_mutex_lock"),n("span",{class:"token punctuation"},"("),s("tree"),n("span",{class:"token operator"},"->"),s("mux"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_mutex_lock"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  current `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"&"),s("tree"),n("span",{class:"token operator"},"->"),s("root"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    s `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("key"),n("span",{class:"token punctuation"},","),s(" key"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("left"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        to_replace `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"&"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("left"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("to_replace"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("right"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
          to_replace `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"&"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("to_replace"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("right"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("key "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("to_replace"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("key"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("value "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("to_replace"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("value"),n("span",{class:"token punctuation"},";"),s(`
        tmp `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"*"),s("to_replace"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("to_replace"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("to_replace"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("left"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),s("tmp"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("right"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        to_replace `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"&"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("right"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("to_replace"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("left"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
          to_replace `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"&"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("to_replace"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("left"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("key "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("to_replace"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("key"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("value "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("to_replace"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("value"),n("span",{class:"token punctuation"},";"),s(`
        tmp `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"*"),s("to_replace"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("to_replace"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("to_replace"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("right"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),s("tmp"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token operator"},"*"),s("current "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
      s `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_mutex_unlock"),n("span",{class:"token punctuation"},"("),s("tree"),n("span",{class:"token operator"},"->"),s("mux"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_mutex_unlock"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"return"),s(" OK"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    current `),n("span",{class:"token operator"},"="),s(" s "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"?"),s(),n("span",{class:"token operator"},"&"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("left "),n("span",{class:"token operator"},":"),s(),n("span",{class:"token operator"},"&"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("right"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  s `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_mutex_unlock"),n("span",{class:"token punctuation"},"("),s("tree"),n("span",{class:"token operator"},"->"),s("mux"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_mutex_unlock"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" ENOTFOUND"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

Boolean `),n("span",{class:"token function"},"binary_tree_lookup"),n("span",{class:"token punctuation"},"("),s("binary_tree "),n("span",{class:"token operator"},"*"),s("tree"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("value"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  binary_tree_node `),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  Boolean result`),n("span",{class:"token punctuation"},";"),s(`
  s `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_mutex_lock"),n("span",{class:"token punctuation"},"("),s("tree"),n("span",{class:"token operator"},"->"),s("mux"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_mutex_lock"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  current `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"&"),s("tree"),n("span",{class:"token operator"},"->"),s("root"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    s `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("key"),n("span",{class:"token punctuation"},","),s(" key"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      result `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("value "),n("span",{class:"token operator"},"=="),s(" value"),n("span",{class:"token punctuation"},";"),s(`
      s `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_mutex_unlock"),n("span",{class:"token punctuation"},"("),s("tree"),n("span",{class:"token operator"},"->"),s("mux"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_mutex_unlock"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"return"),s(" result"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    current `),n("span",{class:"token operator"},"="),s(" s "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"?"),s(),n("span",{class:"token operator"},"&"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("left "),n("span",{class:"token operator"},":"),s(),n("span",{class:"token operator"},"&"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("right"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  s `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_mutex_unlock"),n("span",{class:"token punctuation"},"("),s("tree"),n("span",{class:"token operator"},"->"),s("mux"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_mutex_unlock"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" FALSE"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("keys"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"{"),n("span",{class:"token string"},'"key1"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"key2"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"key3"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"key4"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"key5"'),n("span",{class:"token punctuation"},","),s(`
                  `),n("span",{class:"token string"},'"key6"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"key7"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"key8"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"key9"'),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("unexists_keys"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"{"),n("span",{class:"token string"},'"key11"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"123"'),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" values"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"{"),n("span",{class:"token number"},"11"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"22"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"33"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"44"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"55"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"66"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"77"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"88"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"99"),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`
  binary_tree tree`),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"binary_tree_initialize"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("tree"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"binary_tree_add"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("tree"),n("span",{class:"token punctuation"},","),s(" keys"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("values "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"binary_tree_add"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("tree"),n("span",{class:"token punctuation"},","),s(" keys"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"4"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("values "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"4"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"binary_tree_add"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("tree"),n("span",{class:"token punctuation"},","),s(" keys"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("values "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"binary_tree_add"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("tree"),n("span",{class:"token punctuation"},","),s(" keys"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("values "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"binary_tree_add"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("tree"),n("span",{class:"token punctuation"},","),s(" keys"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("values "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"binary_tree_add"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("tree"),n("span",{class:"token punctuation"},","),s(" keys"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"6"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("values "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"6"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"binary_tree_add"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("tree"),n("span",{class:"token punctuation"},","),s(" keys"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("values "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"binary_tree_add"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("tree"),n("span",{class:"token punctuation"},","),s(" keys"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"8"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("values "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"8"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"binary_tree_add"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("tree"),n("span",{class:"token punctuation"},","),s(" keys"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"7"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("values "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"7"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"binary_tree_lookup"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("tree"),n("span",{class:"token punctuation"},","),s(" keys"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("values "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" TRUE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"binary_tree_lookup"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("tree"),n("span",{class:"token punctuation"},","),s(" keys"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("values "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"7"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" FALSE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"binary_tree_lookup"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("tree"),n("span",{class:"token punctuation"},","),s(" unexists_keys"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("values "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"7"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(`
         FALSE`),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"binary_tree_lookup"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("tree"),n("span",{class:"token punctuation"},","),s(" keys"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("values "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" TRUE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"binary_tree_delete"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("tree"),n("span",{class:"token punctuation"},","),s(" keys"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"binary_tree_lookup"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("tree"),n("span",{class:"token punctuation"},","),s(" keys"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("values "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" FALSE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"assert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"binary_tree_lookup"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("tree"),n("span",{class:"token punctuation"},","),s(" keys"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"6"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("values "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"6"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" TRUE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u4E09\u5341\u4E00\u7AE0"),n("h3",null,"31-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<pthread.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"typedef"),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"one_time_init_contorl"),s(),n("span",{class:"token punctuation"},"{"),s(`
  bool init`),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"pthread_mutex_t"),s(" mux"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(" one_time_init_contorl"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"one_time_init_contorl_init"),n("span",{class:"token punctuation"},"("),s("one_time_init_contorl "),n("span",{class:"token operator"},"*"),s("control"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"pthread_mutex_init"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("control"),n("span",{class:"token operator"},"->"),s("mux"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  control`),n("span",{class:"token operator"},"->"),s("init "),n("span",{class:"token operator"},"="),s(" false"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"one_time_init"),n("span",{class:"token punctuation"},"("),s("one_time_init_contorl "),n("span",{class:"token operator"},"*"),s("control"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("init"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  s `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_mutex_lock"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("control"),n("span",{class:"token operator"},"->"),s("mux"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_mutex_lock"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),s("control"),n("span",{class:"token operator"},"->"),s("init"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    control`),n("span",{class:"token operator"},"->"),s("init "),n("span",{class:"token operator"},"="),s(" true"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"init"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  s `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_mutex_unlock"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("control"),n("span",{class:"token operator"},"->"),s("mux"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_mutex_unlock"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"init"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"init\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"worker"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("arg"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  one_time_init_contorl `),n("span",{class:"token operator"},"*"),s("control "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),s("one_time_init_contorl "),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("arg"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"in worker\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"one_time_init"),n("span",{class:"token punctuation"},"("),s("control"),n("span",{class:"token punctuation"},","),s(" init"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  one_time_init_contorl control`),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"pthread_t"),s(" t"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"setbuf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stdout"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"one_time_init_contorl_init"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("control"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  s `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_create"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("t"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(" worker"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("control"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_create"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"worker"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("control"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  s `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_join"),n("span",{class:"token punctuation"},"("),s("t"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_create"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"31-2"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<libgen.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<limits.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<pthread.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token class-name"},"pthread_key_t"),s(" key_dirname"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token class-name"},"pthread_key_t"),s(" key_basename"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token class-name"},"pthread_once_t"),s(" once_dirname "),n("span",{class:"token operator"},"="),s(" PTHREAD_ONCE_INIT"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token class-name"},"pthread_once_t"),s(" once_basename "),n("span",{class:"token operator"},"="),s(" PTHREAD_ONCE_INIT"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"destructor"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"init_key_dirname"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token function"},"pthread_key_create"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("key_dirname"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("destructor"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"init_key_basename"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token function"},"pthread_key_create"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("key_basename"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("destructor"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"dirname_r"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("pathname"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("ptr"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("pathname "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("pathname"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token string"},'"."'),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_once"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("once_dirname"),n("span",{class:"token punctuation"},","),s(" init_key_dirname"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_once"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  buf `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_getspecific"),n("span",{class:"token punctuation"},"("),s("key_dirname"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("buf "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_setspecific"),n("span",{class:"token punctuation"},"("),s("key_dirname"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),s("buf "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("PATH_MAX "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(`
        `),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_setspecific"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(" pathname"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("pathname"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ptr `),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("pathname"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("ptr"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'/'"),n("span",{class:"token punctuation"},")"),s(`
    ptr`),n("span",{class:"token operator"},"--"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ptr "),n("span",{class:"token operator"},"=="),s(" pathname "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token string"},'"."'),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("ptr"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token char"},"'/'"),n("span",{class:"token punctuation"},")"),s(`
    ptr`),n("span",{class:"token operator"},"--"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ptr "),n("span",{class:"token operator"},"=="),s(" pathname "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token string"},'"."'),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("ptr"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'/'"),n("span",{class:"token punctuation"},")"),s(`
    ptr`),n("span",{class:"token operator"},"--"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},"("),s("ptr "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token char"},"'\\0'"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" buf"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"basename_r"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("pathname"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("ptr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("pathname "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("pathname"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token string"},'"."'),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("pathname"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"."'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("pathname"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'".."'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"||"),s(`
      `),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("pathname"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"/"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" pathname"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_once"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("once_basename"),n("span",{class:"token punctuation"},","),s(" init_key_basename"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_once"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  buf `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_getspecific"),n("span",{class:"token punctuation"},"("),s("key_basename"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("buf "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_setspecific"),n("span",{class:"token punctuation"},"("),s("key_basename"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),s("buf "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("PATH_MAX "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(`
        `),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_setspecific"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(" pathname"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("pathname"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ptr `),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("pathname"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("ptr"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token char"},"'/'"),n("span",{class:"token punctuation"},")"),s(`
    ptr`),n("span",{class:"token operator"},"--"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"return"),s(" ptr "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("path "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string"},'"/home/cattchen/Codes/tlpi-practice"'),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"dirname %s\\nbasename %s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"dirname_r"),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"basename_r"),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u4E09\u5341\u4E8C\u7AE0"),n("h2",null,"\u7B2C\u4E09\u5341\u4E09\u7AE0"),n("h3",null,"33-1"),n("p",null,[n("img",{src:N,alt:"33-1-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<pthread.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"print_sigset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"sigset_t"),s(),n("span",{class:"token operator"},"*"),s("st"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("alias"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s sigset: "'),n("span",{class:"token punctuation"},","),s(" alias"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(" SIGRTMIN"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigismember"),n("span",{class:"token punctuation"},"("),s("st"),n("span",{class:"token punctuation"},","),s(" i"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%d "'),n("span",{class:"token punctuation"},","),s(" i"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"worker"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("arg"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"sigset_t"),s(" st"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigaddset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},","),s(" SIGUSR1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"sigprocmask"),n("span",{class:"token punctuation"},"("),s("SIG_BLOCK"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigprocmask"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"sigpending"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigpending"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"print_sigset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"worker thread"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"sigset_t"),s(" st"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"pthread_t"),s(" t"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"setbuf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stdout"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_create"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("t"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(" worker"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_create"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"pthread_kill"),n("span",{class:"token punctuation"},"("),s("t"),n("span",{class:"token punctuation"},","),s(" SIGUSR1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"pthread_kill"),n("span",{class:"token punctuation"},"("),s("t"),n("span",{class:"token punctuation"},","),s(" SIGUSR1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"sigpending"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigpending"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"print_sigset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"main thread"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_join"),n("span",{class:"token punctuation"},"("),s("t"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_join"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"33-2"),n("p",null,[n("img",{src:T,alt:"33-2-1"})]),n("p",null,"\u5B50\u7EBF\u7A0B\u63D0\u524D\u9000\u51FA\u7684\u8BDD\uFF0C\u7531\u5B50\u7EBF\u7A0B\u521B\u5EFA\u7684\u4FE1\u53F7\u5904\u7406\u5668\u4F1A\u7531\u5176\u4ED6\u7EBF\u7A0B\u6267\u884C\u3002"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<pthread.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/wait.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"sig_handler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"pthread_t"),s(" t"),n("span",{class:"token punctuation"},";"),s(`
  t `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_self"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%d captured %ld\\n"'),n("span",{class:"token punctuation"},","),s(" sig"),n("span",{class:"token punctuation"},","),s(" t"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"worker"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("arg"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sigaction"),s(" sa"),n("span",{class:"token punctuation"},";"),s(`
  sa`),n("span",{class:"token punctuation"},"."),s("sa_flags "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},"."),s("sa_mask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  sa`),n("span",{class:"token punctuation"},"."),s("sa_handler "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"&"),s("sig_handler"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigaction"),n("span",{class:"token punctuation"},"("),s("SIGCHLD"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigaction"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"pthread_exit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"pthread_t"),s(" t"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_create"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("t"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("worker"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_create"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"main thread %ld, worker thread %ld\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"pthread_self"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" t"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_join"),n("span",{class:"token punctuation"},"("),s("t"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_join"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"wait"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u4E09\u5341\u56DB\u7AE0"),n("h3",null,"34-2"),n("p",null,[n("img",{src:O,alt:"34-2-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[s("# "),n("span",{class:"token number"},"34"),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"2"),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1."),s(`c
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"extern"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("environ"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"pid_t"),s(" child_pid"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("child_pid "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"process PID=%ld PPID=%ld PGRP=%ld\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
           `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getppid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpgrp"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token comment"},"// sleep(2);"),s(`
    `),n("span",{class:"token comment"},'// printf("process PID=%ld PPID=%ld PGRP=%ld\\n", (long)getpid(),'),s(`
    `),n("span",{class:"token comment"},"//        (long)getppid(), (long)getpgrp());"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"execve"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"print-id"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},","),s(" environ"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"execve"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"setpgid"),n("span",{class:"token punctuation"},"("),s("child_pid"),n("span",{class:"token punctuation"},","),s(" child_pid"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[s("# "),n("span",{class:"token number"},"34"),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"2"),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"2."),s(`c
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"in other process PID=%ld PPID=%ld PGRP=%ld\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
         `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getppid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpgrp"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"in other process PID=%ld PPID=%ld PGRP=%ld\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
         `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getppid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpgrp"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"34-3"),n("p",null,[n("img",{src:R,alt:"34-3-1"})]),n("p",null,[s("\u4F7F\u7528\u7BA1\u9053\u521B\u5EFA\u8FDB\u7A0B\u7EC4\uFF0C\u5F53\u8FDB\u7A0B\u975E\u8FDB\u7A0B\u7EC4\u9996\u8FDB\u7A0B\u65F6"),n("code",null,"setsid"),s("\u8C03\u7528\u6210\u529F")]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"setsid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"setsid"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"done\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"34-4"),n("p",null,[n("img",{src:F,alt:"34-4-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"_GNU_SOURCE"),s(),n("span",{class:"token comment"},"/* Get strsignal() declaration from <string.h> */")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"tlpi_hdr.h"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<string.h>")]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token comment"},"/* Handler for SIGHUP */"),s(`
`),n("span",{class:"token function"},"handler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"PID %ld: caught signal %2d (%s)\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" sig"),n("span",{class:"token punctuation"},","),s(`
         `),n("span",{class:"token function"},"strsignal"),n("span",{class:"token punctuation"},"("),s("sig"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token comment"},"/* UNSAFE (see Section 21.1.2) */"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"pid_t"),s(" parentPid"),n("span",{class:"token punctuation"},","),s(" childPid"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" j"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sigaction"),s(" sa"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"--help"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s {d|s}... [ > sig.log 2>&1 ]\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"setbuf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stdout"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Make stdout unbuffered */"),s(`

  parentPid `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"PID of parent process is:       %ld\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),s("parentPid"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Foreground process group ID is: %ld\\n"'),n("span",{class:"token punctuation"},","),s(`
         `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"tcgetpgrp"),n("span",{class:"token punctuation"},"("),s("STDIN_FILENO"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},"// \u63A7\u5236\u8FDB\u7A0B\u6355\u83B7SIGHUP"),s(`
  `),n("span",{class:"token function"},"signal"),n("span",{class:"token punctuation"},"("),s("SIGHUP"),n("span",{class:"token punctuation"},","),s(" SIG_IGN"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("j "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(" j "),n("span",{class:"token operator"},"<"),s(" argc"),n("span",{class:"token punctuation"},";"),s(" j"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token comment"},"/* Create child processes */"),s(`
    childPid `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("childPid "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("childPid "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s("     "),n("span",{class:"token comment"},"/* If child... */"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),s("j"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'d'"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token comment"},"/* 'd' --> to different pgrp */"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"setpgid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
          `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"setpgid"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

      `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},"."),s("sa_mask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      sa`),n("span",{class:"token punctuation"},"."),s("sa_flags "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
      sa`),n("span",{class:"token punctuation"},"."),s("sa_handler "),n("span",{class:"token operator"},"="),s(" handler"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigaction"),n("span",{class:"token punctuation"},"("),s("SIGHUP"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigaction"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Child exits loop */"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`

  `),n("span",{class:"token comment"},"/* All processes fall through to here */"),s(`

  `),n("span",{class:"token function"},"alarm"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"60"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Ensure each process eventually terminates */"),s(`

  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"PID=%ld PGID=%ld\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpgrp"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"pause"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Wait for signals */"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"34-5"),n("p",null,[s("\u6267\u884C"),n("code",null,"SIGHUP"),s("\u4FE1\u53F7\u5904\u7406\u5668\u65F6\u9ED8\u8BA4\u662F\u4F1A\u963B\u585E"),n("code",null,"SIGHUP"),s("\uFF0C\u5982\u679C\u628A\u63A5\u89E6\u963B\u585E"),n("code",null,"SIGHUP"),s("\u7684\u4EE3\u7801\u63D0\u524D\u3002\u53EF\u80FD\u5BFC\u81F4\u4FE1\u53F7\u5904\u7406\u5668\u7684\u9012\u5F52\u8C03\u7528")]),n("h3",null,"34-6"),n("p",null,[n("img",{src:C,alt:"34-6-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" buf"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"setbuf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stdout"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"signal"),n("span",{class:"token punctuation"},"("),s("SIGTTIN"),n("span",{class:"token punctuation"},","),s(" SIG_IGN"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"EIO=%d\\n"'),n("span",{class:"token punctuation"},","),s(" EIO"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("STDIN_FILENO"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"errno=%d\\n"'),n("span",{class:"token punctuation"},","),s(" errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"alarm"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"10"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"34-7"),n("p",null,[n("img",{src:A,alt:"34-7-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"_GNU_SOURCE")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"sig_handler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"capture %s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strsignal"),n("span",{class:"token punctuation"},"("),s("sig"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sigaction"),s(" sa"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"setbuf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stdout"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},"."),s("sa_mask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    sa`),n("span",{class:"token punctuation"},"."),s("sa_flags "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"ifdef"),s(),n("span",{class:"token expression"},"WITH_HANDLER")]),s(`
    sa`),n("span",{class:"token punctuation"},"."),s("sa_handler "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"&"),s("sig_handler"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"with handler\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"else")]),s(`
    sa`),n("span",{class:"token punctuation"},"."),s("sa_handler "),n("span",{class:"token operator"},"="),s(" SIG_DFL"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"default\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"endif")]),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigaction"),n("span",{class:"token punctuation"},"("),s("SIGTTIN"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigaction"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"alarm"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"60"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"pause"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"caught signal\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u4E09\u5341\u4E94\u7AE0"),n("h3",null,"35-1"),n("p",null,[n("img",{src:M,alt:"35-1-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sched.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/resource.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"extern"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("environ"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"print_usage"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s [-n N] [COMMAND [ARG]...]\\n"'),n("span",{class:"token punctuation"},","),s(" argv0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" adjustment "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"10"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" c"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("command "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("command_argv"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" command_index "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(" command_argc"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"print_usage"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("c "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getopt"),n("span",{class:"token punctuation"},"("),s("argc"),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"n:"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'n'"),n("span",{class:"token operator"},":"),s(`
      adjustment `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"atoi"),n("span",{class:"token punctuation"},"("),s("optarg"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      command_index `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token function"},"print_usage"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  command `),n("span",{class:"token operator"},"="),s(" argv"),n("span",{class:"token punctuation"},"["),s("command_index"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  command_argc `),n("span",{class:"token operator"},"="),s(" argc "),n("span",{class:"token operator"},"-"),s(" command_index "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  command_argv `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token punctuation"},"("),s("command_argc "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),s("command_argv"),n("span",{class:"token punctuation"},","),s(" argv "),n("span",{class:"token operator"},"+"),s(" command_index"),n("span",{class:"token punctuation"},","),s(`
         `),n("span",{class:"token punctuation"},"("),s("command_argc "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  command_argv`),n("span",{class:"token punctuation"},"["),s("command_argc "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"setpriority"),n("span",{class:"token punctuation"},"("),s("PRIO_PROCESS"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" adjustment"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"setpriotity"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s\\n"'),n("span",{class:"token punctuation"},","),s(" command"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"execve"),n("span",{class:"token punctuation"},"("),s("command"),n("span",{class:"token punctuation"},","),s(" command_argv"),n("span",{class:"token punctuation"},","),s(" environ"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"execve"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"35-2"),n("p",null,[n("img",{src:z,alt:"35-2-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"_GNU_SOURCE")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sched.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"extern"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("environ"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" policy"),n("span",{class:"token punctuation"},","),s(" command_argc"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("command"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("command_argv"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sched_param"),s(" sp"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"uid_t"),s(" ruid"),n("span",{class:"token punctuation"},","),s(" euid"),n("span",{class:"token punctuation"},","),s(" suid"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"4"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s [r|f] priority commmand arg..."'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'r'"),n("span",{class:"token operator"},":"),s(`
    policy `),n("span",{class:"token operator"},"="),s(" SCHED_RR"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'f'"),n("span",{class:"token operator"},":"),s(`
    policy `),n("span",{class:"token operator"},"="),s(" SCHED_FIFO"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errMsg"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"unknown policy %s"'),n("span",{class:"token punctuation"},","),s(" policy"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  sp`),n("span",{class:"token punctuation"},"."),s("sched_priority "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"atoi"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  command `),n("span",{class:"token operator"},"="),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  command_argc `),n("span",{class:"token operator"},"="),s(" argc "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token number"},"4"),n("span",{class:"token punctuation"},";"),s(`
  command_argv `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token punctuation"},"("),s("command_argc "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),s("command_argv"),n("span",{class:"token punctuation"},","),s(" argv "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token punctuation"},"("),s("command_argc "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  command_argv`),n("span",{class:"token punctuation"},"["),s("command_argc "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getresuid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("ruid"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("euid"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("suid"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"getresuid"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"seteuid"),n("span",{class:"token punctuation"},"("),s("suid"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"seteuid"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sched_setscheduler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" policy"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sp"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sched_setscheduler"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"setresuid"),n("span",{class:"token punctuation"},"("),s("ruid"),n("span",{class:"token punctuation"},","),s(" euid"),n("span",{class:"token punctuation"},","),s(" ruid"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"setresuid"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"execve"),n("span",{class:"token punctuation"},"("),s("command"),n("span",{class:"token punctuation"},","),s(" command_argv"),n("span",{class:"token punctuation"},","),s(" environ"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"execve"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"35-3"),n("p",null,[n("img",{src:P,alt:"35-3-1"})]),n("p",null,"\u9700\u8981\u5C06\u865A\u62DF\u673A\u914D\u7F6E\u4E3A\u5355\u6838 CPU"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sched.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/times.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"tms"),s(" t1"),n("span",{class:"token punctuation"},","),s(" t2"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sched_param"),s(" sp"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"pid_t"),s(" this_pid"),n("span",{class:"token punctuation"},","),s(" another_pid"),n("span",{class:"token punctuation"},","),s(" parent_pid"),n("span",{class:"token punctuation"},","),s(" child_pid"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" step "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ticks "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"sysconf"),n("span",{class:"token punctuation"},"("),s("_SC_CLK_TCK"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"setbuf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stdout"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  parent_pid `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  sp`),n("span",{class:"token punctuation"},"."),s("sched_priority "),n("span",{class:"token operator"},"="),s(" SCHED_FIFO"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sched_setscheduler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sp"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sched_setscheduler"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("child_pid "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    another_pid `),n("span",{class:"token operator"},"="),s(" parent_pid"),n("span",{class:"token punctuation"},";"),s(`
    this_pid `),n("span",{class:"token operator"},"="),s(" child_pid"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    another_pid `),n("span",{class:"token operator"},"="),s(" child_pid"),n("span",{class:"token punctuation"},";"),s(`
    this_pid `),n("span",{class:"token operator"},"="),s(" parent_pid"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`

  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("step"),n("span",{class:"token operator"},"++"),s(),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"12"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"times"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("t1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"do"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"times"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("t2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("t2"),n("span",{class:"token punctuation"},"."),s("tms_stime "),n("span",{class:"token operator"},"+"),s(" t2"),n("span",{class:"token punctuation"},"."),s("tms_utime"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token punctuation"},"("),s("t1"),n("span",{class:"token punctuation"},"."),s("tms_stime "),n("span",{class:"token operator"},"+"),s(" t1"),n("span",{class:"token punctuation"},"."),s("tms_utime"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"<"),s(`
             `),n("span",{class:"token number"},"0.25"),s(),n("span",{class:"token operator"},"*"),s(" ticks"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"PID=%ld step=%d\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" step"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("step "),n("span",{class:"token operator"},"%"),s(),n("span",{class:"token number"},"4"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"sched_yield"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"35-4"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token comment"},"// \u6D89\u53CA\u5230\u4E86\u7BA1\u9053\uFF0C\u540E\u9762\u8865"),s(`
`)])]),n("h2",null,"\u7B2C\u4E09\u5341\u516D\u7AE0"),n("h3",null,"36-1"),n("p",null,[n("img",{src:D,alt:"36-1-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/resource.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/times.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/wait.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"pid_t"),s(" child_pid"),n("span",{class:"token punctuation"},";"),s(`

  child_pid `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("child_pid "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("child_pid "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"tms"),s(" t1"),n("span",{class:"token punctuation"},","),s(" t2"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" ticks"),n("span",{class:"token punctuation"},";"),s(`
    ticks `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"sysconf"),n("span",{class:"token punctuation"},"("),s("_SC_CLK_TCK"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"times"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("t1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"do"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"times"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("t2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("t2"),n("span",{class:"token punctuation"},"."),s("tms_stime "),n("span",{class:"token operator"},"+"),s(" t1"),n("span",{class:"token punctuation"},"."),s("tms_utime"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),s(),n("span",{class:"token operator"},"*"),s(" ticks"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"_exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"rusage"),s(" rs1"),n("span",{class:"token punctuation"},","),s(" rs2"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" status"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getrusage"),n("span",{class:"token punctuation"},"("),s("RUSAGE_CHILDREN"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("rs1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"getrusage"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("status"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getrusage"),n("span",{class:"token punctuation"},"("),s("RUSAGE_CHILDREN"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("rs2"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"getrusage"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"stime: %ld.%09ld -> %ld.%09ld\\nutime: %ld.%09ld -> %ld.%09ld\\n"'),n("span",{class:"token punctuation"},","),s(`
           rs1`),n("span",{class:"token punctuation"},"."),s("ru_stime"),n("span",{class:"token punctuation"},"."),s("tv_sec"),n("span",{class:"token punctuation"},","),s(" rs1"),n("span",{class:"token punctuation"},"."),s("ru_stime"),n("span",{class:"token punctuation"},"."),s("tv_usec"),n("span",{class:"token punctuation"},","),s(" rs2"),n("span",{class:"token punctuation"},"."),s("ru_stime"),n("span",{class:"token punctuation"},"."),s("tv_sec"),n("span",{class:"token punctuation"},","),s(`
           rs2`),n("span",{class:"token punctuation"},"."),s("ru_stime"),n("span",{class:"token punctuation"},"."),s("tv_usec"),n("span",{class:"token punctuation"},","),s(" rs1"),n("span",{class:"token punctuation"},"."),s("ru_utime"),n("span",{class:"token punctuation"},"."),s("tv_sec"),n("span",{class:"token punctuation"},","),s(" rs1"),n("span",{class:"token punctuation"},"."),s("ru_utime"),n("span",{class:"token punctuation"},"."),s("tv_usec"),n("span",{class:"token punctuation"},","),s(`
           rs2`),n("span",{class:"token punctuation"},"."),s("ru_utime"),n("span",{class:"token punctuation"},"."),s("tv_sec"),n("span",{class:"token punctuation"},","),s(" rs2"),n("span",{class:"token punctuation"},"."),s("ru_utime"),n("span",{class:"token punctuation"},"."),s("tv_usec"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"36-2"),n("p",null,[n("img",{src:K,alt:"36-2-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/resource.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/times.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/wait.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"extern"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("environ"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"pid_t"),s(" child_pid"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("command"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("command_argv"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" command_argc"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"rusage"),s(" rs1"),n("span",{class:"token punctuation"},","),s(" rs2"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" status"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s command arg..."'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"setbuf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stdout"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  command `),n("span",{class:"token operator"},"="),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  command_argc `),n("span",{class:"token operator"},"="),s(" argc "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},";"),s(`
  command_argv `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token punctuation"},"("),s("command_argc "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),s("command_argv"),n("span",{class:"token punctuation"},","),s(" argv "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token punctuation"},"("),s("command_argc "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  command_argv`),n("span",{class:"token punctuation"},"["),s("command_argc "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`

  child_pid `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("child_pid "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("child_pid "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"execve"),n("span",{class:"token punctuation"},"("),s("command"),n("span",{class:"token punctuation"},","),s(" command_argv"),n("span",{class:"token punctuation"},","),s(" environ"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"execve"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getrusage"),n("span",{class:"token punctuation"},"("),s("RUSAGE_CHILDREN"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("rs1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"getrusage"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("status"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getrusage"),n("span",{class:"token punctuation"},"("),s("RUSAGE_CHILDREN"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("rs2"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"getrusage"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"stime: %ld.%09ld -> %ld.%09ld\\nutime: %ld.%09ld -> %ld.%09ld\\n"'),n("span",{class:"token punctuation"},","),s(`
           rs1`),n("span",{class:"token punctuation"},"."),s("ru_stime"),n("span",{class:"token punctuation"},"."),s("tv_sec"),n("span",{class:"token punctuation"},","),s(" rs1"),n("span",{class:"token punctuation"},"."),s("ru_stime"),n("span",{class:"token punctuation"},"."),s("tv_usec"),n("span",{class:"token punctuation"},","),s(" rs2"),n("span",{class:"token punctuation"},"."),s("ru_stime"),n("span",{class:"token punctuation"},"."),s("tv_sec"),n("span",{class:"token punctuation"},","),s(`
           rs2`),n("span",{class:"token punctuation"},"."),s("ru_stime"),n("span",{class:"token punctuation"},"."),s("tv_usec"),n("span",{class:"token punctuation"},","),s(" rs1"),n("span",{class:"token punctuation"},"."),s("ru_utime"),n("span",{class:"token punctuation"},"."),s("tv_sec"),n("span",{class:"token punctuation"},","),s(" rs1"),n("span",{class:"token punctuation"},"."),s("ru_utime"),n("span",{class:"token punctuation"},"."),s("tv_usec"),n("span",{class:"token punctuation"},","),s(`
           rs2`),n("span",{class:"token punctuation"},"."),s("ru_utime"),n("span",{class:"token punctuation"},"."),s("tv_sec"),n("span",{class:"token punctuation"},","),s(" rs2"),n("span",{class:"token punctuation"},"."),s("ru_utime"),n("span",{class:"token punctuation"},"."),s("tv_usec"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"36-3"),n("p",null,[n("img",{src:G,alt:"36-3-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/resource.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/times.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"rlimit"),s(" r"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"tms"),s(" t1"),n("span",{class:"token punctuation"},","),s(" t2"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" ticks"),n("span",{class:"token punctuation"},";"),s(`

  ticks `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"sysconf"),n("span",{class:"token punctuation"},"("),s("_SC_CLK_TCK"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  r`),n("span",{class:"token punctuation"},"."),s("rlim_cur "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  r`),n("span",{class:"token punctuation"},"."),s("rlim_max "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"setrlimit"),n("span",{class:"token punctuation"},"("),s("RLIMIT_CPU"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("r"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"setrlimit"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"times"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("t1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"do"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"times"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("t2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("t2"),n("span",{class:"token punctuation"},"."),s("tms_stime "),n("span",{class:"token operator"},"+"),s(" t2"),n("span",{class:"token punctuation"},"."),s("tms_utime"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token punctuation"},"("),s("t1"),n("span",{class:"token punctuation"},"."),s("tms_stime "),n("span",{class:"token operator"},"+"),s(" t1"),n("span",{class:"token punctuation"},"."),s("tms_utime"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"<"),s(`
           ticks `),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u4E09\u5341\u4E03\u7AE0"),n("h3",null,"37-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<syslog.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"2048")])]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" buf"),n("span",{class:"token punctuation"},"["),s("BUF_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"openlog"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" LOG_PID"),n("span",{class:"token punctuation"},","),s(" LOG_LOCAL0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"scanf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s"'),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"scanf"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"syslog"),n("span",{class:"token punctuation"},"("),s("LOG_INFO"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"%s"'),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u4E09\u5341\u516B\u7AE0"),n("h3",null,"38-1"),n("p",null,[n("img",{src:X,alt:"38-1-1"})]),n("p",null,"\u5C1D\u8BD5\u4FEE\u6539\u540E\uFF0C\u6587\u4EF6\u7684 SUID \u4F4D\u4F1A\u7F6E\u4E3A 0"),n("h3",null,"38-2"),n("p",null,[n("img",{src:B,alt:"38-1-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"_GNU_SOURCE")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<pwd.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<shadow.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"DEFAULT_USER"),s(),n("span",{class:"token string"},'"root"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"PASSWORD_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"2048")])]),s(`

`),n("span",{class:"token keyword"},"extern"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("environ"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("command"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("command_argv"),n("span",{class:"token punctuation"},","),s(" c"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("password"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("encrypted"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" command_argc"),n("span",{class:"token punctuation"},","),s(" command_index"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"passwd"),s(),n("span",{class:"token operator"},"*"),s("user"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("curr_user"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"spwd"),s(),n("span",{class:"token operator"},"*"),s("curr_swpd"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s [-u user] command arg..."'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("curr_user "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getpwuid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getuid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"getpwuid"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("curr_swpd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getspnam"),n("span",{class:"token punctuation"},"("),s("curr_user"),n("span",{class:"token operator"},"->"),s("pw_name"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"getspnam"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  curr_user`),n("span",{class:"token operator"},"->"),s("pw_passwd "),n("span",{class:"token operator"},"="),s(" curr_swpd"),n("span",{class:"token operator"},"->"),s("sp_pwdp"),n("span",{class:"token punctuation"},";"),s(`

  password `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getpass"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Enter Current User Password:"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("encrypted "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"crypt"),n("span",{class:"token punctuation"},"("),s("password"),n("span",{class:"token punctuation"},","),s(" curr_user"),n("span",{class:"token operator"},"->"),s("pw_passwd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"crypt"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),s("password"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("password"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("encrypted"),n("span",{class:"token punctuation"},","),s(" curr_user"),n("span",{class:"token operator"},"->"),s("pw_passwd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Wrong Password!\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_FAILURE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`

  command_index `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  user `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getpwnam"),n("span",{class:"token punctuation"},"("),s("DEFAULT_USER"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("c "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getopt"),n("span",{class:"token punctuation"},"("),s("argc"),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"u:"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'u'"),n("span",{class:"token operator"},":"),s(`
      user `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getpwnam"),n("span",{class:"token punctuation"},"("),s("optarg"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      command_index `),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  command `),n("span",{class:"token operator"},"="),s(" argv"),n("span",{class:"token punctuation"},"["),s("command_index"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  command_argc `),n("span",{class:"token operator"},"="),s(" argc "),n("span",{class:"token operator"},"-"),s(" command_index "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  command_argv `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token punctuation"},"("),s("command_argc "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),s("command_argv"),n("span",{class:"token punctuation"},","),s(" argv "),n("span",{class:"token operator"},"+"),s(" command_index"),n("span",{class:"token punctuation"},","),s(`
         `),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token punctuation"},"("),s("command_argc "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  command_argv`),n("span",{class:"token punctuation"},"["),s("command_argc "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"setresuid"),n("span",{class:"token punctuation"},"("),s("user"),n("span",{class:"token operator"},"->"),s("pw_uid"),n("span",{class:"token punctuation"},","),s(" user"),n("span",{class:"token operator"},"->"),s("pw_uid"),n("span",{class:"token punctuation"},","),s(" user"),n("span",{class:"token operator"},"->"),s("pw_uid"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"setresuid"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token comment"},"// if (setresgid(user->pw_gid, user->pw_gid, user->pw_gid) == -1)"),s(`
  `),n("span",{class:"token comment"},'//   errExit("setresgid");'),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"execve"),n("span",{class:"token punctuation"},"("),s("command"),n("span",{class:"token punctuation"},","),s(" command_argv"),n("span",{class:"token punctuation"},","),s(" environ"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"execve"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u4E09\u5341\u4E5D\u7AE0"),n("h3",null,"39-1"),n("p",null,[n("img",{src:j,alt:"39-1-1"})]),n("h2",null,"\u7B2C\u56DB\u5341\u7AE0"),n("h3",null,"40-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<utmpx.h>")]),s(`

`),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"tlpi_getlogin"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"utmpx"),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},","),s(" condition"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"pid_t"),s(" sid"),n("span",{class:"token punctuation"},";"),s(`

  condition`),n("span",{class:"token punctuation"},"."),s("ut_type "),n("span",{class:"token operator"},"="),s(" LOGIN_PROCESS"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),s("condition"),n("span",{class:"token punctuation"},"."),s("ut_line"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"ttyname"),n("span",{class:"token punctuation"},"("),s("STDOUT_FILENO"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("sid "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"getsid"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"setutxent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getutxline"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("condition"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" curr"),n("span",{class:"token operator"},"->"),s("ut_user"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("login_user"),n("span",{class:"token punctuation"},";"),s(`
  login_user `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"tlpi_getlogin"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"login: %s\\n"'),n("span",{class:"token punctuation"},","),s(" login_user"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"40-2"),n("p",null,[n("img",{src:V,alt:"40-2-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"_GNU_SOURCE")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"tlpi_hdr.h"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<lastlog.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<paths.h>"),s(),n("span",{class:"token comment"},"/* Definitions of _PATH_UTMP and _PATH_WTMP */")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<pwd.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<utmpx.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"utmpx"),s(" ut"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"lastlog"),s(" llog"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"passwd"),s(),n("span",{class:"token operator"},"*"),s("pw"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("devName"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(" s"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"--help"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s username [sleep-time]\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},"/* Get passwd */"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("pw "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getpwnam"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"getpwnam"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},"/* Initialize login record for utmp and wtmp files */"),s(`

  `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("ut"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"utmpx"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ut`),n("span",{class:"token punctuation"},"."),s("ut_type "),n("span",{class:"token operator"},"="),s(" USER_PROCESS"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* This is a user login */"),s(`
  `),n("span",{class:"token function"},"strncpy"),n("span",{class:"token punctuation"},"("),s("ut"),n("span",{class:"token punctuation"},"."),s("ut_user"),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("ut"),n("span",{class:"token punctuation"},"."),s("ut_user"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"time_t"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("ut"),n("span",{class:"token punctuation"},"."),s("ut_tv"),n("span",{class:"token punctuation"},"."),s("tv_sec"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"time"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Stamp with current time */"),s(`
  ut`),n("span",{class:"token punctuation"},"."),s("ut_pid "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},`/* Set ut_line and ut_id based on the terminal associated with
     'stdin'. This code assumes terminals named "/dev/[pt]t[sy]*".
     The "/dev/" dirname is 5 characters; the "[pt]t[sy]" filename
     prefix is 3 characters (making 8 characters in all). */`),s(`

  devName `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"ttyname"),n("span",{class:"token punctuation"},"("),s("STDIN_FILENO"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("devName "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"ttyname"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("devName"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"<="),s(),n("span",{class:"token number"},"8"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token comment"},"/* Should never happen */"),s(`
    `),n("span",{class:"token function"},"fatal"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Terminal name is too short: %s"'),n("span",{class:"token punctuation"},","),s(" devName"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"strncpy"),n("span",{class:"token punctuation"},"("),s("ut"),n("span",{class:"token punctuation"},"."),s("ut_line"),n("span",{class:"token punctuation"},","),s(" devName "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("ut"),n("span",{class:"token punctuation"},"."),s("ut_line"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"strncpy"),n("span",{class:"token punctuation"},"("),s("ut"),n("span",{class:"token punctuation"},"."),s("ut_id"),n("span",{class:"token punctuation"},","),s(" devName "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"8"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("ut"),n("span",{class:"token punctuation"},"."),s("ut_id"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},"/* Set lastlog */"),s(`
  `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("llog"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("llog"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"strncpy"),n("span",{class:"token punctuation"},"("),s("llog"),n("span",{class:"token punctuation"},"."),s("ll_line"),n("span",{class:"token punctuation"},","),s(" devName "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("devName "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  llog`),n("span",{class:"token punctuation"},"."),s("ll_time "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("_PATH_LASTLOG"),n("span",{class:"token punctuation"},","),s(" O_RDWR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"lseek"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" pw"),n("span",{class:"token operator"},"->"),s("pw_uid "),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"lastlog"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"SEEK_CUR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"lseek"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("llog"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"lastlog"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"write"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Creating login entries in utmp and wtmp\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"        using pid %ld, line %.*s, id %.*s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),s("ut"),n("span",{class:"token punctuation"},"."),s("ut_pid"),n("span",{class:"token punctuation"},","),s(`
         `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),n("span",{class:"token punctuation"},")"),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("ut"),n("span",{class:"token punctuation"},"."),s("ut_line"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" ut"),n("span",{class:"token punctuation"},"."),s("ut_line"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),n("span",{class:"token punctuation"},")"),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("ut"),n("span",{class:"token punctuation"},"."),s("ut_id"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" ut"),n("span",{class:"token punctuation"},"."),s("ut_id"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"setutxent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s("                 "),n("span",{class:"token comment"},"/* Rewind to start of utmp file */"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"pututxline"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("ut"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token comment"},"/* Write login record to utmp */"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"pututxline"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"updwtmpx"),n("span",{class:"token punctuation"},"("),s("_PATH_WTMP"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("ut"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Append login record to wtmp */"),s(`

  `),n("span",{class:"token comment"},"/* Sleep a while, so we can examine utmp and wtmp files */"),s(`

  `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"?"),s(),n("span",{class:"token function"},"getInt"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" GN_NONNEG"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"sleep-time"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},":"),s(),n("span",{class:"token number"},"15"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},`/* Now do a "logout"; use values from previously initialized 'ut',
     except for changes below */`),s(`

  ut`),n("span",{class:"token punctuation"},"."),s("ut_type "),n("span",{class:"token operator"},"="),s(" DEAD_PROCESS"),n("span",{class:"token punctuation"},";"),s("        "),n("span",{class:"token comment"},"/* Required for logout record */"),s(`
  `),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"time_t"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("ut"),n("span",{class:"token punctuation"},"."),s("ut_tv"),n("span",{class:"token punctuation"},"."),s("tv_sec"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Stamp with logout time */"),s(`
  `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("ut"),n("span",{class:"token punctuation"},"."),s("ut_user"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("ut"),n("span",{class:"token punctuation"},"."),s("ut_user"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token comment"},"/* Logout record has null username */"),s(`

  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Creating logout entries in utmp and wtmp\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"setutxent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s("                 "),n("span",{class:"token comment"},"/* Rewind to start of utmp file */"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"pututxline"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("ut"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token comment"},"/* Overwrite previous utmp record */"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"pututxline"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"updwtmpx"),n("span",{class:"token punctuation"},"("),s("_PATH_WTMP"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("ut"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Append logout record to wtmp */"),s(`

  `),n("span",{class:"token function"},"endutxent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"40-3"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},`
`)]),n("h3",null,"40-4"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<utmpx.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"2048")])]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"utmpx"),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" buf"),n("span",{class:"token punctuation"},"["),s("BUF_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"setutxent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getutxent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("ut_type "),n("span",{class:"token operator"},"=="),s(" USER_PROCESS"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"strftime"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"%F %T"'),n("span",{class:"token punctuation"},","),s(`
               `),n("span",{class:"token function"},"localtime"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"time_t"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("curr"),n("span",{class:"token operator"},"->"),s("ut_tv"),n("span",{class:"token punctuation"},"."),s("tv_sec"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s %s\\t%s(%s)\\n"'),n("span",{class:"token punctuation"},","),s(" curr"),n("span",{class:"token operator"},"->"),s("ut_user"),n("span",{class:"token punctuation"},","),s(" curr"),n("span",{class:"token operator"},"->"),s("ut_line"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(`
             curr`),n("span",{class:"token operator"},"->"),s("ut_host"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"endutxent"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u56DB\u5341\u4E00\u7AE0"),n("h3",null,"41-1"),n("p",null,[n("img",{src:q,alt:"41-1-1"})]),n("p",null,[s("\u52A0\u5165"),n("code",null,"static"),s("\u7F16\u8BD1\u9009\u9879\u540E\uFF0C\u6587\u4EF6\u53D8\u5927\uFF0C\u5E76\u4E14\u4E0D\u518D\u5F15\u7528\u5171\u4EAB\u5E93")]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<stdio.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token comment"},"// \u4F7F\u7528glic\u4E2D\u7684\u5E93\u51FD\u6570"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"hello\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u56DB\u5341\u4E8C\u7AE0"),n("h3",null,"42-1"),n("p",null,[n("img",{src:Z,alt:"42-1-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<dlfcn.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token comment"},"// libmysub require libmyadd"),s(`
  `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("handle_libmyadd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("handle_libmysub"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("err"),n("span",{class:"token punctuation"},";"),s(`

  handle_libmyadd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"dlopen"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"libmyadd.so"'),n("span",{class:"token punctuation"},","),s(" RTLD_NOW "),n("span",{class:"token operator"},"|"),s(" RTLD_GLOBAL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("handle_libmyadd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),s(),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token punctuation"},"("),s("err "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"dlerror"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"%s"'),n("span",{class:"token punctuation"},","),s(" err"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_FAILURE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  handle_libmysub `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"dlopen"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"libmysub.so"'),n("span",{class:"token punctuation"},","),s(" RTLD_NOW "),n("span",{class:"token operator"},"|"),s(" RTLD_GLOBAL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("handle_libmysub "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),s(),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token punctuation"},"("),s("err "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"dlerror"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"%s"'),n("span",{class:"token punctuation"},","),s(" err"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_FAILURE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`

  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"handle_libmyadd: %p\\nhandle_libmysub: %p\\n"'),n("span",{class:"token punctuation"},","),s(" handle_libmyadd"),n("span",{class:"token punctuation"},","),s(`
         handle_libmysub`),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"dlclose"),n("span",{class:"token punctuation"},"("),s("handle_libmyadd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  handle_libmyadd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"dlopen"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"libmyadd.so"'),n("span",{class:"token punctuation"},","),s(" RTLD_NOW "),n("span",{class:"token operator"},"|"),s(" RTLD_NOLOAD"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"handle_libmyadd: %p\\n"'),n("span",{class:"token punctuation"},","),s(" handle_libmyadd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"42-2"),n("p",null,[n("img",{src:H,alt:"42-2-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"_GNU_SOURCE")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"tlpi_hdr.h"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<dlfcn.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("libHandle"),n("span",{class:"token punctuation"},";"),s("     "),n("span",{class:"token comment"},"/* Handle for shared library */"),s(`
  `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("funcp"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Pointer to function with no arguments */"),s(`
  `),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("err"),n("span",{class:"token punctuation"},";"),s(`
  Dl_info info`),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"3"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"--help"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s lib-path func-name\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},"/* Load the shared library and get a handle for later use */"),s(`

  libHandle `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"dlopen"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" RTLD_LAZY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("libHandle "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"fatal"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"dlopen: %s"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"dlerror"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},"/* Search library for symbol named in argv[2] */"),s(`

  `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"dlerror"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Clear dlerror() */"),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"pragma"),s(),n("span",{class:"token expression"},"GCC diagnostic push")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"pragma"),s(),n("span",{class:"token expression"},"GCC diagnostic ignored "),n("span",{class:"token string"},'"-Wpedantic"')]),s(`
  funcp `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"dlsym"),n("span",{class:"token punctuation"},"("),s("libHandle"),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"pragma"),s(),n("span",{class:"token expression"},"GCC diagnostic pop")]),s(`

  `),n("span",{class:"token comment"},`/* In the book, instead of the preceding line, the code uses a
     rather clumsy looking cast of the form:

         *(void **) (&funcp) = dlsym(libHandle, argv[2]);

     This was done because the ISO C standard does not require compilers
     to allow casting of pointers to functions back and forth to 'void *'.
     (See TLPI pages 863-864.) SUSv3 TC1 and SUSv4 accepted the ISO C
     requirement and proposed the clumsy cast as the workaround. However,
     the 2013 Technical Corrigendum to SUSv4 requires implementations
     to support casts of the more natural form (now) used in the code
     above. However, various current compilers (e.g., gcc with the
     '-pedantic' flag) may still complain about such casts. Therefore,
     we use a gcc pragma to disable the warning.

     Note that this pragma is available only since gcc 4.6, released in
     2010. If you are using an older compiler, the pragma will generate
     an error. In that case, simply edit this program to remove the
     lines above that begin with '#pragma".

     See also the erratum note for page 864 at
     http://www.man7.org/tlpi/errata/. */`),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"dladdr"),n("span",{class:"token punctuation"},"("),s("funcp"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("info"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"dladdr"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"dli_fname: %s\\ndli_fbase: %p\\ndli_sname: %s\\ndli_saddr: %p\\n"'),n("span",{class:"token punctuation"},","),s(`
         info`),n("span",{class:"token punctuation"},"."),s("dli_fname"),n("span",{class:"token punctuation"},","),s(" info"),n("span",{class:"token punctuation"},"."),s("dli_fbase"),n("span",{class:"token punctuation"},","),s(" info"),n("span",{class:"token punctuation"},"."),s("dli_sname"),n("span",{class:"token punctuation"},","),s(" info"),n("span",{class:"token punctuation"},"."),s("dli_saddr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  err `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"dlerror"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("err "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"fatal"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"dlsym: %s"'),n("span",{class:"token punctuation"},","),s(" err"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},`/* Try calling the address returned by dlsym() as a function
     that takes no arguments */`),s(`

  `),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("funcp"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"dlclose"),n("span",{class:"token punctuation"},"("),s("libHandle"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Close the library */"),s(`

  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u56DB\u5341\u4E09\u7AE0"),n("p",null,"// \u5148\u8DF3\u8FC7"),n("h2",null,"\u7B2C\u56DB\u5341\u56DB\u7AE0"),n("h3",null,"44-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<ctype.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1024")])]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fds1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" fds2"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" buf"),n("span",{class:"token punctuation"},"["),s("BUF_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"setbuf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stdout"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"pipe"),n("span",{class:"token punctuation"},"("),s("fds1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"pipe"),n("span",{class:"token punctuation"},"("),s("fds2"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"pipe"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fds1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fds2"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"close"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("fds1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("buf"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(" s"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        buf`),n("span",{class:"token punctuation"},"["),s("i"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"toupper"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},"["),s("i"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("fds2"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("buf"),n("span",{class:"token punctuation"},","),s(" s"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"write"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fds1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fds2"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"close"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fds1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fds2"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"close"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("STDIN_FILENO"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("buf"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("fds1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" s"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"write"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("fds2"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"read"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s"'),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fds1"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fds2"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"close"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"44-2"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<string.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/wait.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1024")])]),s(`

`),n("span",{class:"token keyword"},"enum"),s(),n("span",{class:"token class-name"},"TLPI_POPEN_MODE"),s(),n("span",{class:"token punctuation"},"{"),s(" TLPI_POPEN_MODE_R"),n("span",{class:"token punctuation"},","),s(" TLPI_POPEN_MODE_W "),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

FILE `),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"tlpi_popen"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("command"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("mode"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fds"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"static"),s(" FILE "),n("span",{class:"token operator"},"*"),s("f"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"pid_t"),s(" child_pid"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"enum"),s(),n("span",{class:"token class-name"},"TLPI_POPEN_MODE"),s(" m"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"pipe"),n("span",{class:"token punctuation"},"("),s("fds"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"pipe"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strchr"),n("span",{class:"token punctuation"},"("),s("mode"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token char"},"'r'"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    m `),n("span",{class:"token operator"},"="),s(" TLPI_POPEN_MODE_R"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strchr"),n("span",{class:"token punctuation"},"("),s("mode"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token char"},"'w'"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    m `),n("span",{class:"token operator"},"="),s(" TLPI_POPEN_MODE_W"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Invalid mode\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_FAILURE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("child_pid "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("m"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"case"),s(" TLPI_POPEN_MODE_R"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fds"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"close"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"dup2"),n("span",{class:"token punctuation"},"("),s("fds"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" STDOUT_FILENO"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"dup2"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(" TLPI_POPEN_MODE_W"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fds"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"close"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"dup2"),n("span",{class:"token punctuation"},"("),s("fds"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" STDIN_FILENO"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"dup2"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Unexpected mode\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_FAILURE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token function"},"system"),n("span",{class:"token punctuation"},"("),s("command"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("m"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"case"),s(" TLPI_POPEN_MODE_R"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fds"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"close"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("f "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fdopen"),n("span",{class:"token punctuation"},"("),s("fds"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"r"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fdopen"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(" TLPI_POPEN_MODE_W"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fds"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"close"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("f "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fdopen"),n("span",{class:"token punctuation"},"("),s("fds"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"w"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fdopen"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Unexpected mode\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_FAILURE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" f"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"tlpi_pclose"),n("span",{class:"token punctuation"},"("),s("FILE "),n("span",{class:"token operator"},"*"),s("fp"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"static"),s(" FILE "),n("span",{class:"token operator"},"*"),s("f"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("f "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),s(),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token function"},"fclose"),n("span",{class:"token punctuation"},"("),s("f"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fclose"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  f `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  FILE `),n("span",{class:"token operator"},"*"),s("p"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" buf"),n("span",{class:"token punctuation"},"["),s("BUF_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"setbuf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stdout"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  p `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"tlpi_popen"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sleep 1 && ls"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"r"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fread"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},","),s(" p"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s"'),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"tlpi_pclose"),n("span",{class:"token punctuation"},"("),s("p"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"44-3"),n("p",null,[n("img",{src:W,alt:"44-3-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"fifo_seqnum.h"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BACKUP_FILE_PATH"),s(),n("span",{class:"token string"},'"/tmp/backup_file"')]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" serverFd"),n("span",{class:"token punctuation"},","),s(" dummyFd"),n("span",{class:"token punctuation"},","),s(" clientFd"),n("span",{class:"token punctuation"},","),s(" backupFd"),n("span",{class:"token punctuation"},","),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" clientFifo"),n("span",{class:"token punctuation"},"["),s("CLIENT_FIFO_NAME_LEN"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"request"),s(" req"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"response"),s(" resp"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" seqNum "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},'/* This is our "service" */'),s(`

  `),n("span",{class:"token comment"},"/* Create well-known FIFO, and open it for reading */"),s(`

  `),n("span",{class:"token function"},"umask"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* So we get the permissions we want */"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("backupFd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("BACKUP_FILE_PATH"),n("span",{class:"token punctuation"},","),s(" O_RDWR "),n("span",{class:"token operator"},"|"),s(" O_SYNC "),n("span",{class:"token operator"},"|"),s(" O_CREAT"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0755"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(`
      `),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open %s"'),n("span",{class:"token punctuation"},","),s(" BACKUP_FILE_PATH"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("backupFd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("seqNum"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("seqNum"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"read %s"'),n("span",{class:"token punctuation"},","),s(" BACKUP_FILE_PATH"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"mkfifo"),n("span",{class:"token punctuation"},"("),s("SERVER_FIFO"),n("span",{class:"token punctuation"},","),s(" S_IRUSR "),n("span",{class:"token operator"},"|"),s(" S_IWUSR "),n("span",{class:"token operator"},"|"),s(" S_IWGRP"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"&&"),s(" errno "),n("span",{class:"token operator"},"!="),s(" EEXIST"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mkfifo %s"'),n("span",{class:"token punctuation"},","),s(" SERVER_FIFO"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  serverFd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("SERVER_FIFO"),n("span",{class:"token punctuation"},","),s(" O_RDONLY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("serverFd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open %s"'),n("span",{class:"token punctuation"},","),s(" SERVER_FIFO"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},"/* Open an extra write descriptor, so that we never see EOF */"),s(`

  dummyFd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("SERVER_FIFO"),n("span",{class:"token punctuation"},","),s(" O_WRONLY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("dummyFd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open %s"'),n("span",{class:"token punctuation"},","),s(" SERVER_FIFO"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},"/* Let's find out about broken client pipe via failed write() */"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"signal"),n("span",{class:"token punctuation"},"("),s("SIGPIPE"),n("span",{class:"token punctuation"},","),s(" SIG_IGN"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" SIG_ERR"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"signal"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token comment"},"/* Read requests and send responses */"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("serverFd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("req"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"request"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(`
        `),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"request"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Error reading request; discarding\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Either partial read or error */"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token comment"},"/* Open client FIFO (previously created by client) */"),s(`

    `),n("span",{class:"token function"},"snprintf"),n("span",{class:"token punctuation"},"("),s("clientFifo"),n("span",{class:"token punctuation"},","),s(" CLIENT_FIFO_NAME_LEN"),n("span",{class:"token punctuation"},","),s(" CLIENT_FIFO_TEMPLATE"),n("span",{class:"token punctuation"},","),s(`
             `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),s("req"),n("span",{class:"token punctuation"},"."),s("pid"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    clientFd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("clientFifo"),n("span",{class:"token punctuation"},","),s(" O_WRONLY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("clientFd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token comment"},"/* Open failed, give up on client */"),s(`
      `),n("span",{class:"token function"},"errMsg"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open %s"'),n("span",{class:"token punctuation"},","),s(" clientFifo"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token comment"},"/* Send response and close FIFO */"),s(`

    resp`),n("span",{class:"token punctuation"},"."),s("seqNum "),n("span",{class:"token operator"},"="),s(" seqNum"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("clientFd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("resp"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"response"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(`
        `),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"response"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Error writing to FIFO %s\\n"'),n("span",{class:"token punctuation"},","),s(" clientFifo"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("clientFd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errMsg"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"close"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    seqNum `),n("span",{class:"token operator"},"+="),s(" req"),n("span",{class:"token punctuation"},"."),s("seqLen"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Update our sequence number */"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"lseek"),n("span",{class:"token punctuation"},"("),s("backupFd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"SEEK_SET"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"||"),s(`
        `),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("backupFd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("seqNum"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("seqNum"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"write %s"'),n("span",{class:"token punctuation"},","),s(" BACKUP_FILE_PATH"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"44-4"),n("p",null,[n("img",{src:Y,alt:"44-4-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"fifo_seqnum.h"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"sig_handler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"unlink"),n("span",{class:"token punctuation"},"("),s("SERVER_FIFO"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"unlink"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"signal"),n("span",{class:"token punctuation"},"("),s("sig"),n("span",{class:"token punctuation"},","),s(" SIG_DFL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" SIG_ERR"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"signal"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"raise"),n("span",{class:"token punctuation"},"("),s("sig"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" serverFd"),n("span",{class:"token punctuation"},","),s(" dummyFd"),n("span",{class:"token punctuation"},","),s(" clientFd"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" clientFifo"),n("span",{class:"token punctuation"},"["),s("CLIENT_FIFO_NAME_LEN"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"request"),s(" req"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"response"),s(" resp"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" seqNum "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},'/* This is our "service" */'),s(`

  `),n("span",{class:"token comment"},"/* Create well-known FIFO, and open it for reading */"),s(`

  `),n("span",{class:"token function"},"umask"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* So we get the permissions we want */"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"mkfifo"),n("span",{class:"token punctuation"},"("),s("SERVER_FIFO"),n("span",{class:"token punctuation"},","),s(" S_IRUSR "),n("span",{class:"token operator"},"|"),s(" S_IWUSR "),n("span",{class:"token operator"},"|"),s(" S_IWGRP"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"&&"),s(" errno "),n("span",{class:"token operator"},"!="),s(" EEXIST"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mkfifo %s"'),n("span",{class:"token punctuation"},","),s(" SERVER_FIFO"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  serverFd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("SERVER_FIFO"),n("span",{class:"token punctuation"},","),s(" O_RDONLY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("serverFd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open %s"'),n("span",{class:"token punctuation"},","),s(" SERVER_FIFO"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},"/* Open an extra write descriptor, so that we never see EOF */"),s(`

  dummyFd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("SERVER_FIFO"),n("span",{class:"token punctuation"},","),s(" O_WRONLY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("dummyFd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open %s"'),n("span",{class:"token punctuation"},","),s(" SERVER_FIFO"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},"/* Let's find out about broken client pipe via failed write() */"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"signal"),n("span",{class:"token punctuation"},"("),s("SIGPIPE"),n("span",{class:"token punctuation"},","),s(" SIG_IGN"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" SIG_ERR"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"signal"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"signal"),n("span",{class:"token punctuation"},"("),s("SIGINT"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sig_handler"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" SIG_ERR"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"signal"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"signal"),n("span",{class:"token punctuation"},"("),s("SIGTERM"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sig_handler"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" SIG_ERR"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"signal"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token comment"},"/* Read requests and send responses */"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("serverFd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("req"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"request"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(`
        `),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"request"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Error reading request; discarding\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Either partial read or error */"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token comment"},"/* Open client FIFO (previously created by client) */"),s(`

    `),n("span",{class:"token function"},"snprintf"),n("span",{class:"token punctuation"},"("),s("clientFifo"),n("span",{class:"token punctuation"},","),s(" CLIENT_FIFO_NAME_LEN"),n("span",{class:"token punctuation"},","),s(" CLIENT_FIFO_TEMPLATE"),n("span",{class:"token punctuation"},","),s(`
             `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),s("req"),n("span",{class:"token punctuation"},"."),s("pid"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    clientFd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("clientFifo"),n("span",{class:"token punctuation"},","),s(" O_WRONLY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("clientFd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token comment"},"/* Open failed, give up on client */"),s(`
      `),n("span",{class:"token function"},"errMsg"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open %s"'),n("span",{class:"token punctuation"},","),s(" clientFifo"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token comment"},"/* Send response and close FIFO */"),s(`

    resp`),n("span",{class:"token punctuation"},"."),s("seqNum "),n("span",{class:"token operator"},"="),s(" seqNum"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("clientFd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("resp"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"response"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(`
        `),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"response"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Error writing to FIFO %s\\n"'),n("span",{class:"token punctuation"},","),s(" clientFifo"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("clientFd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errMsg"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"close"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    seqNum `),n("span",{class:"token operator"},"+="),s(" req"),n("span",{class:"token punctuation"},"."),s("seqLen"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Update our sequence number */"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"44-5"),n("p",null,[s("\u5728\u670D\u52A1\u7AEF\u8FDB\u7A0B\u5173\u95ED"),n("code",null,"serverFd"),s("\u548C\u91CD\u65B0\u6253"),n("code",null,"serverFd"),s("\u671F\u95F4\uFF0C\u53EF\u80FD\u5B58\u5728\u5BA2\u6237\u7AEF\u5199\u6253\u5F00 FIFO \u62A5\u9519")]),n("h3",null,"44-6"),n("p",null,"\u4F7F\u7528\u975E\u963B\u585E IO \u6253\u5F00\u5BA2\u6237\u7AEF\u7684 FIFO"),n("h2",null,"\u7B2C\u56DB\u5341\u4E94\u7AE0"),n("h3",null,"45-1"),n("p",null,[s("\u5F53"),n("code",null,"ftok"),s("\u4F20\u5165\u540C\u4E00\u4E2A\u6587\u4EF6\u540D\uFF0Cproj \u65F6\uFF0C\u8FD4\u56DE\u76F8\u540C\u7684 keyid")]),n("p",null,[n("img",{src:$,alt:"45-1-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/ipc.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("filename"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"key_t"),s(" ipc_id"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" proj"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Usage %s <filename> <proj>\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  filename `),n("span",{class:"token operator"},"="),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  proj `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getInt"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"proj"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  ipc_id `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"ftok"),n("span",{class:"token punctuation"},"("),s("filename"),n("span",{class:"token punctuation"},","),s(" proj"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"ipc_id: %d\\n"'),n("span",{class:"token punctuation"},","),s(" ipc_id"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"45-2"),n("p",null,[n("img",{src:Q,alt:"45-2-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/stat.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token class-name"},"key_t"),s(),n("span",{class:"token function"},"tlpi_ftok"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("pathname"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" proj"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"stat"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"stat"),n("span",{class:"token punctuation"},"("),s("pathname"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("s"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"stat"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("proj "),n("span",{class:"token operator"},"&"),s(),n("span",{class:"token number"},"0xff"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"<<"),s(),n("span",{class:"token number"},"24"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},"."),s("st_dev "),n("span",{class:"token operator"},"&"),s(),n("span",{class:"token number"},"0xff"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"<<"),s(),n("span",{class:"token number"},"16"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(`
         `),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},"."),s("st_ino "),n("span",{class:"token operator"},"&"),s(),n("span",{class:"token number"},"0xffff"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"key_t"),s(" ipc_key"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Usage %s filename proj"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ipc_key `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"tlpi_ftok"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"getLong"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"proj"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"ipc_key: %d\\n"'),n("span",{class:"token punctuation"},","),s(" ipc_key"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u56DB\u5341\u516D\u7AE0"),n("h3",null,"46-1"),n("p",null,[n("img",{src:J,alt:"46-1-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/msg.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/stat.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/types.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"MSG_MAX_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1024")])]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"key_t"),s(" ipc_key"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" msg_key"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("msg_buf"),n("span",{class:"token punctuation"},";"),s(`
  ipc_key `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"ftok"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  msg_buf `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("MSG_MAX_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("msg_key "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"msgget"),n("span",{class:"token punctuation"},"("),s("ipc_key"),n("span",{class:"token punctuation"},","),s(" IPC_CREAT "),n("span",{class:"token operator"},"|"),s(" IPC_EXCL "),n("span",{class:"token operator"},"|"),s(" S_IRUSR "),n("span",{class:"token operator"},"|"),s(" S_IWUSR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(`
      `),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"msgget"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"msg_key:%d\\n"'),n("span",{class:"token punctuation"},","),s(" msg_key"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"msgrcv"),n("span",{class:"token punctuation"},"("),s("msg_key"),n("span",{class:"token punctuation"},","),s(" msg_buf"),n("span",{class:"token punctuation"},","),s(" MSG_MAX_SIZE"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("msg_buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"child process exit\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"_exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"10"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"snprintf"),n("span",{class:"token punctuation"},"("),s("msg_buf"),n("span",{class:"token punctuation"},","),s(" MSG_MAX_SIZE"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"msg %d\\n"'),n("span",{class:"token punctuation"},","),s(" i"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"msgsnd"),n("span",{class:"token punctuation"},"("),s("msg_key"),n("span",{class:"token punctuation"},","),s(" msg_buf"),n("span",{class:"token punctuation"},","),s(" MSG_MAX_SIZE"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"msgsnd"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_FAILURE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"46-2"),n("p",null,[n("img",{src:nn,alt:"46-2-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token comment"},"// server"),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"46-2-comm.h"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/ipc.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/msg.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/stat.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"key_t"),s(" ipc_key"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" msg_key"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"tlpi_msg"),s(),n("span",{class:"token operator"},"*"),s("msg"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("ipc_key "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"ftok"),n("span",{class:"token punctuation"},"("),s("IPC_KEY_FILE"),n("span",{class:"token punctuation"},","),s(" IPC_KEY_PROJ"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"ftok"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("msg_key "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"msgget"),n("span",{class:"token punctuation"},"("),s("ipc_key"),n("span",{class:"token punctuation"},","),s(" IPC_CREAT "),n("span",{class:"token operator"},"|"),s(" S_IRUSR "),n("span",{class:"token operator"},"|"),s(" S_IWUSR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"msgget"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("msg "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("MSG_MAX_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"malloc"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"msgrcv"),n("span",{class:"token punctuation"},"("),s("msg_key"),n("span",{class:"token punctuation"},","),s(" msg"),n("span",{class:"token punctuation"},","),s(" MSG_MAX_SIZE"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"msgrcv"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"send to %ld, receive client %ld\\n"'),n("span",{class:"token punctuation"},","),s(" msg"),n("span",{class:"token operator"},"->"),s("type_id"),n("span",{class:"token punctuation"},","),s(`
           `),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("msg"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"msgsnd"),n("span",{class:"token punctuation"},"("),s("msg_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("msg "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" MSG_MAX_SIZE "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(`
        `),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"msgsnd"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token comment"},"// server"),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"46-2-comm.h"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/ipc.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/msg.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/stat.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"key_t"),s(" ipc_key"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" msg_key"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"tlpi_msg"),s(),n("span",{class:"token operator"},"*"),s("msg"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("ipc_key "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"ftok"),n("span",{class:"token punctuation"},"("),s("IPC_KEY_FILE"),n("span",{class:"token punctuation"},","),s(" IPC_KEY_PROJ"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"ftok"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("msg_key "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"msgget"),n("span",{class:"token punctuation"},"("),s("ipc_key"),n("span",{class:"token punctuation"},","),s(" IPC_CREAT "),n("span",{class:"token operator"},"|"),s(" S_IRUSR "),n("span",{class:"token operator"},"|"),s(" S_IWUSR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"msgget"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("msg "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("MSG_MAX_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"malloc"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"msgrcv"),n("span",{class:"token punctuation"},"("),s("msg_key"),n("span",{class:"token punctuation"},","),s(" msg"),n("span",{class:"token punctuation"},","),s(" MSG_MAX_SIZE"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"msgrcv"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"send to %ld, receive client %ld\\n"'),n("span",{class:"token punctuation"},","),s(" msg"),n("span",{class:"token operator"},"->"),s("type_id"),n("span",{class:"token punctuation"},","),s(`
           `),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("msg"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"msgsnd"),n("span",{class:"token punctuation"},"("),s("msg_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("msg "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" MSG_MAX_SIZE "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(`
        `),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"msgsnd"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"46-3"),n("p",null,"\u6D88\u606F\u7C7B\u578B\u8FD8\u5305\u542B\u6709\u5176\u4ED6\u542B\u4E49\uFF0C\u4F5C\u4E3A\u4F18\u5148\u961F\u5217\u65F6\uFF0C\u51B3\u5B9A\u4E86\u987A\u5E8F"),n("h3",null,"46-4"),n("p",null,"//todo"),n("h3",null,"46-5"),n("p",null,"//todo"),n("h3",null,"46-6"),n("p",null,"//todo"),n("h2",null,"\u7B2C\u56DB\u5341\u4E03\u7AE0"),n("h3",null,"47-1"),n("p",null,[n("img",{src:sn,alt:"47-1-1"})]),n("h3",null,"47-2"),n("p",null,[n("img",{src:an,alt:"47-2-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/ipc.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/sem.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/stat.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"key_t"),s(" ipc_key"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" sem_key"),n("span",{class:"token punctuation"},","),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sembuf"),s(" sops"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"setbuf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stdout"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("ipc_key "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"ftok"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"ftok"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("sem_key "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"semget"),n("span",{class:"token punctuation"},"("),s("ipc_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(" IPC_CREAT "),n("span",{class:"token operator"},"|"),s(" S_IRUSR "),n("span",{class:"token operator"},"|"),s(" S_IWUSR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"semget"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"semctl"),n("span",{class:"token punctuation"},"("),s("sem_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" SETVAL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"semctl"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld] Child started - doing some work\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
           `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld]Child about to notify parent\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
           `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    sops`),n("span",{class:"token punctuation"},"."),s("sem_flg "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
    sops`),n("span",{class:"token punctuation"},"."),s("sem_num "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
    sops`),n("span",{class:"token punctuation"},"."),s("sem_op "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"semop"),n("span",{class:"token punctuation"},"("),s("sem_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sops"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"semop"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"_exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld] Parent about to wait for notify\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
           `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    sops`),n("span",{class:"token punctuation"},"."),s("sem_flg "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
    sops`),n("span",{class:"token punctuation"},"."),s("sem_num "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
    sops`),n("span",{class:"token punctuation"},"."),s("sem_op "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"semop"),n("span",{class:"token punctuation"},"("),s("sem_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sops"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"semop"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld] Parent got notify\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"47-3"),n("p",null,[n("img",{src:tn,alt:"47-3-1"})]),n("p",null,[n("code",null,"SEM_UNDO"),s("\u5728\u8FDB\u7A0B\u9000\u51FA\u65F6\uFF0C\u4F1A\u6267\u884C\u4E00\u6B21\u52A0\u4E0A"),n("code",null,"-sem_op"),s("\u7684\u64CD\u4F5C")]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/ipc.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/sem.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" sem_key"),n("span",{class:"token punctuation"},","),s(" sem_num"),n("span",{class:"token punctuation"},","),s(" op"),n("span",{class:"token punctuation"},","),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sembuf"),s(" sops"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Usage: %s sem-key sem-num op\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  sem_key `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getInt"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"sem-key"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  sem_num `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getInt"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"sem-num"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  op `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getInt"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"op"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  sops`),n("span",{class:"token punctuation"},"."),s("sem_flg "),n("span",{class:"token operator"},"="),s(" SEM_UNDO"),n("span",{class:"token punctuation"},";"),s(`
  sops`),n("span",{class:"token punctuation"},"."),s("sem_num "),n("span",{class:"token operator"},"="),s(" sem_num"),n("span",{class:"token punctuation"},";"),s(`
  sops`),n("span",{class:"token punctuation"},"."),s("sem_op "),n("span",{class:"token operator"},"="),s(" op"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"semop"),n("span",{class:"token punctuation"},"("),s("sem_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sops"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"semop"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"60"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"47-4"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/ipc.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/sem.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

Boolean bsUseSemUndo `),n("span",{class:"token operator"},"="),s(" FALSE"),n("span",{class:"token punctuation"},";"),s(`
Boolean bsRetryOnEintr `),n("span",{class:"token operator"},"="),s(" TRUE"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"reserveSemNB"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" semId"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" semNum"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sembuf"),s(" sops"),n("span",{class:"token punctuation"},";"),s(`
  sops`),n("span",{class:"token punctuation"},"."),s("sem_num "),n("span",{class:"token operator"},"="),s(" semNum"),n("span",{class:"token punctuation"},";"),s(`
  sops`),n("span",{class:"token punctuation"},"."),s("sem_op "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  sops`),n("span",{class:"token punctuation"},"."),s("sem_flg "),n("span",{class:"token operator"},"="),s(" IPC_NOWAIT "),n("span",{class:"token operator"},"|"),s(),n("span",{class:"token punctuation"},"("),s("bsUseSemUndo "),n("span",{class:"token operator"},"?"),s(" SEM_UNDO "),n("span",{class:"token operator"},":"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"semop"),n("span",{class:"token punctuation"},"("),s("semId"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sops"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("errno "),n("span",{class:"token operator"},"!="),s(" EAGAIN "),n("span",{class:"token operator"},"||"),s(" errno "),n("span",{class:"token operator"},"!="),s(" EINTR "),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token operator"},"!"),s("bsRetryOnEintr"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"47-5"),n("p",null,[n("img",{src:on,alt:"47-5-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/ipc.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/sem.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/stat.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"enum"),s(),n("span",{class:"token class-name"},"EventFlag"),s(),n("span",{class:"token punctuation"},"{"),s(" CLEAR"),n("span",{class:"token punctuation"},","),s(" SET "),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"set_event_flag"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sem_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" sem_num"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token function"},"semctl"),n("span",{class:"token punctuation"},"("),s("sem_key"),n("span",{class:"token punctuation"},","),s(" sem_num"),n("span",{class:"token punctuation"},","),s(" SETVAL"),n("span",{class:"token punctuation"},","),s(" SET"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"clear_event_flag"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sem_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" sem_num"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token function"},"semctl"),n("span",{class:"token punctuation"},"("),s("sem_key"),n("span",{class:"token punctuation"},","),s(" sem_num"),n("span",{class:"token punctuation"},","),s(" SETVAL"),n("span",{class:"token punctuation"},","),s(" CLEAR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"get_flag_state"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sem_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" sem_num"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token function"},"semctl"),n("span",{class:"token punctuation"},"("),s("sem_key"),n("span",{class:"token punctuation"},","),s(" sem_num"),n("span",{class:"token punctuation"},","),s(" GETVAL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"wait_for_event_flag"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sem_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" sem_num"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sembuf"),s(" sops"),n("span",{class:"token punctuation"},";"),s(`
  sops`),n("span",{class:"token punctuation"},"."),s("sem_flg "),n("span",{class:"token operator"},"="),s(" SEM_UNDO"),n("span",{class:"token punctuation"},";"),s(`
  sops`),n("span",{class:"token punctuation"},"."),s("sem_num "),n("span",{class:"token operator"},"="),s(" sem_num"),n("span",{class:"token punctuation"},";"),s(`
  sops`),n("span",{class:"token punctuation"},"."),s("sem_op "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"-"),s("SET"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"semop"),n("span",{class:"token punctuation"},"("),s("sem_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sops"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("errno "),n("span",{class:"token operator"},"=="),s(" EINTR"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`
  sops`),n("span",{class:"token punctuation"},"."),s("sem_op "),n("span",{class:"token operator"},"="),s(" SET"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"semop"),n("span",{class:"token punctuation"},"("),s("sem_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sops"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("errno "),n("span",{class:"token operator"},"=="),s(" EINTR"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"key_t"),s(" ipc_key"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" sem_key"),n("span",{class:"token punctuation"},";"),s(`
  ipc_key `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"ftok"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("sem_key "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"semget"),n("span",{class:"token punctuation"},"("),s("ipc_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(" IPC_CREAT "),n("span",{class:"token operator"},"|"),s(" S_IRUSR "),n("span",{class:"token operator"},"|"),s(" S_IWUSR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"semget"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"set_event_flag"),n("span",{class:"token punctuation"},"("),s("sem_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"set_event_flag"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"event_flag %d\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"get_flag_state"),n("span",{class:"token punctuation"},"("),s("sem_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"clear_event_flag"),n("span",{class:"token punctuation"},"("),s("sem_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"clear_event_flag"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"event_flag %d\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"get_flag_state"),n("span",{class:"token punctuation"},"("),s("sem_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld]child process start\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld]child process about to send notify\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
           `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"set_event_flag"),n("span",{class:"token punctuation"},"("),s("sem_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld]child procee sended notify\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
           `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld]parent process wait notify\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
           `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"wait_for_event_flag"),n("span",{class:"token punctuation"},"("),s("sem_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"wait_for_event_flag"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld]parent process got notify\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
           `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"47-6"),n("p",null,[n("img",{src:cn,alt:"47-6-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/ipc.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/sem.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/stat.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"FIFO_FILE_PATH"),s(),n("span",{class:"token string"},'"/home/cattchen/Codes/tlpi-practice/fifo"')]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"reserve_sem"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" fifo_read_fd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token comment"},"// read"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},","),s(" flag"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("flag "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fcntl"),n("span",{class:"token punctuation"},"("),s("fifo_read_fd"),n("span",{class:"token punctuation"},","),s(" F_GETFL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fcntl"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  flag `),n("span",{class:"token operator"},"&="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"~"),s("O_NONBLOCK"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fcntl"),n("span",{class:"token punctuation"},"("),s("fifo_read_fd"),n("span",{class:"token punctuation"},","),s(" F_SETFL"),n("span",{class:"token punctuation"},","),s(" flag"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fcntl"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("fifo_read_fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"reserve_sem_nb"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" fifo_read_fd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token comment"},"// read noblock"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},","),s(" flag"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("flag "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"fcntl"),n("span",{class:"token punctuation"},"("),s("fifo_read_fd"),n("span",{class:"token punctuation"},","),s(" F_GETFL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fcntl"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  flag `),n("span",{class:"token operator"},"|="),s(" O_NONBLOCK"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fcntl"),n("span",{class:"token punctuation"},"("),s("fifo_read_fd"),n("span",{class:"token punctuation"},","),s(" F_SETFL"),n("span",{class:"token punctuation"},","),s(" flag"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fcntl"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("fifo_read_fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"release_sem"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" fifo_write_fd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token comment"},"// write"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("fifo_write_fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"mkfifo"),n("span",{class:"token punctuation"},"("),s("FIFO_FILE_PATH"),n("span",{class:"token punctuation"},","),s(" S_IRUSR "),n("span",{class:"token operator"},"|"),s(" S_IWUSR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mkfifo"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("FIFO_FILE_PATH"),n("span",{class:"token punctuation"},","),s(" O_WRONLY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld]child process start\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld]child about to notify parent\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
           `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"release_sem"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"release_sem"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld]child notified parent\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
           `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("FIFO_FILE_PATH"),n("span",{class:"token punctuation"},","),s(" O_RDONLY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld]parent wait for notify\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
           `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"reserve_sem"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"reserve_sem"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld]parent got notify\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"47-7"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/ipc.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/sem.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" maxind"),n("span",{class:"token punctuation"},","),s(" ind"),n("span",{class:"token punctuation"},","),s(" semid"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"seminfo"),s(" si"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"semid_ds"),s(" ids"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("maxind "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"semctl"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" SEM_INFO"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("si"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"semctl"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("ind "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" ind "),n("span",{class:"token operator"},"<="),s(" maxind"),n("span",{class:"token punctuation"},";"),s(" ind"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("semid "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"semctl"),n("span",{class:"token punctuation"},"("),s("ind"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" SEM_STAT"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("ids"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("errno "),n("span",{class:"token operator"},"!="),s(" EINVAL "),n("span",{class:"token operator"},"&&"),s(" errno "),n("span",{class:"token operator"},"!="),s(" EACCES"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"semctl"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%4d %8d  0x%08lx\\n"'),n("span",{class:"token punctuation"},","),s(" ind"),n("span",{class:"token punctuation"},","),s(" semid"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),s("ids"),n("span",{class:"token punctuation"},"."),s("sem_perm"),n("span",{class:"token punctuation"},"."),s("__key"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u56DB\u5341\u516B\u7AE0"),n("h3",null,"48-1"),n("p",null,[n("img",{src:pn,alt:"48-1-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sched.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/ipc.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/shm.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/stat.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/wait.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1024")])]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(" shm_key"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"enum"),s(),n("span",{class:"token class-name"},"ReadyRead"),s(),n("span",{class:"token punctuation"},"{"),s(" WAIT"),n("span",{class:"token punctuation"},","),s(" READY "),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"shmmsg"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"short"),s(" ready_read"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" size"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" buf"),n("span",{class:"token punctuation"},"["),s("BUF_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"handle_exit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"shmctl"),n("span",{class:"token punctuation"},"("),s("shm_key"),n("span",{class:"token punctuation"},","),s(" IPC_RMID"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"shmctl"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"key_t"),s(" ipc_key"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"shmmsg"),s(),n("span",{class:"token operator"},"*"),s("msg"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("ipc_key "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"ftok"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"ftok"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("shm_key "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"shmget"),n("span",{class:"token punctuation"},"("),s("ipc_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"shmmsg"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
                        IPC_CREAT `),n("span",{class:"token operator"},"|"),s(" S_IRUSR "),n("span",{class:"token operator"},"|"),s(" S_IWUSR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"shmget"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("msg "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"shmat"),n("span",{class:"token punctuation"},"("),s("shm_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"shmat"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  msg`),n("span",{class:"token operator"},"->"),s("ready_read "),n("span",{class:"token operator"},"="),s(" WAIT"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"shmdt"),n("span",{class:"token punctuation"},"("),s("msg"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"shmdt"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token comment"},`/**
   * parent process as writer, child process as reader.
   */`),s(`
  `),n("span",{class:"token function"},"setbuf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stdout"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"atexit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("handle_exit"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token comment"},"// reader"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("msg "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"shmat"),n("span",{class:"token punctuation"},"("),s("shm_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"shmat"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"child process buf %p\\n"'),n("span",{class:"token punctuation"},","),s(" msg"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("msg"),n("span",{class:"token operator"},"->"),s("ready_read "),n("span",{class:"token operator"},"=="),s(" WAIT"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"sched_yield"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
      `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("msg"),n("span",{class:"token operator"},"->"),s("size "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("msg"),n("span",{class:"token operator"},"->"),s("size "),n("span",{class:"token operator"},"-="),s(),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("STDOUT_FILENO"),n("span",{class:"token punctuation"},","),s(" msg"),n("span",{class:"token operator"},"->"),s("buf"),n("span",{class:"token punctuation"},","),s(" msg"),n("span",{class:"token operator"},"->"),s("size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
          `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"write"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
      msg`),n("span",{class:"token operator"},"->"),s("ready_read "),n("span",{class:"token operator"},"="),s(" WAIT"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token comment"},"// writer"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("msg "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"shmat"),n("span",{class:"token punctuation"},"("),s("shm_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"shmat"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"parent process buf %p\\n"'),n("span",{class:"token punctuation"},","),s(" msg"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("msg"),n("span",{class:"token operator"},"->"),s("ready_read "),n("span",{class:"token operator"},"=="),s(" READY"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"sched_yield"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("msg"),n("span",{class:"token operator"},"->"),s("size "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("STDIN_FILENO"),n("span",{class:"token punctuation"},","),s(" msg"),n("span",{class:"token operator"},"->"),s("buf"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"read"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      msg`),n("span",{class:"token operator"},"->"),s("ready_read "),n("span",{class:"token operator"},"="),s(" READY"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"48-2"),n("p",null,"\u6CA1\u6709\u5BF9 EOF \u7684\u60C5\u51B5\u8FDB\u884C\u5904\u7406"),n("h3",null,"48-3"),n("p",null,"// TODO, benchmark"),n("h3",null,"48-4"),n("p",null,[n("img",{src:en,alt:"48-4-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/ipc.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/shm.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"shmid_ds"),s(" ds"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"int"),s(" shm_id"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s shm-id\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  shm_id `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getInt"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"shm-id"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"shmctl"),n("span",{class:"token punctuation"},"("),s("shm_id"),n("span",{class:"token punctuation"},","),s(" SHM_STAT"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("ds"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"shmctl"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"shm changed: %s"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"ctime"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("ds"),n("span",{class:"token punctuation"},"."),s("shm_ctime"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Last shmat():\\t%s"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"ctime"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("ds"),n("span",{class:"token punctuation"},"."),s("shm_atime"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Last shmdt():\\t%s"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"ctime"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("ds"),n("span",{class:"token punctuation"},"."),s("shm_dtime"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"48-5"),n("p",null,[n("img",{src:un,alt:"48-5-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<string.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/ipc.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/sem.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/shm.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/stat.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"10240")])]),s(`

`),n("span",{class:"token comment"},`/**
* meta segment takes place first few bytes
* object segment growth from low address to high
* string segment growth from high address to low
*/`),s(`
`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),s(),n("span",{class:"token punctuation"},"{"),s(`
 `),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"int"),s(" object_offset"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"int"),s(" string_offset"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token comment"},`/**
* KVObject is in used unless key_offset is point to NULL
*/`),s(`
`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token punctuation"},"{"),s(`
 `),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"int"),s(" key_offset"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"int"),s(" value_offset"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),s(),n("span",{class:"token punctuation"},"{"),s(`
 `),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"short"),s(" in_use "),n("span",{class:"token operator"},":"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token class-name"},"size_t"),s(" str_size"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"enum"),s(),n("span",{class:"token class-name"},"KVStringMetaInuse"),s(),n("span",{class:"token punctuation"},"{"),s(" FREE"),n("span",{class:"token punctuation"},","),s(" OCCUPY "),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token comment"},`/**
* string value in low address
* string meta in high address
*/`),s(`
`),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"strseg_malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token class-name"},"size_t"),s(" size"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
 `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),s(),n("span",{class:"token operator"},"*"),s("kv_meta"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("strseg_start"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("strseg_end"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("target"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"int"),s(" split_size"),n("span",{class:"token punctuation"},";"),s(`

 kv_meta `),n("span",{class:"token operator"},"="),s(" buf"),n("span",{class:"token punctuation"},";"),s(`
 strseg_start `),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(" BUF_SIZE "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 strseg_end `),n("span",{class:"token operator"},"="),s(`
     buf `),n("span",{class:"token operator"},"+"),s(" BUF_SIZE "),n("span",{class:"token operator"},"-"),s(" kv_meta"),n("span",{class:"token operator"},"->"),s("string_offset "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

 target `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
 curr `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("strseg_start"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"!="),s(" strseg_end"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
   `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("in_use "),n("span",{class:"token operator"},"=="),s(" FREE "),n("span",{class:"token operator"},"&&"),s(`
       `),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),s("target "),n("span",{class:"token operator"},"||"),s(`
        `),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("str_size "),n("span",{class:"token operator"},">="),s(" size "),n("span",{class:"token operator"},"&&"),s(" curr"),n("span",{class:"token operator"},"->"),s("str_size "),n("span",{class:"token operator"},"<"),s(" target"),n("span",{class:"token operator"},"->"),s("str_size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
     target `),n("span",{class:"token operator"},"="),s(" curr"),n("span",{class:"token punctuation"},";"),s(`
   curr `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("curr "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"-"),s(" curr"),n("span",{class:"token operator"},"->"),s("str_size"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token punctuation"},"}"),s(`
 `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("target "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
   `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(" kv_meta"),n("span",{class:"token operator"},"->"),s("object_offset "),n("span",{class:"token operator"},"+"),s(`
        kv_meta`),n("span",{class:"token operator"},"->"),s("string_offset "),n("span",{class:"token operator"},"+"),s(" size "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},">"),s(`
       BUF_SIZE`),n("span",{class:"token punctuation"},")"),s(`
     `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
   kv_meta`),n("span",{class:"token operator"},"->"),s("string_offset "),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
   target `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("strseg_end"),n("span",{class:"token punctuation"},";"),s(`
   target`),n("span",{class:"token operator"},"->"),s("str_size "),n("span",{class:"token operator"},"="),s(" size"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("split_size "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),s("target"),n("span",{class:"token operator"},"->"),s("str_size "),n("span",{class:"token operator"},"-"),s(" size "),n("span",{class:"token operator"},"-"),s(`
                           `),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
   curr `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("target "),n("span",{class:"token operator"},"-"),s(" size "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
   curr`),n("span",{class:"token operator"},"->"),s("in_use "),n("span",{class:"token operator"},"="),s(" FREE"),n("span",{class:"token punctuation"},";"),s(`
   curr`),n("span",{class:"token operator"},"->"),s("str_size "),n("span",{class:"token operator"},"="),s(" split_size"),n("span",{class:"token punctuation"},";"),s(`
   target`),n("span",{class:"token operator"},"->"),s("str_size "),n("span",{class:"token operator"},"="),s(" size"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token punctuation"},"}"),s(`
 target`),n("span",{class:"token operator"},"->"),s("in_use "),n("span",{class:"token operator"},"="),s(" OCCUPY"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("target "),n("span",{class:"token operator"},"-"),s(" target"),n("span",{class:"token operator"},"->"),s("str_size"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"-"),s(" buf"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"strseg_free"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"int"),s(" target_offset"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
 `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),s(),n("span",{class:"token operator"},"*"),s("kv_meta"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("strseg_start"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("strseg_end"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("target"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("prev"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("seg_end"),n("span",{class:"token punctuation"},";"),s(`

 target `),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(" target_offset"),n("span",{class:"token punctuation"},";"),s(`
 kv_meta `),n("span",{class:"token operator"},"="),s(" buf"),n("span",{class:"token punctuation"},";"),s(`
 strseg_start `),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(" BUF_SIZE "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 strseg_end `),n("span",{class:"token operator"},"="),s(`
     buf `),n("span",{class:"token operator"},"+"),s(" BUF_SIZE "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"-"),s(" kv_meta"),n("span",{class:"token operator"},"->"),s("string_offset"),n("span",{class:"token punctuation"},";"),s(`
 prev `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
 curr `),n("span",{class:"token operator"},"="),s(" strseg_start"),n("span",{class:"token punctuation"},";"),s(`
 seg_end `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"!="),s(" strseg_end"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
   `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("curr "),n("span",{class:"token operator"},"-"),s(" curr"),n("span",{class:"token operator"},"->"),s("str_size"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" target"),n("span",{class:"token punctuation"},")"),s(`
     curr`),n("span",{class:"token operator"},"->"),s("in_use "),n("span",{class:"token operator"},"="),s(" FREE"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("prev "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),s(),n("span",{class:"token operator"},"&&"),s(" curr"),n("span",{class:"token operator"},"->"),s("in_use "),n("span",{class:"token operator"},"=="),s(" FREE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
     prev`),n("span",{class:"token operator"},"->"),s("str_size "),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(" curr"),n("span",{class:"token operator"},"->"),s("str_size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
     prev `),n("span",{class:"token operator"},"="),s(" curr"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token punctuation"},"}"),s(`
   `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("in_use "),n("span",{class:"token operator"},"=="),s(" OCCUPY"),n("span",{class:"token punctuation"},")"),s(`
     seg_end `),n("span",{class:"token operator"},"="),s(" curr"),n("span",{class:"token punctuation"},";"),s(`
   curr `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("curr "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"-"),s(" curr"),n("span",{class:"token operator"},"->"),s("str_size"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token punctuation"},"}"),s(`
 `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("seg_end "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
   seg_end `),n("span",{class:"token operator"},"="),s(" strseg_start"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
   seg_end `),n("span",{class:"token operator"},"="),s(`
       `),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("seg_end "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"-"),s(" seg_end"),n("span",{class:"token operator"},"->"),s("str_size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token punctuation"},"}"),s(`
 kv_meta`),n("span",{class:"token operator"},"->"),s("string_offset "),n("span",{class:"token operator"},"-="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("seg_end "),n("span",{class:"token operator"},"-"),s(" strseg_end"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"objseg_malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
 `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token operator"},"*"),s("objseg_end"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),s(),n("span",{class:"token operator"},"*"),s("kv_meta"),n("span",{class:"token punctuation"},";"),s(`

 kv_meta `),n("span",{class:"token operator"},"="),s(" buf"),n("span",{class:"token punctuation"},";"),s(`
 curr `),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 objseg_end `),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(" kv_meta"),n("span",{class:"token operator"},"->"),s("object_offset"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"!="),s(" objseg_end"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
   `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("key_offset "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
     `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("curr "),n("span",{class:"token operator"},"-"),s(" buf"),n("span",{class:"token punctuation"},";"),s(`
   curr `),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token punctuation"},"}"),s(`
 `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(" kv_meta"),n("span",{class:"token operator"},"->"),s("object_offset "),n("span",{class:"token operator"},"+"),s(" kv_meta"),n("span",{class:"token operator"},"->"),s("string_offset "),n("span",{class:"token operator"},"+"),s(`
      `),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},">"),s(" BUF_SIZE"),n("span",{class:"token punctuation"},")"),s(`
   `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
 kv_meta`),n("span",{class:"token operator"},"->"),s("object_offset "),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("objseg_end "),n("span",{class:"token operator"},"-"),s(" buf"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"objseg_free"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"int"),s(" target_offset"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
 `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),s(),n("span",{class:"token operator"},"*"),s("kv_meta"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token operator"},"*"),s("objseg_start"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("objseg_end"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("seg_end"),n("span",{class:"token punctuation"},";"),s(`

 kv_meta `),n("span",{class:"token operator"},"="),s(" buf"),n("span",{class:"token punctuation"},";"),s(`
 objseg_start `),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 objseg_end `),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(" kv_meta"),n("span",{class:"token operator"},"->"),s("object_offset"),n("span",{class:"token punctuation"},";"),s(`
 seg_end `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
 curr `),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(" target_offset"),n("span",{class:"token punctuation"},";"),s(`
 curr`),n("span",{class:"token operator"},"->"),s("key_offset "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
 curr `),n("span",{class:"token operator"},"="),s(" objseg_start"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"!="),s(" objseg_end"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
   `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("key_offset "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
     seg_end `),n("span",{class:"token operator"},"="),s(" curr"),n("span",{class:"token punctuation"},";"),s(`
   curr `),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token punctuation"},"}"),s(`
 `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("seg_end "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
   seg_end `),n("span",{class:"token operator"},"="),s(" objseg_start"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
   seg_end `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("seg_end "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token punctuation"},"}"),s(`
 kv_meta`),n("span",{class:"token operator"},"->"),s("object_offset "),n("span",{class:"token operator"},"-="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("objseg_end "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("seg_end"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"kv_insert"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("value"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
 `),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"int"),s(" key_size"),n("span",{class:"token punctuation"},","),s(" value_size"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token operator"},"*"),s("kv_obj"),n("span",{class:"token punctuation"},";"),s(`
 key_size `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("key"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
 value_size `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("value"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("kv_obj "),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token function"},"objseg_malloc"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" buf"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"||"),s(`
     `),n("span",{class:"token punctuation"},"("),s("kv_obj"),n("span",{class:"token operator"},"->"),s("key_offset "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"strseg_malloc"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(" key_size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"||"),s(`
     `),n("span",{class:"token punctuation"},"("),s("kv_obj"),n("span",{class:"token operator"},"->"),s("value_offset "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"strseg_malloc"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(" value_size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
   `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),s("buf "),n("span",{class:"token operator"},"+"),s(" kv_obj"),n("span",{class:"token operator"},"->"),s("key_offset"),n("span",{class:"token punctuation"},","),s(" key"),n("span",{class:"token punctuation"},","),s(" key_size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),s("buf "),n("span",{class:"token operator"},"+"),s(" kv_obj"),n("span",{class:"token operator"},"->"),s("value_offset"),n("span",{class:"token punctuation"},","),s(" value"),n("span",{class:"token punctuation"},","),s(" value_size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"kv_init"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
 `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),s(),n("span",{class:"token operator"},"*"),s("kv_meta"),n("span",{class:"token punctuation"},";"),s(`
 kv_meta `),n("span",{class:"token operator"},"="),s(" buf"),n("span",{class:"token punctuation"},";"),s(`
 kv_meta`),n("span",{class:"token operator"},"->"),s("object_offset "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
 kv_meta`),n("span",{class:"token operator"},"->"),s("string_offset "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"kv_get"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("key"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
 `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("kv_object_end"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),s(),n("span",{class:"token operator"},"*"),s("kv_meta"),n("span",{class:"token punctuation"},";"),s(`

 kv_meta `),n("span",{class:"token operator"},"="),s(" buf"),n("span",{class:"token punctuation"},";"),s(`
 curr `),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 kv_object_end `),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(" kv_meta"),n("span",{class:"token operator"},"->"),s("object_offset"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"!="),s(" kv_object_end"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
   `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("key_offset "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("key"),n("span",{class:"token punctuation"},","),s(" buf "),n("span",{class:"token operator"},"+"),s(" curr"),n("span",{class:"token operator"},"->"),s("key_offset"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
     `),n("span",{class:"token keyword"},"return"),s(" buf "),n("span",{class:"token operator"},"+"),s(" curr"),n("span",{class:"token operator"},"->"),s("value_offset"),n("span",{class:"token punctuation"},";"),s(`
   curr `),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token punctuation"},"}"),s(`
 `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"kv_delete"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("key"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
 `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("kv_object_end"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),s(),n("span",{class:"token operator"},"*"),s("kv_meta"),n("span",{class:"token punctuation"},";"),s(`

 kv_meta `),n("span",{class:"token operator"},"="),s(" buf"),n("span",{class:"token punctuation"},";"),s(`
 curr `),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 kv_object_end `),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(" kv_meta"),n("span",{class:"token operator"},"->"),s("object_offset"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"!="),s(" kv_object_end"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
   `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("key_offset "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("key"),n("span",{class:"token punctuation"},","),s(" buf "),n("span",{class:"token operator"},"+"),s(" curr"),n("span",{class:"token operator"},"->"),s("key_offset"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
     `),n("span",{class:"token function"},"strseg_free"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(" curr"),n("span",{class:"token operator"},"->"),s("key_offset"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
     `),n("span",{class:"token function"},"strseg_free"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(" curr"),n("span",{class:"token operator"},"->"),s("value_offset"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
     `),n("span",{class:"token function"},"objseg_free"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("curr "),n("span",{class:"token operator"},"-"),s(" buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
     `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token punctuation"},"}"),s(`
   curr `),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token punctuation"},"}"),s(`
 `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"kv_iter_r"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("kv_object"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
 `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),s(),n("span",{class:"token operator"},"*"),s("kv_meta"),n("span",{class:"token punctuation"},";"),s(`
 kv_meta `),n("span",{class:"token operator"},"="),s(" buf"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("kv_object "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
   `),n("span",{class:"token operator"},"*"),s("kv_object "),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token operator"},"*"),s("kv_object "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("kv_object"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token punctuation"},"}"),s(`
 `),n("span",{class:"token keyword"},"do"),s(),n("span",{class:"token punctuation"},"{"),s(`
   `),n("span",{class:"token operator"},"*"),s("kv_object "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("kv_object"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("kv_object"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("key_offset "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("kv_object"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},">="),s(`
     buf `),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(" kv_meta"),n("span",{class:"token operator"},"->"),s("object_offset"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
   `),n("span",{class:"token operator"},"*"),s("kv_object "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"examine_segment"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
 `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),s(),n("span",{class:"token operator"},"*"),s("kv_meta"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("end"),n("span",{class:"token punctuation"},";"),s(`

 kv_meta `),n("span",{class:"token operator"},"="),s(" buf"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"meta:\\nobject_offset: %d\\nstring_offset:%d\\n"'),n("span",{class:"token punctuation"},","),s(" kv_meta"),n("span",{class:"token operator"},"->"),s("object_offset"),n("span",{class:"token punctuation"},","),s(`
        kv_meta`),n("span",{class:"token operator"},"->"),s("string_offset"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"\\nobject segment:\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
     end `),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(" kv_meta"),n("span",{class:"token operator"},"->"),s("object_offset"),n("span",{class:"token punctuation"},";"),s(`
      curr `),n("span",{class:"token operator"},"<"),s(" end"),n("span",{class:"token punctuation"},";"),s(" curr "),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
   `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("key_offset "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
     `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token punctuation"},"}"),s(`
   `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"offset: %ld, key_offset: %ld, value_offset: %ld\\n"'),n("span",{class:"token punctuation"},","),s(" curr "),n("span",{class:"token operator"},"-"),s(" buf"),n("span",{class:"token punctuation"},","),s(`
          `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("key_offset"),n("span",{class:"token punctuation"},","),s(`
          `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("value_offset"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token punctuation"},"}"),s(`
 `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"\\nstring segment:\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(" BUF_SIZE "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
     end `),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(" BUF_SIZE "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"-"),s(`
           kv_meta`),n("span",{class:"token operator"},"->"),s("string_offset"),n("span",{class:"token punctuation"},";"),s(`
      curr `),n("span",{class:"token operator"},">"),s(" end"),n("span",{class:"token punctuation"},";"),s(" curr "),n("span",{class:"token operator"},"-="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("str_size "),n("span",{class:"token operator"},"+"),s(`
                          `),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
   `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"string_offset: %ld, meta_offset: %ld, str_size: %ld, in_used: "'),s(`
          `),n("span",{class:"token string"},'"%d, value: %s\\n"'),n("span",{class:"token punctuation"},","),s(`
          curr `),n("span",{class:"token operator"},"-"),s(" buf"),n("span",{class:"token punctuation"},","),s(" curr "),n("span",{class:"token operator"},"-"),s(" buf "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("str_size"),n("span",{class:"token punctuation"},","),s(`
          `),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("str_size"),n("span",{class:"token punctuation"},","),s(`
          `),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("in_use"),n("span",{class:"token punctuation"},","),s(`
          `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("str_size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token punctuation"},"}"),s(`
 `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(" sem_key"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"handle_exit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
 `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sembuf"),s(" sops"),n("span",{class:"token punctuation"},";"),s(`
 sops`),n("span",{class:"token punctuation"},"."),s("sem_flg "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
 sops`),n("span",{class:"token punctuation"},"."),s("sem_num "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
 sops`),n("span",{class:"token punctuation"},"."),s("sem_op "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"semop"),n("span",{class:"token punctuation"},"("),s("sem_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sops"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
   `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"semop"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
 `),n("span",{class:"token class-name"},"key_t"),s(" ipc_key"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"int"),s(" shm_key"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("value"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"int"),s(" flag"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sembuf"),s(" sops"),n("span",{class:"token punctuation"},";"),s(`

 `),n("span",{class:"token function"},"setbuf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stdout"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(`
   `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s [g|s|d|l] [key [value]]\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("ipc_key "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"ftok"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
   `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"ftok"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 flag `),n("span",{class:"token operator"},"="),s(" IPC_CREAT "),n("span",{class:"token operator"},"|"),s(" IPC_EXCL "),n("span",{class:"token operator"},"|"),s(" S_IRUSR "),n("span",{class:"token operator"},"|"),s(" S_IWUSR"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("shm_key "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"shmget"),n("span",{class:"token punctuation"},"("),s("ipc_key"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},","),s(" flag"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
   flag `),n("span",{class:"token operator"},"&="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"~"),s("IPC_EXCL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("shm_key "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"shmget"),n("span",{class:"token punctuation"},"("),s("ipc_key"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},","),s(" flag"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
     `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"shmget"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("buf "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"shmat"),n("span",{class:"token punctuation"},"("),s("shm_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
     `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"shmat"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
   `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("buf "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"shmat"),n("span",{class:"token punctuation"},"("),s("shm_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
     `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"shmat"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token function"},"kv_init"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token punctuation"},"}"),s(`

 `),n("span",{class:"token comment"},`/**
  * semophore
  */`),s(`
 flag `),n("span",{class:"token operator"},"="),s(" IPC_CREAT "),n("span",{class:"token operator"},"|"),s(" IPC_EXCL "),n("span",{class:"token operator"},"|"),s(" S_IRUSR "),n("span",{class:"token operator"},"|"),s(" S_IWUSR"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("sem_key "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"semget"),n("span",{class:"token punctuation"},"("),s("ipc_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(" flag"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
   flag `),n("span",{class:"token operator"},"&="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"~"),s("IPC_EXCL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("sem_key "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"semget"),n("span",{class:"token punctuation"},"("),s("ipc_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(" flag"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
     `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"semget"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
   `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"semctl"),n("span",{class:"token punctuation"},"("),s("sem_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" SETVAL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
     `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"semctl"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token punctuation"},"}"),s(`
 key `),n("span",{class:"token operator"},"="),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
 value `),n("span",{class:"token operator"},"="),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
 sops`),n("span",{class:"token punctuation"},"."),s("sem_flg "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
 sops`),n("span",{class:"token punctuation"},"."),s("sem_num "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
 sops`),n("span",{class:"token punctuation"},"."),s("sem_op "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"semop"),n("span",{class:"token punctuation"},"("),s("sem_key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sops"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
   `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"semop"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"atexit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("handle_exit"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
   `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"atexit"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

 `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
 `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'g'"),n("span",{class:"token operator"},":"),s(`
   value `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"kv_get"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(" key"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s -> %s\\n"'),n("span",{class:"token punctuation"},","),s(" key"),n("span",{class:"token punctuation"},","),s(" value"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'s'"),n("span",{class:"token operator"},":"),s(`
   `),n("span",{class:"token function"},"kv_delete"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(" key"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"kv_insert"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(" key"),n("span",{class:"token punctuation"},","),s(" value"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
     `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Insert Fail\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
     `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token punctuation"},"}"),s(`
   `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s -> %s\\n"'),n("span",{class:"token punctuation"},","),s(" key"),n("span",{class:"token punctuation"},","),s(" value"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'d'"),n("span",{class:"token operator"},":"),s(`
   `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"kv_delete"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(" key"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
     `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Delete Fail\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
     `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token punctuation"},"}"),s(`
   `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s deleted\\n"'),n("span",{class:"token punctuation"},","),s(" key"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'l'"),n("span",{class:"token operator"},":"),s(`
   curr `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token function"},"kv_iter_r"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
     `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s -> %s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("buf "),n("span",{class:"token operator"},"+"),s(" curr"),n("span",{class:"token operator"},"->"),s("key_offset"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
            `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("buf "),n("span",{class:"token operator"},"+"),s(" curr"),n("span",{class:"token operator"},"->"),s("value_offset"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
     `),n("span",{class:"token function"},"kv_iter_r"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'e'"),n("span",{class:"token operator"},":"),s(`
   `),n("span",{class:"token function"},"examine_segment"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
   `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Unexpected Command %s\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_FAILURE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
   `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
 `),n("span",{class:"token punctuation"},"}"),s(`
 `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"48-6"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/ipc.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/shm.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" maxind"),n("span",{class:"token punctuation"},","),s(" ind"),n("span",{class:"token punctuation"},","),s(" shmid"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"shm_info"),s(" si"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"shmid_ds"),s(" ids"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("maxind "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"shmctl"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" SHM_INFO"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"shmid_ds"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("si"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"shminfo"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("ind "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" ind "),n("span",{class:"token operator"},"<="),s(" maxind"),n("span",{class:"token punctuation"},";"),s(" ind"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("shmid "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"shmctl"),n("span",{class:"token punctuation"},"("),s("ind"),n("span",{class:"token punctuation"},","),s(" SHM_STAT"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("ids"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("errno "),n("span",{class:"token operator"},"!="),s(" EINVAL "),n("span",{class:"token operator"},"&&"),s(" errno "),n("span",{class:"token operator"},"!="),s(" EACCES"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"shmctl"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%4d %8d 0x%08lx %04d\\n"'),n("span",{class:"token punctuation"},","),s(" ind"),n("span",{class:"token punctuation"},","),s(" shmid"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),s("ids"),n("span",{class:"token punctuation"},"."),s("shm_perm"),n("span",{class:"token punctuation"},"."),s("__key"),n("span",{class:"token punctuation"},","),s(`
           `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),n("span",{class:"token punctuation"},")"),s("ids"),n("span",{class:"token punctuation"},"."),s("shm_nattch"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u56DB\u5341\u4E5D\u7AE0"),n("h3",null,"49-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/mman.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/stat.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd_src"),n("span",{class:"token punctuation"},","),s(" fd_dest"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("addr_src"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("addr_dest"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"stat"),s(" st"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"usage %s src dest\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd_src "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" O_RDONLY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd_dest "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" O_RDWR "),n("span",{class:"token operator"},"|"),s(" O_CREAT"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0755"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fstat"),n("span",{class:"token punctuation"},"("),s("fd_src"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("st"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fstat"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"ftruncate"),n("span",{class:"token punctuation"},"("),s("fd_dest"),n("span",{class:"token punctuation"},","),s(" st"),n("span",{class:"token punctuation"},"."),s("st_size"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"ftruncate"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("addr_src "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"mmap"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(" st"),n("span",{class:"token punctuation"},"."),s("st_size"),n("span",{class:"token punctuation"},","),s(" PROT_READ"),n("span",{class:"token punctuation"},","),s(" MAP_SHARED"),n("span",{class:"token punctuation"},","),s(" fd_src"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(`
      MAP_FAILED`),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mmap"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("addr_dest "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"mmap"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(" st"),n("span",{class:"token punctuation"},"."),s("st_size"),n("span",{class:"token punctuation"},","),s(" PROT_WRITE"),n("span",{class:"token punctuation"},","),s(" MAP_SHARED"),n("span",{class:"token punctuation"},","),s(" fd_dest"),n("span",{class:"token punctuation"},","),s(`
                        `),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" MAP_FAILED"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mmap"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),s("addr_dest"),n("span",{class:"token punctuation"},","),s(" addr_src"),n("span",{class:"token punctuation"},","),s(" st"),n("span",{class:"token punctuation"},"."),s("st_size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"49-2"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sched.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/mman.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1024")])]),s(`

`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"CommMsg"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"short"),s(" ready_read "),n("span",{class:"token operator"},":"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"int"),s(" size"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" buf"),n("span",{class:"token punctuation"},"["),s("BUF_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"CommMsg"),s(),n("span",{class:"token operator"},"*"),s("msg"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("msg "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"mmap"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"CommMsg"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" PROT_READ "),n("span",{class:"token operator"},"|"),s(" PROT_WRITE"),n("span",{class:"token punctuation"},","),s(`
                  MAP_SHARED `),n("span",{class:"token operator"},"|"),s(" MAP_ANONYMOUS"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" MAP_FAILED"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mmap"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  msg`),n("span",{class:"token operator"},"->"),s("ready_read "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),s("msg"),n("span",{class:"token operator"},"->"),s("ready_read"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"sched_yield"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
      `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("msg"),n("span",{class:"token operator"},"->"),s("size "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("msg"),n("span",{class:"token operator"},"->"),s("size "),n("span",{class:"token operator"},"-="),s(),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("STDOUT_FILENO"),n("span",{class:"token punctuation"},","),s(" msg"),n("span",{class:"token operator"},"->"),s("buf"),n("span",{class:"token punctuation"},","),s(" msg"),n("span",{class:"token operator"},"->"),s("size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
          `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"write"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
      msg`),n("span",{class:"token operator"},"->"),s("ready_read "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("msg"),n("span",{class:"token operator"},"->"),s("ready_read"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"sched_yield"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("msg"),n("span",{class:"token operator"},"->"),s("size "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("STDIN_FILENO"),n("span",{class:"token punctuation"},","),s(" msg"),n("span",{class:"token operator"},"->"),s("buf"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"read"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      msg`),n("span",{class:"token operator"},"->"),s("ready_read "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"49-3"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/mman.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"sig_handler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld] %s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strsignal"),n("span",{class:"token punctuation"},"("),s("sig"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" page_size"),n("span",{class:"token punctuation"},","),s(" fd"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("addr"),n("span",{class:"token punctuation"},";"),s(`
  page_size `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"sysconf"),n("span",{class:"token punctuation"},"("),s("_SC_PAGESIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"1.txt"'),n("span",{class:"token punctuation"},","),s(" O_RDWR "),n("span",{class:"token operator"},"|"),s(" O_CREAT"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0755"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"ftruncate"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" page_size "),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token number"},"0.5"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"ftruncate"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("addr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"mmap"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(" page_size "),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},","),s(" PROT_READ "),n("span",{class:"token operator"},"|"),s(" PROT_WRITE"),n("span",{class:"token punctuation"},","),s(" MAP_SHARED"),n("span",{class:"token punctuation"},","),s(" fd"),n("span",{class:"token punctuation"},","),s(`
                   `),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" MAP_FAILED"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mmap"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"signal"),n("span",{class:"token punctuation"},"("),s("SIGBUS"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sig_handler"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"signal"),n("span",{class:"token punctuation"},"("),s("SIGSEGV"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sig_handler"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token comment"},"// *(addr + page_size + 16) = 'a';"),s(`
  `),n("span",{class:"token comment"},"// *(addr + 2 * page_size + 16) = 'a';"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"49-4"),n("p",null,"// TODO"),n("h2",null,"\u7B2C\u4E94\u5341\u7AE0"),n("h3",null,"50-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/mman.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" max_lock_memory"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},";"),s(`
  max_lock_memory `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"sysconf"),n("span",{class:"token punctuation"},"("),s("_SC_MEMLOCK"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("buf "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"mmap"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(" max_lock_memory "),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},","),s(" PROT_READ "),n("span",{class:"token operator"},"|"),s(" PROT_WRITE"),n("span",{class:"token punctuation"},","),s(`
                  MAP_SHARED `),n("span",{class:"token operator"},"|"),s(" MAP_ANONYMOUS"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" MAP_FAILED"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mmap"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"mlock"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(" max_lock_memory "),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mlock"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"done\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"50-2"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/mman.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1024")])]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("addr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("addr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"mmap"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},","),s(" PROT_READ "),n("span",{class:"token operator"},"|"),s(" PROT_WRITE"),n("span",{class:"token punctuation"},","),s(`
                   MAP_PRIVATE `),n("span",{class:"token operator"},"|"),s(" MAP_ANONYMOUS"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" MAP_FAILED"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mmap"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"addr: %p\\n"'),n("span",{class:"token punctuation"},","),s(" addr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"madvise"),n("span",{class:"token punctuation"},"("),s("addr"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},","),s(" MADV_DONTNEED"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"madvise"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"done\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u4E94\u5341\u4E00\u7AE0"),n("h3",null,"51-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"tlpi_hdr.h"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>"),s(),n("span",{class:"token comment"},"/* For definition of O_NONBLOCK */")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<mqueue.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"usageError"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("progName"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Usage: %s [-n] mq-name seconds\\n"'),n("span",{class:"token punctuation"},","),s(" progName"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"    -n           Use O_NONBLOCK flag\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_FAILURE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" flags"),n("span",{class:"token punctuation"},","),s(" opt"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"mqd_t"),s(" mqd"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"int"),s(" prio"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buffer"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"mq_attr"),s(" attr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"ssize_t"),s(" numRead"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"timespec"),s(" ts"),n("span",{class:"token punctuation"},";"),s(`

  flags `),n("span",{class:"token operator"},"="),s(" O_RDONLY"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("opt "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getopt"),n("span",{class:"token punctuation"},"("),s("argc"),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("opt"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'n'"),n("span",{class:"token operator"},":"),s(`
      flags `),n("span",{class:"token operator"},"|="),s(" O_NONBLOCK"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token function"},"usageError"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("optind "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},">="),s(" argc"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageError"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  mqd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"mq_open"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),s("optind"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" flags"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("mqd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"mqd_t"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mq_open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"clock_gettime"),n("span",{class:"token punctuation"},"("),s("CLOCK_REALTIME"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("ts"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ts`),n("span",{class:"token punctuation"},"."),s("tv_sec "),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token function"},"getInt"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),s("optind "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"seconds"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},`/* We need to know the 'mq_msgsize' attribute of the queue in
     order to determine the size of the buffer for mq_receive() */`),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"mq_getattr"),n("span",{class:"token punctuation"},"("),s("mqd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("attr"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mq_getattr"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  buffer `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("attr"),n("span",{class:"token punctuation"},"."),s("mq_msgsize"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("buffer "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"malloc"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  numRead `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"mq_timedreceive"),n("span",{class:"token punctuation"},"("),s("mqd"),n("span",{class:"token punctuation"},","),s(" buffer"),n("span",{class:"token punctuation"},","),s(" attr"),n("span",{class:"token punctuation"},"."),s("mq_msgsize"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("prio"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("ts"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("numRead "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mq_receive"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Read %ld bytes; priority = %u\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),s("numRead"),n("span",{class:"token punctuation"},","),s(" prio"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token comment"},"/*FIXME: above: should use %zd here, and remove (long) cast */"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("STDOUT_FILENO"),n("span",{class:"token punctuation"},","),s(" buffer"),n("span",{class:"token punctuation"},","),s(" numRead"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"write"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("STDOUT_FILENO"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"52-2"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token comment"},"// 52-2-comm"),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"ifndef"),s(),n("span",{class:"token expression"},"_CH522COMM")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"_CH522COMM")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<mqueue.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"MQ_SERVER_PATH"),s(),n("span",{class:"token string"},'"/mq-server"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"MQ_CLIENT_TEMPLATE"),s(),n("span",{class:"token string"},'"/mq-client-%ld"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1024")])]),s(`
`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"MqMsg"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"long"),s(" id"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" buf"),n("span",{class:"token punctuation"},"["),s("BUF_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"endif")]),s(`
`)])]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token comment"},"// 52-2-client.c"),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"52-2-comm.h"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<limits.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<mqueue.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"mqd_t"),s(" send_fd"),n("span",{class:"token punctuation"},","),s(" receive_fd"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" send_path"),n("span",{class:"token punctuation"},"["),s("PATH_MAX"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"MqMsg"),s(" msg"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"mq_attr"),s(" attr"),n("span",{class:"token punctuation"},";"),s(`
  attr`),n("span",{class:"token punctuation"},"."),s("mq_flags "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  attr`),n("span",{class:"token punctuation"},"."),s("mq_maxmsg "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  attr`),n("span",{class:"token punctuation"},"."),s("mq_msgsize "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"MqMsg"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s text\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  msg`),n("span",{class:"token punctuation"},"."),s("id "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),s("msg"),n("span",{class:"token punctuation"},"."),s("buf"),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"snprintf"),n("span",{class:"token punctuation"},"("),s("send_path"),n("span",{class:"token punctuation"},","),s(" PATH_MAX"),n("span",{class:"token punctuation"},","),s(" MQ_CLIENT_TEMPLATE"),n("span",{class:"token punctuation"},","),s(" msg"),n("span",{class:"token punctuation"},"."),s("id"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("receive_fd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"mq_open"),n("span",{class:"token punctuation"},"("),s("send_path"),n("span",{class:"token punctuation"},","),s(" O_CREAT "),n("span",{class:"token operator"},"|"),s(" O_RDONLY"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0755"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("attr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mq_open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("send_fd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"mq_open"),n("span",{class:"token punctuation"},"("),s("MQ_SERVER_PATH"),n("span",{class:"token punctuation"},","),s(" O_WRONLY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mq_open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"mq_send"),n("span",{class:"token punctuation"},"("),s("send_fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("msg"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"MqMsg"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"write"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"mq_receive"),n("span",{class:"token punctuation"},"("),s("receive_fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("msg"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"MqMsg"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"read"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s\\n"'),n("span",{class:"token punctuation"},","),s(" msg"),n("span",{class:"token punctuation"},"."),s("buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token comment"},"// 52-2-server"),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"52-2-comm.h"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<limits.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<mqueue.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"mqd_t"),s(" receive_fd"),n("span",{class:"token punctuation"},","),s(" send_fd"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"MqMsg"),s(" msg"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"mq_attr"),s(" attr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" send_path"),n("span",{class:"token punctuation"},"["),s("PATH_MAX"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  attr`),n("span",{class:"token punctuation"},"."),s("mq_flags "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  attr`),n("span",{class:"token punctuation"},"."),s("mq_maxmsg "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  attr`),n("span",{class:"token punctuation"},"."),s("mq_msgsize "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"MqMsg"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("receive_fd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"mq_open"),n("span",{class:"token punctuation"},"("),s("MQ_SERVER_PATH"),n("span",{class:"token punctuation"},","),s(" O_CREAT "),n("span",{class:"token operator"},"|"),s(" O_RDONLY "),n("span",{class:"token operator"},"|"),s(" O_TRUNC"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0755"),n("span",{class:"token punctuation"},","),s(`
                            `),n("span",{class:"token operator"},"&"),s("attr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mq_open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"mq_receive"),n("span",{class:"token punctuation"},"("),s("receive_fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("msg"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"MqMsg"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(`
         `),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"snprintf"),n("span",{class:"token punctuation"},"("),s("send_path"),n("span",{class:"token punctuation"},","),s(" PATH_MAX"),n("span",{class:"token punctuation"},","),s(" MQ_CLIENT_TEMPLATE"),n("span",{class:"token punctuation"},","),s(" msg"),n("span",{class:"token punctuation"},"."),s("id"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"snprintf"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld]open %s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" send_path"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("send_fd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"mq_open"),n("span",{class:"token punctuation"},"("),s("send_path"),n("span",{class:"token punctuation"},","),s(" O_WRONLY"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0755"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("attr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mq_open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"mq_send"),n("span",{class:"token punctuation"},"("),s("send_fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("msg"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"MqMsg"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mq_send"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"msg_receive"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"52-3"),n("p",null,"// TODO"),n("h3",null,"52-4"),n("p",null,"// TODO"),n("h3",null,"52-5"),n("p",null,[n("img",{src:ln,alt:"52-5-1"})]),n("pre",{class:"language-shell"},[n("code",{class:"language-shell"},[n("span",{class:"token shebang important"},"#!/usr/bin/env bash"),s(`

`),n("span",{class:"token assign-left variable"},"DIR"),n("span",{class:"token operator"},"="),n("span",{class:"token string"},"'/home/cattchen/Codes/tlpi-dist/pmsg'"),s(`

`),n("span",{class:"token assign-left variable"},"NOTIFY"),n("span",{class:"token operator"},"="),n("span",{class:"token string"},"'/home/cattchen/Codes/tlpi-practice/notify'"),s(`

`),n("span",{class:"token comment"},"# Create posix-mq"),s(`
`),n("span",{class:"token function"},"rm"),s(" /dev/mqueue/* "),n("span",{class:"token operator"},">>"),s(" /dev/null "),n("span",{class:"token operator"},[n("span",{class:"token file-descriptor important"},"2"),s(">")]),n("span",{class:"token file-descriptor important"},"&1"),s(`
`),n("span",{class:"token variable"},"${DIR}"),s("/pmsg_create "),n("span",{class:"token parameter variable"},"-c"),s(" /mq "),n("span",{class:"token parameter variable"},"-s"),s(),n("span",{class:"token number"},"6"),s(`

`),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"["),s(),n("span",{class:"token variable"},"$?"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),n("span",{class:"token keyword"},"then"),s(`
  `),n("span",{class:"token builtin class-name"},"exit"),s(),n("span",{class:"token variable"},"$?"),s(`
`),n("span",{class:"token keyword"},"fi"),s(`

`),n("span",{class:"token comment"},"# Set posix-mq notify"),s(`
`),n("span",{class:"token variable"},"${NOTIFY}"),s(" /mq "),n("span",{class:"token operator"},"&"),s(`

`),n("span",{class:"token comment"},"# Send notify twice"),s(`
`),n("span",{class:"token variable"},"${DIR}"),s("/pmsg_send /mq hello"),n("span",{class:"token punctuation"},"\\"),s(`
`),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token builtin class-name"},"echo"),s(),n("span",{class:"token string"},"'write msg1 done'"),n("span",{class:"token punctuation"},"\\"),s(`
`),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token function"},"sleep"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"\\"),s(`
`),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token variable"},"${DIR}"),s("/pmsg_send /mq hello"),n("span",{class:"token punctuation"},"\\"),s(`
`),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token builtin class-name"},"echo"),s(),n("span",{class:"token string"},"'write msg2 done'"),s(`

`),n("span",{class:"token function"},"wait"),s(`
`)])]),n("h3",null,"52-6"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"tlpi_hdr.h"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>"),s(),n("span",{class:"token comment"},"/* For definition of O_NONBLOCK */")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<mqueue.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"NOTIFY_SIG"),s(),n("span",{class:"token expression"},"SIGUSR1")]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"handler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token comment"},"/* Just interrupt sigsuspend() */"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},`/* This program does not handle the case where a message already exists on
   the queue by the time the first attempt is made to register for message
   notification. In that case, the program would never receive a notification.
   See mq_notify_via_signal.c for an example of how to deal with that case. */`),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sigevent"),s(" sev"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"mqd_t"),s(" mqd"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"mq_attr"),s(" attr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buffer"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"ssize_t"),s(" numRead"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"sigset_t"),s(" blockMask"),n("span",{class:"token punctuation"},","),s(" emptyMask"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sigaction"),s(" sa"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"siginfo_t"),s(" info"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"2"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"--help"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s mq-name\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  mqd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"mq_open"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" O_RDONLY "),n("span",{class:"token operator"},"|"),s(" O_NONBLOCK"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mqd: %d\\n"'),n("span",{class:"token punctuation"},","),s(" mqd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("mqd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"mqd_t"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mq_open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},`/* Determine mq_msgsize for message queue, and allocate an input buffer
     of that size */`),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"mq_getattr"),n("span",{class:"token punctuation"},"("),s("mqd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("attr"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mq_getattr"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  buffer `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("attr"),n("span",{class:"token punctuation"},"."),s("mq_msgsize"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("buffer "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"malloc"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},"/* Block the notification signal and establish a handler for it */"),s(`

  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("blockMask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sigaddset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("blockMask"),n("span",{class:"token punctuation"},","),s(" NOTIFY_SIG"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigprocmask"),n("span",{class:"token punctuation"},"("),s("SIG_BLOCK"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("blockMask"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigprocmask"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},"."),s("sa_mask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  sa`),n("span",{class:"token punctuation"},"."),s("sa_flags "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  sa`),n("span",{class:"token punctuation"},"."),s("sa_handler "),n("span",{class:"token operator"},"="),s(" handler"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigaction"),n("span",{class:"token punctuation"},"("),s("NOTIFY_SIG"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigaction"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},"/* Register for message notification via a signal */"),s(`

  sev`),n("span",{class:"token punctuation"},"."),s("sigev_notify "),n("span",{class:"token operator"},"="),s(" SIGEV_SIGNAL"),n("span",{class:"token punctuation"},";"),s(`
  sev`),n("span",{class:"token punctuation"},"."),s("sigev_signo "),n("span",{class:"token operator"},"="),s(" NOTIFY_SIG"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"mq_notify"),n("span",{class:"token punctuation"},"("),s("mqd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sev"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mq_notify"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("emptyMask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token comment"},"// sigsuspend(&emptyMask); /* Wait for notification signal */"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigwaitinfo"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("blockMask"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("info"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigwaitinfo"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"si_code(SI_MESGQ is %d): %d signo: %d\\n"'),n("span",{class:"token punctuation"},","),s(" SI_MESGQ"),n("span",{class:"token punctuation"},","),s(" info"),n("span",{class:"token punctuation"},"."),s("si_code"),n("span",{class:"token punctuation"},","),s(`
           info`),n("span",{class:"token punctuation"},"."),s("si_signo"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"/* Reregister for message notification */"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"mq_notify"),n("span",{class:"token punctuation"},"("),s("mqd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sev"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mq_notify"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("numRead "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"mq_receive"),n("span",{class:"token punctuation"},"("),s("mqd"),n("span",{class:"token punctuation"},","),s(" buffer"),n("span",{class:"token punctuation"},","),s(" attr"),n("span",{class:"token punctuation"},"."),s("mq_msgsize"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},">="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Read %ld bytes\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),s("numRead"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token comment"},"/*FIXME: above: should use %zd here, and remove (long) cast */"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("errno "),n("span",{class:"token operator"},"!="),s(" EAGAIN"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token comment"},"/* Unexpected error */"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mq_receive"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"52-7"),n("p",null,"\u4E0D\u884C\uFF0C\u591A\u4E2A\u7EBF\u7A0B\u4F1A\u5171\u4EAB\u8FDB\u7A0B\u7684\u5168\u5C40\u53D8\u91CF\uFF0C\u4EA7\u751F\u7ADE\u6001\u95EE\u9898"),n("h2",null,"\u7B2C\u4E94\u5341\u4E09\u7AE0"),n("h3",null,"53-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<pthread.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<semaphore.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1024")])]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token class-name"},"sem_t"),s(" read_ready"),n("span",{class:"token punctuation"},","),s(" write_ready"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"char"),s(" buf"),n("span",{class:"token punctuation"},"["),s("BUF_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(" size"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"read_worker"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("arg"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sem_wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("read_ready"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sem_wait"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"-="),s(),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("STDOUT_FILENO"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"write"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sem_post"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("write_ready"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sem_post"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"write_worker"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("arg"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sem_wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("write_ready"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sem_wait"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("STDIN_FILENO"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"read"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sem_post"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("read_ready"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sem_post"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"pthread_t"),s(" thread_reader"),n("span",{class:"token punctuation"},","),s(" thread_writer"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sem_init"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("read_ready"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"sem_init"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("write_ready"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sem_init"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_create"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("thread_reader"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(" read_worker"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_create"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_create"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("thread_writer"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(" write_worker"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_create"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_join"),n("span",{class:"token punctuation"},"("),s("thread_reader"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_join"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_join"),n("span",{class:"token punctuation"},"("),s("thread_writer"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_join"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"53-2"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},'"tlpi_hdr.h"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<semaphore.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"sem_t"),s(),n("span",{class:"token operator"},"*"),s("sem"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"timespec"),s(" ts"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"3"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"--help"'),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s sem-name timeout-seconds\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"clock_gettime"),n("span",{class:"token punctuation"},"("),s("CLOCK_REALTIME"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("ts"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  ts`),n("span",{class:"token punctuation"},"."),s("tv_sec "),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token function"},"getInt"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"timeout-seconds"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  sem `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"sem_open"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("sem "),n("span",{class:"token operator"},"=="),s(" SEM_FAILED"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sem_open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sem_timedwait"),n("span",{class:"token punctuation"},"("),s("sem"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("ts"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sem_wait"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%ld sem_wait() succeeded\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"53-3"),n("p",null,"// TODO"),n("h3",null,"53-4"),n("p",null,"// TODO"),n("h2",null,"\u7B2C\u4E94\u5341\u56DB\u7AE0"),n("h3",null,"54-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sched.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/mman.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/wait.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"SHM_FILE"),s(),n("span",{class:"token string"},'"/read-writer-shm"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1024")])]),s(`

`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"ShmMsg"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"short"),s(" read_ready "),n("span",{class:"token operator"},":"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" size"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" buf"),n("span",{class:"token punctuation"},"["),s("BUF_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"ShmMsg"),s(),n("span",{class:"token operator"},"*"),s("msg"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"shm_open"),n("span",{class:"token punctuation"},"("),s("SHM_FILE"),n("span",{class:"token punctuation"},","),s(" O_CREAT "),n("span",{class:"token operator"},"|"),s(" O_RDWR"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0755"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"shm_open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"ftruncate"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"ShmMsg"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"ftruncate"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("msg "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"mmap"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"ShmMsg"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" PROT_READ "),n("span",{class:"token operator"},"|"),s(" PROT_WRITE"),n("span",{class:"token punctuation"},","),s(`
                  MAP_SHARED`),n("span",{class:"token punctuation"},","),s(" fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" MAP_FAILED"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"mmap"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),s("msg"),n("span",{class:"token operator"},"->"),s("read_ready"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"sched_yield"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("STDOUT_FILENO"),n("span",{class:"token punctuation"},","),s(" msg"),n("span",{class:"token operator"},"->"),s("buf"),n("span",{class:"token punctuation"},","),s(" msg"),n("span",{class:"token operator"},"->"),s("size"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"write"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      msg`),n("span",{class:"token operator"},"->"),s("read_ready "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("msg"),n("span",{class:"token operator"},"->"),s("read_ready"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"sched_yield"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("msg"),n("span",{class:"token operator"},"->"),s("size "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("STDIN_FILENO"),n("span",{class:"token punctuation"},","),s(" msg"),n("span",{class:"token operator"},"->"),s("buf"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"read"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      msg`),n("span",{class:"token operator"},"->"),s("read_ready "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u4E94\u5341\u4E94\u7AE0"),n("h3",null,"55-1"),n("p",null,"// TODO"),n("h3",null,"55-2"),n("p",null,[n("img",{src:kn,alt:"55-2-1"})]),n("p",null,"\u662F\u4F1A\u53D1\u751F\u6B7B\u9501\u7684\uFF0C\u9700\u8981\u6CE8\u610F\u7236\u5B50\u8FDB\u7A0B\u9700\u8981\u5355\u72EC\u6253\u5F00 fd\uFF0C\u5982\u679C\u8FDB\u884C dup\uFF0C\u4F1A\u5F15\u7528\u540C\u4E00\u4E2A\u9501"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/file.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd1"),n("span",{class:"token punctuation"},","),s(" fd2"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"alarm"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd1 "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"1.txt"'),n("span",{class:"token punctuation"},","),s(" O_RDWR "),n("span",{class:"token operator"},"|"),s(" O_CREAT"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0755"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd2 "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"2.txt"'),n("span",{class:"token punctuation"},","),s(" O_RDWR "),n("span",{class:"token operator"},"|"),s(" O_CREAT"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0755"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld] start\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"flock"),n("span",{class:"token punctuation"},"("),s("fd1"),n("span",{class:"token punctuation"},","),s(" LOCK_EX"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"flock"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld] fd1\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"flock"),n("span",{class:"token punctuation"},"("),s("fd2"),n("span",{class:"token punctuation"},","),s(" LOCK_EX"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"flock"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld] fd2\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"alarm"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd1 "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"1.txt"'),n("span",{class:"token punctuation"},","),s(" O_RDWR "),n("span",{class:"token operator"},"|"),s(" O_CREAT"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0755"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd2 "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"2.txt"'),n("span",{class:"token punctuation"},","),s(" O_RDWR "),n("span",{class:"token operator"},"|"),s(" O_CREAT"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0755"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld] start\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"flock"),n("span",{class:"token punctuation"},"("),s("fd2"),n("span",{class:"token punctuation"},","),s(" LOCK_EX"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"flock"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld] fd2\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"flock"),n("span",{class:"token punctuation"},"("),s("fd1"),n("span",{class:"token punctuation"},","),s(" LOCK_EX"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"flock"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld] fd1\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"55-3"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/file.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/wait.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"open"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"1.txt"'),n("span",{class:"token punctuation"},","),s(" O_CREAT "),n("span",{class:"token operator"},"|"),s(" O_RDWR"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0755"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"open"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"flock"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" LOCK_EX"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"flock"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"flock"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" LOCK_EX"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"flock"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"get lock\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"55-4"),n("p",null,[n("img",{src:rn,alt:"55-4-1"})]),n("p",null,[n("code",null,"flock"),s("\u548C"),n("code",null,"fcntl"),s("\u662F\u4E92\u76F8\u4E0D\u53EF\u89C1\u7684")]),n("h3",null,"// TODO"),n("h2",null,"\u7B2C\u4E94\u5341\u516D\u7AE0"),n("h2",null,"\u7B2C\u4E94\u5341\u4E03\u7AE0"),n("h3",null,"57-1"),n("p",null,[n("img",{src:dn,alt:"57-1-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/socket.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/un.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/wait.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<time.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"SOCKET_SERVER"),s(),n("span",{class:"token string"},'"/tmp/echo-socket-server"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"SOCKET_CLIENT"),s(),n("span",{class:"token string"},'"/tmp/echo-socket-client"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1024")])]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"access"),n("span",{class:"token punctuation"},"("),s("SOCKET_SERVER"),n("span",{class:"token punctuation"},","),s(" F_OK"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"unlink"),n("span",{class:"token punctuation"},"("),s("SOCKET_SERVER"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"unlink"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"access"),n("span",{class:"token punctuation"},"("),s("SOCKET_CLIENT"),n("span",{class:"token punctuation"},","),s(" F_OK"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"unlink"),n("span",{class:"token punctuation"},"("),s("SOCKET_CLIENT"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"unlink"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"int"),s(" fdl"),n("span",{class:"token punctuation"},","),s(" fdr"),n("span",{class:"token punctuation"},","),s(" size"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_un"),s(" addr_s"),n("span",{class:"token punctuation"},","),s(" addr_c"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" buf"),n("span",{class:"token punctuation"},"["),s("BUF_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("addr_s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_un"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),s("addr_s"),n("span",{class:"token punctuation"},"."),s("sun_path"),n("span",{class:"token punctuation"},","),s(" SOCKET_SERVER"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  addr_s`),n("span",{class:"token punctuation"},"."),s("sun_family "),n("span",{class:"token operator"},"="),s(" AF_UNIX"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("addr_c"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_un"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),s("addr_c"),n("span",{class:"token punctuation"},"."),s("sun_path"),n("span",{class:"token punctuation"},","),s(" SOCKET_CLIENT"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  addr_c`),n("span",{class:"token punctuation"},"."),s("sun_family "),n("span",{class:"token operator"},"="),s(" AF_UNIX"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"setbuf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stdout"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fdl "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"socket"),n("span",{class:"token punctuation"},"("),s("AF_UNIX"),n("span",{class:"token punctuation"},","),s(" SOCK_DGRAM"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"socket"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"bind"),n("span",{class:"token punctuation"},"("),s("fdl"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("addr_c"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("addr_c"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"bind"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"recvfrom"),n("span",{class:"token punctuation"},"("),s("fdl"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"recvfrom"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"[%ld %ld]%s"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"time"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),n("span",{class:"token function"},"getpid"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fdl "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"socket"),n("span",{class:"token punctuation"},"("),s("AF_UNIX"),n("span",{class:"token punctuation"},","),s(" SOCK_DGRAM"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"socket"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"bind"),n("span",{class:"token punctuation"},"("),s("fdl"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("addr_s"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("addr_s"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"bind"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"snprintf"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"msg-%d\\n"'),n("span",{class:"token punctuation"},","),s(" i"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sendto"),n("span",{class:"token punctuation"},"("),s("fdl"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("addr_c"),n("span",{class:"token punctuation"},","),s(`
                 `),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("addr_c"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sendto"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token function"},"wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"57-2"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/socket.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/un.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"SOCKET_SERVER"),s(),n("span",{class:"token string"},'"123456"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1024")])]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fdl"),n("span",{class:"token punctuation"},","),s(" fdr"),n("span",{class:"token punctuation"},","),s(" size"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_un"),s(" addr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" buf"),n("span",{class:"token punctuation"},"["),s("BUF_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"access"),n("span",{class:"token punctuation"},"("),s("SOCKET_SERVER"),n("span",{class:"token punctuation"},","),s(" F_OK"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"unlink"),n("span",{class:"token punctuation"},"("),s("SOCKET_SERVER"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"unlink"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("addr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_un"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  addr`),n("span",{class:"token punctuation"},"."),s("sun_family "),n("span",{class:"token operator"},"="),s(" AF_UNIX"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),s("addr"),n("span",{class:"token punctuation"},"."),s("sun_path "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(" SOCKET_SERVER"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fdl "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"socket"),n("span",{class:"token punctuation"},"("),s("AF_UNIX"),n("span",{class:"token punctuation"},","),s(" SOCK_STREAM"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"socket"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fdr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"connect"),n("span",{class:"token punctuation"},"("),s("fdl"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("addr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("addr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"bind"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("STDIN_FILENO"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"-="),s(),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("fdr"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
          `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"write"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fdl "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"socket"),n("span",{class:"token punctuation"},"("),s("AF_UNIX"),n("span",{class:"token punctuation"},","),s(" SOCK_STREAM"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"socket"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"bind"),n("span",{class:"token punctuation"},"("),s("fdl"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("addr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("addr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"bind"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"listen"),n("span",{class:"token punctuation"},"("),s("fdl"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"listen"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fdr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"accept"),n("span",{class:"token punctuation"},"("),s("fdl"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"[accept] %s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("fdr"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"-="),s(),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("fdr"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
          `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
            `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"write"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fdr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"57-3"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/socket.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/un.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"SOCKET_PATH"),s(),n("span",{class:"token string"},'"/tmp/num-socket-server"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1024")])]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fdl"),n("span",{class:"token punctuation"},","),s(" fdr"),n("span",{class:"token punctuation"},","),s(" size"),n("span",{class:"token punctuation"},","),s(" index"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_un"),s(" addr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" buf"),n("span",{class:"token punctuation"},"["),s("BUF_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"access"),n("span",{class:"token punctuation"},"("),s("SOCKET_PATH"),n("span",{class:"token punctuation"},","),s(" F_OK"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"unlink"),n("span",{class:"token punctuation"},"("),s("SOCKET_PATH"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"unlink"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"setbuf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stdout"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("addr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_un"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  addr`),n("span",{class:"token punctuation"},"."),s("sun_family "),n("span",{class:"token operator"},"="),s(" AF_UNIX"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),s("addr"),n("span",{class:"token punctuation"},"."),s("sun_path"),n("span",{class:"token punctuation"},","),s(" SOCKET_PATH"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("index "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" index "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"10"),n("span",{class:"token punctuation"},";"),s(" index"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fdl "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"socket"),n("span",{class:"token punctuation"},"("),s("AF_UNIX"),n("span",{class:"token punctuation"},","),s(" SOCK_STREAM"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"socket"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"connect"),n("span",{class:"token punctuation"},"("),s("fdl"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("addr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_un"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(`
          `),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"connect"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("fdl"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"read"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("STDOUT_FILENO"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" size "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fdl"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    index `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fdl "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"socket"),n("span",{class:"token punctuation"},"("),s("AF_UNIX"),n("span",{class:"token punctuation"},","),s(" SOCK_STREAM"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"socket"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"bind"),n("span",{class:"token punctuation"},"("),s("fdl"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("addr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_un"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"bind"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"listen"),n("span",{class:"token punctuation"},"("),s("fdl"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"listen"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fdr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"accept"),n("span",{class:"token punctuation"},"("),s("fdl"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"accept"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"snprintf"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"%d\\n"'),n("span",{class:"token punctuation"},","),s(" index"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      size `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("fdr"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" size"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(" size"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"write"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fdr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      index`),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"57-4"),n("p",null,[n("img",{src:mn,alt:"57-4-1"})]),n("p",null,"\u4E00\u4E2A\u5730\u5740\u540C\u4E00\u4E2A\u65F6\u523B\u53EA\u80FD\u88AB\u4E00\u4E2A socket bind"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/socket.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/un.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/wait.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"SOCKET_A"),s(),n("span",{class:"token string"},'"/tmp/socket-a"')]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"SOCKET_B"),s(),n("span",{class:"token string"},'"/tmp/socket-b"')]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fdl"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_un"),s(" addr_a"),n("span",{class:"token punctuation"},","),s(" addr_b"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("addr_a"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("addr_a"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  addr_a`),n("span",{class:"token punctuation"},"."),s("sun_family "),n("span",{class:"token operator"},"="),s(" AF_UNIX"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),s("addr_a"),n("span",{class:"token punctuation"},"."),s("sun_path"),n("span",{class:"token punctuation"},","),s(" SOCKET_A"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("addr_b"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("addr_b"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  addr_b`),n("span",{class:"token punctuation"},"."),s("sun_family "),n("span",{class:"token operator"},"="),s(" AF_UNIX"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),s("addr_b"),n("span",{class:"token punctuation"},"."),s("sun_path"),n("span",{class:"token punctuation"},","),s(" SOCKET_B"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fdl "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"socket"),n("span",{class:"token punctuation"},"("),s("AF_UNIX"),n("span",{class:"token punctuation"},","),s(" SOCK_DGRAM"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"socket"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"bind"),n("span",{class:"token punctuation"},"("),s("fdl"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("addr_a"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("addr_a"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"bind"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fdl "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"socket"),n("span",{class:"token punctuation"},"("),s("AF_UNIX"),n("span",{class:"token punctuation"},","),s(" SOCK_DGRAM"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"socket"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"bind"),n("span",{class:"token punctuation"},"("),s("fdl"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("addr_b"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("addr_b"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"bind"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fdl "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"socket"),n("span",{class:"token punctuation"},"("),s("AF_UNIX"),n("span",{class:"token punctuation"},","),s(" SOCK_DGRAM"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"socket"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"bind"),n("span",{class:"token punctuation"},"("),s("fdl"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("addr_a"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("addr_a"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"bind"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token function"},"wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h2",null,"\u7B2C\u4E94\u5341\u516B\u7AE0"),n("h2",null,"\u7B2C\u4E94\u5341\u4E5D\u7AE0"),n("h3",null,"59-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"ReadlineBuf"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"ssize_t"),s(" cap"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"ssize_t"),s(" pos"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"readline_buf_init"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"ReadlineBuf"),s(),n("span",{class:"token operator"},"*"),s("rlbuf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token class-name"},"ssize_t"),s(" cap"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  rlbuf`),n("span",{class:"token operator"},"->"),s("pos "),n("span",{class:"token operator"},"="),s(" cap "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  rlbuf`),n("span",{class:"token operator"},"->"),s("cap "),n("span",{class:"token operator"},"="),s(" cap"),n("span",{class:"token punctuation"},";"),s(`
  rlbuf`),n("span",{class:"token operator"},"->"),s("buf "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("cap "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"readline_buf_rl"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"ReadlineBuf"),s(),n("span",{class:"token operator"},"*"),s("rlbuf"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" size"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"ssize_t"),s(" i"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),s("rlbuf"),n("span",{class:"token operator"},"->"),s("buf"),n("span",{class:"token punctuation"},","),s(" rlbuf"),n("span",{class:"token operator"},"->"),s("buf "),n("span",{class:"token operator"},"+"),s(" rlbuf"),n("span",{class:"token operator"},"->"),s("pos"),n("span",{class:"token punctuation"},","),s(" rlbuf"),n("span",{class:"token operator"},"->"),s("cap "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"-"),s(" rlbuf"),n("span",{class:"token operator"},"->"),s("pos"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  rlbuf`),n("span",{class:"token operator"},"->"),s("pos "),n("span",{class:"token operator"},"%="),s(),n("span",{class:"token punctuation"},"("),s("rlbuf"),n("span",{class:"token operator"},"->"),s("cap "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" rlbuf"),n("span",{class:"token operator"},"->"),s("buf "),n("span",{class:"token operator"},"+"),s(" rlbuf"),n("span",{class:"token operator"},"->"),s("pos"),n("span",{class:"token punctuation"},","),s(" rlbuf"),n("span",{class:"token operator"},"->"),s("cap "),n("span",{class:"token operator"},"-"),s(" rlbuf"),n("span",{class:"token operator"},"->"),s("pos"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  size `),n("span",{class:"token operator"},"+="),s(" rlbuf"),n("span",{class:"token operator"},"->"),s("pos"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(" size"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("rlbuf"),n("span",{class:"token operator"},"->"),s("buf"),n("span",{class:"token punctuation"},"["),s("i"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'\\n'"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),s("rlbuf"),n("span",{class:"token operator"},"->"),s("buf "),n("span",{class:"token operator"},"+"),s(" i "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},","),s(" rlbuf"),n("span",{class:"token operator"},"->"),s("buf "),n("span",{class:"token operator"},"+"),s(" i "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(" rlbuf"),n("span",{class:"token operator"},"->"),s("cap "),n("span",{class:"token operator"},"-"),s(" i "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      rlbuf`),n("span",{class:"token operator"},"->"),s("pos "),n("span",{class:"token operator"},"="),s(" i "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},";"),s(`
      rlbuf`),n("span",{class:"token operator"},"->"),s("buf"),n("span",{class:"token punctuation"},"["),s("i "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"return"),s(" i "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  rlbuf`),n("span",{class:"token operator"},"->"),s("pos "),n("span",{class:"token operator"},"="),s(" size "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  rlbuf`),n("span",{class:"token operator"},"->"),s("buf"),n("span",{class:"token punctuation"},"["),s("size"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" size"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"readline_buf_destory"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"ReadlineBuf"),s(),n("span",{class:"token operator"},"*"),s("rlbuf"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("rlbuf"),n("span",{class:"token operator"},"->"),s("buf"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),s("rlbuf"),n("span",{class:"token operator"},"->"),s("buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    rlbuf`),n("span",{class:"token operator"},"->"),s("buf "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" size"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"ReadlineBuf"),s(" rlbuf"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"readline_buf_init"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("rlbuf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1024"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"readline_buf_rl"),n("span",{class:"token punctuation"},"("),s("STDIN_FILENO"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("rlbuf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"read"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("STDOUT_FILENO"),n("span",{class:"token punctuation"},","),s(" rlbuf"),n("span",{class:"token punctuation"},"."),s("buf"),n("span",{class:"token punctuation"},","),s(" size"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"write"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"readline_buf_destory"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("rlbuf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"59-2"),n("p",null,"// TODO"),n("h3",null,"59-3"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<limits.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/socket.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/un.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"un_bind"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("socket_path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" type"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"un_listen"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("socket_path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" backlog"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"un_connect"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("socket_path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" type"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"un_bind"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("socket_path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" type"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_un"),s(" addr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},";"),s(`
  addr`),n("span",{class:"token punctuation"},"."),s("sun_family "),n("span",{class:"token operator"},"="),s(" AF_UNIX"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),s("addr"),n("span",{class:"token punctuation"},"."),s("sun_path"),n("span",{class:"token punctuation"},","),s(" socket_path"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"socket"),n("span",{class:"token punctuation"},"("),s("AF_UNIX"),n("span",{class:"token punctuation"},","),s(" type"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"bind"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("addr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_un"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" fd"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"un_listen"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("socket_path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" backlog"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"un_bind"),n("span",{class:"token punctuation"},"("),s("socket_path"),n("span",{class:"token punctuation"},","),s(" SOCK_DGRAM"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"listen"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" backlog"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" fd"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"un_connect"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("socket_path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" type"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_un"),s(" addr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"un_bind"),n("span",{class:"token punctuation"},"("),s("socket_path"),n("span",{class:"token punctuation"},","),s(" type"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("type "),n("span",{class:"token operator"},"=="),s(" SOCK_DGRAM"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    addr`),n("span",{class:"token punctuation"},"."),s("sun_family "),n("span",{class:"token operator"},"="),s(" AF_UNIX"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),s("addr"),n("span",{class:"token punctuation"},"."),s("sun_path"),n("span",{class:"token punctuation"},","),s(" socket_path"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"connect"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("addr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_un"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(`
        `),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" fd"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"59-4"),n("p",null,[n("img",{src:fn,alt:"59-4-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<arpa/inet.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<netdb.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<netinet/in.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/socket.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUFFER_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"10240")])]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"IO_BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1024")])]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name function"},"KV_STR_DEREF"),n("span",{class:"token expression"},[n("span",{class:"token punctuation"},"("),s("meta"),n("span",{class:"token punctuation"},")"),s("                                                     ")]),n("span",{class:"token punctuation"},"\\"),s(`
  `),n("span",{class:"token expression"},[n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("meta"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),s("meta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("str_size"),n("span",{class:"token punctuation"},")")])]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"USAGE"),s(),n("span",{class:"token string"},'"Usage:\\nget <key>\\nset <key> <value>\\ndel <key>\\nkeys\\n"')]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"char"),s(" buffer"),n("span",{class:"token punctuation"},"["),s("BUFFER_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"ssize_t"),s(" cap"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"ssize_t"),s(" object_offset"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"ssize_t"),s(" string_offset"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"ssize_t"),s(" key_string_offset"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"ssize_t"),s(" value_string_offset"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"short"),s(" in_used "),n("span",{class:"token operator"},":"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"ssize_t"),s(" str_size"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token comment"},"/* Init/Destory kv */"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"kv_init"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token class-name"},"ssize_t"),s(" size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"kv_destory"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token comment"},"/* kv object */"),s(`
`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"kv_object_malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"kv_object_free"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token operator"},"*"),s("obj"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token comment"},"/* kv string */"),s(`
`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"kv_string_malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token class-name"},"ssize_t"),s(" str_size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"kv_string_free"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),s(),n("span",{class:"token operator"},"*"),s("str_meta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token comment"},"/* operate key/value */"),s(`
`),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"kv_get"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("key"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"kv_set"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("value"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"kv_iter_r"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token comment"},"/* do with command */"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"tokenize"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("command"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("tokens"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"do_work"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("command"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("query_result"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("command"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("query_result"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fd_l"),n("span",{class:"token punctuation"},","),s(" fd_r"),n("span",{class:"token punctuation"},","),s(" optval"),n("span",{class:"token punctuation"},","),s(" size"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"addrinfo"),s(" hints"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("result"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s [ip|host] [port|service]\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("hints"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"addrinfo"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  hints`),n("span",{class:"token punctuation"},"."),s("ai_family "),n("span",{class:"token operator"},"="),s(" AF_INET"),n("span",{class:"token punctuation"},";"),s(`
  hints`),n("span",{class:"token punctuation"},"."),s("ai_socktype "),n("span",{class:"token operator"},"="),s(" SOCK_STREAM"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getaddrinfo"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("hints"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("result"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"getaddrinfo"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd_l "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"socket"),n("span",{class:"token punctuation"},"("),s("AF_INET"),n("span",{class:"token punctuation"},","),s(" SOCK_STREAM"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"socket"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  optval `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"setsockopt"),n("span",{class:"token punctuation"},"("),s("fd_l"),n("span",{class:"token punctuation"},","),s(" SOL_SOCKET"),n("span",{class:"token punctuation"},","),s(" SO_REUSEADDR"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("optval"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("optval"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"setsockopt"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"="),s(" result"),n("span",{class:"token punctuation"},";"),s(" curr "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(" curr "),n("span",{class:"token operator"},"="),s(" curr"),n("span",{class:"token operator"},"->"),s("ai_next"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"bind"),n("span",{class:"token punctuation"},"("),s("fd_l"),n("span",{class:"token punctuation"},","),s(" curr"),n("span",{class:"token operator"},"->"),s("ai_addr"),n("span",{class:"token punctuation"},","),s(" curr"),n("span",{class:"token operator"},"->"),s("ai_addrlen"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"listen"),n("span",{class:"token punctuation"},"("),s("fd_l"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    result `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`

  command `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("IO_BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  query_result `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),s("IO_BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"kv_init"),n("span",{class:"token punctuation"},"("),s("buffer"),n("span",{class:"token punctuation"},","),s(" BUFFER_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd_r "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"accept"),n("span",{class:"token punctuation"},"("),s("fd_l"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"[accept] %s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"send"),n("span",{class:"token punctuation"},"("),s("fd_r"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'">"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),s("command"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" IO_BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"recv"),n("span",{class:"token punctuation"},"("),s("fd_r"),n("span",{class:"token punctuation"},","),s(" command"),n("span",{class:"token punctuation"},","),s(" IO_BUF_SIZE"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"[recv] %s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
      `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),s("query_result"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" IO_BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"do_work"),n("span",{class:"token punctuation"},"("),s("command"),n("span",{class:"token punctuation"},","),s(" query_result"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"send"),n("span",{class:"token punctuation"},"("),s("fd_r"),n("span",{class:"token punctuation"},","),s(" query_result"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("query_result"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"[send] %s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd_r"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"kv_destory"),n("span",{class:"token punctuation"},"("),s("buffer"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),s("command"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"free"),n("span",{class:"token punctuation"},"("),s("query_result"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"kv_init"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token class-name"},"ssize_t"),s(" size"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),s(),n("span",{class:"token operator"},"*"),s("meta"),n("span",{class:"token punctuation"},";"),s(`
  meta `),n("span",{class:"token operator"},"="),s(" buf"),n("span",{class:"token punctuation"},";"),s(`
  meta`),n("span",{class:"token operator"},"->"),s("cap "),n("span",{class:"token operator"},"="),s(" size"),n("span",{class:"token punctuation"},";"),s(`
  meta`),n("span",{class:"token operator"},"->"),s("object_offset "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  meta`),n("span",{class:"token operator"},"->"),s("string_offset "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"kv_destory"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),s(),n("span",{class:"token operator"},"*"),s("meta"),n("span",{class:"token punctuation"},";"),s(`
  meta `),n("span",{class:"token operator"},"="),s(" buf"),n("span",{class:"token punctuation"},";"),s(`
  meta`),n("span",{class:"token operator"},"->"),s("cap "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  meta`),n("span",{class:"token operator"},"->"),s("object_offset "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  meta`),n("span",{class:"token operator"},"->"),s("string_offset "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"kv_object_malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),s(),n("span",{class:"token operator"},"*"),s("meta"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("end"),n("span",{class:"token punctuation"},";"),s(`
  meta `),n("span",{class:"token operator"},"="),s(" buf"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
      end `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("curr "),n("span",{class:"token operator"},"+"),s(" meta"),n("span",{class:"token operator"},"->"),s("object_offset"),n("span",{class:"token punctuation"},";"),s(`
       curr `),n("span",{class:"token operator"},"!="),s(" end"),n("span",{class:"token punctuation"},";"),s(" curr"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("key_string_offset "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"return"),s(" curr"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(" meta"),n("span",{class:"token operator"},"->"),s("object_offset "),n("span",{class:"token operator"},"+"),s(" meta"),n("span",{class:"token operator"},"->"),s("string_offset "),n("span",{class:"token operator"},"+"),s(`
       `),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},">"),s(" meta"),n("span",{class:"token operator"},"->"),s("cap"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  meta`),n("span",{class:"token operator"},"->"),s("object_offset "),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" end"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"kv_object_free"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token operator"},"*"),s("obj"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),s(),n("span",{class:"token operator"},"*"),s("meta"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("end"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("next_end"),n("span",{class:"token punctuation"},";"),s(`
  meta `),n("span",{class:"token operator"},"="),s(" buf"),n("span",{class:"token punctuation"},";"),s(`
  obj`),n("span",{class:"token operator"},"->"),s("key_string_offset "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
      end `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("curr "),n("span",{class:"token operator"},"+"),s(" meta"),n("span",{class:"token operator"},"->"),s("object_offset"),n("span",{class:"token punctuation"},","),s(" next_end "),n("span",{class:"token operator"},"="),s(" end"),n("span",{class:"token punctuation"},";"),s(`
       curr `),n("span",{class:"token operator"},"!="),s(" end"),n("span",{class:"token punctuation"},";"),s(" curr"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("key_string_offset "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
      next_end `),n("span",{class:"token operator"},"="),s(" curr "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  meta`),n("span",{class:"token operator"},"->"),s("object_offset "),n("span",{class:"token operator"},"-="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("end "),n("span",{class:"token operator"},"-"),s(" next_end"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"kv_string_malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token class-name"},"ssize_t"),s(" str_size"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),s(),n("span",{class:"token operator"},"*"),s("meta"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("end"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("target"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("fragment"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" fragment_size"),n("span",{class:"token punctuation"},";"),s(`
  meta `),n("span",{class:"token operator"},"="),s(" buf"),n("span",{class:"token punctuation"},";"),s(`
  target `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(" meta"),n("span",{class:"token operator"},"->"),s("cap "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
      end `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("curr "),n("span",{class:"token operator"},"-"),s(" meta"),n("span",{class:"token operator"},"->"),s("string_offset"),n("span",{class:"token punctuation"},";"),s(`
       curr `),n("span",{class:"token operator"},"!="),s(" end"),n("span",{class:"token punctuation"},";"),s(`
       curr `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("curr "),n("span",{class:"token operator"},"-"),s(" curr"),n("span",{class:"token operator"},"->"),s("str_size "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),s("curr"),n("span",{class:"token operator"},"->"),s("in_used "),n("span",{class:"token operator"},"&&"),s(" curr"),n("span",{class:"token operator"},"->"),s("str_size "),n("span",{class:"token operator"},">="),s(" str_size "),n("span",{class:"token operator"},"&&"),s(`
        `),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),s("target "),n("span",{class:"token operator"},"||"),s(" curr"),n("span",{class:"token operator"},"->"),s("str_size "),n("span",{class:"token operator"},"<"),s(" target"),n("span",{class:"token operator"},"->"),s("str_size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
      target `),n("span",{class:"token operator"},"="),s(" curr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),s("target"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(" meta"),n("span",{class:"token operator"},"->"),s("object_offset "),n("span",{class:"token operator"},"+"),s(" meta"),n("span",{class:"token operator"},"->"),s("string_offset "),n("span",{class:"token operator"},"+"),s(`
         `),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},">"),s(" meta"),n("span",{class:"token operator"},"->"),s("cap"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    meta`),n("span",{class:"token operator"},"->"),s("string_offset "),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token punctuation"},"("),s("str_size "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    target `),n("span",{class:"token operator"},"="),s(" end"),n("span",{class:"token punctuation"},";"),s(`
    target`),n("span",{class:"token operator"},"->"),s("str_size "),n("span",{class:"token operator"},"="),s(" str_size"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fragment_size "),n("span",{class:"token operator"},"="),s(" target"),n("span",{class:"token operator"},"->"),s("str_size "),n("span",{class:"token operator"},"-"),s(" str_size "),n("span",{class:"token operator"},"-"),s(`
                              `),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    fragment `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("target "),n("span",{class:"token operator"},"-"),s(" str_size "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    fragment`),n("span",{class:"token operator"},"->"),s("in_used "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
    fragment`),n("span",{class:"token operator"},"->"),s("str_size "),n("span",{class:"token operator"},"="),s(" fragment_size"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  target`),n("span",{class:"token operator"},"->"),s("in_used "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"return"),s(" target"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"kv_string_free"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),s(),n("span",{class:"token operator"},"*"),s("str_meta"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),s(),n("span",{class:"token operator"},"*"),s("meta"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("end"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("next_end"),n("span",{class:"token punctuation"},";"),s(`
  meta `),n("span",{class:"token operator"},"="),s(" buf"),n("span",{class:"token punctuation"},";"),s(`
  str_meta`),n("span",{class:"token operator"},"->"),s("in_used "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(" meta"),n("span",{class:"token operator"},"->"),s("cap "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
      end `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("curr "),n("span",{class:"token operator"},"-"),s(" meta"),n("span",{class:"token operator"},"->"),s("string_offset"),n("span",{class:"token punctuation"},";"),s(`
       curr `),n("span",{class:"token operator"},"!="),s(" end"),n("span",{class:"token punctuation"},";"),s(`
       curr `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("curr "),n("span",{class:"token operator"},"-"),s(" curr"),n("span",{class:"token operator"},"->"),s("str_size "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("curr"),n("span",{class:"token operator"},"->"),s("in_used "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
      next_end `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("curr "),n("span",{class:"token operator"},"-"),s(" curr"),n("span",{class:"token operator"},"->"),s("str_size "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  meta`),n("span",{class:"token operator"},"->"),s("string_offset "),n("span",{class:"token operator"},"-="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("next_end "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("end"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"kv_iter_r"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),s(),n("span",{class:"token operator"},"*"),s("meta"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token operator"},"*"),s("end"),n("span",{class:"token punctuation"},";"),s(`
  meta `),n("span",{class:"token operator"},"="),s(" buf"),n("span",{class:"token punctuation"},";"),s(`
  end `),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(" meta"),n("span",{class:"token operator"},"->"),s("object_offset"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("curr "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token operator"},"*"),s("curr "),n("span",{class:"token operator"},"="),s(" buf "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVMeta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token operator"},"*"),s("curr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("curr "),n("span",{class:"token operator"},"!="),s(" end "),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"->"),s("key_string_offset "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token operator"},"*"),s("curr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("curr "),n("span",{class:"token operator"},"=="),s(" end"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token operator"},"*"),s("curr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"kv_get"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("key"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},";"),s(`
  curr `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"kv_iter_r"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"KV_STR_DEREF"),n("span",{class:"token punctuation"},"("),s("buf "),n("span",{class:"token operator"},"+"),s(" curr"),n("span",{class:"token operator"},"->"),s("key_string_offset"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token function"},"KV_STR_DEREF"),n("span",{class:"token punctuation"},"("),s("buf "),n("span",{class:"token operator"},"+"),s(" curr"),n("span",{class:"token operator"},"->"),s("value_string_offset"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token function"},"kv_iter_r"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"kv_set"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("value"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVStringMeta"),s(),n("span",{class:"token operator"},"*"),s("key_meta"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("value_meta"),n("span",{class:"token punctuation"},";"),s(`
  curr `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"kv_iter_r"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),s("key"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"KV_STR_DEREF"),n("span",{class:"token punctuation"},"("),s("buf "),n("span",{class:"token operator"},"+"),s(" curr"),n("span",{class:"token operator"},"->"),s("key_string_offset"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"kv_string_free"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(" buf "),n("span",{class:"token operator"},"+"),s(" curr"),n("span",{class:"token operator"},"->"),s("key_string_offset"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"kv_string_free"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(" buf "),n("span",{class:"token operator"},"+"),s(" curr"),n("span",{class:"token operator"},"->"),s("value_string_offset"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"kv_object_free"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(" curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token function"},"kv_iter_r"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("value "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    curr `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"kv_object_malloc"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    key_meta `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"kv_string_malloc"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("key"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    value_meta `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"kv_string_malloc"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("value"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"KV_STR_DEREF"),n("span",{class:"token punctuation"},"("),s("key_meta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" key"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"KV_STR_DEREF"),n("span",{class:"token punctuation"},"("),s("value_meta"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" value"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    curr`),n("span",{class:"token operator"},"->"),s("key_string_offset "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("key_meta "),n("span",{class:"token operator"},"-"),s(" buf"),n("span",{class:"token punctuation"},";"),s(`
    curr`),n("span",{class:"token operator"},"->"),s("value_string_offset "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),s("value_meta "),n("span",{class:"token operator"},"-"),s(" buf"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"tokenize"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("command"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("tokens"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token class-name"},"ssize_t"),s(" command_len"),n("span",{class:"token punctuation"},","),s(" space_count"),n("span",{class:"token punctuation"},","),s(" token_index"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("end"),n("span",{class:"token punctuation"},";"),s(`
  command_len `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("command"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("command_len "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token operator"},"*"),s("tokens "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"return"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  space_count `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"="),s(" command "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(" end "),n("span",{class:"token operator"},"="),s(" command "),n("span",{class:"token operator"},"+"),s(" command_len"),n("span",{class:"token punctuation"},";"),s(" curr "),n("span",{class:"token operator"},"!="),s(" end"),n("span",{class:"token punctuation"},";"),s(" curr"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("curr "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"' '"),s(),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token char"},"' '"),n("span",{class:"token punctuation"},")"),s(`
      space_count`),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("curr "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"' '"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token operator"},"*"),s("curr "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'\\n'"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token operator"},"*"),s("curr "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"13"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token operator"},"*"),s("curr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token operator"},"*"),s("tokens "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"malloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("space_count "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  token_index `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("tokens"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"["),s("token_index"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(" command"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"="),s(" command "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},","),s(" end "),n("span",{class:"token operator"},"="),s(" curr "),n("span",{class:"token operator"},"+"),s(" command_len"),n("span",{class:"token punctuation"},";"),s(" curr "),n("span",{class:"token operator"},"!="),s(" end"),n("span",{class:"token punctuation"},";"),s(" curr"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("curr "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"-"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("tokens"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"["),s("token_index"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(" curr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("tokens"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"["),s("token_index"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"do_work"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("command"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("query_result"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("tokens"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("value"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"KVObject"),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"tokenize"),n("span",{class:"token punctuation"},"("),s("command"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("tokens"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strncmp"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"get"'),n("span",{class:"token punctuation"},","),s(" tokens"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"&&"),s(" tokens"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token comment"},"// pass"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strncmp"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"set"'),n("span",{class:"token punctuation"},","),s(" tokens"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"&&"),s(" tokens"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),s(),n("span",{class:"token operator"},"&&"),s(`
             tokens`),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"kv_set"),n("span",{class:"token punctuation"},"("),s("buffer"),n("span",{class:"token punctuation"},","),s(" tokens"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" tokens"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strncmp"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"del"'),n("span",{class:"token punctuation"},","),s(" tokens"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"&&"),s(" tokens"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"kv_set"),n("span",{class:"token punctuation"},"("),s("buffer"),n("span",{class:"token punctuation"},","),s(" tokens"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strncmp"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"keys"'),n("span",{class:"token punctuation"},","),s(" tokens"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"4"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    curr `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"kv_iter_r"),n("span",{class:"token punctuation"},"("),s("buffer"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"snprintf"),n("span",{class:"token punctuation"},"("),s("query_result "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("query_result"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" IO_BUF_SIZE"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"%s -> %s\\n"'),n("span",{class:"token punctuation"},","),s(`
               `),n("span",{class:"token function"},"KV_STR_DEREF"),n("span",{class:"token punctuation"},"("),s("buffer "),n("span",{class:"token operator"},"+"),s(" curr"),n("span",{class:"token operator"},"->"),s("key_string_offset"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
               `),n("span",{class:"token function"},"KV_STR_DEREF"),n("span",{class:"token punctuation"},"("),s("buffer "),n("span",{class:"token operator"},"+"),s(" curr"),n("span",{class:"token operator"},"->"),s("value_string_offset"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"kv_iter_r"),n("span",{class:"token punctuation"},"("),s("buffer"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("curr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"return"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),s("query_result"),n("span",{class:"token punctuation"},","),s(" USAGE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"return"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  value `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"kv_get"),n("span",{class:"token punctuation"},"("),s("buffer"),n("span",{class:"token punctuation"},","),s(" tokens"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"snprintf"),n("span",{class:"token punctuation"},"("),s("query_result"),n("span",{class:"token punctuation"},","),s(" IO_BUF_SIZE"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"%s -> %s\\n"'),n("span",{class:"token punctuation"},","),s(" tokens"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(`
           value `),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),s(),n("span",{class:"token operator"},"?"),s(),n("span",{class:"token string"},'"(nil)"'),s(),n("span",{class:"token operator"},":"),s(" value"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`
`)])]),n("h3",null,"59-5"),n("p",null,"// TODO"),n("h2",null,"\u7B2C\u516D\u5341\u7AE0"),n("h3",null,"60-1"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<fcntl.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<netdb.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<semaphore.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/wait.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"IO_BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1024")])]),s(`

`),n("span",{class:"token class-name"},"sem_t"),s(" limit_sem"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"sig_handler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"sem_post"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("limit_sem"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"char"),s(" c"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},"["),s("IO_BUF_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token class-name"},"ssize_t"),s(" limit"),n("span",{class:"token punctuation"},","),s(" opt_count"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("host"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("port"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"addrinfo"),s(" hints"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("result"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" optval"),n("span",{class:"token punctuation"},","),s(" fd_l"),n("span",{class:"token punctuation"},","),s(" fd_r"),n("span",{class:"token punctuation"},","),s(" size"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sigaction"),s(" sig"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s [-n limit] host port\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  limit `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  opt_count `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("c "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getopt"),n("span",{class:"token punctuation"},"("),s("argc"),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"n:"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token char"},"'n'"),n("span",{class:"token operator"},":"),s(`
      limit `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getLong"),n("span",{class:"token punctuation"},"("),s("optarg"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"limit"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      opt_count `),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"getopt"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("hints"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"addrinfo"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getaddrinfo"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"+"),s(" opt_count "),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),s(),n("span",{class:"token operator"},"+"),s(" opt_count "),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("hints"),n("span",{class:"token punctuation"},","),s(`
                  `),n("span",{class:"token operator"},"&"),s("result"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"getaddrinfo"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd_l "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"socket"),n("span",{class:"token punctuation"},"("),s("AF_INET"),n("span",{class:"token punctuation"},","),s(" SOCK_STREAM"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"socket"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  optval `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"setsockopt"),n("span",{class:"token punctuation"},"("),s("fd_l"),n("span",{class:"token punctuation"},","),s(" SOL_SOCKET"),n("span",{class:"token punctuation"},","),s(" SO_REUSEADDR"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("optval"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("optval"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"setsockopt"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  hints`),n("span",{class:"token punctuation"},"."),s("ai_family "),n("span",{class:"token operator"},"="),s(" AF_INET"),n("span",{class:"token punctuation"},";"),s(`
  hints`),n("span",{class:"token punctuation"},"."),s("ai_socktype "),n("span",{class:"token operator"},"="),s(" SOCK_STREAM"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"="),s(" result"),n("span",{class:"token punctuation"},";"),s(" curr "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(" curr "),n("span",{class:"token operator"},"="),s(" curr"),n("span",{class:"token operator"},"->"),s("ai_next"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"bind"),n("span",{class:"token punctuation"},"("),s("fd_l"),n("span",{class:"token punctuation"},","),s(" curr"),n("span",{class:"token operator"},"->"),s("ai_addr"),n("span",{class:"token punctuation"},","),s(" curr"),n("span",{class:"token operator"},"->"),s("ai_addrlen"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"listen"),n("span",{class:"token punctuation"},"("),s("fd_l"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
    result `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("result "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"bind/listen"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token comment"},"// TODO handle SIGCHLD"),s(`
  `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("sig"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("sig"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  sig`),n("span",{class:"token punctuation"},"."),s("sa_handler "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"&"),s("sig_handler"),n("span",{class:"token punctuation"},";"),s(`
  sig`),n("span",{class:"token punctuation"},"."),s("sa_flags "),n("span",{class:"token operator"},"="),s(" SA_RESTART"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("sig"),n("span",{class:"token punctuation"},"."),s("sa_mask"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigemptyset"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigaction"),n("span",{class:"token punctuation"},"("),s("SIGCHLD"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sig"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigaction"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"child process limit %ld\\n"'),n("span",{class:"token punctuation"},","),s(" limit"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sem_init"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("limit_sem"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(" limit"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sem_init"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd_r "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"accept"),n("span",{class:"token punctuation"},"("),s("fd_l"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
      `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"[accept] %s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token function"},"sem_wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("limit_sem"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"[fork] %s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd_r"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" IO_BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"recv"),n("span",{class:"token punctuation"},"("),s("fd_r"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" IO_BUF_SIZE"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
          `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"[recv] %s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
          `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
          `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"send"),n("span",{class:"token punctuation"},"("),s("fd_r"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
          `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"[send] %s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
          `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
      `),n("span",{class:"token punctuation"},"}"),s(`
      `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd_r"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token function"},"_exit"),n("span",{class:"token punctuation"},"("),s("EXIT_SUCCESS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
      `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd_r"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
      `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
  `),n("span",{class:"token function"},"sem_destroy"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("limit_sem"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"60-2"),n("p",null,"//TODO"),n("h2",null,"\u7B2C\u516D\u5341\u4E00\u7AE0"),n("h3",null,"61-1"),n("p",null,"\u8FD9\u662F\u4E2A\u8FED\u4EE3\u5F0F\u7684\u670D\u52A1\u5668\uFF0C\u4E00\u6B21\u65F6\u523B\u662F\u80FD\u5904\u7406\u4E00\u4E2A\u8BF7\u6C42"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<netdb.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"IO_BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1024")])]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),n("span",{class:"token operator"},"*"),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" fd_l"),n("span",{class:"token punctuation"},","),s(" fd_r"),n("span",{class:"token punctuation"},","),s(" optval"),n("span",{class:"token punctuation"},","),s(" size"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"addrinfo"),s(" hints"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("result"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"char"),s(" buf"),n("span",{class:"token punctuation"},"["),s("IO_BUF_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s host port\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("hints"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("hints"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    hints`),n("span",{class:"token punctuation"},"."),s("ai_family "),n("span",{class:"token operator"},"="),s(" AF_INET"),n("span",{class:"token punctuation"},";"),s(`
    hints`),n("span",{class:"token punctuation"},"."),s("ai_socktype "),n("span",{class:"token operator"},"="),s(" SOCK_STREAM"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getaddrinfo"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("hints"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("result"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"getaddrinfo"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd_l "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"socket"),n("span",{class:"token punctuation"},"("),s("AF_INET"),n("span",{class:"token punctuation"},","),s(" SOCK_STREAM"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"socket"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    optval `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"setsockopt"),n("span",{class:"token punctuation"},"("),s("fd_l"),n("span",{class:"token punctuation"},","),s(" SOL_SOCKET"),n("span",{class:"token punctuation"},","),s(" SO_REUSEADDR"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("optval"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("optval"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(`
        `),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"setsockopt"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"="),s(" result"),n("span",{class:"token punctuation"},";"),s(" curr "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(" curr "),n("span",{class:"token operator"},"="),s(" curr"),n("span",{class:"token operator"},"->"),s("ai_next"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"bind"),n("span",{class:"token punctuation"},"("),s("fd_l"),n("span",{class:"token punctuation"},","),s(" curr"),n("span",{class:"token operator"},"->"),s("ai_addr"),n("span",{class:"token punctuation"},","),s(" curr"),n("span",{class:"token operator"},"->"),s("ai_addrlen"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
            `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"listen"),n("span",{class:"token punctuation"},"("),s("fd_l"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
            `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
        result `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("result "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"bind/listen"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd_r "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"accept"),n("span",{class:"token punctuation"},"("),s("fd_l"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"[accept] %s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" IO_BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("STDIN_FILENO"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" IO_BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"[read] %s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
                `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("fd_r"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" size"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"[write] %s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"shutdown"),n("span",{class:"token punctuation"},"("),s("fd_r"),n("span",{class:"token punctuation"},","),s(" SHUT_RDWR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"[shutdown] %s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"61-2"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/socket.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/wait.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"tlpi_pipe"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" fds"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"socketpair"),n("span",{class:"token punctuation"},"("),s("AF_UNIX"),n("span",{class:"token punctuation"},","),s(" SOCK_STREAM"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" fds"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"shutdown"),n("span",{class:"token punctuation"},"("),s("fds"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" SHUT_WR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"shutdown"),n("span",{class:"token punctuation"},"("),s("fds"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" SHUT_RD"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"IO_BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1024")])]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" fds"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" size"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"char"),s(" buf"),n("span",{class:"token punctuation"},"["),s("IO_BUF_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"tlpi_pipe"),n("span",{class:"token punctuation"},"("),s("fds"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"tlpi_pipe"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fds"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
            `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"close"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("fds"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" IO_BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
            `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"read"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("STDOUT_FILENO"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" size"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
            `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"write"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fds"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
            `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"close"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" IO_BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"strcpy"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"hello\\n"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("fds"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
            `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"write"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"61-3"),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/mman.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token class-name"},"ssize_t"),s(),n("span",{class:"token function"},"tlpi_sendfile"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" out_fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" in_fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token class-name"},"off_t"),n("span",{class:"token operator"},"*"),s(" offset"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token class-name"},"size_t"),s(" count"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"void"),n("span",{class:"token operator"},"*"),s(" addr"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token class-name"},"ssize_t"),s(" written_count"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("addr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"mmap"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(" count"),n("span",{class:"token punctuation"},","),s(" PROT_READ"),n("span",{class:"token punctuation"},","),s(" MAP_PRIVATE"),n("span",{class:"token punctuation"},","),s(" in_fd"),n("span",{class:"token punctuation"},","),s(`
                     offset `),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),s(),n("span",{class:"token operator"},"?"),s(),n("span",{class:"token operator"},"*"),s("offset "),n("span",{class:"token operator"},":"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" MAP_FAILED"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token function"},"write"),n("span",{class:"token punctuation"},"("),s("out_fd"),n("span",{class:"token punctuation"},","),s(" addr"),n("span",{class:"token punctuation"},","),s(" count"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"mian"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"61-4"),n("p",null,[n("img",{src:yn,alt:"61-4-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<netdb.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<netinet/in.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/socket.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1024")])]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_in"),s(" addr"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token class-name"},"socklen_t"),s(" sock_len"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"char"),s(" host"),n("span",{class:"token punctuation"},"["),s("BUF_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" service"),n("span",{class:"token punctuation"},"["),s("BUF_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"socket"),n("span",{class:"token punctuation"},"("),s("AF_INET"),n("span",{class:"token punctuation"},","),s(" SOCK_STREAM"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"socket"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"listen"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"listen"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    sock_len `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("addr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getsockname"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("addr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sock_len"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"getsockname"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getnameinfo"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("addr"),n("span",{class:"token punctuation"},","),s(" sock_len"),n("span",{class:"token punctuation"},","),s(" host"),n("span",{class:"token punctuation"},","),s(" BUF_SIZE"),n("span",{class:"token punctuation"},","),s(" service"),n("span",{class:"token punctuation"},","),s(`
                    BUF_SIZE`),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"getnameinfo"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"printf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"host: %s\\nservice: %s\\n"'),n("span",{class:"token punctuation"},","),s(" host"),n("span",{class:"token punctuation"},","),s(" service"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"61-5"),n("p",null,[n("img",{src:wn,alt:"61-5-1"})]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<netdb.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<signal.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/wait.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"sig_handler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" sig"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token function"},"wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"IO_BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1024")])]),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),n("span",{class:"token operator"},"*"),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" fd_l"),n("span",{class:"token punctuation"},","),s(" fd_r"),n("span",{class:"token punctuation"},","),s(" optval"),n("span",{class:"token punctuation"},","),s(" size"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"addrinfo"),s(" hints"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("result"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"char"),s(" buf"),n("span",{class:"token punctuation"},"["),s("IO_BUF_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sigaction"),s(" sa"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s host port\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("hints"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("hints"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    hints`),n("span",{class:"token punctuation"},"."),s("ai_family "),n("span",{class:"token operator"},"="),s(" AF_INET"),n("span",{class:"token punctuation"},";"),s(`
    hints`),n("span",{class:"token punctuation"},"."),s("ai_socktype "),n("span",{class:"token operator"},"="),s(" SOCK_STREAM"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getaddrinfo"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("hints"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("result"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"getaddrinfo"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd_l "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"socket"),n("span",{class:"token punctuation"},"("),s("AF_INET"),n("span",{class:"token punctuation"},","),s(" SOCK_STREAM"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"socket"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    optval `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"setsockopt"),n("span",{class:"token punctuation"},"("),s("fd_l"),n("span",{class:"token punctuation"},","),s(" SOL_SOCKET"),n("span",{class:"token punctuation"},","),s(" SO_REUSEADDR"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("optval"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("optval"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(`
        `),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"setsockopt"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"="),s(" result"),n("span",{class:"token punctuation"},";"),s(" curr "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(" curr "),n("span",{class:"token operator"},"="),s(" curr"),n("span",{class:"token operator"},"->"),s("ai_next"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"bind"),n("span",{class:"token punctuation"},"("),s("fd_l"),n("span",{class:"token punctuation"},","),s(" curr"),n("span",{class:"token operator"},"->"),s("ai_addr"),n("span",{class:"token punctuation"},","),s(" curr"),n("span",{class:"token operator"},"->"),s("ai_addrlen"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
            `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"listen"),n("span",{class:"token punctuation"},"("),s("fd_l"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
            `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
        result `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("result "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"bind/listen"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("sa"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    sa`),n("span",{class:"token punctuation"},"."),s("sa_flags "),n("span",{class:"token operator"},"="),s(" SA_RESTART"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"sigemptyset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},"."),s("sa_mask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    sa`),n("span",{class:"token punctuation"},"."),s("sa_handler "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"&"),s("sig_handler"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sigaction"),n("span",{class:"token punctuation"},"("),s("SIGCHLD"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sigaction"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd_r "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"accept"),n("span",{class:"token punctuation"},"("),s("fd_l"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"[accpt] %s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"fork"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token operator"},":"),s(`
            `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"fork"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"case"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token operator"},":"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"dup2"),n("span",{class:"token punctuation"},"("),s("fd_r"),n("span",{class:"token punctuation"},","),s(" STDOUT_FILENO"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
                `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"dup2"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"send"),n("span",{class:"token punctuation"},"("),s("fd_r"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"> "'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                    `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"[send] %s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
                `),n("span",{class:"token punctuation"},"}"),s(`
                `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" IO_BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("size "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("fd_r"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" IO_BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                    `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"[read] %s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                    `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
                `),n("span",{class:"token punctuation"},"}"),s(`
                `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"size_t"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(" size"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},"["),s("i"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'\\n'"),s(),n("span",{class:"token operator"},"||"),s(" buf"),n("span",{class:"token punctuation"},"["),s("i"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"13"),n("span",{class:"token punctuation"},")"),s(`
                        buf`),n("span",{class:"token punctuation"},"["),s("i"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
                `),n("span",{class:"token punctuation"},"}"),s(`
                `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"system"),n("span",{class:"token punctuation"},"("),s("buf"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
                    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"system"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"shutdown"),n("span",{class:"token punctuation"},"("),s("fd_r"),n("span",{class:"token punctuation"},","),s(" SHUT_RDWR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
                `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"shutdown"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"default"),n("span",{class:"token operator"},":"),s(`
            `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd_r"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"61-6"),n("p",null,"// TODO"),n("h2",null,"\u7B2C\u516D\u5341\u4E8C\u7AE0"),n("p",null,"// TODO"),n("h2",null,"\u7B2C\u516D\u5341\u4E09\u7AE0"),n("h3",null,"63-1"),n("h3",null,"63-2"),n("p",null,[s("UDP \u7684"),n("code",null,"recvfrom"),s("\u9700\u8981\u4F7F\u7528 inet6 \u7684\u5730\u5740\u63A5\u6536")]),n("pre",{class:"language-c"},[n("code",{class:"language-c"},[n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<netdb.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<pthread.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<sys/epoll.h>")]),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"include"),s(),n("span",{class:"token string"},"<tlpi_hdr.h>")]),s(`

`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"define"),s(),n("span",{class:"token macro-name"},"IO_BUF_SIZE"),s(),n("span",{class:"token expression"},[n("span",{class:"token number"},"1024")])]),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(" epollfd"),n("span",{class:"token punctuation"},","),s(" fd_udp_l"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token function"},"echo_worker"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),n("span",{class:"token operator"},"*"),s(" arg"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"char"),s(" buf"),n("span",{class:"token punctuation"},"["),s("IO_BUF_SIZE"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_in6"),s(" addr"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token class-name"},"socklen_t"),s(" addr_len"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"epoll_event"),s(" epevt"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"epoll_wait"),n("span",{class:"token punctuation"},"("),s("epollfd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("epevt"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
            `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"epoll_wait"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
            `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("epevt"),n("span",{class:"token punctuation"},"."),s("data"),n("span",{class:"token punctuation"},"."),s("fd "),n("span",{class:"token operator"},"!="),s(" fd_udp_l"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"read"),n("span",{class:"token punctuation"},"("),s("epevt"),n("span",{class:"token punctuation"},"."),s("data"),n("span",{class:"token punctuation"},"."),s("fd"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" IO_BUF_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
                `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"read"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"epoll_ctl"),n("span",{class:"token punctuation"},"("),s("epollfd"),n("span",{class:"token punctuation"},","),s(" EPOLL_CTL_DEL"),n("span",{class:"token punctuation"},","),s(" epevt"),n("span",{class:"token punctuation"},"."),s("data"),n("span",{class:"token punctuation"},"."),s("fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(`
                    `),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
                    `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"epoll_ctl"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"send"),n("span",{class:"token punctuation"},"("),s("epevt"),n("span",{class:"token punctuation"},"."),s("data"),n("span",{class:"token punctuation"},"."),s("fd"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
                `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"send"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"recvfrom"),n("span",{class:"token punctuation"},"("),s("epevt"),n("span",{class:"token punctuation"},"."),s("data"),n("span",{class:"token punctuation"},"."),s("fd"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" IO_BUF_SIZE"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(`
                              `),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("addr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("addr_len"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
                `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"recvfrom"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"sendto"),n("span",{class:"token punctuation"},"("),s("epevt"),n("span",{class:"token punctuation"},"."),s("data"),n("span",{class:"token punctuation"},"."),s("fd"),n("span",{class:"token punctuation"},","),s(" buf"),n("span",{class:"token punctuation"},","),s(" s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("addr"),n("span",{class:"token punctuation"},","),s(`
                       addr_len`),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
                `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"sendto"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" argc"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),n("span",{class:"token operator"},"*"),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" fd_tcp_l"),n("span",{class:"token punctuation"},","),s(" fd_r"),n("span",{class:"token punctuation"},","),s(" optval"),n("span",{class:"token punctuation"},","),s(" s"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"addrinfo"),s(" hints"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("result"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("curr"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"epoll_event"),s(" evt"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token class-name"},"pthread_t"),s(" echo_thread"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("argc "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"usageErr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"%s host port\\n"'),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd_tcp_l "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"socket"),n("span",{class:"token punctuation"},"("),s("AF_INET"),n("span",{class:"token punctuation"},","),s(" SOCK_STREAM"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"socket"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    optval `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"setsockopt"),n("span",{class:"token punctuation"},"("),s("fd_tcp_l"),n("span",{class:"token punctuation"},","),s(" SOL_SOCKET"),n("span",{class:"token punctuation"},","),s(" SO_REUSEADDR"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("optval"),n("span",{class:"token punctuation"},","),s(`
                   `),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("optval"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"setsockopt"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("hints"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("hints"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    hints`),n("span",{class:"token punctuation"},"."),s("ai_family "),n("span",{class:"token operator"},"="),s(" AF_INET"),n("span",{class:"token punctuation"},";"),s(`
    hints`),n("span",{class:"token punctuation"},"."),s("ai_socktype "),n("span",{class:"token operator"},"="),s(" SOCK_STREAM"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getaddrinfo"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("hints"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("result"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"getaddrinfo"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"="),s(" result"),n("span",{class:"token punctuation"},";"),s(" curr "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(" curr "),n("span",{class:"token operator"},"="),s(" curr"),n("span",{class:"token operator"},"->"),s("ai_next"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"bind"),n("span",{class:"token punctuation"},"("),s("fd_tcp_l"),n("span",{class:"token punctuation"},","),s(" curr"),n("span",{class:"token operator"},"->"),s("ai_addr"),n("span",{class:"token punctuation"},","),s(" curr"),n("span",{class:"token operator"},"->"),s("ai_addrlen"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
            `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"listen"),n("span",{class:"token punctuation"},"("),s("fd_tcp_l"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
            `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
        result `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("result "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"bind/listen"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd_udp_l "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"socket"),n("span",{class:"token punctuation"},"("),s("AF_INET"),n("span",{class:"token punctuation"},","),s(" SOCK_DGRAM"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"socket"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    optval `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"setsockopt"),n("span",{class:"token punctuation"},"("),s("fd_udp_l"),n("span",{class:"token punctuation"},","),s(" SOL_SOCKET"),n("span",{class:"token punctuation"},","),s(" SO_REUSEADDR"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("optval"),n("span",{class:"token punctuation"},","),s(`
                   `),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("optval"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"setsockopt"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("hints"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("hints"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    hints`),n("span",{class:"token punctuation"},"."),s("ai_family "),n("span",{class:"token operator"},"="),s(" AF_INET"),n("span",{class:"token punctuation"},";"),s(`
    hints`),n("span",{class:"token punctuation"},"."),s("ai_socktype "),n("span",{class:"token operator"},"="),s(" SOCK_DGRAM"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getaddrinfo"),n("span",{class:"token punctuation"},"("),s("argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" argv"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("hints"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("result"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"getaddrinfo"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("curr "),n("span",{class:"token operator"},"="),s(" result"),n("span",{class:"token punctuation"},";"),s(" curr "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(" curr "),n("span",{class:"token operator"},"="),s(" curr"),n("span",{class:"token operator"},"->"),s("ai_next"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"bind"),n("span",{class:"token punctuation"},"("),s("fd_udp_l"),n("span",{class:"token punctuation"},","),s(" curr"),n("span",{class:"token operator"},"->"),s("ai_addr"),n("span",{class:"token punctuation"},","),s(" curr"),n("span",{class:"token operator"},"->"),s("ai_addrlen"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
            `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
        result `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("result "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"bind/listen"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("epollfd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"epoll_create"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"epoll_create"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_create"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("echo_thread"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("echo_worker"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_create"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"pthread_detach"),n("span",{class:"token punctuation"},"("),s("echo_thread"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExitEN"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"pthread_detach"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("evt"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("evt"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    evt`),n("span",{class:"token punctuation"},"."),s("events "),n("span",{class:"token operator"},"="),s(" EPOLLIN"),n("span",{class:"token punctuation"},";"),s(`
    evt`),n("span",{class:"token punctuation"},"."),s("data"),n("span",{class:"token punctuation"},"."),s("fd "),n("span",{class:"token operator"},"="),s(" fd_udp_l"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"epoll_ctl"),n("span",{class:"token punctuation"},"("),s("epollfd"),n("span",{class:"token punctuation"},","),s(" EPOLL_CTL_ADD"),n("span",{class:"token punctuation"},","),s(" fd_udp_l"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("evt"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"errExit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"epoll_ctl"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd_r "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"accept"),n("span",{class:"token punctuation"},"("),s("fd_tcp_l"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"[accept] %s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("evt"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("evt"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        evt`),n("span",{class:"token punctuation"},"."),s("events "),n("span",{class:"token operator"},"="),s(" EPOLLIN"),n("span",{class:"token punctuation"},";"),s(`
        evt`),n("span",{class:"token punctuation"},"."),s("data"),n("span",{class:"token punctuation"},"."),s("fd "),n("span",{class:"token operator"},"="),s(" fd_r"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"epoll_ctl"),n("span",{class:"token punctuation"},"("),s("epollfd"),n("span",{class:"token punctuation"},","),s(" EPOLL_CTL_ADD"),n("span",{class:"token punctuation"},","),s(" fd_r"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("evt"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token function"},"fprintf"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"stderr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"[epoll_ctl] %s\\n"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("h3",null,"63-3"),n("p",null,"// TODO"),n("p",null,"// TODO"),n("h2",null,"\u7B2C\u516D\u5341\u56DB\u7AE0"),n("p",null,"//TODO")],-1),Ln="\u300Athe linux programming interface\u300B\u7EC3\u4E60",xn="2021-09-28T15:58:01.000Z",In=["\u968F\u7B14"],Un="./the-linux-programming-interface.png",Nn={__name:"content",setup(_n,{expose:t}){const a={title:"\u300Athe linux programming interface\u300B\u7EC3\u4E60",date:"2021-09-28T15:58:01.000Z",tags:["\u968F\u7B14"],coverImage:"./the-linux-programming-interface.png"};return t({frontmatter:a}),(hn,bn)=>{const o=c;return u(),p(o,{frontmatter:a},{default:e(()=>[gn]),_:1})}}};export{Un as coverImage,xn as date,Nn as default,In as tags,Ln as title};
